<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ListLab V48 - Summary Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">

    <style>

        
        /* === FOUNDATIONS === */
        body { font-family: 'Assistant', sans-serif; background: #eef0f4; height: 100vh; overflow: hidden; color: #1e293b; font-size: 14px; }
        .num-font { font-family: 'Inter', sans-serif; }
        
        /* === LAYOUT === */
        .main-wrapper { width: 100%; height: 100%; display: flex; flex-direction: column; padding: 6px; gap: 5px; }
        .glass-header { background: white; border-radius: 10px; padding: 0 1.2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.04); display: flex; justify-content: space-between; align-items: center; height: 50px; border: 1px solid #e5e7eb; }
        .dash-container { flex: 1; background: white; border-radius: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); display: flex; overflow: hidden; border: 1px solid #e0e3e8; }
        
        /* === SIDEBAR === */
        .dash-sidebar { width: 310px; background: #f6f7f9; border-left: 1px solid #e0e3e8; display: flex; flex-direction: column; overflow-y: auto; padding: 10px; gap: 6px; }
        .dash-content { flex: 1; background: #fafbfc; display: flex; flex-direction: column; overflow: hidden; }

        /* === CONTROL BOXES - Unified white cards with accent strips === */
        .control-box { border-radius: 8px; padding: 10px; border: 1px solid #e5e7eb; background: white !important; position: relative; transition: box-shadow 0.15s; }
        .control-box:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .control-box.border-blue-200 { border-right: 3px solid #3b82f6; }
        .control-box.border-slate-300 { border-right: 3px solid #94a3b8; }
        .control-box.border-amber-200 { border-right: 3px solid #f59e0b; }
        .control-box.border-purple-200 { border-right: 3px solid #8b5cf6; }
        .control-box.border-slate-200 { border-right: 3px solid #64748b; }
        
        .control-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .control-item { display: flex; flex-direction: column; }
        .lbl-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
        .lbl-sm { font-size: 11px; font-weight: 700; color: #64748b; }
        
        /* === INPUTS === */
        input[type=range] { height: 4px; border-radius: 2px; background: #e2e8f0; outline: none; appearance: none; cursor: pointer; width: 100%; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%; background: currentColor; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .dash-input { width: 46px; font-family: 'Inter', sans-serif; font-weight: 700; font-size: 11px; text-align: center; border: 1px solid #ddd; border-radius: 5px; padding: 2px; background: #fafbfc; height: 24px; transition: border-color 0.15s; }
        .dash-input:focus { border-color: #3b82f6; outline: none; }

        /* === COLLAPSIBLES === */
        .collapsible-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 2px 0; }
        .collapsible-content { display: none; }
        .collapsible-content.open { display: block; }
        .collapse-icon { transition: transform 0.2s; }
        .collapse-icon.open { transform: rotate(180deg); }

        /* === KPI CARDS === */
        .kpi-container { display: flex; flex-wrap: wrap; gap: 6px; }
        .kpi-card { background: white; border: 1px solid #e8eaed; border-radius: 8px; transition: box-shadow 0.15s; display: flex; flex-direction: column; padding: 8px 10px; flex: 1 1 auto; min-width: 165px; max-width: 260px; }
        .kpi-card:hover { box-shadow: 0 3px 12px -2px rgba(0,0,0,0.08); }
        .kpi-card.hidden { display: none !important; }
        .kpi-card.custom-active { border: 2px solid #8b5cf6; box-shadow: 0 0 12px rgba(139, 92, 246, 0.2); }
        
        .kpi-pure { border-right: 4px solid #eab308; }
        .kpi-gold { border-right: 4px solid #f59e0b; }
        .kpi-potential { border-right: 4px solid #10b981; }
        .kpi-ignore { border-right: 4px solid #9ca3af; }
        .kpi-blacklist { border-right: 4px solid #ef4444; }
        .kpi-testing { border-right: 4px solid #3b82f6; }

        .stat-lbl { font-size: 10px; font-weight: 700; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.03em; }
        .stat-val { font-family: 'Inter', sans-serif; font-weight: 700; font-size: 13px; color: #1e293b; }
        
        .g-item { text-align: center; border-left: 1px solid #f3f4f6; flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 0 5px; }
        .g-item:last-child { border: none; }
        .g-lbl { font-size: 10px; font-weight: 700; color: #9ca3af; text-transform: uppercase; }
        .g-val { font-size: 13px; font-weight: 800; color: #1e293b; font-family: 'Inter', sans-serif; }

        /* === SCROLLBAR === */
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .chk-input { width: 13px; height: 13px; accent-color: #4f46e5; cursor: pointer; }
        
        /* === TABLE === */
        th { font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; color: #6b7280; font-weight: 800; background: #f3f4f6; position: sticky; top: 0; z-index: 20; padding: 8px 10px; cursor: pointer; border-bottom: 2px solid #e5e7eb; }
        th:hover { background: #e8eaed; color: #374151; }
        
        .summary-cell {
            background: #f0f0ff;
            color: #312e81;
            font-weight: 800;
            font-family: 'Inter', sans-serif;
            font-size: 11px;
            padding: 7px 10px;
            position: sticky;
            top: 34px;
            z-index: 19;
            border-bottom: 2px solid #c7d2fe;
        }

        td { font-size: 12px; border-bottom: 1px solid #f3f4f6; padding: 6px 10px; }
        tr:hover td { background-color: #f8f9fb; }
        
        /* Row tints - SUBTLE, not gradient soup */
        .row-pure { background: rgba(253, 224, 71, 0.08); }
        .row-gold { background: rgba(245, 158, 11, 0.06); }
        .row-potential { background: rgba(16, 185, 129, 0.06); }
        .row-blacklist { background: rgba(239, 68, 68, 0.06); }
        .row-testing { background: rgba(59, 130, 246, 0.05); }
        .row-custom { background: rgba(139, 92, 246, 0.06); }
        .row-summary { background: #f0f0ff; font-weight: 700; }

        /* === BADGES === */
        .cat-badge { font-size: 10px; font-weight: 800; padding: 2px 7px; border-radius: 4px; white-space: nowrap; letter-spacing: 0.02em; }
        .badge-pure { background: #fef3c7; color: #92400e; }
        .badge-gold { background: #fde68a; color: #92400e; }
        .badge-potential { background: #d1fae5; color: #065f46; }
        .badge-ignore { background: #f3f4f6; color: #6b7280; }
        .badge-blacklist { background: #fee2e2; color: #991b1b; }
        .badge-testing { background: #dbeafe; color: #1e40af; }
        .badge-custom { background: #ede9fe; color: #7c3aed; }
        .badge-summary { background: #e0e7ff; color: #4338ca; }

        .score-pill { font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; padding: 2px 7px; border-radius: 10px; }
        .score-high { background: #fbbf24; color: #78350f; }
        .score-mid { background: #10b981; color: white; }
        .score-low { background: #e8eaed; color: #6b7280; }

        /* === UPLOAD & BUTTONS === */
        .btn-upload { background: white; color: #4338ca; border: 1.5px dashed #a5b4fc; padding: 10px; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .btn-upload:hover { background: #eef2ff; border-color: #6366f1; }

        /* === FILTERS === */
        .filter-item { margin-bottom: 6px; position: relative; }
        .filter-header { display: flex; justify-content: space-between; align-items: center; font-size: 11px; font-weight: 700; color: #475569; margin-bottom: 2px; }
        .filter-btn { width: 100%; text-align: right; background: #fafbfc; border: 1px solid #ddd; padding: 6px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: border-color 0.15s; }
        .filter-btn:hover { border-color: #3b82f6; }
        .filter-popup { position: absolute; top: 100%; left: 0; width: 240px; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 12px 28px rgba(0,0,0,0.12); z-index: 50; display: none; flex-direction: column; padding: 8px; margin-top: 4px; }
        .filter-popup.show { display: flex; }
        .filter-search { width: 100%; padding: 5px 9px; border: 1px solid #e5e7eb; border-radius: 5px; font-size: 11px; margin-bottom: 6px; }
        .filter-list { max-height: 150px; overflow-y: auto; display: flex; flex-direction: column; gap: 3px; border: 1px solid #f3f4f6; padding: 4px; border-radius: 5px; margin-bottom: 6px; }
        .filter-opt { display: flex; align-items: center; gap: 6px; font-size: 11px; color: #334155; cursor: pointer; user-select: none; padding: 3px 5px; border-radius: 4px; }
        .filter-opt:hover { background: #f3f4f6; }
        .btn-tiny { font-size: 11px; padding: 3px 10px; border-radius: 4px; cursor: pointer; font-weight: 600; }
        .btn-apply { background: #4f46e5; color: white; }
        .btn-cancel { background: #f3f4f6; color: #64748b; }

        /* === LEVEL BADGES === */
        .level-badge { font-size: 10px; font-weight: 800; padding: 2px 6px; border-radius: 4px; }
        .level-1 { background: #fee2e2; color: #991b1b; }
        .level-2 { background: #fef3c7; color: #92400e; }
        .level-3 { background: #d1fae5; color: #065f46; }

        /* === MAPPING === */
        .mapping-row { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; }
        .mapping-row label { font-size: 10px; font-weight: 700; color: #6b7280; min-width: 48px; }
        .mapping-row select { flex: 1; font-size: 10px; padding: 3px 5px; border: 1px solid #ddd; border-radius: 5px; }

        /* === THRESHOLD === */
        .threshold-info { font-size: 10px; color: #6b7280; background: #f6f7f9; padding: 4px 8px; border-radius: 5px; margin-top: 4px; border: 1px solid #eee; }
        .threshold-val { font-weight: 800; color: #4f46e5; }
        
        /* === MINI DASHBOARD === */
        .mini-dashboard { display: flex; gap: 10px; padding: 10px; background: #f6f7f9; border-bottom: 1px solid #e5e7eb; }
        .dash-chart { background: white; border-radius: 8px; padding: 10px; border: 1px solid #e5e7eb; flex: 1; min-width: 200px; }
        .dash-chart-title { font-size: 10px; font-weight: 700; color: #6b7280; text-transform: uppercase; letter-spacing: 0.04em; margin-bottom: 6px; }
        
        /* === SEARCH & TOOLBAR === */
        .search-box { position: relative; }
        .search-box input { width: 150px; padding: 5px 10px 5px 28px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px; background: #fafbfc; transition: all 0.15s; }
        .search-box input:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.08); background: white; }
        .search-box i { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); color: #9ca3af; pointer-events: none; }
        .search-highlight { background: #fef08a !important; padding: 0 2px; border-radius: 2px; }
        .icloud-badge { font-size: 10px; margin-left: 4px; opacity: 0.7; cursor: help; color: #3b82f6; }
        
        /* === SWITCHERS (unified look) === */
        .icloud-switcher, .agg-switcher { display: flex; align-items: center; gap: 3px; padding: 2px 4px; background: #f3f4f6; border-radius: 6px; border: 1px solid #e5e7eb; }
        .switcher-options { display: flex; gap: 1px; }
        .switcher-btn { padding: 2px 6px; font-size: 10px; border: none; background: transparent; border-radius: 4px; cursor: pointer; opacity: 0.45; transition: all 0.15s; font-weight: 600; }
        .icloud-switcher .switcher-btn:hover, .agg-switcher .switcher-btn:hover { opacity: 0.75; background: #e5e7eb; }
        .icloud-switcher .switcher-btn.active { opacity: 1; background: #4f46e5; color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .agg-switcher .switcher-btn.active { opacity: 1; background: #059669; color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        
        /* === SORT === */
        .sortable-th { cursor: pointer; user-select: none; transition: background 0.15s; }
        .sortable-th:hover { background: #e8eaed; }
        .sortable-th .sort-icon { font-size: 10px; opacity: 0.35; margin-right: 2px; }
        .sortable-th.sort-asc .sort-icon { opacity: 1; font-size: 0; }
        .sortable-th.sort-asc .sort-icon::after { content: 'â†‘'; font-size: 10px; }
        .sortable-th.sort-desc .sort-icon { opacity: 1; font-size: 0; }
        .sortable-th.sort-desc .sort-icon::after { content: 'â†“'; font-size: 10px; }
        
        /* === COMPARE === */
        .compare-badge { font-size: 9px; padding: 2px 6px; border-radius: 10px; font-weight: 700; }
        .badge-new { background: #d1fae5; color: #065f46; }
        .badge-improved { background: #dbeafe; color: #1e40af; }
        .badge-declined { background: #fee2e2; color: #991b1b; }
        .badge-gone { background: #f3f4f6; color: #6b7280; }
        
        .compare-panel { background: white; border: 1px solid #93c5fd; border-right: 3px solid #3b82f6; border-radius: 8px; padding: 8px; }
        .compare-stats { display: flex; gap: 8px; flex-wrap: wrap; }
        .compare-stat { text-align: center; padding: 5px 10px; background: #f8f9fb; border-radius: 6px; border: 1px solid #e5e7eb; }
        .compare-stat-val { font-size: 16px; font-weight: 800; font-family: 'Inter', sans-serif; }
        .compare-stat-lbl { font-size: 9px; color: #6b7280; font-weight: 600; }
        
        .change-delta { font-size: 9px; font-weight: 700; padding: 1px 3px; border-radius: 3px; font-family: 'Inter', sans-serif; display: inline-block; margin-bottom: 1px; }
        .delta-positive { background: #d1fae5; color: #059669; }
        .delta-negative { background: #fee2e2; color: #dc2626; }
        
        /* === PERFORMERS === */
        .performer-item { display: flex; justify-content: space-between; align-items: center; gap: 2px; padding: 2px 0; border-bottom: 1px solid #f3f4f6; flex-wrap: wrap; }
        .performer-item:last-child { border: none; }
        .performer-id { font-weight: 600; color: #374151; font-size: 11px; word-break: break-all; }
        .performer-val { font-weight: 700; font-family: 'Inter', sans-serif; white-space: nowrap; font-size: 11px; }

        /* === BL MODE SWITCHER === */
        .bl-mode-switcher { display: inline-flex; gap: 1px; background: #fee2e2; border-radius: 5px; padding: 2px; margin-right: 6px; }
        .bl-mode-btn { font-size: 9px; font-weight: 800; padding: 2px 7px; border-radius: 3px; cursor: pointer; border: none; background: transparent; color: #991b1b; opacity: 0.5; transition: all 0.15s; white-space: nowrap; }
        .bl-mode-btn.active { opacity: 1; background: #dc2626; color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.15); }
        .bl-mode-btn:hover:not(.active) { opacity: 0.8; background: #fca5a5; }
        
        /* === SIDEBAR TYPOGRAPHY === */
        .dash-sidebar select { font-size: 11px; border: 1px solid #ddd; border-radius: 5px; background: #fafbfc; transition: border-color 0.15s; }
        .dash-sidebar select:focus { border-color: #4f46e5; outline: none; }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <div class="glass-header">
            <div class="flex items-center gap-2.5 shrink-0">
                <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 text-white p-1.5 rounded-lg">
                    <i data-lucide="activity" class="w-4 h-4"></i>
                </div>
                <div>
                    <h1 class="text-sm font-extrabold text-slate-800 leading-none">ListLab <span class="text-indigo-500 font-black">V48</span></h1>
                </div>
            </div>
            
            <div id="global-stats" class="flex-1 flex justify-center items-center">
                <span class="text-sm text-slate-400">×˜×¢×Ÿ ×§×•×‘×¥ ×œ×”×ª×—×œ×”...</span>
            </div>
            
            <div id="medians-box" class="hidden shrink-0 text-[11px] bg-gray-50 px-3 py-1 rounded-lg border border-gray-200">
                <span class="text-slate-500">Median PPC:</span> <strong id="med-ppc" class="text-amber-600 num-font">$0</strong>
                <span class="mx-2 text-slate-300">|</span>
                <span class="text-slate-500">Median CR:</span> <strong id="med-cr" class="text-blue-600 num-font">0%</strong>
                <span class="mx-2 text-slate-300">|</span>
                <span class="text-slate-500">×¡×£ ×§×œ×™×§×™×:</span> <strong id="click-threshold" class="text-red-500 num-font">0</strong>
            </div>
        </div>

        <div class="dash-container">
            <aside class="dash-sidebar custom-scrollbar">
                <div class="btn-upload" id="drop-zone">
                    <input type="file" id="file-input" class="hidden" accept=".xlsx,.csv">
                    <div class="flex items-center justify-center gap-2 text-indigo-600">
                        <i data-lucide="upload-cloud" class="w-3.5 h-3.5"></i>
                        <span class="text-xs font-bold">×˜×¢×Ÿ ×§×•×‘×¥ CSV / Excel</span>
                    </div>
                    <div id="filename" class="text-[10px] text-indigo-400 truncate mt-0.5"></div>
                </div>
                
                <div class="flex gap-1.5">
                    <button id="btn-compare" class="flex-1 flex items-center justify-center gap-1 bg-white border border-gray-200 text-gray-600 py-1 rounded-md text-[10px] font-bold hover:bg-gray-50 hover:border-indigo-300 hover:text-indigo-600 disabled:opacity-40 transition-colors" disabled>
                        <i data-lucide="git-compare" class="w-3 h-3"></i> ×”×©×•×•×” ×§×‘×¦×™×
                    </button>
                    <input type="file" id="compare-input" class="hidden" accept=".xlsx,.csv">
                    <button id="btn-clear-compare" class="hidden px-2 py-1.5 bg-slate-100 border border-slate-200 text-slate-600 rounded text-[11px] font-bold hover:bg-slate-200">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                </div>
                
                <div id="compare-panel" class="compare-panel hidden">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-[11px] font-bold text-indigo-700">×ª×•×¦××•×ª ×”×©×•×•××”</span>
                        <span id="compare-file-name" class="text-[10px] text-blue-500 truncate max-w-[150px]"></span>
                    </div>
                    <div class="compare-stats">
                        <div class="compare-stat">
                            <div class="compare-stat-val text-green-600" id="cmp-new">0</div>
                            <div class="compare-stat-lbl">×—×“×©×™×</div>
                        </div>
                        <div class="compare-stat">
                            <div class="compare-stat-val text-blue-600" id="cmp-improved">0</div>
                            <div class="compare-stat-lbl">×”×©×ª×¤×¨×•</div>
                        </div>
                        <div class="compare-stat">
                            <div class="compare-stat-val text-red-600" id="cmp-declined">0</div>
                            <div class="compare-stat-lbl">×™×¨×“×•</div>
                        </div>
                        <div class="compare-stat">
                            <div class="compare-stat-val text-slate-500" id="cmp-gone">0</div>
                            <div class="compare-stat-lbl">× ×¢×œ××•</div>
                        </div>
                    </div>
                </div>

                <div id="hierarchy-box" class="hidden bg-white border border-amber-200 border-r-4 rounded-lg p-2">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2 text-amber-700 text-[11px] font-bold">
                            <i data-lucide="git-branch" class="w-3 h-3"></i>
                            <span>×”×™×¨×¨×›×™×” ×¤×¢×™×œ×”</span>
                        </div>
                        <div id="level-badges" class="flex gap-1"></div>
                    </div>
                </div>

                <div class="control-box border-blue-200">
                    <div class="text-[11px] font-bold text-slate-700 mb-2 flex items-center gap-1.5">
                        <i data-lucide="layers" class="w-3.5 h-3.5 text-blue-500"></i> ×¡×•×’ ××–×”×” ×•×¡×£ ×§×œ×™×§×™×
                    </div>
                    
                    <div class="grid grid-cols-2 gap-1.5 mb-1.5">
                        <div>
                            <label class="text-[10px] text-slate-500 mb-1 block">×¢××•×“×ª ××–×”×”:</label>
                            <select id="col-ip" class="w-full text-[11px] border border-gray-200 rounded p-1.5 font-medium"></select>
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 mb-1 block">×¡×•×’:</label>
                            <select id="identifier-type" class="w-full text-[11px] border border-gray-200 rounded p-1.5 font-medium">
                                <option value="auto">ğŸ” ××•×˜×•××˜×™</option>
                                <option value="subid">ğŸ¯ SubID</option>
                                <option value="zone">ğŸ“ Zone</option>
                                <option value="ip">ğŸŒ IP</option>
                            </select>
                        </div>
                    </div>
                    
                    <div id="detected-type" class="text-[10px] text-green-600 font-bold mb-1.5 hidden"></div>
                    
                    <div class="mb-1.5">
                        <label class="text-[10px] text-slate-500 mb-0.5 block">×¨××ª ×˜×¨××¤×™×§:</label>
                        <select id="ip-level" class="w-full text-[11px] border border-gray-200 rounded p-1 font-medium">
                            <option value="1" selected>×¨××” 1 - SubID/IP32 (1.5Ã—)</option>
                            <option value="2">×¨××” 2 - Zone/IP24 (3Ã—)</option>
                            <option value="3">×¨××” 3 - IP16 (5Ã—)</option>
                        </select>
                    </div>
                    
                    <div class="threshold-info">
                        ×¡×£ ×§×œ×™×§×™× × ×•×›×—×™: <span class="threshold-val" id="current-threshold">1,500</span>
                        <br>× ×•×¡×—×”: ××›×¤×™×œ Ã— (100 / CR%)
                    </div>
                </div>

                <div class="control-box border-slate-300">
                    <div class="collapsible-header" onclick="toggleSection('filters')">
                        <div class="text-[11px] font-bold text-slate-700 flex items-center gap-1.5">
                            <i data-lucide="filter" class="w-3.5 h-3.5 text-slate-400"></i> ×¡×™× ×•×Ÿ ××ª×§×“×
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-600 collapse-icon open" id="filters-icon"></i>
                    </div>
                    <div class="collapsible-content open" id="filters-content">
                        <div id="filters-list" class="mt-2"></div>
                        <button onclick="showAddFilterMenu()" id="btn-add-filter" class="hidden w-full mt-2 border border-dashed border-indigo-300 text-indigo-600 rounded p-1.5 text-[10px] font-bold hover:bg-indigo-50 flex items-center justify-center gap-1">
                            <i data-lucide="plus" class="w-3 h-3"></i> ×”×•×¡×£ ××¡× ×Ÿ
                        </button>
                        <select id="col-selector" class="hidden w-full mt-1 text-[11px] border border-slate-300 rounded p-1" onchange="createNewFilter(this.value)">
                            <option value="">×‘×—×¨ ×¢××•×“×”...</option>
                        </select>
                        <div id="filter-msg" class="text-[11px] text-slate-400 text-center py-2 italic">×˜×¢×Ÿ ×§×•×‘×¥ ×›×“×™ ×œ×”×ª×—×™×œ</div>
                    </div>
                </div>

                <div class="control-box border-amber-200">
                    <div class="text-[11px] font-bold text-slate-700 mb-2 flex items-center gap-1.5">
                        <i data-lucide="sliders" class="w-3.5 h-3.5 text-amber-500"></i> TOP % Thresholds
                    </div>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="lbl-row"><span class="lbl-sm">ğŸ’ PURE</span><input type="number" id="pure-pct-num" value="10" class="dash-input text-amber-600"></div>
                            <input type="range" id="pure-pct" min="5" max="30" value="10" class="text-amber-500">
                        </div>
                        <div class="control-item">
                            <div class="lbl-row"><span class="lbl-sm">ğŸ¥‡ GOLD</span><input type="number" id="gold-pct-num" value="25" class="dash-input text-amber-600"></div>
                            <input type="range" id="gold-pct" min="15" max="50" value="25" class="text-amber-500">
                        </div>
                    </div>
                </div>

                <div class="control-box border-purple-200">
                    <div class="collapsible-header" onclick="toggleSection('custom')">
                        <div class="text-[11px] font-bold text-slate-700 flex items-center gap-1.5">
                            <i data-lucide="list-filter" class="w-3.5 h-3.5 text-purple-500"></i> Custom List
                            <span id="custom-badge" class="hidden text-[9px] bg-purple-600 text-white px-1.5 py-0.5 rounded-full">×¤×¢×™×œ</span>
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-purple-600 collapse-icon" id="custom-icon"></i>
                    </div>
                    <div class="collapsible-content" id="custom-content">
                        <div class="flex items-center gap-2 mb-2 mt-1.5">
                            <input type="checkbox" id="custom-enabled" class="chk-input">
                            <label for="custom-enabled" class="text-[11px] font-bold text-gray-700">×”×¤×¢×œ Custom List</label>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-1.5 mb-1.5">
                            <div class="bg-gray-50 rounded-md p-1.5 border border-gray-200">
                                <div class="text-[10px] font-bold text-gray-600 mb-1">Conv</div>
                                <div class="flex gap-1">
                                    <div class="flex-1"><input type="number" id="cust-conv-min" value="1" min="0" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="Min"></div>
                                    <span class="text-slate-300 self-center">-</span>
                                    <div class="flex-1"><input type="number" id="cust-conv-max" value="" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="âˆ"></div>
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-md p-1.5 border border-gray-200">
                                <div class="text-[10px] font-bold text-gray-600 mb-1">Score</div>
                                <div class="flex gap-1">
                                    <div class="flex-1"><input type="number" id="cust-score-min" value="0" step="0.1" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="Min"></div>
                                    <span class="text-slate-300 self-center">-</span>
                                    <div class="flex-1"><input type="number" id="cust-score-max" value="" step="0.1" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="âˆ"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-1.5 mb-1.5">
                            <div class="bg-gray-50 rounded-md p-1.5 border border-gray-200">
                                <div class="text-[10px] font-bold text-gray-600 mb-1">Clicks</div>
                                <div class="flex gap-1">
                                    <div class="flex-1"><input type="number" id="cust-clicks-min" value="0" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="Min"></div>
                                    <span class="text-slate-300 self-center">-</span>
                                    <div class="flex-1"><input type="number" id="cust-clicks-max" value="" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="âˆ"></div>
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-md p-1.5 border border-gray-200">
                                <div class="text-[10px] font-bold text-gray-600 mb-1">ROI%</div>
                                <div class="flex gap-1">
                                    <div class="flex-1"><input type="number" id="cust-roi-min" value="-100" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="Min"></div>
                                    <span class="text-slate-300 self-center">-</span>
                                    <div class="flex-1"><input type="number" id="cust-roi-max" value="" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="âˆ"></div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-1.5 mb-1.5">
                            <div class="bg-gray-50 rounded-md p-1.5 border border-gray-200">
                                <div class="text-[10px] font-bold text-gray-600 mb-1">CR%</div>
                                <div class="flex gap-1">
                                    <div class="flex-1"><input type="number" id="cust-cr-min" value="0" step="0.001" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="Min"></div>
                                    <span class="text-slate-300 self-center">-</span>
                                    <div class="flex-1"><input type="number" id="cust-cr-max" value="" step="0.001" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="âˆ"></div>
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-md p-1.5 border border-gray-200">
                                <div class="text-[10px] font-bold text-gray-600 mb-1">PPC (Profit/Click)</div>
                                <div class="flex gap-1">
                                    <div class="flex-1"><input type="number" id="cust-ppc-min" value="-1" step="0.001" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="Min"></div>
                                    <span class="text-slate-300 self-center">-</span>
                                    <div class="flex-1"><input type="number" id="cust-ppc-max" value="" step="0.001" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="âˆ"></div>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="processData()" class="w-full mt-1 bg-indigo-600 text-white py-1.5 rounded-md text-xs font-bold hover:bg-indigo-700 flex items-center justify-center gap-1 transition-colors">
                            <i data-lucide="check" class="w-3 h-3"></i> ×”×—×œ ×¤×™×œ×˜×¨
                        </button>
                    </div>
                </div>

                <!-- Mapping moved here (was higher up) -->
                <div id="mapping-box" class="hidden control-box border-slate-200">
                    <div class="collapsible-header" onclick="toggleSection('mapping')">
                        <div class="text-[11px] font-bold text-slate-700 flex items-center gap-1.5">
                            <i data-lucide="columns" class="w-3.5 h-3.5 text-slate-400"></i> ××™×¤×•×™ ×¢××•×“×•×ª
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-600 collapse-icon" id="mapping-icon"></i>
                    </div>
                    <div class="collapsible-content" id="mapping-content">
                        <div class="mapping-row"><label>×§×œ×™×§×™×</label><select id="col-clicks"></select></div>
                        <div class="mapping-row"><label>×”××¨×•×ª</label><select id="col-conv"></select></div>
                        <div class="mapping-row"><label>×”×›× ×¡×”</label><select id="col-rev"></select></div>
                        <div class="mapping-row"><label>×¢×œ×•×ª</label><select id="col-cost"></select></div>
                        <button onclick="processData()" class="w-full mt-2 bg-gray-700 text-white py-1.5 rounded-md text-xs font-bold hover:bg-gray-800 transition-colors">×¢×“×›×Ÿ ××™×¤×•×™</button>
                    </div>
                </div>

                <div class="mt-auto border-t border-gray-200 pt-2">
                    <div class="grid grid-cols-3 gap-1.5 mb-2 text-[10px] font-medium text-slate-500">
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="chk-pure" checked class="chk-input"> Pure</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="chk-gold" checked class="chk-input"> Gold</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="chk-potential" checked class="chk-input"> Potential</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="chk-bl" class="chk-input"> Blacklist</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="chk-custom" class="chk-input"> Custom</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="chk-cidr" class="chk-input"> CIDR</label>
                    </div>
                    <button onclick="exportData()" class="w-full bg-indigo-600 text-white py-1.5 rounded-lg text-xs font-bold hover:bg-indigo-700 flex items-center justify-center gap-2 transition-colors shadow-sm">
                        <i data-lucide="download" class="w-3.5 h-3.5"></i> ×™×™×¦×•× Excel
                    </button>
                </div>
            </aside>

            <main class="dash-content">
                <div class="p-2.5 bg-white border-b border-gray-100 shrink-0">
                    <div id="kpi-container" class="kpi-container"></div>
                </div>
                
                <div id="mini-dashboard" class="hidden border-b border-slate-200">
                    <div class="flex items-center justify-between px-3 py-1.5 bg-gray-50 cursor-pointer border-b border-gray-100" onclick="toggleDashboard()">
                        <div class="flex items-center gap-2 text-[11px] font-bold text-gray-500">
                            <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                            <span>Dashboard ××”×™×¨</span>
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 transition-transform" id="dash-toggle-icon"></i>
                    </div>
                    <div id="dashboard-content" class="hidden px-3 py-2 bg-gray-50">
                        <div class="grid grid-cols-4 gap-2">
                            <div class="bg-white rounded-lg p-2 border border-green-200 shadow-sm">
                                <div class="text-[11px] font-bold text-green-600 mb-1 flex items-center gap-1">
                                    <i data-lucide="trophy" class="w-3 h-3"></i> TOP 5 ×¨×•×•×—×™×™×
                                </div>
                                <div id="top-performers" class="space-y-0.5"></div>
                            </div>
                            <div class="bg-white rounded-lg p-2 border border-red-200 shadow-sm">
                                <div class="text-[11px] font-bold text-red-600 mb-1 flex items-center gap-1">
                                    <i data-lucide="trending-down" class="w-3 h-3"></i> TOP 5 ××¤×¡×™×“×™×
                                </div>
                                <div id="top-losers" class="space-y-0.5"></div>
                            </div>
                            <div class="bg-white rounded-lg p-2 border border-purple-200 shadow-sm">
                                <div class="text-[11px] font-bold text-purple-600 mb-1 flex items-center gap-1">
                                    <i data-lucide="star" class="w-3 h-3"></i> ×¨××•×™×™× ×œ×§××¤×™×™×Ÿ × ×¤×¨×“
                                </div>
                                <div id="outstanding-list" class="space-y-0.5"></div>
                            </div>
                            <div class="bg-white rounded-lg p-2 border border-blue-200 shadow-sm">
                                <div class="text-[11px] font-bold text-blue-600 mb-1 flex items-center gap-1">
                                    <i data-lucide="calculator" class="w-3 h-3"></i> Break-Even Calculator
                                </div>
                                <div class="text-[10px] space-y-1.5">
                                    <div class="bg-blue-50 rounded p-1.5">
                                        <div class="text-slate-600 mb-0.5 font-medium">×§×œ×™×§×™× ××§×¡×³ ×¢×“ ×”×¤×¡×“:</div>
                                        <div class="font-bold text-blue-700 num-font text-[13px]" id="be-max-clicks">-</div>
                                        <div class="text-[9px] text-slate-400 num-font" id="be-clicks-formula"></div>
                                    </div>
                                    <div class="bg-purple-50 rounded p-1.5">
                                        <div class="text-slate-600 mb-0.5 font-medium">CR ××™× ×™××œ×™ ×œ×¨×•×•×—:</div>
                                        <div class="font-bold text-purple-700 num-font text-[13px]" id="be-min-cr">-</div>
                                        <div class="text-[9px] text-slate-400 num-font" id="be-cr-formula"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="flex-1 p-2.5 min-h-0 flex flex-col">
                    <div class="bg-white rounded-lg border border-gray-200 flex-1 flex flex-col overflow-hidden">
                        <div class="px-3 py-2 border-b border-gray-100 bg-white flex justify-between items-center shrink-0 flex-wrap gap-2">
                            <div class="flex items-center gap-3 flex-wrap">
                                <div class="search-box">
                                    <i data-lucide="search" class="w-3 h-3"></i>
                                    <input type="text" id="search-input" placeholder="×—×¤×© ××–×”×”..." class="text-right">
                                </div>
                                
                                <div class="icloud-switcher">
                                    <div class="switcher-options">
                                        <button type="button" class="switcher-btn" data-value="hide" title="×”×¡×ª×¨ iCloud">ğŸš«</button>
                                        <button type="button" class="switcher-btn active" data-value="all" title="×”×¦×’ ×”×›×œ">âœ“</button>
                                        <button type="button" class="switcher-btn" data-value="only" title="×¨×§ iCloud">â˜ï¸</button>
                                    </div>
                                </div>
                                
                                <div class="agg-switcher" title="××¦×‘ ×ª×¦×•×’×”: MICRO/MACRO">
                                    <div class="switcher-options">
                                        <button type="button" class="switcher-btn active" data-agg="split" title="MICRO - ×›×œ ×©×•×¨×” × ×¤×¨×“×ª">MICRO</button>
                                        <button type="button" class="switcher-btn" data-agg="smart" title="MACRO - × ×ª×•× ×™× ×××•×’×“×™×">MACRO</button>
                                    </div>
                                    <span id="macro-warning" class="hidden text-[10px] bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full font-bold animate-pulse border border-orange-200 shadow-sm">âš ï¸ ×××•×’×“: <span id="macro-count">0</span> | ××¤×•×¦×œ: <span id="micro-count">0</span></span>
                                </div>
                                
                                <div id="show-changes-box" class="hidden flex items-center gap-1 border-l border-slate-200 pl-3">
                                    <label class="flex items-center gap-1 text-[11px] text-blue-600 font-bold cursor-pointer">
                                        <input type="checkbox" id="chk-show-changes" class="chk-input" checked> ×”×¦×’ ×©×™× ×•×™×™×
                                    </label>
                                </div>
                                
                                <div class="flex items-center gap-2">
                                    <span class="text-[11px] font-bold text-slate-400 uppercase">×ª×¦×•×’×”:</span>
                                    <select id="filter-view" class="text-sm bg-slate-50 border border-slate-200 rounded px-2 py-1 font-medium w-40">
                                        <option value="all">×”×›×œ</option>
                                        <option value="relevant">ğŸ¯ Relevant (P+G+Pot)</option>
                                        <option value="relevant_plus">ğŸš€ Relevant+ (incl. Test)</option>
                                        <option value="winners">âœ¨ Winners (P+G)</option>
                                        <option value="pure">ğŸ’ Pure</option>
                                        <option value="gold">ğŸ¥‡ Gold</option>
                                        <option value="potential">ğŸŒ± Potential</option>
                                        <option value="ignore">ğŸ˜ Ignore</option>
                                        <option value="blacklist">ğŸš« Blacklist</option>
                                        <option value="testing">ğŸ”¬ Testing</option>
                                        <option value="custom">ğŸ¯ Custom</option>
                                        <option value="compare-new">âœ¨ ×—×“×©×™×</option>
                                        <option value="compare-improved">ğŸ“ˆ ×”×©×ª×¤×¨×•</option>
                                        <option value="compare-declined">ğŸ“‰ ×™×¨×“×•</option>
                                    </select>
                                </div>

                                <div class="flex items-center gap-2" id="level-filter-box" style="display:none;">
                                    <span class="text-[11px] font-bold text-slate-400 uppercase">×©×›×‘×”:</span>
                                    <select id="level-view" class="text-sm bg-slate-50 border border-slate-200 rounded px-2 py-1 font-medium">
                                        <option value="detail">×¤×™×¨×•×˜ ×‘×œ×‘×“</option>
                                        <option value="all">×”×›×œ (×›×•×œ×œ ×¡×™×›×•××™×)</option>
                                    </select>
                                </div>

                                <div class="flex items-center gap-2 border-r border-slate-200 pr-3">
                                    <span class="text-[11px] font-bold text-slate-400">Min Score:</span>
                                    <input type="number" id="min-score-filter" value="0" step="0.1" class="w-16 text-sm border border-slate-200 rounded px-2 py-1 num-font">
                                </div>

                                <div class="flex items-center gap-2">
                                    <label class="flex items-center gap-1 text-[11px] text-slate-500 font-bold cursor-pointer">
                                        <input type="checkbox" id="chk-copy-cidr" class="chk-input"> CIDR
                                    </label>
                                    <button onclick="copyIPs()" id="btn-copy" class="flex items-center gap-1 bg-white border border-slate-200 text-slate-600 px-2 py-1 rounded hover:bg-slate-50 text-[11px] font-bold">
                                        <i data-lucide="copy" class="w-3 h-3"></i> ×”×¢×ª×§
                                    </button>
                                </div>
                            </div>
                            <div class="text-[11px] text-slate-400 font-medium">
                                ×¡×”"×›: <span id="disp-count" class="font-bold text-slate-800 num-font text-base">0</span>
                            </div>
                        </div>

                        <div class="flex-1 overflow-auto custom-scrollbar bg-white">
                            <table class="w-full text-sm relative">
                                <thead class="bg-slate-50 sticky top-0 z-20">
                                    <tr>
                                        <th class="text-center w-8">#</th>
                                        <th class="text-center w-10" id="th-level" style="display:none;">Lvl</th>
                                        <th class="text-right sortable-th" data-sort="identifier" onclick="sortByColumn('identifier')">××–×”×” <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="category" onclick="sortByColumn('category')">×§×˜×’×•×¨×™×” <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="score" onclick="sortByColumn('score')">Score <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="clicks" onclick="sortByColumn('clicks')">Clicks <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="conv" onclick="sortByColumn('conv')">Conv <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="revenue" onclick="sortByColumn('revenue')">Revenue <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="cost" onclick="sortByColumn('cost')">Cost <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="profit" onclick="sortByColumn('profit')">Profit <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="roi" onclick="sortByColumn('roi')">ROI% <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="cr" onclick="sortByColumn('cr')">CR% <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="ppc" onclick="sortByColumn('ppc')">PPC <span class="sort-icon">â‡…</span></th>
                                    </tr>
                                    <tr id="table-summary-row"></tr>
                                </thead>
                                <tbody id="table-body"></tbody>
                            </table>
                        </div>

                        <div class="p-1.5 border-t border-gray-100 bg-white flex justify-center gap-4 items-center shrink-0">
                            <button onclick="changePage(-1)" class="p-1 hover:bg-gray-100 rounded text-gray-400"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                            <span id="page-num" class="text-[11px] font-bold text-gray-400 num-font">1 / 1</span>
                            <button onclick="changePage(1)" class="p-1 hover:bg-gray-100 rounded text-gray-400"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        document.addEventListener('click', (e) => {
            const insidePopup = e.target.closest('.filter-popup');
            const insideBtn = e.target.closest('.filter-btn');
            const insideFilterItem = e.target.closest('.filter-item');
            if (insidePopup || insideBtn || insideFilterItem) return;
            document.querySelectorAll('.filter-popup').forEach(p => p.classList.remove('show'));
        });
        
        const state = {
            rawData: [], allRows: [], detailRows: [], summaryRows: [], aggregatedData: [], processed: [], filtered: [],
            headers: [], dimensions: {}, activeFilters: [], page: 1, pageSize: 100,
            medianPPC: 0, medianCR: 0, medianROI: 100, campaignCR: 0, clickThreshold: 7000,
            visibleKpis: ['pure', 'gold', 'potential', 'ignore', 'blacklist', 'testing'],
            hasHierarchy: false, levelColumn: null, maxLevel: 1, ipColumn: '',
            customEnabled: false,
            identifierType: 'auto',
            detectedType: null,
            compareMode: false,
            compareData: null,
            compareResults: { new: [], improved: [], declined: [], gone: [] },
            searchQuery: '',
            osColumn: null,
            ispColumn: null,
            extraColumns: [],
            sortColumn: null,
            sortDirection: 'desc',
            icloudFilter: 'all',
            aggMode: 'split',
            rawDetailRows: [],
            processedRaw: null,
            hasActiveAdvancedFilters: false,
            blMode: 'ppc' // NEW: 'ppc' or 'cr'
        };
        
        const ICLOUD_RANGES = ['104.28', '172.226', '172.225', '172.224', '146.75', '140.248'];
        function isIcloudIP(identifier) {
            if (!identifier) return false;
            const str = String(identifier);
            for (const range of ICLOUD_RANGES) { if (str.startsWith(range + '.')) return true; }
            return false;
        }

        const IP_LEVELS = {
            1: { name: 'SubID/IP32', multiplier: 1.5, min: 500, max: 3000, default: 1500 },
            2: { name: 'Zone/IP24', multiplier: 3, min: 2500, max: 10000, default: 7000 },
            3: { name: 'IP16', multiplier: 5, min: 5000, max: 15000, default: 10000 }
        };
        
        const INVALID_PATTERNS = [
            '0.0.0.0', /^0\.0\.0\./,
            '{zone_id}', '{zoneid}', '{zone}',
            '{sub}', '{subid}', '{sub_id}',
            '{click_id}', '{clickid}',
            '×œ× ××–×•×”×”', 'not identified', 'unknown', 'undefined', 'null',
            '(not set)', '(none)', 'n/a', 'na'
        ];
        const $ = id => document.getElementById(id);
        const parseNum = v => { if (typeof v === 'number') return v; if (!v) return 0; return parseFloat(String(v).replace(/[,$%\s]/g, '')) || 0; };
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = String(text ?? '');
            return div.innerHTML;
        }
        
        function highlightSafe(text, query) {
            const raw = String(text ?? '');
            const q = String(query ?? '').trim();
            if (!q) return escapeHtml(raw);
            const re = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            let out = '', last = 0;
            raw.replace(re, (m, offset) => {
                out += escapeHtml(raw.slice(last, offset));
                out += '<mark class="search-highlight">' + escapeHtml(m) + '</mark>';
                last = offset + m.length;
                return m;
            });
            out += escapeHtml(raw.slice(last));
            return out;
        }
        
        function fillSelectWithHeaders(selectEl, headers) {
            selectEl.textContent = '';
            headers.forEach((h, i) => {
                const opt = document.createElement('option');
                opt.value = String(i);
                opt.textContent = String(h ?? '');
                selectEl.appendChild(opt);
            });
        }
        function toggleSection(section) {
            const content = $(section + '-content');
            const icon = $(section + '-icon');
            content.classList.toggle('open');
            icon.classList.toggle('open');
        }

        function isInvalidIdentifier(id) {
            if (!id || id.trim() === '') return true;
            const lower = id.toLowerCase().trim();
            for (const pattern of INVALID_PATTERNS) {
                if (pattern instanceof RegExp) { if (pattern.test(lower)) return true; }
                else { if (lower === pattern.toLowerCase()) return true; }
            }
            if (/^\{.*\}$/.test(lower)) return true;
            return false;
        }
        
        function detectIdentifierType(values) {
            const sample = values.slice(0, 100);
            let ipCount = 0, numericCount = 0, mixedCount = 0;
            for (const val of sample) {
                if (!val || isInvalidIdentifier(val)) continue;
                if (/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}(\/\d{1,2})?$/.test(val)) ipCount++;
                else if (/^\d+$/.test(val)) numericCount++;
                else mixedCount++;
            }
            const total = ipCount + numericCount + mixedCount;
            if (total === 0) return 'unknown';
            if (ipCount / total > 0.5) return 'ip';
            if (numericCount / total > 0.5) {
                const numericValues = sample.filter(v => /^\d+$/.test(v)).map(Number);
                const avgValue = numericValues.reduce((a, b) => a + b, 0) / numericValues.length;
                const maxValue = Math.max(...numericValues);
                if (maxValue > 10000 || avgValue > 1000) return 'subid';
                return 'zone';
            }
            return 'mixed';
        }
        
        function getIdentifierTypeLabel(type) {
            const labels = { 'ip': 'ğŸŒ IP Address', 'zone': 'ğŸ“ Zone ID', 'subid': 'ğŸ¯ SubID', 'mixed': 'ğŸ”€ Mixed', 'unknown': 'â“ Unknown' };
            return labels[type] || type;
        }

        function toCIDR(identifier) {
            const str = String(identifier).trim();
            const ipLevel = parseInt($('ip-level').value);
            if (str.includes('/')) return str;
            if (/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(str)) {
                const parts = str.split('.').map(Number);
                if (ipLevel === 1) return str + '/32';
                if (ipLevel === 2) return parts[0] + '.' + parts[1] + '.' + parts[2] + '.0/24';
                if (ipLevel === 3) return parts[0] + '.' + parts[1] + '.0.0/16';
                return str + '/32';
            }
            return str;
        }

        function calculateClickThreshold() {
            const level = parseInt($('ip-level').value);
            const config = IP_LEVELS[level];
            if (state.campaignCR <= 0 || state.campaignCR < 0.001) {
                state.clickThreshold = config.default;
            } else {
                const crPercent = state.campaignCR * 100;
                let threshold = config.multiplier * (100 / crPercent);
                threshold = Math.max(config.min, Math.min(config.max, threshold));
                state.clickThreshold = Math.round(threshold);
            }
            $('current-threshold').textContent = state.clickThreshold.toLocaleString();
            $('click-threshold').textContent = state.clickThreshold.toLocaleString();
        }

        const dz = $('drop-zone');
        const fi = $('file-input');
        dz.addEventListener('click', () => fi.click());
        fi.addEventListener('change', e => loadFile(e.target.files[0]));
        dz.addEventListener('dragover', e => e.preventDefault());
        dz.addEventListener('drop', e => { e.preventDefault(); loadFile(e.dataTransfer.files[0]); });

        function loadFile(file) {
            if (!file) return;
            const sizeMB = file.size / (1024 * 1024);
            if (sizeMB > 50) { alert('×§×•×‘×¥ ×’×“×•×œ ××“×™ (××¢×œ 50MB). × ×¡×” ×œ×¤×¦×œ ××ª ×”×§×•×‘×¥.'); return; }
            $('filename').innerHTML = '<span class="animate-pulse">â³ ×˜×•×¢×Ÿ ' + escapeHtml(file.name) + ' (' + sizeMB.toFixed(1) + 'MB)...</span>';
            $('global-stats').innerHTML = '<span class="text-amber-500 animate-pulse">ğŸ”„ ××¢×‘×“ × ×ª×•× ×™×...</span>';
            setTimeout(() => {
                const reader = new FileReader();
                reader.onerror = () => { alert('×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥'); $('filename').textContent = ''; };
                reader.onload = e => {
                    try {
                        const wb = XLSX.read(e.target.result, { type: 'array', cellDates: false, cellNF: false, cellStyles: false });
                        const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1, defval: '', raw: true });
                        if (json.length < 2) { alert('×§×•×‘×¥ ×¨×™×§'); $('filename').textContent = ''; return; }
                        state.headers = json[0].map(h => String(h || '').trim());
                        state.rawData = json.slice(1).filter(row => row.some(c => c !== '' && c != null));
                        $('filename').textContent = file.name + ' (' + state.rawData.length.toLocaleString() + ' ×©×•×¨×•×ª)';
                        const hLower = state.headers.map(h => h.toLowerCase());
                        const levelIdx = hLower.findIndex(x => x === 'level' || x === 'lvl' || x === 'depth');
                        state.levelColumn = levelIdx !== -1 ? state.headers[levelIdx] : null;
                        state.hasHierarchy = levelIdx !== -1;
                        setupMapping();
                        setupFilters();
                        setTimeout(() => processData(), 10);
                    } catch (err) {
                        console.error('Error processing file:', err);
                        alert('×©×’×™××” ×‘×¢×™×‘×•×“ ×”×§×•×‘×¥: ' + err.message);
                        $('filename').textContent = '';
                        $('global-stats').innerHTML = '<span class="text-red-500">×©×’×™××” ×‘×˜×¢×™× ×”</span>';
                    }
                };
                reader.readAsArrayBuffer(file);
            }, 50);
        }

        function setupMapping() {
            const ipSel = $('col-ip');
            fillSelectWithHeaders(ipSel, state.headers);
            const hLower = state.headers.map(h => h.toLowerCase());
            const subidPatterns = ['subid', 'sub_id', 'sub id', 'token 3', 'token3'];
            const zonePatterns = ['zone', 'zone_id', 'zoneid', 'token 4', 'token4'];
            const ipPatterns = ['ip', 'ip address', 'ip_address', 'range', 'identifier'];
            
            let matchIdx = hLower.findIndex(h => subidPatterns.some(p => h.includes(p)));
            if (matchIdx < 0) matchIdx = hLower.findIndex(h => zonePatterns.some(p => h.includes(p)));
            if (matchIdx < 0) matchIdx = hLower.findIndex(h => ipPatterns.some(p => h.includes(p)));
            if (matchIdx >= 0) ipSel.value = matchIdx;

            const selects = ['col-clicks', 'col-conv', 'col-rev', 'col-cost'];
            const defaults = { 'col-clicks': ['clicks', 'click', 'impressions'], 'col-conv': ['conv', 'conversions', 'conversion', 'leads'], 'col-rev': ['revenue', 'rev', 'income', 'payout'], 'col-cost': ['cost', 'spend', 'expense'] };
            selects.forEach(id => {
                const sel = $(id);
                fillSelectWithHeaders(sel, state.headers);
                const matchIdx = hLower.findIndex(h => defaults[id].some(k => h.includes(k)));
                if (matchIdx >= 0) sel.value = matchIdx;
            });
            
            state.ipColumn = state.headers[+$('col-ip').value];
            $('mapping-box').classList.remove('hidden');
            $('medians-box').classList.remove('hidden');
            state.extraColumns = [];
            const osPatterns = ['os', 'operating system', 'device os', 'platform'];
            const ispPatterns = ['isp', 'carrier', 'network', 'provider'];
            const browserPatterns = ['browser', 'user agent'];
            const countryPatterns = ['country', 'geo', 'region'];
            
            const osIdx = hLower.findIndex(h => osPatterns.some(p => h.includes(p)));
            const ispIdx = hLower.findIndex(h => ispPatterns.some(p => h.includes(p)));
            const browserIdx = hLower.findIndex(h => browserPatterns.some(p => h.includes(p)));
            const countryIdx = hLower.findIndex(h => countryPatterns.some(p => h === p || h.includes(p)));
            
            if (osIdx >= 0) { state.osColumn = osIdx; state.extraColumns.push(state.headers[osIdx]); }
            if (ispIdx >= 0) { state.ispColumn = ispIdx; state.extraColumns.push(state.headers[ispIdx]); }
            if (browserIdx >= 0 && state.extraColumns.length < 2) state.extraColumns.push(state.headers[browserIdx]);
            if (countryIdx >= 0 && state.extraColumns.length < 2) state.extraColumns.push(state.headers[countryIdx]);

            detectAndUpdateIdentifierType();
            if (state.hasHierarchy) {
                $('hierarchy-box').classList.remove('hidden');
                $('level-filter-box').style.display = 'flex';
                $('th-level').style.display = '';
            } else {
                $('hierarchy-box').classList.add('hidden');
                $('level-filter-box').style.display = 'none';
                $('th-level').style.display = 'none';
            }
        }
        
        function detectAndUpdateIdentifierType() {
            const ipColIdx = +$('col-ip').value;
            const colName = state.headers[ipColIdx] || '';
            const identifierValues = state.rawData.map(row => String(row[ipColIdx] || '').trim());
            state.detectedType = detectIdentifierType(identifierValues);
            const colLower = colName.toLowerCase();
            let nameHint = null;
            if (colLower.includes('subid') || colLower.includes('sub_id') || colLower.includes('token 3') || colLower.includes('token3')) nameHint = 'subid';
            else if (colLower.includes('zone') || colLower.includes('token 4') || colLower.includes('token4')) nameHint = 'zone';
            else if (colLower.includes('ip')) nameHint = 'ip';
            const finalType = nameHint || state.detectedType;
            const detectedEl = $('detected-type');
            if (finalType && finalType !== 'unknown') {
                detectedEl.innerHTML = 'âœ“ ×–×•×”×”: ' + getIdentifierTypeLabel(finalType) + ' <span class="text-slate-400">(' + escapeHtml(colName) + ')</span>';
                detectedEl.classList.remove('hidden');
                if ($('identifier-type').value === 'auto') {
                    if (finalType === 'subid') $('ip-level').value = '1';
                    else if (finalType === 'zone') $('ip-level').value = '2';
                    else if (finalType === 'ip') {
                        const hasSlash24 = identifierValues.some(v => v.endsWith('.0') || v.includes('/24'));
                        $('ip-level').value = hasSlash24 ? '2' : '1';
                    }
                }
            } else { detectedEl.classList.add('hidden'); }
            state.ipColumn = colName;
        }

        function setupFilters() {
            state.dimensions = {};
            const skip = ['clicks', 'conversions', 'revenue', 'cost', 'profit', 'roi', 'cr', 'epc', 'cpc', 'level'];
            state.headers.forEach((h, idx) => {
                if (skip.some(s => h.toLowerCase().includes(s))) return;
                const vals = new Set();
                state.rawData.forEach(row => { const v = row[idx]; if (v !== undefined && v !== null && String(v).trim() !== '') vals.add(String(v).trim()); });
                if (vals.size > 0 && vals.size < 500) state.dimensions[h] = [...vals].sort();
            });
            const colSel = $('col-selector');
            colSel.textContent = '';
            const defaultOpt = document.createElement('option');
            defaultOpt.value = '';
            defaultOpt.textContent = '×‘×—×¨ ×¢××•×“×”...';
            colSel.appendChild(defaultOpt);
            Object.keys(state.dimensions).forEach(h => {
                const opt = document.createElement('option');
                opt.value = h;
                opt.textContent = h;
                colSel.appendChild(opt);
            });
            $('filter-msg').classList.add('hidden');
            $('btn-add-filter').classList.remove('hidden');
            state.activeFilters = [];
            $('filters-list').innerHTML = '';
        }

        function showAddFilterMenu() {
            if (state.activeFilters.length >= 4) return alert("××§×¡×™××•× 4 ××¡× × ×™×");
            $('btn-add-filter').classList.add('hidden');
            $('col-selector').classList.remove('hidden');
            $('col-selector').value = "";
        }

        function createNewFilter(col) {
            if (!col) { $('col-selector').classList.add('hidden'); $('btn-add-filter').classList.remove('hidden'); return; }
            const fid = Date.now();
            const div = document.createElement('div');
            div.className = 'filter-item';
            div.id = 'f-' + fid;
            div.innerHTML = '<div class="filter-header"><span>' + escapeHtml(col) + '</span><i data-lucide="x" class="w-3 h-3 cursor-pointer text-red-400 hover:text-red-600" onclick="removeFilter(' + fid + ')"></i></div><div class="filter-btn" onclick="togglePopup(' + fid + ')"><span id="l-' + fid + '">(×”×›×œ)</span><i data-lucide="chevron-down" class="w-3 h-3"></i></div><div class="filter-popup" id="p-' + fid + '"><input type="text" class="filter-search" placeholder="×—×¤×©..." oninput="filterOpts(' + fid + ', this.value)"><div class="filter-list custom-scrollbar" id="lst-' + fid + '"></div><div class="flex justify-between mt-2"><div class="btn-tiny btn-cancel" onclick="togglePopup(' + fid + ')">×¡×’×•×¨</div><div class="btn-tiny btn-apply" onclick="applyFilterSelection(' + fid + ')">×”×—×œ</div></div></div>';
            $('filters-list').appendChild(div);
            lucide.createIcons();
            const lst = $('lst-' + fid);
            (state.dimensions[col] || []).forEach(v => {
                const optDiv = document.createElement('div');
                optDiv.className = 'filter-opt';
                const chk = document.createElement('input');
                chk.type = 'checkbox'; chk.className = 'chk-input'; chk.value = v;
                const span = document.createElement('span');
                span.textContent = v;
                optDiv.appendChild(chk); optDiv.appendChild(span);
                lst.appendChild(optDiv);
            });
            state.activeFilters.push({ id: fid, col, colIdx: state.headers.indexOf(col), values: [] });
            $('col-selector').classList.add('hidden');
            if (state.activeFilters.length < 4) $('btn-add-filter').classList.remove('hidden');
        }

        function removeFilter(fid) { $('f-' + fid).remove(); state.activeFilters = state.activeFilters.filter(f => f.id !== fid); $('btn-add-filter').classList.remove('hidden'); processData(); }
        function togglePopup(fid) { const el = $('p-' + fid); const isOpen = el.classList.contains('show'); document.querySelectorAll('.filter-popup').forEach(p => p.classList.remove('show')); if (!isOpen) el.classList.add('show'); }
        function filterOpts(fid, txt) { const term = txt.toLowerCase(); const opts = $('lst-' + fid).children; for (let o of opts) o.style.display = o.innerText.toLowerCase().includes(term) ? 'flex' : 'none'; }
        function applyFilterSelection(fid) {
            const lst = $('lst-' + fid);
            const vals = Array.from(lst.querySelectorAll('input:checked')).map(c => c.value);
            const f = state.activeFilters.find(x => x.id === fid);
            f.values = vals;
            const lbl = $('l-' + fid);
            lbl.innerText = vals.length ? vals.length + ' × ×‘×—×¨×•' : '(×”×›×œ)';
            lbl.className = vals.length ? 'text-blue-600 font-bold' : '';
            togglePopup(fid);
            processData(); 
        }

        function processData() {
            try {
                if (state.compareMode) {
                    state.compareMode = false;
                    state.compareData = null;
                    state.compareResults = { new: [], improved: [], declined: [], gone: [] };
                    $('compare-panel').classList.add('hidden');
                    $('btn-clear-compare').classList.add('hidden');
                    $('show-changes-box').classList.add('hidden');
                }
                
                $('global-stats').innerHTML = '<span class="text-amber-500">ğŸ”„ ××¢×‘×“ ' + state.rawData.length.toLocaleString() + ' ×©×•×¨×•×ª...</span>';
                const cols = { ip: +$('col-ip').value, clicks: +$('col-clicks').value, conv: +$('col-conv').value, rev: +$('col-rev').value, cost: +$('col-cost').value };
                state.ipColumn = state.headers[cols.ip];
                const levelIdx = state.levelColumn ? state.headers.indexOf(state.levelColumn) : -1;
                const extraColIndices = {};
                state.extraColumns.forEach(col => { extraColIndices[col] = state.headers.indexOf(col); });

                state.allRows = state.rawData.map((row, idx) => {
                    const level = levelIdx >= 0 ? parseNum(row[levelIdx]) : 1;
                    const extraData = {};
                    state.extraColumns.forEach(col => { const colIdx = extraColIndices[col]; if (colIdx >= 0) extraData[col] = String(row[colIdx] || '').trim(); });
                    return { idx, raw: row, identifier: String(row[cols.ip] || '').trim(), level, clicks: parseNum(row[cols.clicks]), conv: parseNum(row[cols.conv]), rev: parseNum(row[cols.rev]), cost: parseNum(row[cols.cost]), profit: parseNum(row[cols.rev]) - parseNum(row[cols.cost]), extraData };
                });

                if (state.hasHierarchy) {
                    let maxLvl = 1;
                    const levelSet = new Set();
                    for (let i = 0; i < state.allRows.length; i++) {
                        const lvl = state.allRows[i].level;
                        if (lvl > maxLvl) maxLvl = lvl;
                        levelSet.add(lvl);
                    }
                    state.maxLevel = maxLvl;
                    const levels = [...levelSet].sort((a, b) => a - b);
                    $('level-badges').innerHTML = levels.map(l => '<span class="level-badge level-' + Math.min(l, 3) + '">' + l + '</span>').join('');
                }

                state.customEnabled = $('custom-enabled').checked;
                $('custom-badge').classList.toggle('hidden', !state.customEnabled);
                processFullPipeline();
            } catch (err) {
                console.error('Error in processData:', err);
                $('global-stats').innerHTML = '<span class="text-red-500">âŒ ×©×’×™××”: ' + err.message + '</span>';
                alert('×©×’×™××” ×‘×¢×™×‘×•×“: ' + err.message);
            }
        }

        function calculateScore(r, medianPPC, medianCR, medianROI) {
            if (r.conv === 0) return 0;
            if (r.ppc <= 0) return 0;
            if (r.profit <= 0) return 0;
            if (medianPPC <= 0 || medianCR <= 0) return 0;
            const roiMed = medianROI > 0 ? medianROI : 100;
            const ppcComponent = 0.5 * (r.ppc / medianPPC);
            const roiComponent = 0.3 * (r.roi / roiMed);
            const crComponent = 0.2 * (r.cr / medianCR);
            const quality = ppcComponent + roiComponent + crComponent;
            const reliability = Math.min(r.conv / 10, 1.0);
            return quality * reliability;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // UPDATED BLACKLIST LOGIC
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function classifyRanges(data, medianPPC, medianCR, campaignAvgCR, campaignAvgPPC, totalCost, totalProfit, medianROI) {
            const purePct = +$('pure-pct-num').value || 10;
            const goldPct = +$('gold-pct-num').value || 25;
            const clickThreshold = state.clickThreshold;
            const medROI = medianROI || state.medianROI || 100;
            const blMode = state.blMode; // 'ppc' or 'cr'

            const custConvMin = parseFloat($('cust-conv-min').value) || 0;
            const custConvMax = $('cust-conv-max').value !== '' ? parseFloat($('cust-conv-max').value) : Infinity;
            const custScoreMin = parseFloat($('cust-score-min').value) || 0;
            const custScoreMax = $('cust-score-max').value !== '' ? parseFloat($('cust-score-max').value) : Infinity;
            const custClicksMin = parseFloat($('cust-clicks-min').value) || 0;
            const custClicksMax = $('cust-clicks-max').value !== '' ? parseFloat($('cust-clicks-max').value) : Infinity;
            const custRoiMin = parseFloat($('cust-roi-min').value) || -9999;
            const custRoiMax = $('cust-roi-max').value !== '' ? parseFloat($('cust-roi-max').value) : Infinity;
            const custCrMin = parseFloat($('cust-cr-min').value) || 0;
            const custCrMax = $('cust-cr-max').value !== '' ? parseFloat($('cust-cr-max').value) : Infinity;
            const custPpcMin = parseFloat($('cust-ppc-min').value) || 0;
            const custPpcMax = $('cust-ppc-max').value !== '' ? parseFloat($('cust-ppc-max').value) : Infinity;

            data = data.map(r => ({ ...r, score: calculateScore(r, medianPPC, medianCR, medROI) }));

            function percentileThreshold(pool, pct) {
                if (!pool.length) return Infinity;
                const idx = Math.max(0, Math.min(pool.length - 1, Math.ceil(pool.length * pct / 100) - 1));
                return pool[idx].score;
            }
            
            const purePool = data.filter(r => r.conv >= 3 && r.profit > 0).sort((a, b) => b.score - a.score);
            const goldPool = data.filter(r => r.conv >= 2 && r.profit > 0).sort((a, b) => b.score - a.score);
            const pureThreshold = percentileThreshold(purePool, purePct);
            const goldThreshold = percentileThreshold(goldPool, goldPct);

            const campaignAvgROI = totalCost > 0 ? (totalProfit / totalCost * 100) : 0;

            return data.map(r => {
                let category, action;
                const hasEnoughClicks = r.clicks >= clickThreshold;
                
                // --- NEW BL LOGIC ---
                // Always BL: zero conversions with enough clicks, or negative profit with enough clicks
                const blCond1_ZeroConv = r.conv === 0;
                const blCond2_NegProfit = r.profit < 0;
                
                // Mode-based BL condition: PPC or CR below 50% of campaign average
                let blCond3_PoorPerformance = false;
                if (r.conv > 0) {
                    if (blMode === 'ppc') {
                        // PPC mode: blacklist if PPC < 50% of campaign average PPC
                        blCond3_PoorPerformance = r.ppc < (campaignAvgPPC * 0.5);
                    } else {
                        // CR mode: blacklist if CR < 50% of campaign average CR
                        blCond3_PoorPerformance = r.cr < (campaignAvgCR * 0.5);
                    }
                }
                
                const isBlacklist = hasEnoughClicks && (blCond1_ZeroConv || blCond2_NegProfit || blCond3_PoorPerformance);
                const isTesting = r.conv === 0 && r.clicks < clickThreshold;

                const crPercent = r.cr * 100;
                const matchesCustom = state.customEnabled &&
                    r.conv >= custConvMin && r.conv <= custConvMax &&
                    r.score >= custScoreMin && r.score <= custScoreMax &&
                    r.clicks >= custClicksMin && r.clicks <= custClicksMax &&
                    r.roi >= custRoiMin && r.roi <= custRoiMax &&
                    crPercent >= custCrMin && crPercent <= custCrMax &&
                    r.ppc >= custPpcMin && r.ppc <= custPpcMax;

                if (isBlacklist) { category = 'blacklist'; action = 'Block'; }
                else if (isTesting) { category = 'testing'; action = 'Wait'; }
                else if (matchesCustom) { category = 'custom'; action = 'Custom'; }
                else if (r.conv >= 3 && r.profit > 0 && r.score >= pureThreshold) { category = 'pure'; action = 'Bid +30%'; }
                else if (r.conv >= 2 && r.profit > 0 && r.score >= goldThreshold) { category = 'gold'; action = 'Bid +15%'; }
                else if (r.conv >= 1 && r.profit > 0) { category = 'potential'; action = 'Bid +5-10%'; }
                else { category = 'ignore'; action = 'RON'; }

                return { ...r, category, action, matchesCustom, isBlacklist, isTesting, blReason: isBlacklist ? (blCond1_ZeroConv ? 'zero_conv' : blCond2_NegProfit ? 'neg_profit' : 'poor_' + blMode) : null };
            });
        }

        function processFullPipeline() {
            let filteredRows = state.allRows.filter(r => {
                for (const f of state.activeFilters) { 
                    if (f.values.length > 0) { const val = String(r.raw[f.colIdx] || ''); if (!f.values.includes(val)) return false; } 
                }
                if (state.icloudFilter === 'hide' && isIcloudIP(r.identifier)) return false;
                if (state.icloudFilter === 'only' && !isIcloudIP(r.identifier)) return false;
                return true;
            });

            if (state.hasHierarchy) {
                state.detailRows = filteredRows.filter(r => r.level === state.maxLevel);
                state.summaryRows = filteredRows.filter(r => r.level < state.maxLevel);
            } else {
                state.detailRows = filteredRows.filter(r => r.identifier !== '');
                state.summaryRows = [];
            }
            state.detailRows = state.detailRows.filter(r => !isInvalidIdentifier(r.identifier));

            state.rawDetailRows = state.detailRows.map(r => ({
                ...r, identifier: r.identifier || 'Unknown',
                roi: r.cost > 0 ? (r.profit / r.cost) * 100 : (r.profit > 0 ? 999 : 0),
                cr: r.clicks > 0 ? r.conv / r.clicks : 0,
                ppc: r.clicks > 0 ? r.profit / r.clicks : 0
            }));
            
            const getAggKey = (r) => {
                let keyParts = [r.identifier || 'Unknown'];
                state.activeFilters.forEach(f => { if (f.values.length > 0) { keyParts.push(f.colIdx + ':' + String(r.raw[f.colIdx] || '').trim()); } });
                return keyParts.join('|');
            };
            
            const grouped = {};
            state.detailRows.forEach(r => {
                const key = getAggKey(r);
                if (!grouped[key]) {
                    grouped[key] = { identifier: r.identifier || 'Unknown', level: r.level, clicks: 0, conv: 0, rev: 0, cost: 0, profit: 0, isSummary: false, extraData: { ...r.extraData }, _extraSets: {}, _rowCount: 0 };
                    state.extraColumns.forEach(col => { grouped[key]._extraSets[col] = new Set(); if (r.extraData && r.extraData[col]) grouped[key]._extraSets[col].add(r.extraData[col]); });
                } else {
                    state.extraColumns.forEach(col => { if (r.extraData && r.extraData[col]) grouped[key]._extraSets[col].add(r.extraData[col]); });
                }
                const g = grouped[key];
                g.clicks += r.clicks; g.conv += r.conv; g.rev += r.rev; g.cost += r.cost; g.profit += r.profit; g._rowCount++;
            });
            
            state.aggregatedData = Object.values(grouped).map(g => {
                const finalExtraData = { ...g.extraData };
                state.extraColumns.forEach(col => { if (g._extraSets[col] && g._extraSets[col].size > 1) finalExtraData[col] = '××¢×•×¨×‘ (' + g._extraSets[col].size + ')'; });
                return { ...g, extraData: finalExtraData, roi: g.cost > 0 ? (g.profit / g.cost) * 100 : (g.profit > 0 ? 999 : 0), cr: g.clicks > 0 ? g.conv / g.clicks : 0, ppc: g.clicks > 0 ? g.profit / g.clicks : 0 };
            });

            const totalClicks = state.aggregatedData.reduce((s, r) => s + r.clicks, 0);
            const totalConv = state.aggregatedData.reduce((s, r) => s + r.conv, 0);
            const totalProfit = state.aggregatedData.reduce((s, r) => s + r.profit, 0);
            const totalCost = state.aggregatedData.reduce((s, r) => s + r.cost, 0);
            const campaignAvgCR = totalClicks > 0 ? totalConv / totalClicks : 0;
            const campaignAvgPPC = totalClicks > 0 ? totalProfit / totalClicks : 0;

            const profitable = state.aggregatedData.filter(r => r.conv > 0 && r.ppc > 0);
            let medianPPC = 0.001, medianCR = 0.001, medianROI = 100;
            if (profitable.length > 0) {
                const ppcs = profitable.map(r => r.ppc).sort((a, b) => a - b);
                const crs = profitable.map(r => r.cr).sort((a, b) => a - b);
                const rois = profitable.filter(r => r.cost > 0 && r.roi > 0).map(r => Math.min(r.roi, 300)).sort((a, b) => a - b);
                medianPPC = ppcs[Math.floor(ppcs.length / 2)];
                medianCR = crs[Math.floor(crs.length / 2)];
                medianROI = rois.length > 0 ? rois[Math.floor(rois.length / 2)] : 100;
            }
            
            state.medianPPC = medianPPC;
            state.medianCR = medianCR;
            state.medianROI = medianROI;
            state.campaignCR = campaignAvgCR;
            state.campaignAvgPPC = campaignAvgPPC; // Store for display
            $('med-ppc').textContent = '$' + state.medianPPC.toFixed(4);
            $('med-cr').textContent = (state.medianCR * 100).toFixed(3) + '%';
            calculateClickThreshold();

            state.processed = classifyRanges(state.aggregatedData, medianPPC, medianCR, campaignAvgCR, campaignAvgPPC, totalCost, totalProfit, medianROI);
            state.processedRaw = null;

            applyViewFilter();
            renderKPIs();
            renderTable();
            renderGlobalStats();
            updateMiniDashboard();
            enableCompareButton();
            updateMacroWarning();
        }
        
        function applyViewFilter() {
            const view = $('filter-view').value;
            const levelView = $('level-view').value;
            const minScore = parseFloat($('min-score-filter').value) || 0;
            
            if (state.aggMode === 'split' && !state.processedRaw && state.rawDetailRows.length > 0) {
                const rawClicks = state.rawDetailRows.reduce((s, r) => s + r.clicks, 0);
                const rawConv = state.rawDetailRows.reduce((s, r) => s + r.conv, 0);
                const rawCost = state.rawDetailRows.reduce((s, r) => s + r.cost, 0);
                const rawProfit = state.rawDetailRows.reduce((s, r) => s + r.profit, 0);
                const rawCampaignAvgCR = rawClicks > 0 ? (rawConv / rawClicks) : 0;
                const rawCampaignAvgPPC = rawClicks > 0 ? (rawProfit / rawClicks) : 0;
                state.processedRaw = classifyRanges(state.rawDetailRows, state.medianPPC, state.medianCR, rawCampaignAvgCR, rawCampaignAvgPPC, rawCost, rawProfit, state.medianROI);
                
                if (state.compareMode && state.compareData) {
                    state.processedRaw.forEach(r => {
                        const old = state.compareData.get(r.identifier);
                        if (!old) { r.compareStatus = 'new'; r.profitChange = 0; }
                        else {
                            const profitChange = old.profit - r.profit;
                            r.profitChange = profitChange; r.oldProfit = old.profit; r.oldRoi = old.roi; r.oldCr = old.cr;
                            if (profitChange > 0.5) r.compareStatus = 'improved';
                            else if (profitChange < -0.5) r.compareStatus = 'declined';
                            else r.compareStatus = 'same';
                        }
                    });
                }
            }
            
            const sourceData = state.aggMode === 'split' ? state.processedRaw : state.processed;
            let finalData = [...(sourceData || [])];

            if (levelView === 'all' && state.hasHierarchy) {
                const summaries = state.summaryRows.map(r => ({
                    ...r, identifier: r.identifier || buildIdentifier(r),
                    roi: r.cost > 0 ? (r.profit / r.cost) * 100 : 0, cr: r.clicks > 0 ? r.conv / r.clicks : 0,
                    ppc: r.clicks > 0 ? r.profit / r.clicks : 0,
                    score: 0, category: 'summary', action: '-', isSummary: true
                }));
                finalData = [...summaries, ...finalData];
            }

            if (view === 'winners') finalData = finalData.filter(r => ['pure', 'gold'].includes(r.category));
            else if (view === 'relevant') finalData = finalData.filter(r => ['pure', 'gold', 'potential'].includes(r.category));
            else if (view === 'relevant_plus') finalData = finalData.filter(r => ['pure', 'gold', 'potential', 'testing'].includes(r.category));
            else if (view === 'custom') finalData = finalData.filter(r => r.matchesCustom);
            else if (view === 'compare-new') finalData = finalData.filter(r => r.compareStatus === 'new');
            else if (view === 'compare-improved') finalData = finalData.filter(r => r.compareStatus === 'improved');
            else if (view === 'compare-declined') finalData = finalData.filter(r => r.compareStatus === 'declined');
            else if (view !== 'all') finalData = finalData.filter(r => r.category === view);
            
            if (minScore > 0) finalData = finalData.filter(r => r.score >= minScore || r.isSummary);
            if (state.icloudFilter === 'hide') finalData = finalData.filter(r => !isIcloudIP(r.identifier));
            else if (state.icloudFilter === 'only') finalData = finalData.filter(r => isIcloudIP(r.identifier));
            if (state.searchQuery) finalData = finalData.filter(r => r.identifier.toLowerCase().includes(state.searchQuery));
            
            state.filtered = finalData.sort((a, b) => {
                if (a.isSummary && !b.isSummary) return -1;
                if (!a.isSummary && b.isSummary) return 1;
                if (a.isSummary && b.isSummary) return a.level - b.level;
                if (state.sortColumn) {
                    let valA, valB;
                    switch (state.sortColumn) {
                        case 'identifier': valA = a.identifier; valB = b.identifier; break;
                        case 'category': valA = a.category; valB = b.category; break;
                        case 'score': valA = a.score; valB = b.score; break;
                        case 'clicks': valA = a.clicks; valB = b.clicks; break;
                        case 'conv': valA = a.conv; valB = b.conv; break;
                        case 'revenue': valA = a.rev; valB = b.rev; break;
                        case 'cost': valA = a.cost; valB = b.cost; break;
                        case 'profit': valA = a.profit; valB = b.profit; break;
                        case 'roi': valA = a.roi; valB = b.roi; break;
                        case 'cr': valA = a.cr; valB = b.cr; break;
                        case 'ppc': valA = a.ppc; valB = b.ppc; break;
                        default: valA = a.score; valB = b.score;
                    }
                    if (typeof valA === 'string') { const cmp = valA.localeCompare(valB); return state.sortDirection === 'asc' ? cmp : -cmp; }
                    return state.sortDirection === 'asc' ? valA - valB : valB - valA;
                }
                return b.score - a.score;
            });
            state.page = 1;
        }
        
        function applyFilter() {
            applyViewFilter();
            renderKPIs();
            renderTable();
            renderGlobalStats();
            updateMiniDashboard();
            updateMacroWarning();
        }
        
        function updateMacroWarning() {
            const warningEl = $('macro-warning');
            if (!warningEl) return;
            const microCount = state.rawDetailRows ? state.rawDetailRows.length : 0;
            const macroCount = state.processed ? state.processed.length : 0;
            const microCountEl = $('micro-count');
            const macroCountEl = $('macro-count');
            if (microCountEl) microCountEl.textContent = microCount.toLocaleString();
            if (macroCountEl) macroCountEl.textContent = macroCount.toLocaleString();
            warningEl.classList.toggle('hidden', state.aggMode !== 'smart');
        }
        
        function sortByColumn(column) {
            if (state.sortColumn === column) state.sortDirection = state.sortDirection === 'desc' ? 'asc' : 'desc';
            else { state.sortColumn = column; state.sortDirection = 'desc'; }
            applyFilter();
        }
        
        function updateSortIndicators() {
            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sort === state.sortColumn) th.classList.add(state.sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
            });
        }

        function buildIdentifier(row) {
            const parts = [];
            const skip = ['level', 'clicks', 'conversions', 'revenue', 'cost', 'profit', 'roi', 'cr'];
            for (let i = 0; i < state.headers.length; i++) {
                const h = state.headers[i].toLowerCase();
                if (skip.some(s => h.includes(s))) continue;
                const val = row.raw[i];
                if (val && String(val).trim() !== '') parts.push(String(val).trim());
            }
            return parts.join(' | ') || 'Unknown';
        }

        $('filter-view').addEventListener('change', () => { applyFilter(); });
        $('level-view').addEventListener('change', () => { applyFilter(); });
        $('min-score-filter').addEventListener('input', () => { applyFilter(); });
        
        document.querySelectorAll('.icloud-switcher .switcher-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.icloud-switcher .switcher-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.icloudFilter = btn.dataset.value;
                applyFilter();
            });
        });
        
        document.querySelectorAll('.agg-switcher .switcher-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const newMode = btn.dataset.agg;
                if (state.aggMode === newMode) return;
                document.querySelectorAll('.agg-switcher .switcher-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                state.aggMode = newMode;
                updateMacroWarning();
                if (newMode === 'smart') state.processedRaw = null;
                applyFilter();
            });
        });
        
        $('ip-level').addEventListener('change', () => { processData(); });
        $('identifier-type').addEventListener('change', () => { 
            state.identifierType = $('identifier-type').value;
            if (state.identifierType !== 'auto') {
                if (state.identifierType === 'subid') $('ip-level').value = '1';
                else if (state.identifierType === 'zone') $('ip-level').value = '2';
                else if (state.identifierType === 'ip') $('ip-level').value = '1';
            }
            processData(); 
        });
        $('col-ip').addEventListener('change', () => { detectAndUpdateIdentifierType(); processData(); });
        $('custom-enabled').addEventListener('change', () => { processData(); });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BL MODE SWITCHER HANDLER (on KPI card)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function setBlMode(mode) {
            state.blMode = mode;
            // Update button states
            document.querySelectorAll('.bl-mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.blmode === mode);
            });
            // Reprocess
            state.processedRaw = null;
            processFullPipeline();
        }

        function renderKPIs() {
            const sourceData = state.aggMode === 'split' ? (state.processedRaw || []) : (state.processed || []);
            
            const categories = [
                { key: 'pure', name: 'PURE', icon: 'ğŸ’', cls: 'kpi-pure' },
                { key: 'gold', name: 'GOLD', icon: 'ğŸ¥‡', cls: 'kpi-gold' },
                { key: 'potential', name: 'POTENTIAL', icon: 'ğŸŒ±', cls: 'kpi-potential' },
                { key: 'ignore', name: 'IGNORE', icon: 'ğŸ˜', cls: 'kpi-ignore' },
                { key: 'blacklist', name: 'BLACKLIST', icon: 'ğŸš«', cls: 'kpi-blacklist' },
                { key: 'testing', name: state.customEnabled ? 'CUSTOM' : 'TESTING', icon: state.customEnabled ? 'ğŸ¯' : 'ğŸ”¬', cls: 'kpi-testing' }
            ];
            let html = '';
            categories.forEach(cat => {
                let rows;
                if (cat.key === 'testing' && state.customEnabled) rows = sourceData.filter(r => r.matchesCustom);
                else rows = sourceData.filter(r => r.category === cat.key);

                const s = { count: rows.length, clicks: rows.reduce((sum, r) => sum + r.clicks, 0), conv: rows.reduce((sum, r) => sum + r.conv, 0), rev: rows.reduce((sum, r) => sum + r.rev, 0), cost: rows.reduce((sum, r) => sum + r.cost, 0), profit: rows.reduce((sum, r) => sum + r.profit, 0) };
                s.roi = s.cost > 0 ? (s.profit / s.cost * 100) : (s.profit > 0 ? 999 : 0);
                s.cr = s.clicks > 0 ? (s.conv / s.clicks * 100) : 0;
                s.ppc = s.clicks > 0 ? (s.profit / s.clicks) : 0;
                const isCustomActive = cat.key === 'testing' && state.customEnabled;
                
                // BL switcher - only on the blacklist KPI card
                let blSwitcherHtml = '';
                if (cat.key === 'blacklist') {
                    const ppcActive = state.blMode === 'ppc' ? 'active' : '';
                    const crActive = state.blMode === 'cr' ? 'active' : '';
                    
                    // Show current threshold info
                    const avgPPC = state.campaignAvgPPC || 0;
                    const avgCR = state.campaignCR || 0;
                    const thresholdVal = state.blMode === 'ppc' 
                        ? 'PPC < $' + (avgPPC * 0.5).toFixed(4)
                        : 'CR < ' + (avgCR * 50).toFixed(3) + '%';
                    
                    blSwitcherHtml = '<div class="flex items-center justify-between mt-1 pt-1 border-t border-red-200">' +
                        '<div class="bl-mode-switcher">' +
                        '<button class="bl-mode-btn ' + ppcActive + '" data-blmode="ppc" onclick="event.stopPropagation(); setBlMode(\'ppc\')" title="×—×¡×•× ×œ×¤×™ PPC × ××•×š ×-50% ××”×××•×¦×¢">PPC</button>' +
                        '<button class="bl-mode-btn ' + crActive + '" data-blmode="cr" onclick="event.stopPropagation(); setBlMode(\'cr\')" title="×—×¡×•× ×œ×¤×™ CR × ××•×š ×-50% ××”×××•×¦×¢">CR</button>' +
                        '</div>' +
                        '<span class="text-[9px] text-red-400 num-font font-bold">' + thresholdVal + '</span>' +
                        '</div>';
                }

                html += '<div class="kpi-card ' + cat.cls + (isCustomActive ? ' custom-active' : '') + '">' +
                    '<div class="flex justify-between items-center mb-1">' +
                    '<div class="flex items-center gap-1"><span class="text-lg">' + cat.icon + '</span><span class="text-[11px] font-black uppercase">' + cat.name + '</span></div>' +
                    '<div class="text-xl font-black num-font text-slate-800">' + s.count.toLocaleString() + '</div>' +
                    '</div>' +
                    '<div class="bg-slate-100 border border-slate-200 rounded px-2 py-1 flex justify-between items-center mb-1">' +
                    '<div class="text-center flex-1"><div class="stat-lbl">Clicks</div><div class="stat-val text-[12px]">' + formatNum(s.clicks) + '</div></div>' +
                    '<div class="text-center flex-1 border-r border-slate-200"><div class="stat-lbl">PPC</div><div class="stat-val text-[12px]">$' + s.ppc.toFixed(4) + '</div></div>' +
                    '</div>' +
                    '<div class="grid grid-cols-3 gap-0.5 text-center mb-1 border-b border-slate-100 pb-1">' +
                    '<div><div class="stat-lbl">Conv</div><div class="stat-val text-[12px]">' + s.conv.toLocaleString() + '</div></div>' +
                    '<div><div class="stat-lbl">Revenue</div><div class="stat-val text-[12px] text-green-600">$' + formatNum(s.rev) + '</div></div>' +
                    '<div><div class="stat-lbl">Cost</div><div class="stat-val text-[12px] text-slate-500">$' + formatNum(s.cost) + '</div></div>' +
                    '</div>' +
                    '<div class="grid grid-cols-3 gap-0.5 text-center">' +
                    '<div><div class="stat-lbl">Profit</div><div class="stat-val text-[12px] ' + (s.profit >= 0 ? 'text-green-600' : 'text-red-500') + '">$' + formatNum(s.profit) + '</div></div>' +
                    '<div><div class="stat-lbl">ROI</div><div class="stat-val text-[12px] ' + (s.roi >= 0 ? 'text-green-600' : 'text-red-500') + '">' + s.roi.toFixed(0) + '%</div></div>' +
                    '<div><div class="stat-lbl">CR</div><div class="stat-val text-[12px] text-blue-600">' + s.cr.toFixed(3) + '%</div></div>' +
                    '</div>' +
                    blSwitcherHtml +
                    '</div>';
            });
            $('kpi-container').innerHTML = html;
        }

        function formatNum(n) {
            if (Math.abs(n) >= 1e6) return (n / 1e6).toFixed(1) + 'M';
            if (Math.abs(n) >= 1e3) return (n / 1e3).toFixed(1) + 'K';
            return n.toFixed(0);
        }

        function renderGlobalStats() {
            const data = state.aggMode === 'split' ? (state.processedRaw || []) : (state.processed || []);
            const clicks = data.reduce((s, r) => s + r.clicks, 0);
            const conv = data.reduce((s, r) => s + r.conv, 0);
            const rev = data.reduce((s, r) => s + r.rev, 0);
            const cost = data.reduce((s, r) => s + r.cost, 0);
            const profit = data.reduce((s, r) => s + r.profit, 0);
            const roi = cost > 0 ? (profit / cost * 100) : 0;
            const cr = clicks > 0 ? (conv / clicks * 100) : 0;
            const ppc = clicks > 0 ? (profit / clicks) : 0;
            const pill = (l, v, c) => '<div class="g-item"><span class="g-lbl">' + l + '</span><span class="g-val ' + c + '">' + v + '</span></div>';
            $('global-stats').innerHTML = pill('××–×”×™×', data.length.toLocaleString(), '') + pill('Clicks', formatNum(clicks), 'text-blue-600') + pill('Conv', conv.toLocaleString(), '') + pill('Revenue', '$' + formatNum(rev), 'text-green-600') + pill('Cost', '$' + formatNum(cost), 'text-slate-500') + pill('Profit', '$' + formatNum(profit), profit >= 0 ? 'text-green-600' : 'text-red-500') + pill('ROI', roi.toFixed(0) + '%', roi >= 0 ? 'text-green-600' : 'text-red-500') + pill('CR', cr.toFixed(3) + '%', 'text-blue-600') + pill('PPC', '$' + ppc.toFixed(4), 'text-amber-600');
        }

        function renderTable() {
            const start = (state.page - 1) * state.pageSize;
            const pageData = state.filtered.slice(start, start + state.pageSize);
            const showLevel = state.hasHierarchy;
            const showChanges = state.compareMode && $('chk-show-changes').checked;
            const showExtraCols = state.extraColumns && state.extraColumns.length > 0;
            
            const totals = { clicks: 0, conv: 0, rev: 0, cost: 0, profit: 0 };
            state.filtered.forEach(r => {
                if (!r.isSummary) { totals.clicks += r.clicks; totals.conv += r.conv; totals.rev += r.rev; totals.cost += r.cost; totals.profit += r.profit; }
            });
            totals.roi = totals.cost > 0 ? (totals.profit / totals.cost * 100) : 0;
            totals.cr = totals.clicks > 0 ? (totals.conv / totals.clicks * 100) : 0;
            totals.ppc = totals.clicks > 0 ? (totals.profit / totals.clicks) : 0;
            const extraColsPlaceholders = state.extraColumns.map(() => '<th class="summary-cell"></th>').join('');
            
            $('table-summary-row').innerHTML = '<th class="summary-cell text-center text-slate-400">-</th>' +
                (showLevel ? '<th class="summary-cell"></th>' : '') +
                '<th class="summary-cell text-right text-indigo-700">×¡×”"×› (' + state.filtered.length + ')</th>' +
                extraColsPlaceholders +
                '<th class="summary-cell"></th><th class="summary-cell"></th>' +
                '<th class="summary-cell text-center text-indigo-900">' + totals.clicks.toLocaleString() + '</th>' +
                '<th class="summary-cell text-center text-indigo-900">' + totals.conv.toLocaleString() + '</th>' +
                '<th class="summary-cell text-center text-green-700">$' + formatNum(totals.rev) + '</th>' +
                '<th class="summary-cell text-center text-slate-500">$' + formatNum(totals.cost) + '</th>' +
                '<th class="summary-cell text-center ' + (totals.profit >= 0 ? 'text-green-700' : 'text-red-600') + '">$' + formatNum(totals.profit) + '</th>' +
                '<th class="summary-cell text-center ' + (totals.roi >= 0 ? 'text-green-700' : 'text-red-600') + '">' + totals.roi.toFixed(0) + '%</th>' +
                '<th class="summary-cell text-center text-blue-700">' + totals.cr.toFixed(3) + '%</th>' +
                '<th class="summary-cell text-center text-amber-700">$' + totals.ppc.toFixed(4) + '</th>';

            const catConfig = {
                pure: { badge: 'badge-pure', row: 'row-pure', label: 'ğŸ’ PURE' },
                gold: { badge: 'badge-gold', row: 'row-gold', label: 'ğŸ¥‡ GOLD' },
                potential: { badge: 'badge-potential', row: 'row-potential', label: 'ğŸŒ± POTENTIAL' },
                ignore: { badge: 'badge-ignore', row: '', label: 'ğŸ˜ IGNORE' },
                blacklist: { badge: 'badge-blacklist', row: 'row-blacklist', label: 'ğŸš« BLACKLIST' },
                testing: { badge: 'badge-testing', row: 'row-testing', label: 'ğŸ”¬ TESTING' },
                custom: { badge: 'badge-custom', row: 'row-custom', label: 'ğŸ¯ CUSTOM' },
                summary: { badge: 'badge-summary', row: 'row-summary', label: 'ğŸ“Š SUMMARY' }
            };
            const compareBadges = {
                'new': '<span class="compare-badge badge-new ml-1">âœ¨</span>',
                'improved': '<span class="compare-badge badge-improved ml-1">ğŸ“ˆ</span>',
                'declined': '<span class="compare-badge badge-declined ml-1">ğŸ“‰</span>'
            };
            function makeDelta(current, old, prefix, suffix, decimals) {
                if (!showChanges || old === undefined) return '';
                const delta = current - old;
                if (Math.abs(delta) < 0.01) return '';
                const cls = delta >= 0 ? 'delta-positive' : 'delta-negative';
                const sign = delta >= 0 ? '+' : '';
                return '<div class="change-delta ' + cls + '">' + sign + prefix + delta.toFixed(decimals) + suffix + '</div>';
            }

            let html = '';
            pageData.forEach((r, i) => {
                const cfg = catConfig[r.category] || catConfig.ignore;
                const scoreCls = r.score > 5 ? 'score-high' : r.score > 1 ? 'score-mid' : 'score-low';
                const levelCls = r.level === 1 ? 'level-1' : r.level === 2 ? 'level-2' : 'level-3';
                const displayId = highlightSafe(r.identifier, state.searchQuery);
                const cmpBadge = state.compareMode && r.compareStatus ? (compareBadges[r.compareStatus] || '') : '';
                const icloudBadge = isIcloudIP(r.identifier) ? '<span class="icloud-badge" title="iCloud Private Relay">â˜ï¸</span>' : '';
                const profitDelta = r.compareStatus !== 'new' ? makeDelta(r.profit, r.oldProfit, '$', '', 2) : '';
                const roiDelta = r.compareStatus !== 'new' ? makeDelta(r.roi, r.oldRoi, '', '%', 0) : '';
                const crDelta = r.compareStatus !== 'new' ? makeDelta(r.cr * 100, r.oldCr * 100, '', '%', 2) : '';
                let extraCells = '';
                if (showExtraCols) state.extraColumns.forEach(col => { extraCells += '<td class="text-center text-[11px] text-slate-600">' + escapeHtml((r.extraData && r.extraData[col]) || '-') + '</td>'; });
                
                html += '<tr class="' + cfg.row + '">' +
                    '<td class="text-center num-font text-slate-400">' + (start + i + 1) + '</td>' +
                    (showLevel ? '<td class="text-center"><span class="level-badge ' + levelCls + '">' + r.level + '</span></td>' : '') +
                    '<td class="text-right font-bold text-slate-700 ' + (r.isSummary ? 'text-indigo-700' : '') + '">' + icloudBadge + displayId + cmpBadge + '</td>' +
                    extraCells +
                    '<td class="text-center"><span class="cat-badge ' + cfg.badge + '">' + cfg.label + '</span></td>' +
                    '<td class="text-center"><span class="score-pill ' + scoreCls + '">' + r.score.toFixed(2) + '</span></td>' +
                    '<td class="text-center num-font">' + r.clicks.toLocaleString() + '</td>' +
                    '<td class="text-center num-font font-bold">' + r.conv + '</td>' +
                    '<td class="text-center num-font text-green-600">$' + r.rev.toFixed(2) + '</td>' +
                    '<td class="text-center num-font text-slate-500">$' + r.cost.toFixed(2) + '</td>' +
                    '<td class="text-center num-font font-bold ' + (r.profit >= 0 ? 'text-green-600' : 'text-red-500') + '">' + profitDelta + '$' + r.profit.toFixed(2) + '</td>' +
                    '<td class="text-center num-font ' + (r.roi >= 0 ? 'text-green-600' : 'text-red-500') + '">' + roiDelta + r.roi.toFixed(0) + '%</td>' +
                    '<td class="text-center num-font text-blue-600">' + crDelta + (r.cr * 100).toFixed(3) + '%</td>' +
                    '<td class="text-center num-font">$' + r.ppc.toFixed(4) + '</td></tr>';
            });
            const baseCols = showLevel ? 13 : 12;
            const colspan = baseCols + (showExtraCols ? state.extraColumns.length : 0);
            $('table-body').innerHTML = html || '<tr><td colspan="' + colspan + '" class="text-center text-slate-400 py-8">××™×Ÿ × ×ª×•× ×™×</td></tr>';
            const maxPage = Math.ceil(state.filtered.length / state.pageSize) || 1;
            $('disp-count').textContent = state.filtered.length.toLocaleString();
            $('page-num').textContent = state.page + ' / ' + maxPage;
            updateExtraColumnHeaders();
            updateSortIndicators();
        }
        
        function updateExtraColumnHeaders() {
            const existingExtraTh = document.querySelectorAll('.extra-col-th');
            existingExtraTh.forEach(th => th.remove());
            if (state.extraColumns && state.extraColumns.length > 0) {
                const categoryTh = document.querySelector('th:nth-child(' + (state.hasHierarchy ? 4 : 3) + ')');
                state.extraColumns.forEach(col => {
                    const th = document.createElement('th');
                    th.className = 'text-center extra-col-th';
                    th.textContent = col;
                    categoryTh.parentNode.insertBefore(th, categoryTh);
                });
            }
        }

        function changePage(d) {
            const max = Math.ceil(state.filtered.length / state.pageSize) || 1;
            if (state.page + d > 0 && state.page + d <= max) { state.page += d; renderTable(); }
        }

        function exportData() {
            const wb = XLSX.utils.book_new();
            const useCidr = $('chk-cidr').checked;
            const source = state.aggMode === 'split' ? (state.processedRaw || []) : (state.processed || []);
            const exports = [
                { id: 'chk-pure', name: 'Pure', pick: r => r.category === 'pure' },
                { id: 'chk-gold', name: 'Gold', pick: r => r.category === 'gold' },
                { id: 'chk-potential', name: 'Potential', pick: r => r.category === 'potential' },
                { id: 'chk-bl', name: 'Blacklist', pick: r => r.category === 'blacklist' },
                { id: 'chk-custom', name: 'Custom', pick: r => r.matchesCustom || r.category === 'custom' }
            ];
            let count = 0;
            exports.forEach(exp => {
                if ($(exp.id).checked) {
                    const rows = source.filter(r => !r.isSummary && exp.pick(r));
                    if (rows.length) {
                        const data = rows.map(r => ({
                            Identifier: useCidr ? toCIDR(r.identifier) : r.identifier,
                            Score: r.score.toFixed(2), Clicks: r.clicks, Conv: r.conv,
                            Revenue: r.rev.toFixed(2), Cost: r.cost.toFixed(2), Profit: r.profit.toFixed(2),
                            'ROI%': r.roi.toFixed(0), 'CR%': (r.cr * 100).toFixed(3), PPC: r.ppc.toFixed(4), Action: r.action
                        }));
                        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), exp.name);
                        count++;
                    }
                }
            });
            if (count) XLSX.writeFile(wb, 'ListLab_V48_Export.xlsx');
            else alert('×‘×—×¨ ×œ×¤×—×•×ª ×¨×©×™××” ××—×ª');
        }

        function copyIPs() {
            if (!state.filtered.length) return alert('××™×Ÿ × ×ª×•× ×™×');
            const useCidr = $('chk-copy-cidr').checked;
            const allIds = state.filtered.filter(r => !r.isSummary).map(r => useCidr ? toCIDR(r.identifier) : r.identifier);
            const uniqueIds = [...new Set(allIds)];
            navigator.clipboard.writeText(uniqueIds.join('\n')).then(() => {
                const btn = $('btn-copy');
                btn.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i> ×”×•×¢×ª×§!';
                lucide.createIcons();
                setTimeout(() => { btn.innerHTML = '<i data-lucide="copy" class="w-3 h-3"></i> ×”×¢×ª×§'; lucide.createIcons(); }, 1500);
            });
        }

        function debounce(fn, ms = 150) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); }; }
        const debouncedProcess = debounce(processData, 200);
        
        function syncControls(rangeId, numId) {
            const range = $(rangeId); const num = $(numId);
            range.addEventListener('input', () => { num.value = range.value; debouncedProcess(); });
            num.addEventListener('input', () => { range.value = num.value; debouncedProcess(); });
        }
        syncControls('pure-pct', 'pure-pct-num');
        syncControls('gold-pct', 'gold-pct-num');
        
        function toggleDashboard() {
            const content = $('dashboard-content');
            const icon = $('dash-toggle-icon');
            content.classList.toggle('hidden');
            icon.style.transform = content.classList.contains('hidden') ? '' : 'rotate(180deg)';
        }
        
        function getCategoryMini(cat) {
            const cats = {
                pure: '<span class="text-[9px] px-1 rounded bg-amber-100 text-amber-700">PURE</span>',
                gold: '<span class="text-[9px] px-1 rounded bg-amber-200 text-amber-800">GOLD</span>',
                potential: '<span class="text-[9px] px-1 rounded bg-green-100 text-green-700">POT</span>',
                ignore: '<span class="text-[9px] px-1 rounded bg-slate-100 text-slate-600">IGN</span>',
                blacklist: '<span class="text-[9px] px-1 rounded bg-red-100 text-red-700">BL</span>',
                testing: '<span class="text-[9px] px-1 rounded bg-blue-100 text-blue-700">TEST</span>'
            };
            return cats[cat] || '';
        }
        
        function updateMiniDashboard() {
            const sourceData = state.aggMode === 'split' ? (state.processedRaw || []) : (state.processed || []);
            if (!sourceData.length) { $('mini-dashboard').classList.add('hidden'); return; }
            $('mini-dashboard').classList.remove('hidden');
            const byProfit = [...sourceData].sort((a, b) => b.profit - a.profit);
            const testedOnly = byProfit.filter(r => r.clicks >= state.clickThreshold);
            
            const top5 = testedOnly.filter(r => r.profit > 0).slice(0, 5);
            $('top-performers').innerHTML = top5.length ? top5.map(r => '<div class="performer-item"><span class="performer-id" title="' + escapeHtml(r.identifier) + '">' + escapeHtml(r.identifier) + '</span>' + getCategoryMini(r.category) + '<span class="performer-val text-green-600">+$' + r.profit.toFixed(2) + '</span></div>').join('') : '<div class="text-slate-400 text-[10px]">××™×Ÿ × ×ª×•× ×™×</div>';
            
            const bottom5 = testedOnly.filter(r => r.profit < 0).sort((a, b) => a.profit - b.profit).slice(0, 5);
            $('top-losers').innerHTML = bottom5.length ? bottom5.map(r => '<div class="performer-item"><span class="performer-id" title="' + escapeHtml(r.identifier) + '">' + escapeHtml(r.identifier) + '</span>' + getCategoryMini(r.category) + '<span class="performer-val text-red-500">$' + r.profit.toFixed(2) + '</span></div>').join('') : '<div class="text-slate-400 text-[10px]">××™×Ÿ × ×ª×•× ×™×</div>';

            const totalClicks = sourceData.reduce((s, r) => s + r.clicks, 0);
            const totalCost = sourceData.reduce((s, r) => s + r.cost, 0);
            const avgCPC = totalClicks > 0 ? totalCost / totalClicks : 0.001;
            const payoutsPerConv = [];
            sourceData.forEach(r => { if (r.conv > 0 && r.rev > 0) payoutsPerConv.push(r.rev / r.conv); });
            payoutsPerConv.sort((a, b) => a - b);
            const medianPayout = payoutsPerConv.length > 0 ? payoutsPerConv[Math.floor(payoutsPerConv.length / 2)] : 0;
            const maxClicksUntilLoss = avgCPC > 0 ? medianPayout / avgCPC : 0;
            const minCRtoProfit = medianPayout > 0 ? avgCPC / medianPayout : 0;
            
            $('be-max-clicks').textContent = maxClicksUntilLoss.toLocaleString(undefined, {maximumFractionDigits: 0});
            $('be-clicks-formula').textContent = 'Median AP $' + medianPayout.toFixed(2) + ' Ã· CPC $' + avgCPC.toFixed(4);
            $('be-min-cr').textContent = (minCRtoProfit * 100).toFixed(3) + '%';
            $('be-cr-formula').textContent = 'CPC $' + avgCPC.toFixed(4) + ' Ã· Median AP $' + medianPayout.toFixed(2);

            const avgROI = testedOnly.length > 0 ? testedOnly.reduce((s, r) => s + r.roi, 0) / testedOnly.length : 0;
            const crValues = testedOnly.filter(r => r.conv > 0).map(r => r.cr).sort((a, b) => a - b);
            const medianCR = crValues.length > 0 ? crValues[Math.floor(crValues.length / 2)] : 0;
            
            const outstanding = testedOnly.filter(r => {
                if (r.profit <= 0 || r.conv < 2 || r.cr < medianCR) return false;
                const roiRatio = avgROI > 0 ? r.roi / avgROI : 0;
                return roiRatio >= 2 && r.roi > 750;
            }).sort((a, b) => b.roi - a.roi).slice(0, 5);
            
            $('outstanding-list').innerHTML = outstanding.length ? outstanding.map(r => {
                const multiplier = avgROI > 0 ? (r.roi / avgROI).toFixed(1) : 'âˆ';
                return '<div class="performer-item"><span class="performer-id" title="' + escapeHtml(r.identifier) + '">' + escapeHtml(r.identifier) + '</span>' + getCategoryMini(r.category) + '<span class="performer-val text-purple-600">x' + multiplier + '</span></div>';
            }).join('') : '<div class="text-slate-400 text-[10px]">××™×Ÿ ××¦×˜×™×™× ×™× ×‘×•×œ×˜×™×</div>';
        }
        
        function searchIdentifier(query) { state.searchQuery = query.trim().toLowerCase(); applyFilter(); }
        $('search-input').addEventListener('input', (e) => { searchIdentifier(e.target.value); });

        function enableCompareButton() { $('btn-compare').disabled = !state.processed.length; }
        $('btn-compare').addEventListener('click', () => { $('compare-input').click(); });
        $('btn-clear-compare').addEventListener('click', () => {
            state.compareMode = false; state.compareData = null;
            state.compareResults = { new: [], improved: [], declined: [], gone: [] };
            state.processed.forEach(r => { r.compareStatus = null; r.profitChange = undefined; r.oldProfit = undefined; r.oldRoi = undefined; r.oldCr = undefined; });
            if (state.processedRaw) state.processedRaw.forEach(r => { r.compareStatus = null; r.profitChange = undefined; r.oldProfit = undefined; r.oldRoi = undefined; r.oldCr = undefined; });
            $('compare-panel').classList.add('hidden');
            $('btn-clear-compare').classList.add('hidden');
            $('show-changes-box').classList.add('hidden');
            applyFilter();
        });
        $('chk-show-changes').addEventListener('change', () => { renderTable(); });
        $('compare-input').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                    if (json.length < 2) { alert('×§×•×‘×¥ ×”×”×©×•×•××” ×¨×™×§'); return; }
                    const ipIdx = +$('col-ip').value, clicksIdx = +$('col-clicks').value, convIdx = +$('col-conv').value, revIdx = +$('col-rev').value, costIdx = +$('col-cost').value;
                    const compareMap = new Map();
                    for (let i = 1; i < json.length; i++) {
                        const row = json[i];
                        const id = String(row[ipIdx] || '').trim();
                        if (!id || isInvalidIdentifier(id)) continue;
                        const clicks = parseFloat(row[clicksIdx]) || 0, conv = parseFloat(row[convIdx]) || 0, rev = parseFloat(row[revIdx]) || 0, cost = parseFloat(row[costIdx]) || 0;
                        const profit = rev - cost, roi = cost > 0 ? ((rev - cost) / cost) * 100 : 0, cr = clicks > 0 ? conv / clicks : 0;
                        compareMap.set(id, { clicks, conv, rev, cost, profit, roi, cr });
                    }
                    state.compareData = compareMap; state.compareMode = true;
                    const results = { new: [], improved: [], declined: [], gone: [] };
                    const currentIds = new Set(state.processed.map(r => r.identifier));
                    function applyCompareToRow(r) {
                        const old = compareMap.get(r.identifier);
                        if (!old) { r.compareStatus = 'new'; r.profitChange = 0; return 'new'; }
                        else {
                            const profitChange = old.profit - r.profit;
                            r.profitChange = profitChange; r.oldProfit = old.profit; r.oldRoi = old.roi; r.oldCr = old.cr;
                            if (profitChange > 0.5) { r.compareStatus = 'improved'; return 'improved'; }
                            else if (profitChange < -0.5) { r.compareStatus = 'declined'; return 'declined'; }
                            else { r.compareStatus = 'same'; return 'same'; }
                        }
                    }
                    state.processed.forEach(r => { const s = applyCompareToRow(r); if (s === 'new') results.new.push(r.identifier); else if (s === 'improved') results.improved.push(r.identifier); else if (s === 'declined') results.declined.push(r.identifier); });
                    if (state.processedRaw) state.processedRaw.forEach(r => applyCompareToRow(r));
                    compareMap.forEach((_, id) => { if (!currentIds.has(id)) results.gone.push(id); });
                    state.compareResults = results;
                    $('compare-panel').classList.remove('hidden');
                    $('btn-clear-compare').classList.remove('hidden');
                    $('show-changes-box').classList.remove('hidden');
                    $('compare-file-name').textContent = file.name;
                    $('cmp-new').textContent = results.new.length;
                    $('cmp-improved').textContent = results.improved.length;
                    $('cmp-declined').textContent = results.declined.length;
                    $('cmp-gone').textContent = results.gone.length;
                    applyFilter();
                } catch (err) { console.error('Compare file error:', err); alert('×©×’×™××” ×‘×§×¨×™××ª ×§×•×‘×¥ ×”×”×©×•×•××”'); }
            };
            reader.readAsArrayBuffer(file);
            e.target.value = '';
        });
    </script>
</body>
</html>
