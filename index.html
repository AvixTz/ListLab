<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Executive Dashboard V24 - Grid Control</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Assistant', sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            height: 100vh;
            overflow: hidden;
            color: #1e293b;
        }
        .num-font { font-family: 'Inter', sans-serif; }
        
        /* Main Layout */
        .main-wrapper {
            width: 100%; height: 100%; display: flex; flex-direction: column; padding: 0.5rem;
        }

        /* Header */
        .glass-header {
            background: white; border-radius: 10px; padding: 0 1.5rem; margin-bottom: 0.5rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between;
            align-items: center; height: 60px; shrink: 0;
        }

        /* Dashboard Container */
        .dash-container {
            flex: 1; background: white; border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05);
            display: flex; overflow: hidden; border: 1px solid #e2e8f0;
        }

        /* Sidebar */
        .dash-sidebar {
            width: 300px; background: #ffffff; border-left: 1px solid #e2e8f0;
            display: flex; flex-direction: column; overflow-y: auto; padding: 1rem;
        }

        /* Content */
        .dash-content {
            flex: 1; background: #f8fafc; display: flex; flex-direction: column; overflow: hidden;
        }

        /* --- Grid Controls --- */
        .control-box {
            border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem; border: 1px solid;
        }
        .control-grid {
            display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem; row-gap: 0.75rem;
        }
        .control-item { display: flex; flex-direction: column; }
        
        .lbl-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
        .lbl-sm { font-size: 11px; font-weight: 700; color: #64748b; white-space: nowrap; }
        
        input[type=range] {
            height: 4px; border-radius: 2px; background: rgba(0,0,0,0.1);
            outline: none; appearance: none; cursor: pointer; width: 100%; display: block;
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; width: 12px; height: 12px; border-radius: 50%;
            background: currentColor; border: 2px solid white; box-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        .dash-input {
            width: 42px; font-family: 'Inter', sans-serif; font-weight: 700; font-size: 11px;
            text-align: center; border: 1px solid #cbd5e1; border-radius: 4px; padding: 1px;
            background: white; height: 22px;
        }
        .dash-input:focus { outline: 2px solid #3b82f6; border-color: transparent; }

        /* KPI Cards */
        .kpi-card {
            background: white; border: 1px solid #e2e8f0; border-radius: 10px;
            overflow: visible; transition: transform 0.2s; display: flex; flex-direction: column;
            padding: 1rem; height: 100%; justify-content: space-between;
        }
        .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px -4px rgba(0,0,0,0.1); }
        
        .stat-lbl { font-size: 10px; font-weight: 700; color: #94a3b8; text-transform: uppercase; margin-bottom: 2px; }
        .stat-val { font-family: 'Inter', sans-serif; font-weight: 700; font-size: 15px; color: #334155; line-height: 1.1; }

        /* Global Stats */
        .g-item { text-align: center; border-left: 1px solid #f1f5f9; flex: 1; display: flex; flex-direction: column; justify-content: center; }
        .g-item:last-child { border: none; }
        .g-lbl { font-size: 10px; font-weight: 700; color: #94a3b8; text-transform: uppercase; }
        .g-val { font-size: 14px; font-weight: 700; color: #334155; font-family: 'Inter', sans-serif; }

        /* Scrollbar & Checkbox */
        .custom-scrollbar::-webkit-scrollbar { width: 5px; height: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        .chk-label { display: flex; align-items: center; gap: 6px; font-size: 11px; font-weight: 600; color: #475569; cursor: pointer; user-select: none; }
        .chk-input { width: 14px; height: 14px; accent-color: #1e293b; cursor: pointer; border-radius: 3px; }

        /* Table */
        th { font-size: 11px; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; font-weight: 700; background: #f8fafc; position: sticky; top: 0; z-index: 10; padding: 10px; }
        td { font-size: 12px; border-bottom: 1px solid #f1f5f9; padding: 8px 10px; }
        tr:hover td { background-color: #f8fafc; }
        
        .btn-upload { background: #e0e7ff; color: #4338ca; border: 1px dashed #a5b4fc; padding: 0.75rem; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .btn-upload:hover { background: #c7d2fe; border-color: #6366f1; }
    </style>
</head>
<body>

    <div class="main-wrapper">
        
        <div class="glass-header">
            <div class="flex items-center gap-3 shrink-0 w-48">
                <div class="bg-indigo-600 text-white p-1.5 rounded-lg shadow-md">
                    <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="text-sm font-bold text-slate-800 leading-tight">M.A.T System</h1>
                    <div class="text-[10px] text-indigo-500 font-bold">V24 Grid</div>
                </div>
            </div>
            
            <div id="global-stats" class="flex-1 flex justify-between px-2 h-full">
                <span class="text-xs text-slate-400 w-full text-center">טוען נתונים...</span>
            </div>
        </div>

        <div class="dash-container">
            
            <aside class="dash-sidebar custom-scrollbar">
                
                <div class="btn-upload mb-4 group" id="drop-zone">
                    <input type="file" id="file-input" class="hidden" accept=".xlsx, .csv">
                    <div class="flex items-center justify-center gap-2 mb-1 text-indigo-700">
                        <i data-lucide="upload-cloud" class="w-4 h-4"></i>
                        <span class="text-xs font-bold">טען קובץ נתונים</span>
                    </div>
                    <div id="filename" class="text-[9px] text-indigo-400 truncate">Excel / CSV</div>
                </div>

                <div class="control-box border-indigo-100 bg-indigo-50/30">
                    <div class="flex items-center gap-2 mb-2 text-indigo-700 border-b border-indigo-100 pb-1">
                        <i data-lucide="list-filter" class="w-3 h-3"></i>
                        <span class="text-xs font-bold uppercase">Custom List</span>
                    </div>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="lbl-row"><span class="lbl-sm">Min Conv</span><input type="number" id="num-cust-min" value="1" class="dash-input text-indigo-600 border-indigo-200"></div>
                            <input type="range" id="rng-cust-min" min="1" max="20" value="1" class="text-indigo-500">
                        </div>
                        <div class="control-item">
                            <div class="lbl-row"><span class="lbl-sm">Target %</span><input type="number" id="num-cust-pct" value="100" class="dash-input text-indigo-600 border-indigo-200"></div>
                            <input type="range" id="rng-cust-pct" min="0" max="100" value="100" class="text-indigo-500">
                        </div>
                        <div class="control-item">
                            <div class="lbl-row"><span class="lbl-sm">Min ROI</span><input type="number" id="num-cust-roi" value="0" class="dash-input text-indigo-600 border-indigo-200"></div>
                            <input type="range" id="rng-cust-roi" min="-100" max="100" value="0" class="text-indigo-500">
                        </div>
                        <div class="control-item">
                            <div class="lbl-row"><span class="lbl-sm">Min CR %</span><input type="number" id="num-cust-mcr" value="0" step="0.1" class="dash-input text-indigo-600 border-indigo-200"></div>
                            <input type="range" id="rng-cust-mcr" min="0" max="20" step="0.1" value="0" class="text-indigo-500">
                        </div>
                    </div>
                </div>

                <div class="control-box border-emerald-100 bg-emerald-50/20">
                    <div class="flex items-center gap-2 mb-2 text-emerald-700 border-b border-emerald-100 pb-1">
                        <i data-lucide="gem" class="w-3 h-3"></i>
                        <span class="text-xs font-bold uppercase">Pure List</span>
                    </div>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="lbl-row"><span class="lbl-sm">Min Conv</span><input type="number" id="num-pure-min" value="5" class="dash-input text-emerald-600 border-emerald-200"></div>
                            <input type="range" id="rng-pure-min" min="1" max="50" value="5" class="text-emerald-500">
                        </div>
                        <div class="control-item">
                            <div class="lbl-row"><span class="lbl-sm">Target %</span><input type="number" id="num-pure-pct" value="10" class="dash-input text-emerald-600 border-emerald-200"></div>
                            <input type="range" id="rng-pure-pct" min="0" max="100" value="10" class="text-emerald-500">
                        </div>
                        <div class="control-item">
                            <div class="lbl-row"><span class="lbl-sm">Min ROI</span><input type="number" id="num-pure-roi" value="0" class="dash-input text-emerald-600 border-emerald-200"></div>
                            <input type="range" id="rng-pure-roi" min="-100" max="100" value="0" class="text-emerald-500">
                        </div>
                        <div class="control-item">
                            <div class="lbl-row"><span class="lbl-sm">Min CR %</span><input type="number" id="num-pure-mcr" value="0" step="0.1" class="dash-input text-emerald-600 border-emerald-200"></div>
                            <input type="range" id="rng-pure-mcr" min="0" max="20" step="0.1" value="0" class="text-emerald-500">
                        </div>
                    </div>
                    <div class="text-[9px] text-right text-emerald-600/70 font-mono mt-1">Target > <span id="calc-pure-cr">-</span></div>
                </div>

                <div class="control-box border-amber-100 bg-amber-50/20">
                    <div class="flex items-center gap-2 mb-2 text-amber-700 border-b border-amber-100 pb-1">
                        <i data-lucide="award" class="w-3 h-3"></i>
                        <span class="text-xs font-bold uppercase">Gold List</span>
                    </div>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="lbl-row"><span class="lbl-sm">Min Conv</span><input type="number" id="num-gold-min" value="3" class="dash-input text-amber-600 border-amber-200"></div>
                            <input type="range" id="rng-gold-min" min="1" max="30" value="3" class="text-amber-500">
                        </div>
                        <div class="control-item">
                            <div class="lbl-row"><span class="lbl-sm">Target %</span><input type="number" id="num-gold-pct" value="40" class="dash-input text-amber-600 border-amber-200"></div>
                            <input type="range" id="rng-gold-pct" min="0" max="100" value="40" class="text-amber-500">
                        </div>
                        <div class="control-item">
                            <div class="lbl-row"><span class="lbl-sm">Min ROI</span><input type="number" id="num-gold-roi" value="0" class="dash-input text-amber-600 border-amber-200"></div>
                            <input type="range" id="rng-gold-roi" min="-100" max="100" value="0" class="text-amber-500">
                        </div>
                        <div class="control-item">
                            <div class="lbl-row"><span class="lbl-sm">Min CR %</span><input type="number" id="num-gold-mcr" value="0" step="0.1" class="dash-input text-amber-600 border-amber-200"></div>
                            <input type="range" id="rng-gold-mcr" min="0" max="20" step="0.1" value="0" class="text-amber-500">
                        </div>
                    </div>
                    <div class="text-[9px] text-right text-amber-600/70 font-mono mt-1">Target > <span id="calc-gold-cr">-</span></div>
                </div>

                <div class="control-box border-red-100 bg-red-50/20">
                    <div class="flex items-center gap-2 mb-2 text-red-700 border-b border-red-100 pb-1">
                        <i data-lucide="ban" class="w-3 h-3"></i>
                        <span class="text-xs font-bold uppercase">Blacklist</span>
                    </div>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="lbl-row"><span class="lbl-sm">Max ROI</span><input type="number" id="num-bl-roi" value="0" class="dash-input text-red-600 border-red-200"></div>
                            <input type="range" id="rng-bl-roi" min="-100" max="20" value="0" class="text-red-500">
                        </div>
                        <div class="control-item">
                            <div class="lbl-row"><span class="lbl-sm">Min Clicks</span><input type="number" id="num-bl-clicks" value="0" class="dash-input text-slate-600 border-slate-200"></div>
                            <input type="range" id="rng-bl-clicks" min="0" max="500" value="0" class="text-slate-400">
                        </div>
                    </div>
                </div>

                <div id="other-alert" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-2 text-center mb-3">
                    <div class="text-[10px] text-yellow-700 font-bold flex items-center justify-center gap-1">
                        <i data-lucide="alert-triangle" class="w-3 h-3"></i>
                        <span id="other-count">0</span> טווחים פעילים ללא סיווג
                    </div>
                </div>

                <div class="mt-auto border-t pt-3">
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <label class="chk-label"><input type="checkbox" id="chk-pure" checked class="chk-input"> Pure</label>
                        <label class="chk-label"><input type="checkbox" id="chk-gold" checked class="chk-input"> Gold</label>
                        <label class="chk-label"><input type="checkbox" id="chk-cust" checked class="chk-input"> Custom</label>
                        <label class="chk-label"><input type="checkbox" id="chk-bl" class="chk-input"> Blacklist</label>
                        <label class="chk-label col-span-2 justify-center"><input type="checkbox" id="chk-other" class="chk-input"> Other (Residual)</label>
                    </div>
                    <label class="flex items-center justify-center gap-1.5 text-[10px] text-indigo-700 font-bold mb-3 cursor-pointer">
                        <input type="checkbox" id="chk-cidr" class="chk-input border-indigo-200"> Convert to CIDR /24
                    </label>
                    <button onclick="exportData()" class="w-full bg-slate-900 text-white py-2 rounded-md text-xs font-bold hover:bg-slate-800 transition flex items-center justify-center gap-2 shadow">
                        <i data-lucide="download" class="w-3 h-3"></i> ייצוא נבחרים
                    </button>
                </div>

            </aside>

            <main class="dash-content">
                
                <div class="p-4 bg-white border-b border-slate-100 shrink-0">
                    <div id="kpi-cards-container" class="grid grid-cols-4 gap-4 w-full">
                        </div>
                </div>

                <div class="flex-1 p-4 min-h-0 flex flex-col bg-slate-50">
                    <div class="bg-white rounded-xl border border-slate-200 flex-1 flex flex-col overflow-hidden shadow-sm">
                        <div class="px-4 py-2 border-b border-slate-200 bg-white flex justify-between items-center shrink-0">
                            <div class="flex items-center gap-2">
                                <span class="text-[10px] font-bold text-slate-400 uppercase tracking-wide">סינון:</span>
                                <select id="filter-view" class="text-xs bg-slate-50 border border-slate-200 rounded px-2 py-1 font-medium focus:outline-none w-32">
                                    <option value="all">הצג הכל</option>
                                    <option value="custom">Custom List</option>
                                    <option value="gold">Gold List</option>
                                    <option value="pure">Pure List</option>
                                    <option value="other">Other</option>
                                    <option value="blacklist">Blacklist</option>
                                </select>
                            </div>
                            <div class="text-[10px] text-slate-400 font-medium">
                                סה"כ: <span id="disp-count" class="font-bold text-slate-800 num-font text-sm">0</span>
                            </div>
                        </div>
                        <div class="flex-1 overflow-auto custom-scrollbar bg-white">
                            <table class="w-full text-xs text-left relative">
                                <thead class="bg-slate-50 text-slate-500 font-bold uppercase sticky top-0 z-10 shadow-sm">
                                    <tr>
                                        <th class="pl-4 text-left w-40">IP Range</th>
                                        <th class="text-right">Clicks</th>
                                        <th class="text-right">Conv</th>
                                        <th class="text-right">Rev</th>
                                        <th class="text-right">Cost</th>
                                        <th class="text-right">Profit</th>
                                        <th class="text-right">CR %</th>
                                        <th class="text-right">ROI %</th>
                                        <th class="text-center">Tag</th>
                                    </tr>
                                </thead>
                                <tbody id="table-body" class="divide-y divide-slate-100 text-slate-600 num-font"></tbody>
                            </table>
                        </div>
                        <div class="p-1 border-t border-slate-100 bg-white flex justify-center gap-4 items-center shrink-0">
                            <button onclick="changePage(-1)" class="p-1 hover:bg-slate-100 rounded text-slate-500"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                            <span id="page-num" class="text-[10px] font-bold text-slate-400">1</span>
                            <button onclick="changePage(1)" class="p-1 hover:bg-slate-100 rounded text-slate-500"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // State Management
        const state = { data: [], processed: [], display: [], page: 1, pageSize: 100, thresholds: { pure: 0, gold: 0, cust: 0 } };

        // DOM Elements
        const getEl = (id) => document.getElementById(id);
        const dom = {
            pure: { min: getEl('rng-pure-min'), pct: getEl('rng-pure-pct'), roi: getEl('rng-pure-roi'), mcr: getEl('rng-pure-mcr'), numMin: getEl('num-pure-min'), numPct: getEl('num-pure-pct'), numRoi: getEl('num-pure-roi'), numMcr: getEl('num-pure-mcr') },
            gold: { min: getEl('rng-gold-min'), pct: getEl('rng-gold-pct'), roi: getEl('rng-gold-roi'), mcr: getEl('rng-gold-mcr'), numMin: getEl('num-gold-min'), numPct: getEl('num-gold-pct'), numRoi: getEl('num-gold-roi'), numMcr: getEl('num-gold-mcr') },
            cust: { min: getEl('rng-cust-min'), pct: getEl('rng-cust-pct'), roi: getEl('rng-cust-roi'), mcr: getEl('rng-cust-mcr'), numMin: getEl('num-cust-min'), numPct: getEl('num-cust-pct'), numRoi: getEl('num-cust-roi'), numMcr: getEl('num-cust-mcr') },
            bl: { roi: getEl('rng-bl-roi'), numRoi: getEl('num-bl-roi'), clicks: getEl('rng-bl-clicks'), numClicks: getEl('num-bl-clicks') },
            displays: { pureCr: getEl('calc-pure-cr'), goldCr: getEl('calc-gold-cr') },
            filter: getEl('filter-view'),
            otherAlert: getEl('other-alert'),
            otherCount: getEl('other-count')
        };

        // Sync inputs
        const sync = (range, number) => {
            range.addEventListener('input', () => { number.value = range.value; runEngine(); });
            number.addEventListener('input', () => { range.value = number.value; runEngine(); });
        };

        // Init
        const initSync = (g) => { sync(g.min, g.numMin); sync(g.pct, g.numPct); sync(g.roi, g.numRoi); sync(g.mcr, g.numMcr); };
        initSync(dom.pure); initSync(dom.gold); initSync(dom.cust);
        sync(dom.bl.roi, dom.bl.numRoi); sync(dom.bl.clicks, dom.bl.numClicks);
        dom.filter.addEventListener('change', () => { state.page = 1; renderTable(); });

        const dz = getEl('drop-zone');
        const fi = getEl('file-input');
        dz.addEventListener('click', () => fi.click());
        fi.addEventListener('change', e => loadFile(e.target.files[0]));
        dz.addEventListener('dragover', e => e.preventDefault());
        dz.addEventListener('drop', e => { e.preventDefault(); loadFile(e.dataTransfer.files[0]); });

        function loadFile(file) {
            if(!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const wb = XLSX.read(e.target.result, { type: 'array' });
                const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1 });
                if(json.length < 2) return alert("קובץ ריק");

                const h = json[0].map(s => String(s).toLowerCase());
                const map = {
                    ip: h.findIndex(x => x.includes('ip') || x.includes('range')),
                    clk: h.findIndex(x => x.includes('click') || x.includes('imp')),
                    conv: h.findIndex(x => x.includes('conv') || x.includes('sale')),
                    rev: h.findIndex(x => x.includes('rev') || x.includes('pay') || x.includes('total')),
                    roi: h.findIndex(x => x.includes('roi')),
                    cost: h.findIndex(x => x.includes('cost') || x.includes('spend'))
                };

                if(map.ip === -1) return alert("לא נמצאה עמודת IP");

                state.data = json.slice(1).map(r => {
                    const clicks = Number(r[map.clk] || 0);
                    const conv = Number(r[map.conv] || 0);
                    const rev = map.rev !== -1 ? Number(r[map.rev] || 0) : 0;
                    let roi = parseFloat(r[map.roi] || 0);
                    let cost = 0;
                    if (map.cost !== -1) cost = Number(r[map.cost] || 0);
                    else if (rev > 0 && roi > -100) cost = rev / (1 + (roi / 100));
                    
                    return { ip: r[map.ip], clicks, conv, rev, cost, profit: rev - cost, roi, cr: clicks > 0 ? (conv / clicks) : 0 };
                }).filter(r => r.ip);

                updateGlobalStats();
                getEl('filename').innerText = file.name;
                runEngine();
            };
            reader.readAsArrayBuffer(file);
        }

        function updateGlobalStats() {
            const d = state.data;
            const tClicks = d.reduce((s,r)=>s+r.clicks,0);
            const tCost = d.reduce((s,r)=>s+r.cost,0);
            const tRev = d.reduce((s,r)=>s+r.rev,0);
            const tProfit = d.reduce((s,r)=>s+r.profit,0);
            
            const rois = d.filter(r=>r.conv>0).map(r=>r.roi);
            const avgRoi = rois.length ? rois.reduce((a,b)=>a+b,0)/rois.length : 0;
            const roisSort = [...rois].sort((a,b)=>a-b);
            const medRoi = roisSort.length ? roisSort[Math.floor(roisSort.length/2)] : 0;

            const crs = d.filter(r=>r.clicks>0).map(r=>r.cr);
            const avgCr = crs.length ? crs.reduce((a,b)=>a+b,0)/crs.length : 0;
            const crsSort = [...crs].sort((a,b)=>a-b);
            const medCr = crsSort.length ? crsSort[Math.floor(crsSort.length/2)] : 0;

            const makeG = (lbl, val, col) => `
                <div class="g-item">
                    <span class="g-lbl">${lbl}</span>
                    <span class="g-val ${col}">${val}</span>
                </div>`;
            
            getEl('global-stats').innerHTML = 
                makeG('RANGES', d.length.toLocaleString(), 'text-slate-700') +
                makeG('CLICKS', tClicks.toLocaleString(), 'text-blue-600') +
                makeG('COST', '$'+tCost.toLocaleString(undefined,{maximumFractionDigits:0}), 'text-slate-500') +
                makeG('REVENUE', '$'+tRev.toLocaleString(undefined,{maximumFractionDigits:0}), 'text-green-600') +
                makeG('PROFIT', '$'+tProfit.toLocaleString(undefined,{maximumFractionDigits:0}), tProfit>=0?'text-green-600':'text-red-500') +
                makeG('AVG ROI', avgRoi.toFixed(0)+'%', 'text-slate-700') +
                makeG('MED ROI', medRoi.toFixed(0)+'%', 'text-slate-700') +
                makeG('AVG CR', (avgCr*100).toFixed(2)+'%', 'text-blue-600') +
                makeG('MED CR', (medCr*100).toFixed(2)+'%', 'text-blue-600');
            
            getEl('global-stats').classList.remove('hidden');
            getEl('global-stats').classList.add('flex');
        }

        function getPercentile(data, pct) {
            const vals = data.filter(r => r.conv > 0).map(r => r.cr).sort((a,b)=>a-b);
            if(!vals.length) return 0;
            const idx = Math.floor(vals.length * (1 - (pct/100)));
            return vals[Math.max(0, Math.min(idx, vals.length-1))];
        }

        function runEngine() {
            state.thresholds.pure = getPercentile(state.data, dom.pure.numPct.value);
            state.thresholds.gold = getPercentile(state.data, dom.gold.numPct.value);
            state.thresholds.cust = getPercentile(state.data, dom.cust.numPct.value);

            dom.displays.pureCr.innerText = (state.thresholds.pure * 100).toFixed(2) + '%';
            dom.displays.goldCr.innerText = (state.thresholds.gold * 100).toFixed(2) + '%';

            // Extract Values
            const blRoi = parseFloat(dom.bl.numRoi.value);
            const blMinClicks = parseInt(dom.bl.numClicks.value);

            const getParams = (g) => ({ 
                c: parseInt(g.numMin.value), 
                r: parseFloat(g.numRoi.value), 
                mcr: parseFloat(g.numMcr.value) / 100 
            });

            const p = getParams(dom.pure);
            const g = getParams(dom.gold);
            const c = getParams(dom.cust);

            let otherCount = 0;

            state.processed = state.data.map(r => {
                let status = 'Other'; let rank = 0;
                
                // Logic: Independent Checks
                const isBl = (r.clicks >= blMinClicks && (r.conv === 0 || (r.conv > 0 && r.roi < blRoi)));
                const isPure = !isBl && r.conv >= p.c && r.roi >= p.r && r.cr >= state.thresholds.pure && r.cr >= p.mcr;
                const isGold = !isBl && r.conv >= g.c && r.roi >= g.r && r.cr >= state.thresholds.gold && r.cr >= g.mcr;
                const isCust = !isBl && r.conv >= c.c && r.roi >= c.r && r.cr >= state.thresholds.cust && r.cr >= c.mcr;

                if (isBl) { status = 'Blacklist'; rank = -1; }
                else if (isPure) { status = 'Pure'; rank = 4; }
                else if (isGold) { status = 'Gold'; rank = 3; }
                else if (isCust) { status = 'Custom'; rank = 2; }
                else if (r.conv > 0) { 
                    status = 'Other'; rank = 1;
                    otherCount++;
                }

                return { ...r, isBl, isPure, isGold, isCust, status, rank };
            });

            if(otherCount > 0) {
                dom.otherAlert.classList.remove('hidden');
                dom.otherCount.innerText = otherCount;
            } else {
                dom.otherAlert.classList.add('hidden');
            }

            renderCards();
            renderTable();
        }

        function renderCards() {
            const container = getEl('kpi-cards-container');
            const totalClicks = state.data.reduce((s,r) => s+r.clicks, 0);
            
            const groups = {
                'Blacklist': { color: 'red', icon: 'ban', rows: state.processed.filter(r => r.isBl) },
                'Custom List': { color: 'indigo', icon: 'list-filter', rows: state.processed.filter(r => r.isCust) },
                'Gold List': { color: 'amber', icon: 'award', rows: state.processed.filter(r => r.isGold) },
                'Pure List': { color: 'emerald', icon: 'gem', rows: state.processed.filter(r => r.isPure) }
            };

            let html = '';
            for(const [title, data] of Object.entries(groups)) {
                const rows = data.rows;
                const count = rows.length;
                const clicks = rows.reduce((s,r)=>s+r.clicks,0);
                const conv = rows.reduce((s,r)=>s+r.conv,0);
                const profit = rows.reduce((s,r)=>s+r.profit,0);
                const share = totalClicks ? (clicks/totalClicks*100).toFixed(1) + '%' : '0%';
                
                const crs = rows.map(r=>r.cr).sort((a,b)=>a-b);
                const medCr = crs.length ? crs[Math.floor(crs.length/2)] : 0;
                const avgRoi = rows.length ? (rows.reduce((a,b)=>a+b.roi,0)/rows.length) : 0;
                
                const c = data.color;

                html += `
                <div class="kpi-card group hover:border-${c}-300 border-t-4 border-t-${c}-500">
                    <div class="flex justify-between items-start mb-2">
                        <div class="flex items-center gap-2">
                            <div class="p-1.5 rounded bg-${c}-50 text-${c}-600 border border-${c}-100"><i data-lucide="${data.icon}" class="w-4 h-4"></i></div>
                            <span class="text-sm font-black text-${c}-700 uppercase tracking-widest drop-shadow-sm">${title}</span>
                        </div>
                        <div class="text-3xl font-black text-slate-800 num-font leading-none">${count.toLocaleString()}</div>
                    </div>
                    
                    <div class="bg-slate-50 border border-slate-100 rounded px-2 py-1.5 flex justify-between items-center mb-3">
                        <div class="flex gap-1 items-baseline"><span class="stat-val text-xs text-slate-600">${share}</span><span class="stat-lbl text-[9px]">Share</span></div>
                        <div class="flex gap-1 items-baseline"><span class="stat-val text-xs text-slate-600">${clicks.toLocaleString()}</span><span class="stat-lbl text-[9px]">Clicks</span></div>
                    </div>

                    <div class="flex-1 flex flex-col justify-between gap-1">
                        <div class="flex justify-between items-center border-b border-slate-50 pb-2">
                            <div class="flex flex-col"><span class="stat-lbl mb-0.5">CONVERSIONS</span><span class="stat-val text-sm text-slate-600">${conv.toLocaleString()}</span></div>
                            <div class="flex flex-col text-right"><span class="stat-lbl mb-0.5">PROFIT</span><span class="stat-val text-sm ${profit>=0?'text-green-600':'text-red-500'}">$${profit.toLocaleString(undefined,{maximumFractionDigits:0})}</span></div>
                        </div>
                        <div class="flex justify-between items-center pt-1">
                            <div class="flex flex-col"><span class="stat-lbl mb-0.5">MEDIAN CR</span><span class="stat-val text-sm text-blue-600">${(medCr*100).toFixed(2)}%</span></div>
                            <div class="flex flex-col text-right"><span class="stat-lbl mb-0.5">AVG ROI</span><span class="stat-val text-sm text-slate-700">${avgRoi.toFixed(0)}%</span></div>
                        </div>
                    </div>
                </div>`;
            }
            container.innerHTML = html;
            lucide.createIcons();
        }

        function renderTable() {
            const view = dom.filter.value;
            let list = state.processed;
            
            if (view === 'custom') list = list.filter(r => r.isCust);
            else if (view === 'gold') list = list.filter(r => r.isGold);
            else if (view === 'pure') list = list.filter(r => r.isPure);
            else if (view === 'blacklist') list = list.filter(r => r.isBl);
            else if (view === 'other') list = list.filter(r => r.status === 'Other');

            list.sort((a,b) => b.rank - a.rank || b.conv - a.conv);
            state.display = list;
            getEl('disp-count').innerText = list.length.toLocaleString();

            const start = (state.page - 1) * state.pageSize;
            const chunk = list.slice(start, start + state.pageSize);
            const tbody = getEl('table-body');
            tbody.innerHTML = '';

            const colors = { 'Pure': 'bg-emerald-100 text-emerald-700', 'Gold': 'bg-amber-100 text-amber-700', 'Custom': 'bg-indigo-100 text-indigo-700', 'Blacklist': 'bg-red-50 text-red-600', 'Other': 'bg-slate-100 text-slate-400' };

            chunk.forEach(r => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-slate-50 border-b border-slate-50 transition-colors';
                const tagColor = colors[r.status] || 'bg-slate-100 text-slate-600';
                
                tr.innerHTML = `
                    <td class="pl-4 font-mono text-slate-600">${r.ip}</td>
                    <td class="text-right">${r.clicks.toLocaleString()}</td>
                    <td class="text-right font-bold text-slate-700">${r.conv}</td>
                    <td class="text-right text-green-600">$${r.rev.toFixed(0)}</td>
                    <td class="text-right text-slate-400">$${r.cost.toFixed(0)}</td>
                    <td class="text-right ${r.profit>=0?'text-green-600':'text-red-500'} font-bold">$${r.profit.toFixed(0)}</td>
                    <td class="text-right text-blue-600 font-bold">${(r.cr*100).toFixed(2)}%</td>
                    <td class="text-right">${r.roi.toFixed(0)}%</td>
                    <td class="text-center"><span class="px-2 py-0.5 rounded text-[9px] font-bold uppercase ${tagColor}">${view === 'custom' ? 'Custom' : r.status}</span></td>
                `;
                tbody.appendChild(tr);
            });
            getEl('page-num').innerText = state.page;
        }

        function changePage(d) {
            const max = Math.ceil(state.display.length / state.pageSize);
            if(state.page + d > 0 && state.page + d <= max) { state.page += d; renderTable(); }
        }

        function exportData() {
            const wb = XLSX.utils.book_new();
            const useCidr = getEl('chk-cidr').checked;
            const fmt = ip => useCidr && !String(ip).includes('/') ? ip+'/24' : ip;
            
            const checks = [
                { id: 'chk-pure', name: 'Pure List', f: r => r.isPure },
                { id: 'chk-gold', name: 'Gold List', f: r => r.isGold },
                { id: 'chk-cust', name: 'Custom List', f: r => r.isCust },
                { id: 'chk-other', name: 'Other Active', f: r => r.status === 'Other' },
                { id: 'chk-bl', name: 'Blacklist', f: r => r.isBl }
            ];

            let count = 0;
            checks.forEach(c => {
                if(getEl(c.id).checked) {
                    const rows = state.processed.filter(c.f);
                    if(rows.length) {
                        const data = rows.map(r => ({
                            IP_Range: fmt(r.ip), Clicks: r.clicks, Conversions: r.conv, Revenue: r.rev, Cost: r.cost, Profit: r.profit,
                            CR: (r.cr*100).toFixed(2)+'%', ROI: r.roi.toFixed(2)+'%', Tag: r.status
                        }));
                        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), c.name);
                        count++;
                    }
                }
            });

            if(count) XLSX.writeFile(wb, "Executive_Export.xlsx");
            else alert("Please select a list to download");
        }

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
        });
    </script>
</body>
</html>
