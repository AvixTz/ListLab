<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ListLab V49 - Enhanced Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">

    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LISTLAB V49 - ENHANCED EDITION
           Based on V48 by Nir & Yael
           Improvements: Scoring, BL tiers, Wilson CI, 
           localStorage, compact KPIs, shortcuts, anomaly detection
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        body { font-family: 'Assistant', sans-serif; background: #eef0f4; height: 100vh; overflow: hidden; color: #1e293b; font-size: 14px; box-sizing: border-box; margin: 0; }
        *, *::before, *::after { box-sizing: border-box; }
        .num-font { font-family: 'Inter', sans-serif; }
        
        .main-wrapper { width: 100%; height: 100vh; display: flex; flex-direction: column; padding: 6px; gap: 5px; }
        .glass-header { background: white; border-radius: 10px; padding: 0 1.2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.04); display: flex; justify-content: space-between; align-items: center; height: 50px; border: 1px solid #e5e7eb; flex-shrink: 0; }
        .dash-container { flex: 1; min-height: 0; background: white; border-radius: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); display: flex; overflow: hidden; border: 1px solid #e0e3e8; }
        
        .dash-sidebar { width: 310px; background: #f6f7f9; border-left: 1px solid #e0e3e8; display: flex; flex-direction: column; overflow-y: auto; padding: 10px; gap: 6px; flex-shrink: 0; }
        .dash-content { flex: 1; min-height: 0; background: #fafbfc; display: flex; flex-direction: column; overflow: hidden; }

        .control-box { border-radius: 8px; padding: 10px; border: 1px solid #e5e7eb; background: white !important; position: relative; transition: box-shadow 0.15s; }
        .control-box:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .control-box.border-blue-200 { border-right: 3px solid #3b82f6; }
        .control-box.border-slate-300 { border-right: 3px solid #94a3b8; }
        .control-box.border-amber-200 { border-right: 3px solid #f59e0b; }
        .control-box.border-purple-200 { border-right: 3px solid #8b5cf6; }
        .control-box.border-slate-200 { border-right: 3px solid #64748b; }
        .control-box.border-red-200 { border-right: 3px solid #ef4444; }
        
        .control-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .control-item { display: flex; flex-direction: column; }
        .lbl-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
        .lbl-sm { font-size: 11px; font-weight: 700; color: #64748b; }
        
        input[type=range] { height: 4px; border-radius: 2px; background: #e2e8f0; outline: none; appearance: none; cursor: pointer; width: 100%; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%; background: currentColor; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .dash-input { width: 46px; font-family: 'Inter', sans-serif; font-weight: 700; font-size: 11px; text-align: center; border: 1px solid #ddd; border-radius: 5px; padding: 2px; background: #fafbfc; height: 24px; transition: border-color 0.15s; }
        .dash-input:focus { border-color: #3b82f6; outline: none; }

        .collapsible-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 2px 0; }
        .collapsible-content { display: none; }
        .collapsible-content.open { display: block; }
        .collapse-icon { transition: transform 0.2s; }
        .collapse-icon.open { transform: rotate(180deg); }

        /* === KPI CARDS === */
        .kpi-container { display: flex; flex-wrap: nowrap; gap: 6px; overflow-x: auto; padding: 3px 0; }
        .kpi-card { 
            background: white; border: 1px solid #e2e5e9; border-radius: 8px; 
            cursor: pointer; transition: all 0.15s; flex: 1; min-width: 148px;
            display: flex; flex-direction: column; overflow: hidden;
        }
        .kpi-card:hover { box-shadow: 0 3px 12px -2px rgba(0,0,0,0.1); transform: translateY(-1px); }
        .kpi-card-header { display: flex; justify-content: space-between; align-items: center; padding: 7px 10px 5px; }
        .kpi-card-count { font-family: 'Inter', sans-serif; font-size: 22px; font-weight: 900; color: #1e293b; line-height: 1; }
        .kpi-card-label { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.03em; display: flex; align-items: center; gap: 3px; }
        .kpi-top-row { display: grid; grid-template-columns: 1fr 1fr; gap: 4px; padding: 4px 8px; }
        .kpi-top-cell { background: #f8f9fb; border: 1px solid #eef0f3; border-radius: 5px; padding: 3px 6px; text-align: center; }
        .kpi-top-lbl { font-size: 8px; font-weight: 700; color: #9ca3af; text-transform: uppercase; }
        .kpi-top-val { font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 800; color: #374151; }
        .kpi-mid-row { display: grid; grid-template-columns: 1fr 1fr 1fr; border-top: 1px solid #f1f2f4; }
        .kpi-mid-cell { padding: 3px 6px; text-align: center; }
        .kpi-mid-lbl { font-size: 8px; font-weight: 700; color: #b0b5bc; text-transform: uppercase; }
        .kpi-mid-val { font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 700; color: #4b5563; }
        .kpi-bot-row { display: grid; grid-template-columns: 1fr 1fr 1fr; border-top: 1px solid #eef0f3; background: #fcfcfd; }
        .kpi-bot-cell { padding: 4px 6px; text-align: center; }
        .kpi-bot-lbl { font-size: 8px; font-weight: 700; color: #9ca3af; }
        .kpi-bot-val { font-family: 'Inter', sans-serif; font-size: 12px; font-weight: 800; }
        
        .kpi-pure { border-right: 3px solid #eab308; }
        .kpi-gold { border-right: 3px solid #f59e0b; }
        .kpi-potential { border-right: 3px solid #10b981; }
        .kpi-ignore { border-right: 3px solid #9ca3af; }
        .kpi-blacklist { border-right: 3px solid #ef4444; }
        .kpi-testing { border-right: 3px solid #3b82f6; }
        .kpi-custom-active { border: 2px solid #8b5cf6; box-shadow: 0 0 12px rgba(139, 92, 246, 0.2); }

        .stat-lbl { font-size: 10px; font-weight: 700; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.03em; }
        
        /* Focus mode: F key hides everything except table */
        .focus-mode .collapsible-section,
        .focus-mode #section-dashboard,
        .focus-mode .dash-sidebar { display: none !important; }
        .focus-mode .dash-content { flex: 1; }
        .focus-mode .table-toolbar { padding: 4px 8px !important; }
        
        /* Section collapse */
        .section-toggle { 
            position: absolute; top: 4px; left: 4px; z-index: 5;
            width: 20px; height: 20px; border-radius: 50%; border: 1px solid #ddd;
            background: white; cursor: pointer; display: flex; align-items: center; 
            justify-content: center; font-size: 10px; color: #999; transition: all 0.15s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .section-toggle:hover { background: #f3f4f6; color: #333; }
        .section-collapsed .section-inner { display: none !important; }
        .section-collapsed { padding: 0 !important; padding-left: 28px !important; min-height: 22px !important; }
        .section-collapsed .section-toggle { top: 1px; }
        
        /* Focus indicator */
        #focus-badge { 
            position: fixed; top: 8px; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 3px 14px; border-radius: 20px;
            font-size: 11px; font-weight: 700; z-index: 100; display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .focus-mode #focus-badge { display: flex; align-items: center; gap: 6px; }
        .stat-val { font-family: 'Inter', sans-serif; font-weight: 700; font-size: 13px; color: #1e293b; }
        
        .g-item { text-align: center; border-left: 1px solid #f3f4f6; flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 0 5px; }
        .g-item:last-child { border: none; }
        .g-lbl { font-size: 10px; font-weight: 700; color: #9ca3af; text-transform: uppercase; }
        .g-val { font-size: 13px; font-weight: 800; color: #1e293b; font-family: 'Inter', sans-serif; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .chk-input { width: 13px; height: 13px; accent-color: #4f46e5; cursor: pointer; }
        
        th { font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; color: #6b7280; font-weight: 800; background: #f3f4f6; position: sticky; top: 0; z-index: 20; padding: 8px 10px; cursor: pointer; border-bottom: 2px solid #e5e7eb; }
        th:hover { background: #e8eaed; color: #374151; }
        
        .summary-cell {
            background: #f0f0ff; color: #312e81; font-weight: 800;
            font-family: 'Inter', sans-serif; font-size: 11px; padding: 7px 10px;
            position: sticky; top: 34px; z-index: 19; border-bottom: 2px solid #c7d2fe;
        }

        td { font-size: 12px; border-bottom: 1px solid #f3f4f6; padding: 6px 10px; }
        tr:hover td { background-color: #f8f9fb; }
        
        .row-pure { background: rgba(253, 224, 71, 0.08); }
        .row-gold { background: rgba(245, 158, 11, 0.06); }
        .row-potential { background: rgba(16, 185, 129, 0.06); }
        .row-blacklist { background: rgba(239, 68, 68, 0.06); }
        .row-blacklist-soft { background: rgba(251, 146, 60, 0.06); }
        .row-watch { background: rgba(234, 179, 8, 0.05); }
        .row-testing { background: rgba(59, 130, 246, 0.05); }
        .row-custom { background: rgba(139, 92, 246, 0.06); }
        .row-summary { background: #f0f0ff; font-weight: 700; }

        .cat-badge { font-size: 10px; font-weight: 800; padding: 2px 7px; border-radius: 4px; white-space: nowrap; letter-spacing: 0.02em; }
        .badge-pure { background: #fef3c7; color: #92400e; }
        .badge-gold { background: #fde68a; color: #92400e; }
        .badge-potential { background: #d1fae5; color: #065f46; }
        .badge-ignore { background: #f3f4f6; color: #6b7280; }
        .badge-blacklist { background: #fee2e2; color: #991b1b; }
        .badge-blacklist-soft { background: #ffedd5; color: #9a3412; }
        .badge-watch { background: #fef9c3; color: #854d0e; }
        .badge-testing { background: #dbeafe; color: #1e40af; }
        .badge-custom { background: #ede9fe; color: #7c3aed; }
        .vol-badge { font-size: 9px; font-weight: 800; padding: 1px 5px; border-radius: 3px; letter-spacing: 0.3px; }
        .vol-high { background: #dcfce7; color: #166534; }
        .vol-mid { background: #f1f5f9; color: #475569; }
        .vol-low { background: #fef2f2; color: #991b1b; }
        .badge-summary { background: #e0e7ff; color: #4338ca; }

        .score-pill { font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; padding: 2px 7px; border-radius: 10px; }
        .score-high { background: #fbbf24; color: #78350f; }
        .score-mid { background: #10b981; color: white; }
        .score-low { background: #e8eaed; color: #6b7280; }

        .btn-upload { background: white; color: #4338ca; border: 1.5px dashed #a5b4fc; padding: 10px; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .btn-upload:hover { background: #eef2ff; border-color: #6366f1; }

        .filter-item { margin-bottom: 6px; position: relative; }
        .filter-header { display: flex; justify-content: space-between; align-items: center; font-size: 11px; font-weight: 700; color: #475569; margin-bottom: 2px; }
        .filter-btn { width: 100%; text-align: right; background: #fafbfc; border: 1px solid #ddd; padding: 6px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: border-color 0.15s; }
        .filter-btn:hover { border-color: #3b82f6; }
        .filter-popup { position: absolute; top: 100%; left: 0; width: 240px; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 12px 28px rgba(0,0,0,0.12); z-index: 50; display: none; flex-direction: column; padding: 8px; margin-top: 4px; }
        .filter-popup.show { display: flex; }
        .filter-search { width: 100%; padding: 5px 9px; border: 1px solid #e5e7eb; border-radius: 5px; font-size: 11px; margin-bottom: 6px; }
        .filter-list { max-height: 150px; overflow-y: auto; display: flex; flex-direction: column; gap: 3px; border: 1px solid #f3f4f6; padding: 4px; border-radius: 5px; margin-bottom: 6px; }
        .filter-opt { display: flex; align-items: center; gap: 6px; font-size: 11px; color: #334155; cursor: pointer; user-select: none; padding: 3px 5px; border-radius: 4px; }
        .filter-opt:hover { background: #f3f4f6; }
        .btn-tiny { font-size: 11px; padding: 3px 10px; border-radius: 4px; cursor: pointer; font-weight: 600; }
        .btn-apply { background: #4f46e5; color: white; }
        .btn-cancel { background: #f3f4f6; color: #64748b; }

        .level-badge { font-size: 10px; font-weight: 800; padding: 2px 6px; border-radius: 4px; }
        .level-1 { background: #fee2e2; color: #991b1b; }
        .level-2 { background: #fef3c7; color: #92400e; }
        .level-3 { background: #d1fae5; color: #065f46; }

        .mapping-row { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; }
        .mapping-row label { font-size: 10px; font-weight: 700; color: #6b7280; min-width: 48px; }
        .mapping-row select { flex: 1; font-size: 10px; padding: 3px 5px; border: 1px solid #ddd; border-radius: 5px; }

        .threshold-info { font-size: 10px; color: #6b7280; background: #f6f7f9; padding: 4px 8px; border-radius: 5px; margin-top: 4px; border: 1px solid #eee; }
        .threshold-val { font-weight: 800; color: #4f46e5; }
        
        .search-box { position: relative; }
        .search-box input { width: 150px; padding: 5px 10px 5px 28px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px; background: #fafbfc; transition: all 0.15s; }
        .search-box input:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.08); background: white; }
        .search-box i { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); color: #9ca3af; pointer-events: none; }
        .search-highlight { background: #fef08a !important; padding: 0 2px; border-radius: 2px; }
        .icloud-badge { font-size: 10px; margin-left: 4px; opacity: 0.7; cursor: help; color: #3b82f6; }
        
        .icloud-switcher, .agg-switcher { display: flex; align-items: center; gap: 3px; padding: 2px 4px; background: #f3f4f6; border-radius: 6px; border: 1px solid #e5e7eb; }
        .switcher-options { display: flex; gap: 1px; }
        .switcher-btn { padding: 2px 6px; font-size: 10px; border: none; background: transparent; border-radius: 4px; cursor: pointer; opacity: 0.45; transition: all 0.15s; font-weight: 600; }
        .icloud-switcher .switcher-btn:hover, .agg-switcher .switcher-btn:hover { opacity: 0.75; background: #e5e7eb; }
        .icloud-switcher .switcher-btn.active { opacity: 1; background: #4f46e5; color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .agg-switcher .switcher-btn.active { opacity: 1; background: #059669; color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        
        .sortable-th { cursor: pointer; user-select: none; transition: background 0.15s; }
        .sortable-th:hover { background: #e8eaed; }
        .sortable-th .sort-icon { font-size: 10px; opacity: 0.35; margin-right: 2px; }
        .sortable-th.sort-asc .sort-icon { opacity: 1; font-size: 0; }
        .sortable-th.sort-asc .sort-icon::after { content: 'â†‘'; font-size: 10px; }
        .sortable-th.sort-desc .sort-icon { opacity: 1; font-size: 0; }
        .sortable-th.sort-desc .sort-icon::after { content: 'â†“'; font-size: 10px; }
        
        .compare-badge { font-size: 9px; padding: 2px 6px; border-radius: 10px; font-weight: 700; }
        .badge-new { background: #d1fae5; color: #065f46; }
        .badge-improved { background: #dbeafe; color: #1e40af; }
        .badge-declined { background: #fee2e2; color: #991b1b; }
        .badge-gone { background: #f3f4f6; color: #6b7280; }
        
        .compare-panel { background: white; border: 1px solid #93c5fd; border-right: 3px solid #3b82f6; border-radius: 8px; padding: 8px; }
        .compare-stats { display: flex; gap: 8px; flex-wrap: wrap; }
        .compare-stat { text-align: center; padding: 5px 10px; background: #f8f9fb; border-radius: 6px; border: 1px solid #e5e7eb; }
        .compare-stat-val { font-size: 16px; font-weight: 800; font-family: 'Inter', sans-serif; }
        .compare-stat-lbl { font-size: 9px; color: #6b7280; font-weight: 600; }
        
        .change-delta { font-size: 9px; font-weight: 700; padding: 1px 3px; border-radius: 3px; font-family: 'Inter', sans-serif; display: inline-block; margin-bottom: 1px; }
        .delta-positive { background: #d1fae5; color: #059669; }
        .delta-negative { background: #fee2e2; color: #dc2626; }
        
        .performer-item { display: flex; justify-content: space-between; align-items: center; gap: 2px; padding: 2px 0; border-bottom: 1px solid #f3f4f6; flex-wrap: wrap; }
        .performer-item:last-child { border: none; }
        .performer-id { font-weight: 600; color: #374151; font-size: 11px; word-break: break-all; }
        .performer-val { font-weight: 700; font-family: 'Inter', sans-serif; white-space: nowrap; font-size: 11px; }

        .bl-mode-switcher { display: inline-flex; gap: 1px; background: #fee2e2; border-radius: 5px; padding: 2px; margin-right: 6px; }
        .bl-mode-btn { font-size: 9px; font-weight: 800; padding: 2px 7px; border-radius: 3px; cursor: pointer; border: none; background: transparent; color: #991b1b; opacity: 0.5; transition: all 0.15s; white-space: nowrap; }
        .bl-mode-btn.active { opacity: 1; background: #dc2626; color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.15); }
        .bl-mode-btn:hover:not(.active) { opacity: 0.8; background: #fca5a5; }
        
        .dash-sidebar select { font-size: 11px; border: 1px solid #ddd; border-radius: 5px; background: #fafbfc; transition: border-color 0.15s; }
        .dash-sidebar select:focus { border-color: #4f46e5; outline: none; }
        
        /* === TOAST NOTIFICATION === */
        .toast-container { position: fixed; top: 12px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 6px; pointer-events: none; }
        .toast { 
            background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px 16px; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.12); font-size: 12px; font-weight: 600;
            display: flex; align-items: center; gap: 8px; pointer-events: auto;
            animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
            max-width: 400px;
        }
        .toast-success { border-right: 3px solid #10b981; }
        .toast-info { border-right: 3px solid #3b82f6; }
        .toast-warn { border-right: 3px solid #f59e0b; }
        .toast-error { border-right: 3px solid #ef4444; }
        @keyframes toastIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-10px); } }
        
        /* === CONFIDENCE INTERVAL === */
        .ci-bar { display: inline-flex; align-items: center; gap: 2px; }
        .ci-range { font-size: 9px; color: #9ca3af; font-family: 'Inter', sans-serif; }
        .ci-indicator { width: 4px; height: 10px; border-radius: 1px; display: inline-block; }
        .ci-high { background: #10b981; }
        .ci-medium { background: #f59e0b; }
        .ci-low { background: #ef4444; }
        
        /* === ANOMALY FLAG === */
        .anomaly-flag { font-size: 9px; padding: 1px 4px; border-radius: 3px; font-weight: 800; margin-left: 3px; cursor: help; }
        .anomaly-fraud { background: #fecaca; color: #dc2626; }
        .anomaly-bot { background: #fed7aa; color: #ea580c; }
        .anomaly-outlier { background: #ddd6fe; color: #7c3aed; }
        
        /* === KEYBOARD SHORTCUTS HINT === */
        .shortcuts-hint { 
            position: fixed; bottom: 12px; right: 12px; background: rgba(30,41,59,0.9); 
            color: white; padding: 10px 14px; border-radius: 8px; font-size: 11px; 
            z-index: 100; display: none; backdrop-filter: blur(8px);
        }
        .shortcuts-hint.show { display: block; }
        .shortcut-key { background: rgba(255,255,255,0.15); padding: 1px 5px; border-radius: 3px; font-family: 'Inter', monospace; font-size: 10px; margin-left: 4px; }
        
        /* === BL SEVERITY INDICATOR === */
        .bl-severity { font-size: 9px; font-weight: 800; padding: 1px 5px; border-radius: 3px; margin-right: 4px; }
        .bl-hard { background: #dc2626; color: white; }
        .bl-soft { background: #fb923c; color: white; }
        .bl-watch { background: #fbbf24; color: #78350f; }
    </style>
</head>
<body>
    <div class="toast-container" id="toast-container"></div>
    <div id="focus-badge">ğŸ” Focus Mode â€” ×œ×—×¥ F ×œ×—×–×•×¨</div>
    
    <div class="main-wrapper">
        <div class="glass-header">
            <div class="flex items-center gap-2.5 shrink-0">
                <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 text-white p-1.5 rounded-lg">
                    <i data-lucide="activity" class="w-4 h-4"></i>
                </div>
                <div>
                    <h1 class="text-sm font-extrabold text-slate-800 leading-none">ListLab <span class="text-indigo-500 font-black">V49</span></h1>
                    <div class="text-[9px] text-slate-400 font-medium">Enhanced Edition</div>
                </div>
            </div>
            
            <div id="global-stats" class="flex-1 flex justify-center items-center">
                <span class="text-sm text-slate-400">×˜×¢×Ÿ ×§×•×‘×¥ ×œ×”×ª×—×œ×”... <span class="shortcut-key">?</span> ×œ×§×™×¦×•×¨×™ ××§×œ×“×ª</span>
            </div>
            
            <div id="medians-box" class="hidden shrink-0 text-[11px] bg-gray-50 px-3 py-1 rounded-lg border border-gray-200">
                <span class="text-slate-500">Median PPC:</span> <strong id="med-ppc" class="text-amber-600 num-font">$0</strong>
                <span class="mx-2 text-slate-300">|</span>
                <span class="text-slate-500">Median CR:</span> <strong id="med-cr" class="text-blue-600 num-font">0%</strong>
                <span class="mx-2 text-slate-300">|</span>
                <span class="text-slate-500">×¡×£ ×§×œ×™×§×™×:</span> <strong id="click-threshold" class="text-red-500 num-font">0</strong>
            </div>
        </div>

        <div class="dash-container">
            <aside class="dash-sidebar custom-scrollbar">
                <div class="btn-upload" id="drop-zone">
                    <input type="file" id="file-input" class="hidden" accept=".xlsx,.csv">
                    <div class="flex items-center justify-center gap-2 text-indigo-600">
                        <i data-lucide="upload-cloud" class="w-3.5 h-3.5"></i>
                        <span class="text-xs font-bold">×˜×¢×Ÿ ×§×•×‘×¥ CSV / Excel</span>
                    </div>
                    <div id="filename" class="text-[10px] text-indigo-400 truncate mt-0.5"></div>
                </div>
                
                <div class="flex gap-1.5">
                    <button id="btn-compare" class="flex-1 flex items-center justify-center gap-1 bg-white border border-gray-200 text-gray-600 py-1 rounded-md text-[10px] font-bold hover:bg-gray-50 hover:border-indigo-300 hover:text-indigo-600 disabled:opacity-40 transition-colors" disabled>
                        <i data-lucide="git-compare" class="w-3 h-3"></i> ×”×©×•×•×” ×§×‘×¦×™×
                    </button>
                    <input type="file" id="compare-input" class="hidden" accept=".xlsx,.csv">
                    <button id="btn-clear-compare" class="hidden px-2 py-1.5 bg-slate-100 border border-slate-200 text-slate-600 rounded text-[11px] font-bold hover:bg-slate-200">
                        <i data-lucide="x" class="w-3 h-3"></i>
                    </button>
                </div>
                
                <div id="compare-panel" class="compare-panel hidden">
                    <div class="flex items-center justify-between mb-2">
                        <span class="text-[11px] font-bold text-indigo-700">×ª×•×¦××•×ª ×”×©×•×•××”</span>
                        <span id="compare-file-name" class="text-[10px] text-blue-500 truncate max-w-[150px]"></span>
                    </div>
                    <div class="compare-stats">
                        <div class="compare-stat"><div class="compare-stat-val text-green-600" id="cmp-new">0</div><div class="compare-stat-lbl">×—×“×©×™×</div></div>
                        <div class="compare-stat"><div class="compare-stat-val text-blue-600" id="cmp-improved">0</div><div class="compare-stat-lbl">×”×©×ª×¤×¨×•</div></div>
                        <div class="compare-stat"><div class="compare-stat-val text-red-600" id="cmp-declined">0</div><div class="compare-stat-lbl">×™×¨×“×•</div></div>
                        <div class="compare-stat"><div class="compare-stat-val text-slate-500" id="cmp-gone">0</div><div class="compare-stat-lbl">× ×¢×œ××•</div></div>
                    </div>
                </div>

                <div id="hierarchy-box" class="hidden bg-white border border-amber-200 border-r-4 rounded-lg p-2">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2 text-amber-700 text-[11px] font-bold">
                            <i data-lucide="git-branch" class="w-3 h-3"></i><span>×”×™×¨×¨×›×™×” ×¤×¢×™×œ×”</span>
                        </div>
                        <div id="level-badges" class="flex gap-1"></div>
                    </div>
                </div>

                <div class="control-box border-blue-200">
                    <div class="text-[11px] font-bold text-slate-700 mb-2 flex items-center gap-1.5">
                        <i data-lucide="layers" class="w-3.5 h-3.5 text-blue-500"></i> ×¡×•×’ ××–×”×” ×•×¡×£ ×§×œ×™×§×™×
                    </div>
                    <div class="grid grid-cols-2 gap-1.5 mb-1.5">
                        <div>
                            <label class="text-[10px] text-slate-500 mb-1 block">×¢××•×“×ª ××–×”×”:</label>
                            <select id="col-ip" class="w-full text-[11px] border border-gray-200 rounded p-1.5 font-medium"></select>
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 mb-1 block">×¡×•×’:</label>
                            <select id="identifier-type" class="w-full text-[11px] border border-gray-200 rounded p-1.5 font-medium">
                                <option value="auto">ğŸ” ××•×˜×•××˜×™</option>
                                <option value="subid">ğŸ¯ SubID</option>
                                <option value="zone">ğŸ“ Zone</option>
                                <option value="ip">ğŸŒ IP</option>
                            </select>
                        </div>
                    </div>
                    <div id="detected-type" class="text-[10px] text-green-600 font-bold mb-1.5 hidden"></div>
                    <div class="mb-1.5">
                        <label class="text-[10px] text-slate-500 mb-0.5 block">×¨××ª ×˜×¨××¤×™×§:</label>
                        <select id="ip-level" class="w-full text-[11px] border border-gray-200 rounded p-1 font-medium">
                            <option value="1" selected>×¨××” 1 - SubID/IP32 (1.5Ã—)</option>
                            <option value="2">×¨××” 2 - Zone/IP24 (3Ã—)</option>
                            <option value="3">×¨××” 3 - IP16 (5Ã—)</option>
                        </select>
                    </div>
                    <div class="threshold-info">
                        ×¡×£ ×§×œ×™×§×™× × ×•×›×—×™: <span class="threshold-val" id="current-threshold">1,500</span>
                        <br>× ×•×¡×—×”: ××›×¤×™×œ Ã— (100 / CR%)
                    </div>
                </div>

                <!-- === BL SEVERITY CONFIG === -->
                <div class="control-box border-red-200">
                    <div class="collapsible-header" onclick="toggleSection('bl-config')">
                        <div class="text-[11px] font-bold text-slate-700 flex items-center gap-1.5">
                            <i data-lucide="shield-alert" class="w-3.5 h-3.5 text-red-500"></i> ×”×’×“×¨×•×ª Blacklist
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-600 collapse-icon" id="bl-config-icon"></i>
                    </div>
                    <div class="collapsible-content" id="bl-config-content">
                        <div class="mt-2 space-y-2">
                            <div class="flex items-center gap-2 text-[10px]">
                                <span class="font-bold text-slate-600 w-20">×—×™×©×•×‘ ×¡×£:</span>
                                <div class="bl-mode-switcher" style="background:#fef3c3;">
                                    <button class="bl-mode-btn active" data-blcalc="median" onclick="setBlCalc('median')" title="××—×¦×™×•×Ÿ â€” ×©××¨× ×™, ×¢××™×“ ×œ-outliers" style="color:#854d0e;">××—×¦×™×•×Ÿ</button>
                                    <button class="bl-mode-btn" data-blcalc="mean" onclick="setBlCalc('mean')" title="×××•×¦×¢ â€” ××’×¨×¡×™×‘×™, ×—×•×¡× ×™×•×ª×¨" style="color:#854d0e;">×××•×¦×¢</button>
                                    <button class="bl-mode-btn" data-blcalc="jenks" onclick="setBlCalc('jenks')" title="Jenks â€” ××•×¦× ×¤×¢×¨×™× ×˜×‘×¢×™×™× ×‘×“××˜×”" style="color:#854d0e;">ğŸ¤– Auto</button>
                                </div>
                            </div>
                            <div id="bl-jenks-info" class="hidden bg-amber-50 rounded p-2 text-[9px] text-amber-800 border border-amber-200">
                                <span class="font-bold">ğŸ¤– Jenks BL:</span> <span id="bl-jenks-text"></span>
                            </div>
                            <div class="flex items-center gap-2 text-[10px]">
                                <span class="font-bold text-slate-600 w-20">××¦×‘ BL:</span>
                                <div class="bl-mode-switcher">
                                    <button class="bl-mode-btn active" data-blmode="ppc" onclick="setBlMode('ppc')" title="×—×¡×•× ×œ×¤×™ PPC">PPC</button>
                                    <button class="bl-mode-btn" data-blmode="cr" onclick="setBlMode('cr')" title="×—×¡×•× ×œ×¤×™ CR">CR</button>
                                    <button class="bl-mode-btn" data-blmode="roi" onclick="setBlMode('roi')" title="×—×¡×•× ×œ×¤×™ ROI">ROI</button>
                                    <button class="bl-mode-btn" data-blmode="score" onclick="setBlMode('score')" title="×—×¡×•× ×œ×¤×™ Score (PPC+ROI+CR ××©×•×§×œ×œ)">Score</button>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 text-[10px]">
                                <span class="font-bold text-slate-600 w-20">××›×¤×™×œ BL:</span>
                                <input type="number" id="bl-threshold-mult" value="0.5" step="0.05" min="0.1" max="1.0" class="w-16 text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center">
                                <span class="text-slate-400">Ã— ×××•×¦×¢ (×‘×¨×™×¨×ª ××—×“×œ: 0.5)</span>
                            </div>
                            <div class="flex items-center gap-2 text-[10px]">
                                <span class="font-bold text-slate-600 w-20">Soft BL ROI:</span>
                                <input type="number" id="bl-soft-roi" value="-30" step="5" class="w-16 text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center">
                                <span class="text-slate-400">% (×‘×™×Ÿ Soft ×œ-Hard)</span>
                            </div>
                            <div class="bg-red-50 rounded p-2 text-[10px] text-red-700 border border-red-100">
                                <div class="font-bold mb-1">×¨××•×ª Blacklist:</div>
                                <div class="flex items-center gap-1 mb-0.5"><span class="bl-severity bl-hard">HARD</span> 0 Conv / ROI ×§×™×¦×•× ×™ / Jenks bottom</div>
                                <div class="flex items-center gap-1 mb-0.5"><span class="bl-severity bl-soft">SOFT</span> ×¨×•×•×— ×©×œ×™×œ×™ ×¢××•×§ / Jenks mid-low</div>
                                <div class="flex items-center gap-1"><span class="bl-severity bl-watch">WATCH</span> ×‘×™×¦×•×¢ ×—×œ×© (×œ×™×“ BL)</div>
                                <div class="mt-1.5 pt-1.5 border-t border-red-200 text-[9px]">
                                    <div>×¡×£ × ×•×›×—×™ (<span id="bl-calc-label">××—×¦×™×•×Ÿ</span>):</div>
                                    <div class="font-bold num-font text-red-800" id="bl-current-threshold-display">×˜×¢×Ÿ ×§×•×‘×¥...</div>
                                    <div class="text-red-400 mt-0.5">××—×¦×™×•×Ÿ = ×©××¨× ×™ | ×××•×¦×¢ = ××’×¨×¡×™×‘×™ | Jenks = ××•×ª×× ×œ×“××˜×”</div>
                                </div>
                            </div>
                            <button onclick="processData()" class="w-full bg-red-600 text-white py-1.5 rounded-md text-xs font-bold hover:bg-red-700 flex items-center justify-center gap-1 transition-colors">
                                <i data-lucide="refresh-cw" class="w-3 h-3"></i> ×¢×“×›×Ÿ
                            </button>
                        </div>
                    </div>
                </div>

                <div class="control-box border-slate-300">
                    <div class="collapsible-header" onclick="toggleSection('filters')">
                        <div class="text-[11px] font-bold text-slate-700 flex items-center gap-1.5">
                            <i data-lucide="filter" class="w-3.5 h-3.5 text-slate-400"></i> ×¡×™× ×•×Ÿ ××ª×§×“×
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-600 collapse-icon open" id="filters-icon"></i>
                    </div>
                    <div class="collapsible-content open" id="filters-content">
                        <div id="filters-list" class="mt-2"></div>
                        <button onclick="showAddFilterMenu()" id="btn-add-filter" class="hidden w-full mt-2 border border-dashed border-indigo-300 text-indigo-600 rounded p-1.5 text-[10px] font-bold hover:bg-indigo-50 flex items-center justify-center gap-1">
                            <i data-lucide="plus" class="w-3 h-3"></i> ×”×•×¡×£ ××¡× ×Ÿ
                        </button>
                        <select id="col-selector" class="hidden w-full mt-1 text-[11px] border border-slate-300 rounded p-1" onchange="createNewFilter(this.value)">
                            <option value="">×‘×—×¨ ×¢××•×“×”...</option>
                        </select>
                        <div id="filter-msg" class="text-[11px] text-slate-400 text-center py-2 italic">×˜×¢×Ÿ ×§×•×‘×¥ ×›×“×™ ×œ×”×ª×—×™×œ</div>
                    </div>
                </div>

                <div class="control-box border-amber-200">
                    <div class="text-[11px] font-bold text-slate-700 mb-2 flex items-center justify-between">
                        <div class="flex items-center gap-1.5">
                            <i data-lucide="sliders" class="w-3.5 h-3.5 text-amber-500"></i> TOP % Thresholds + Smart BL
                        </div>
                        <div class="flex items-center gap-1">
                            <select id="auto-metric" class="text-[10px] border border-amber-300 rounded px-1 py-0.5 bg-amber-50 font-bold text-amber-700" disabled>
                                <option value="score">Score</option>
                                <option value="ppc">PPC</option>
                                <option value="roi">ROI</option>
                                <option value="cr">CR</option>
                            </select>
                            <button onclick="autoDetectThresholds()" id="btn-auto-thresh" class="flex items-center gap-1 bg-amber-500 text-white px-2 py-0.5 rounded text-[10px] font-bold hover:bg-amber-600 transition-colors disabled:opacity-40" disabled>
                                <i data-lucide="sparkles" class="w-3 h-3"></i> Smart Auto
                            </button>
                        </div>
                    </div>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="lbl-row"><span class="lbl-sm">ğŸ’ PURE</span><input type="number" id="pure-pct-num" value="10" class="dash-input text-amber-600"></div>
                            <input type="range" id="pure-pct" min="1" max="50" value="10" class="text-amber-500">
                        </div>
                        <div class="control-item">
                            <div class="lbl-row"><span class="lbl-sm">ğŸ¥‡ GOLD</span><input type="number" id="gold-pct-num" value="25" class="dash-input text-amber-600"></div>
                            <input type="range" id="gold-pct" min="1" max="70" value="25" class="text-amber-500">
                        </div>
                    </div>
                    <div id="auto-thresh-info" class="hidden threshold-info mt-2 border-amber-200 bg-amber-50" style="line-height:1.6;">
                        <div class="text-amber-700 font-bold mb-1">ğŸ¤– Smart Auto Results:</div>
                        <div id="auto-thresh-text" class="text-amber-800 text-[10px] num-font"></div>
                    </div>
                </div>

                <div class="control-box border-purple-200">
                    <div class="collapsible-header" onclick="toggleSection('custom')">
                        <div class="text-[11px] font-bold text-slate-700 flex items-center gap-1.5">
                            <i data-lucide="list-filter" class="w-3.5 h-3.5 text-purple-500"></i> Custom List
                            <span id="custom-badge" class="hidden text-[9px] bg-purple-600 text-white px-1.5 py-0.5 rounded-full">×¤×¢×™×œ</span>
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-purple-600 collapse-icon" id="custom-icon"></i>
                    </div>
                    <div class="collapsible-content" id="custom-content">
                        <div class="flex items-center gap-2 mb-2 mt-1.5">
                            <input type="checkbox" id="custom-enabled" class="chk-input">
                            <label for="custom-enabled" class="text-[11px] font-bold text-gray-700">×”×¤×¢×œ Custom List</label>
                        </div>
                        <div class="grid grid-cols-2 gap-1.5 mb-1.5">
                            <div class="bg-gray-50 rounded-md p-1.5 border border-gray-200">
                                <div class="text-[10px] font-bold text-gray-600 mb-1">Conv</div>
                                <div class="flex gap-1">
                                    <div class="flex-1"><input type="number" id="cust-conv-min" value="1" min="0" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="Min"></div>
                                    <span class="text-slate-300 self-center">-</span>
                                    <div class="flex-1"><input type="number" id="cust-conv-max" value="" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="âˆ"></div>
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-md p-1.5 border border-gray-200">
                                <div class="text-[10px] font-bold text-gray-600 mb-1">Score</div>
                                <div class="flex gap-1">
                                    <div class="flex-1"><input type="number" id="cust-score-min" value="0" step="0.1" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="Min"></div>
                                    <span class="text-slate-300 self-center">-</span>
                                    <div class="flex-1"><input type="number" id="cust-score-max" value="" step="0.1" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="âˆ"></div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-1.5 mb-1.5">
                            <div class="bg-gray-50 rounded-md p-1.5 border border-gray-200">
                                <div class="text-[10px] font-bold text-gray-600 mb-1">Clicks</div>
                                <div class="flex gap-1">
                                    <div class="flex-1"><input type="number" id="cust-clicks-min" value="0" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="Min"></div>
                                    <span class="text-slate-300 self-center">-</span>
                                    <div class="flex-1"><input type="number" id="cust-clicks-max" value="" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="âˆ"></div>
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-md p-1.5 border border-gray-200">
                                <div class="text-[10px] font-bold text-gray-600 mb-1">ROI%</div>
                                <div class="flex gap-1">
                                    <div class="flex-1"><input type="number" id="cust-roi-min" value="-100" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="Min"></div>
                                    <span class="text-slate-300 self-center">-</span>
                                    <div class="flex-1"><input type="number" id="cust-roi-max" value="" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="âˆ"></div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-1.5 mb-1.5">
                            <div class="bg-gray-50 rounded-md p-1.5 border border-gray-200">
                                <div class="text-[10px] font-bold text-gray-600 mb-1">CR%</div>
                                <div class="flex gap-1">
                                    <div class="flex-1"><input type="number" id="cust-cr-min" value="0" step="0.001" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="Min"></div>
                                    <span class="text-slate-300 self-center">-</span>
                                    <div class="flex-1"><input type="number" id="cust-cr-max" value="" step="0.001" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="âˆ"></div>
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-md p-1.5 border border-gray-200">
                                <div class="text-[10px] font-bold text-gray-600 mb-1">PPC</div>
                                <div class="flex gap-1">
                                    <div class="flex-1"><input type="number" id="cust-ppc-min" value="-1" step="0.001" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="Min"></div>
                                    <span class="text-slate-300 self-center">-</span>
                                    <div class="flex-1"><input type="number" id="cust-ppc-max" value="" step="0.001" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="âˆ"></div>
                                </div>
                            </div>
                        </div>
                        <button onclick="processData()" class="w-full mt-1 bg-indigo-600 text-white py-1.5 rounded-md text-xs font-bold hover:bg-indigo-700 flex items-center justify-center gap-1 transition-colors">
                            <i data-lucide="check" class="w-3 h-3"></i> ×”×—×œ ×¤×™×œ×˜×¨
                        </button>
                    </div>
                </div>

                <div id="mapping-box" class="hidden control-box border-slate-200">
                    <div class="collapsible-header" onclick="toggleSection('mapping')">
                        <div class="text-[11px] font-bold text-slate-700 flex items-center gap-1.5">
                            <i data-lucide="columns" class="w-3.5 h-3.5 text-slate-400"></i> ××™×¤×•×™ ×¢××•×“×•×ª
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-600 collapse-icon" id="mapping-icon"></i>
                    </div>
                    <div class="collapsible-content" id="mapping-content">
                        <div class="mapping-row"><label>×§×œ×™×§×™×</label><select id="col-clicks"></select></div>
                        <div class="mapping-row"><label>×”××¨×•×ª</label><select id="col-conv"></select></div>
                        <div class="mapping-row"><label>×”×›× ×¡×”</label><select id="col-rev"></select></div>
                        <div class="mapping-row"><label>×¢×œ×•×ª</label><select id="col-cost"></select></div>
                        <button onclick="processData()" class="w-full mt-2 bg-gray-700 text-white py-1.5 rounded-md text-xs font-bold hover:bg-gray-800 transition-colors">×¢×“×›×Ÿ ××™×¤×•×™</button>
                    </div>
                </div>

                <div class="mt-auto border-t border-gray-200 pt-2">
                    <div class="grid grid-cols-3 gap-1.5 mb-2 text-[10px] font-medium text-slate-500">
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="chk-pure" checked class="chk-input"> Pure</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="chk-gold" checked class="chk-input"> Gold</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="chk-potential" checked class="chk-input"> Potential</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="chk-bl" class="chk-input"> Blacklist</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="chk-custom" class="chk-input"> Custom</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="chk-cidr" class="chk-input"> CIDR</label>
                    </div>
                    <button onclick="exportData()" class="w-full bg-indigo-600 text-white py-1.5 rounded-lg text-xs font-bold hover:bg-indigo-700 flex items-center justify-center gap-2 transition-colors shadow-sm">
                        <i data-lucide="download" class="w-3.5 h-3.5"></i> ×™×™×¦×•× Excel <span class="shortcut-key text-indigo-300">E</span>
                    </button>
                </div>
            </aside>

            <main class="dash-content">
                <div id="section-kpi" class="p-2 bg-white border-b border-gray-100 shrink-0 relative collapsible-section">
                    <button class="section-toggle" onclick="toggleSectionCollapse('section-kpi')" title="×›×•×•×¥/×”×¨×—×‘">â–²</button>
                    <div class="section-inner">
                        <div id="kpi-container" class="kpi-container"></div>
                    </div>
                </div>
                
                <div id="section-dashboard" class="hidden border-b border-slate-200 collapsible-section">
                    <div class="flex items-center justify-between px-3 py-1.5 bg-gray-50 cursor-pointer border-b border-gray-100" onclick="toggleDashboard()">
                        <div class="flex items-center gap-2 text-[11px] font-bold text-gray-500">
                            <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                            <span>Dashboard ××”×™×¨</span> <span class="shortcut-key">D</span>
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 transition-transform" id="dash-toggle-icon"></i>
                    </div>
                    <div id="dashboard-content" class="hidden px-3 py-2 bg-gray-50">
                        <div class="grid grid-cols-4 gap-2">
                            <div class="bg-white rounded-lg p-2 border border-green-200 shadow-sm">
                                <div class="text-[11px] font-bold text-green-600 mb-1 flex items-center gap-1">
                                    <i data-lucide="trophy" class="w-3 h-3"></i> TOP 5 ×¨×•×•×—×™×™×
                                </div>
                                <div id="top-performers" class="space-y-0.5"></div>
                            </div>
                            <div class="bg-white rounded-lg p-2 border border-red-200 shadow-sm">
                                <div class="text-[11px] font-bold text-red-600 mb-1 flex items-center gap-1">
                                    <i data-lucide="trending-down" class="w-3 h-3"></i> TOP 5 ××¤×¡×™×“×™×
                                </div>
                                <div id="top-losers" class="space-y-0.5"></div>
                            </div>
                            <div class="bg-white rounded-lg p-2 border border-purple-200 shadow-sm">
                                <div class="text-[11px] font-bold text-purple-600 mb-1 flex items-center gap-1">
                                    <i data-lucide="star" class="w-3 h-3"></i> ×¨××•×™×™× ×œ×§××¤×™×™×Ÿ × ×¤×¨×“
                                </div>
                                <div id="outstanding-list" class="space-y-0.5"></div>
                            </div>
                            <div class="bg-white rounded-lg p-2 border border-blue-200 shadow-sm">
                                <div class="text-[11px] font-bold text-blue-600 mb-1 flex items-center gap-1">
                                    <i data-lucide="calculator" class="w-3 h-3"></i> Break-Even Calculator
                                </div>
                                <div class="text-[10px] space-y-1.5">
                                    <div class="bg-blue-50 rounded p-1.5">
                                        <div class="text-slate-600 mb-0.5 font-medium">×§×œ×™×§×™× ××§×¡×³ ×¢×“ ×”×¤×¡×“:</div>
                                        <div class="font-bold text-blue-700 num-font text-[13px]" id="be-max-clicks">-</div>
                                        <div class="text-[9px] text-slate-400 num-font" id="be-clicks-formula"></div>
                                    </div>
                                    <div class="bg-purple-50 rounded p-1.5">
                                        <div class="text-slate-600 mb-0.5 font-medium">CR ××™× ×™××œ×™ ×œ×¨×•×•×—:</div>
                                        <div class="font-bold text-purple-700 num-font text-[13px]" id="be-min-cr">-</div>
                                        <div class="text-[9px] text-slate-400 num-font" id="be-cr-formula"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="flex:1;min-height:0;display:flex;flex-direction:column;padding:8px;padding-top:4px;">
                    <div style="flex:1;min-height:0;display:flex;flex-direction:column;background:white;border-radius:8px;border:1px solid #e5e7eb;">
                        <div id="section-toolbar" class="table-toolbar px-3 py-2 border-b border-gray-100 bg-white shrink-0 relative" style="border-radius:8px 8px 0 0;">
                            <button class="section-toggle" onclick="toggleSectionCollapse('section-toolbar')" title="×›×•×•×¥/×”×¨×—×‘ ×¡×¨×’×œ" style="top:2px;left:2px;">â–²</button>
                            <div class="section-inner flex justify-between items-center flex-wrap gap-2">
                            <div class="flex items-center gap-3 flex-wrap">
                                <div class="search-box">
                                    <i data-lucide="search" class="w-3 h-3"></i>
                                    <input type="text" id="search-input" placeholder="×—×¤×© ××–×”×”... (Ctrl+F)" class="text-right">
                                </div>
                                
                                <div class="icloud-switcher">
                                    <div class="switcher-options">
                                        <button type="button" class="switcher-btn" data-value="hide" title="×”×¡×ª×¨ iCloud">ğŸš«</button>
                                        <button type="button" class="switcher-btn active" data-value="all" title="×”×¦×’ ×”×›×œ">âœ“</button>
                                        <button type="button" class="switcher-btn" data-value="only" title="×¨×§ iCloud">â˜ï¸</button>
                                    </div>
                                </div>
                                
                                <div class="agg-switcher" title="××¦×‘ ×ª×¦×•×’×”">
                                    <div class="switcher-options">
                                        <button type="button" class="switcher-btn active" data-agg="split" title="MICRO">MICRO</button>
                                        <button type="button" class="switcher-btn" data-agg="smart" title="MACRO">MACRO</button>
                                    </div>
                                    <span id="macro-warning" class="hidden text-[10px] bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full font-bold animate-pulse border border-orange-200 shadow-sm">âš ï¸ ×××•×’×“: <span id="macro-count">0</span> | ××¤×•×¦×œ: <span id="micro-count">0</span></span>
                                </div>
                                
                                <div id="show-changes-box" class="hidden flex items-center gap-1 border-l border-slate-200 pl-3">
                                    <label class="flex items-center gap-1 text-[11px] text-blue-600 font-bold cursor-pointer">
                                        <input type="checkbox" id="chk-show-changes" class="chk-input" checked> ×”×¦×’ ×©×™× ×•×™×™×
                                    </label>
                                </div>
                                
                                <div class="flex items-center gap-2">
                                    <span class="text-[11px] font-bold text-slate-400 uppercase">×ª×¦×•×’×”:</span>
                                    <select id="filter-view" class="text-sm bg-slate-50 border border-slate-200 rounded px-2 py-1 font-medium w-40">
                                        <option value="all">×”×›×œ</option>
                                        <option value="relevant">ğŸ¯ Relevant (P+G+Pot)</option>
                                        <option value="relevant_high">ğŸ¯â–² Relevant High</option>
                                        <option value="relevant_mid">ğŸ¯â–  Relevant Mid</option>
                                        <option value="relevant_low">ğŸ¯â–¼ Relevant Low</option>
                                        <option value="relevant_plus">ğŸš€ Relevant+ (incl. Test)</option>
                                        <option value="winners">âœ¨ Winners (P+G)</option>
                                        <option value="pure">ğŸ’ Pure</option>
                                        <option value="pure_high">ğŸ’â–² Pure High</option>
                                        <option value="pure_mid">ğŸ’â–  Pure Mid</option>
                                        <option value="pure_low">ğŸ’â–¼ Pure Low</option>
                                        <option value="gold">ğŸ¥‡ Gold</option>
                                        <option value="gold_high">ğŸ¥‡â–² Gold High</option>
                                        <option value="gold_mid">ğŸ¥‡â–  Gold Mid</option>
                                        <option value="gold_low">ğŸ¥‡â–¼ Gold Low</option>
                                        <option value="potential">ğŸŒ± Potential</option>
                                        <option value="ignore">ğŸ˜ Ignore</option>
                                        <option value="blacklist">ğŸš« Blacklist (Hard)</option>
                                        <option value="blacklist-soft">âš ï¸ Blacklist (Soft)</option>
                                        <option value="watch">ğŸ‘€ Watch</option>
                                        <option value="all-bl">ğŸ”´ All BL+Watch</option>
                                        <option value="testing">ğŸ”¬ Testing</option>
                                        <option value="custom">ğŸ¯ Custom</option>
                                        <option value="anomaly">ğŸš¨ Anomalies</option>
                                        <option value="compare-new">âœ¨ ×—×“×©×™×</option>
                                        <option value="compare-improved">ğŸ“ˆ ×”×©×ª×¤×¨×•</option>
                                        <option value="compare-declined">ğŸ“‰ ×™×¨×“×•</option>
                                    </select>
                                </div>

                                <div class="flex items-center gap-2">
                                    <span class="text-[11px] font-bold text-slate-400 uppercase">Vol:</span>
                                    <select id="filter-volume" class="text-sm bg-slate-50 border border-slate-200 rounded px-2 py-1 font-medium w-28" onchange="applyViewFilter(); renderKPIs(); renderTable(); renderGlobalStats(); updateMiniDashboard();">
                                        <option value="all">×”×›×œ</option>
                                        <option value="high">â–² High</option>
                                        <option value="mid">â–  Mid</option>
                                        <option value="low">â–¼ Low</option>
                                        <option value="high-mid">â–²â–  High+Mid</option>
                                    </select>
                                </div>

                                <div class="flex items-center gap-2" id="level-filter-box" style="display:none;">
                                    <span class="text-[11px] font-bold text-slate-400 uppercase">×©×›×‘×”:</span>
                                    <select id="level-view" class="text-sm bg-slate-50 border border-slate-200 rounded px-2 py-1 font-medium">
                                        <option value="detail">×¤×™×¨×•×˜ ×‘×œ×‘×“</option>
                                        <option value="all">×”×›×œ (×›×•×œ×œ ×¡×™×›×•××™×)</option>
                                    </select>
                                </div>

                                <div class="flex items-center gap-2 border-r border-slate-200 pr-3">
                                    <span class="text-[11px] font-bold text-slate-400">Min Score:</span>
                                    <input type="number" id="min-score-filter" value="0" step="0.1" class="w-16 text-sm border border-slate-200 rounded px-2 py-1 num-font">
                                </div>

                                <div class="flex items-center gap-2">
                                    <label class="flex items-center gap-1 text-[11px] text-slate-500 font-bold cursor-pointer">
                                        <input type="checkbox" id="chk-copy-cidr" class="chk-input"> CIDR
                                    </label>
                                    <button onclick="copyIPs()" id="btn-copy" class="flex items-center gap-1 bg-white border border-slate-200 text-slate-600 px-2 py-1 rounded hover:bg-slate-50 text-[11px] font-bold">
                                        <i data-lucide="copy" class="w-3 h-3"></i> ×”×¢×ª×§ <span class="shortcut-key">C</span>
                                    </button>
                                </div>
                            </div>
                            <div class="text-[11px] text-slate-400 font-medium">
                                ×¡×”"×›: <span id="disp-count" class="font-bold text-slate-800 num-font text-base">0</span>
                            </div>
                            </div>
                        </div>

                        <div class="custom-scrollbar" style="flex:1;min-height:0;overflow:auto;background:white;">
                            <table class="w-full text-sm relative">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="text-center w-8">#</th>
                                        <th class="text-center w-10" id="th-level" style="display:none;">Lvl</th>
                                        <th class="text-right sortable-th" data-sort="identifier" onclick="sortByColumn('identifier')">××–×”×” <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="category" onclick="sortByColumn('category')">×§×˜×’×•×¨×™×” <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="volumeTier" onclick="sortByColumn('volumeTier')">Vol <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="score" onclick="sortByColumn('score')">Score <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="clicks" onclick="sortByColumn('clicks')">Clicks <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="conv" onclick="sortByColumn('conv')">Conv <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="revenue" onclick="sortByColumn('revenue')">Revenue <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="cost" onclick="sortByColumn('cost')">Cost <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="profit" onclick="sortByColumn('profit')">Profit <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="roi" onclick="sortByColumn('roi')">ROI% <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="cr" onclick="sortByColumn('cr')">CR% <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="ppc" onclick="sortByColumn('ppc')">PPC <span class="sort-icon">â‡…</span></th>
                                    </tr>
                                    <tr id="table-summary-row"></tr>
                                </thead>
                                <tbody id="table-body"></tbody>
                            </table>
                        </div>

                        <div class="p-1.5 border-t border-gray-100 bg-white flex justify-center gap-4 items-center" style="flex-shrink:0;border-radius:0 0 8px 8px;">
                            <button onclick="changePage(-1)" class="p-1 hover:bg-gray-100 rounded text-gray-400"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                            <span id="page-num" class="text-[11px] font-bold text-gray-400 num-font">1 / 1</span>
                            <button onclick="changePage(1)" class="p-1 hover:bg-gray-100 rounded text-gray-400"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Keyboard shortcuts overlay -->
    <div id="shortcuts-panel" class="shortcuts-hint">
        <div class="font-bold text-[12px] mb-2 border-b border-slate-600 pb-1">âŒ¨ï¸ ×§×™×¦×•×¨×™ ××§×œ×“×ª</div>
        <div class="space-y-1">
            <div><span class="shortcut-key">Ctrl+F</span> ×—×™×¤×•×©</div>
            <div><span class="shortcut-key">E</span> ×™×™×¦×•× Excel</div>
            <div><span class="shortcut-key">C</span> ×”×¢×ª×§ ××–×”×™×</div>
            <div><span class="shortcut-key">D</span> Dashboard</div>
            <div><span class="shortcut-key">F</span> Focus (×˜×‘×œ×” ×‘×œ×‘×“)</div>
            <div><span class="shortcut-key">1-6</span> ××¢×‘×¨ ×§×˜×’×•×¨×™×”</div>
            <div><span class="shortcut-key">?</span> ×¢×–×¨×” ×–×•</div>
            <div><span class="shortcut-key">Esc</span> ×¡×’×•×¨</div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        document.addEventListener('click', (e) => {
            const insidePopup = e.target.closest('.filter-popup');
            const insideBtn = e.target.closest('.filter-btn');
            const insideFilterItem = e.target.closest('.filter-item');
            if (insidePopup || insideBtn || insideFilterItem) return;
            document.querySelectorAll('.filter-popup').forEach(p => p.classList.remove('show'));
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TOAST SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showToast(message, type = 'info', duration = 3000) {
            const container = $('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast toast-' + type;
            const icons = { success: 'âœ…', info: 'â„¹ï¸', warn: 'âš ï¸', error: 'âŒ' };
            toast.innerHTML = '<span>' + (icons[type] || '') + '</span><span>' + message + '</span>';
            container.appendChild(toast);
            setTimeout(() => { if (toast.parentNode) toast.remove(); }, duration);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // WILSON SCORE CONFIDENCE INTERVAL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function wilsonScore(successes, total, z = 1.96) {
            if (total === 0) return { lower: 0, upper: 0, center: 0, confidence: 'none' };
            const p = successes / total;
            const denominator = 1 + z * z / total;
            const center = (p + z * z / (2 * total)) / denominator;
            const margin = z * Math.sqrt((p * (1 - p) + z * z / (4 * total)) / total) / denominator;
            const lower = Math.max(0, center - margin);
            const upper = Math.min(1, center + margin);
            const width = upper - lower;
            let confidence = 'low';
            if (total >= 1000 && width < 0.01) confidence = 'high';
            else if (total >= 200 && width < 0.03) confidence = 'high';
            else if (total >= 50 && width < 0.05) confidence = 'medium';
            else if (total >= 20) confidence = 'medium';
            return { lower, upper, center, confidence, width };
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ANOMALY DETECTION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function detectAnomalies(data, campaignAvgCR) {
            if (!data.length) return data;
            const crs = data.filter(r => r.conv > 0 && r.clicks > 10).map(r => r.cr);
            if (!crs.length) return data;
            const mean = crs.reduce((s, v) => s + v, 0) / crs.length;
            const variance = crs.reduce((s, v) => s + (v - mean) ** 2, 0) / crs.length;
            const stdDev = Math.sqrt(variance);
            
            return data.map(r => {
                const anomalies = [];
                // Suspiciously high CR with low volume = possible fraud
                if (r.conv > 0 && r.clicks < 50 && r.cr > mean + 3 * stdDev && r.cr > 0.1) {
                    anomalies.push({ type: 'fraud', label: 'ğŸ­ CR ×—×©×•×“', reason: 'CR ×’×‘×•×” ×××•×“ ×¢× volume × ××•×š' });
                }
                // Zero conv with very high clicks = possible bot
                if (r.conv === 0 && r.clicks > state.clickThreshold * 2) {
                    anomalies.push({ type: 'bot', label: 'ğŸ¤– Bot?', reason: '0 ×”××¨×•×ª ×¢× ' + r.clicks.toLocaleString() + ' ×§×œ×™×§×™×' });
                }
                // Statistical outlier - extreme PPC (positive)
                if (r.ppc > state.medianPPC * 10 && r.conv >= 3) {
                    anomalies.push({ type: 'outlier', label: 'â­ Outlier+', reason: 'PPC x' + (r.ppc / state.medianPPC).toFixed(0) + ' ××”×××•×¦×¢' });
                }
                return { ...r, anomalies };
            });
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LOCALSTORAGE PERSISTENCE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const STORAGE_KEY = 'listlab_v49_settings';
        
        function saveSettings() {
            try {
                const settings = {
                    purePct: $('pure-pct-num').value,
                    goldPct: $('gold-pct-num').value,
                    ipLevel: $('ip-level').value,
                    identifierType: $('identifier-type').value,
                    blMode: state.blMode,
                    blCalc: state.blCalc,
                    blThresholdMult: $('bl-threshold-mult').value,
                    blSoftRoi: $('bl-soft-roi').value,
                    icloudFilter: state.icloudFilter,
                    aggMode: state.aggMode,
                    customEnabled: $('custom-enabled').checked,
                    custConvMin: $('cust-conv-min').value,
                    custConvMax: $('cust-conv-max').value,
                    custScoreMin: $('cust-score-min').value,
                    custScoreMax: $('cust-score-max').value,
                    custClicksMin: $('cust-clicks-min').value,
                    custClicksMax: $('cust-clicks-max').value,
                    custRoiMin: $('cust-roi-min').value,
                    custRoiMax: $('cust-roi-max').value,
                    custCrMin: $('cust-cr-min').value,
                    custCrMax: $('cust-cr-max').value,
                    custPpcMin: $('cust-ppc-min').value,
                    custPpcMax: $('cust-ppc-max').value,
                    exportChecks: {
                        pure: $('chk-pure').checked, gold: $('chk-gold').checked,
                        potential: $('chk-potential').checked, bl: $('chk-bl').checked,
                        custom: $('chk-custom').checked, cidr: $('chk-cidr').checked
                    }
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
            } catch(e) { /* silent fail */ }
        }
        
        function loadSettings() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) return;
                const s = JSON.parse(saved);
                if (s.purePct) { $('pure-pct-num').value = s.purePct; $('pure-pct').value = s.purePct; }
                if (s.goldPct) { $('gold-pct-num').value = s.goldPct; $('gold-pct').value = s.goldPct; }
                if (s.ipLevel) $('ip-level').value = s.ipLevel;
                if (s.identifierType) $('identifier-type').value = s.identifierType;
                if (s.blMode) { state.blMode = s.blMode; document.querySelectorAll('.bl-mode-btn[data-blmode]').forEach(b => b.classList.toggle('active', b.dataset.blmode === s.blMode)); }
                if (s.blCalc) { state.blCalc = s.blCalc; document.querySelectorAll('.bl-mode-btn[data-blcalc]').forEach(b => b.classList.toggle('active', b.dataset.blcalc === s.blCalc)); }
                if (s.blThresholdMult) $('bl-threshold-mult').value = s.blThresholdMult;
                if (s.blSoftRoi) $('bl-soft-roi').value = s.blSoftRoi;
                if (s.icloudFilter) { state.icloudFilter = s.icloudFilter; document.querySelectorAll('.icloud-switcher .switcher-btn').forEach(b => b.classList.toggle('active', b.dataset.value === s.icloudFilter)); }
                if (s.aggMode) { state.aggMode = s.aggMode; document.querySelectorAll('.agg-switcher .switcher-btn').forEach(b => b.classList.toggle('active', b.dataset.agg === s.aggMode)); }
                if (s.customEnabled) $('custom-enabled').checked = s.customEnabled;
                if (s.custConvMin) $('cust-conv-min').value = s.custConvMin;
                if (s.custConvMax) $('cust-conv-max').value = s.custConvMax;
                if (s.custScoreMin) $('cust-score-min').value = s.custScoreMin;
                if (s.custScoreMax) $('cust-score-max').value = s.custScoreMax;
                if (s.custClicksMin) $('cust-clicks-min').value = s.custClicksMin;
                if (s.custClicksMax) $('cust-clicks-max').value = s.custClicksMax;
                if (s.custRoiMin) $('cust-roi-min').value = s.custRoiMin;
                if (s.custRoiMax) $('cust-roi-max').value = s.custRoiMax;
                if (s.custCrMin) $('cust-cr-min').value = s.custCrMin;
                if (s.custCrMax) $('cust-cr-max').value = s.custCrMax;
                if (s.custPpcMin) $('cust-ppc-min').value = s.custPpcMin;
                if (s.custPpcMax) $('cust-ppc-max').value = s.custPpcMax;
                if (s.exportChecks) {
                    if (s.exportChecks.pure !== undefined) $('chk-pure').checked = s.exportChecks.pure;
                    if (s.exportChecks.gold !== undefined) $('chk-gold').checked = s.exportChecks.gold;
                    if (s.exportChecks.potential !== undefined) $('chk-potential').checked = s.exportChecks.potential;
                    if (s.exportChecks.bl !== undefined) $('chk-bl').checked = s.exportChecks.bl;
                    if (s.exportChecks.custom !== undefined) $('chk-custom').checked = s.exportChecks.custom;
                    if (s.exportChecks.cidr !== undefined) $('chk-cidr').checked = s.exportChecks.cidr;
                }
                showToast('×”×’×“×¨×•×ª × ×˜×¢× ×• ××”×–×™×›×¨×•×Ÿ', 'info');
            } catch(e) { /* silent fail */ }
        }
        
        // Load settings on startup
        loadSettings();
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // KEYBOARD SHORTCUTS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        document.addEventListener('keydown', (e) => {
            const tag = document.activeElement.tagName;
            const isInput = tag === 'INPUT' || tag === 'SELECT' || tag === 'TEXTAREA';
            
            // Ctrl+F - search
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                $('search-input').focus();
                return;
            }
            
            if (isInput) return;
            
            // ? - show shortcuts
            if (e.key === '?') {
                $('shortcuts-panel').classList.toggle('show');
                return;
            }
            // Esc - close shortcuts
            if (e.key === 'Escape') {
                $('shortcuts-panel').classList.remove('show');
                return;
            }
            // E - export
            if (e.key === 'e' || e.key === 'E') { exportData(); return; }
            // C - copy IPs
            if (e.key === 'c' && !e.ctrlKey) { copyIPs(); return; }
            // D - toggle dashboard
            if (e.key === 'd' || e.key === 'D') { toggleDashboard(); return; }
            // F - focus mode (table only)
            if (e.key === 'f' || e.key === 'F') { toggleFocusMode(); return; }
            // 1-6 - category views
            const viewMap = { '1': 'pure', '2': 'gold', '3': 'potential', '4': 'blacklist', '5': 'testing', '6': 'all' };
            if (viewMap[e.key]) { $('filter-view').value = viewMap[e.key]; applyFilter(); return; }
        });
        
        const state = {
            rawData: [], allRows: [], detailRows: [], summaryRows: [], aggregatedData: [], processed: [], filtered: [],
            headers: [], dimensions: {}, activeFilters: [], page: 1, pageSize: 100,
            medianPPC: 0, medianCR: 0, medianROI: 100, campaignCR: 0, campaignAvgPPC: 0, clickThreshold: 7000,
            visibleKpis: ['pure', 'gold', 'potential', 'ignore', 'blacklist', 'testing'],
            hasHierarchy: false, levelColumn: null, maxLevel: 1, ipColumn: '',
            customEnabled: false, identifierType: 'auto', detectedType: null,
            compareMode: false, compareData: null,
            compareResults: { new: [], improved: [], declined: [], gone: [] },
            searchQuery: '', osColumn: null, ispColumn: null, extraColumns: [],
            sortColumn: null, sortDirection: 'desc',
            icloudFilter: 'all', aggMode: 'split',
            rawDetailRows: [], processedRaw: null, hasActiveAdvancedFilters: false,
            blMode: 'ppc',
            blCalc: 'median',
            blCleanThreshold: 0,
            blJenksHard: 0,
            blJenksSoft: 0
        };
        
        const ICLOUD_RANGES = ['104.28', '172.226', '172.225', '172.224', '146.75', '140.248'];
        function isIcloudIP(identifier) {
            if (!identifier) return false;
            const str = String(identifier);
            for (const range of ICLOUD_RANGES) { if (str.startsWith(range + '.')) return true; }
            return false;
        }

        const IP_LEVELS = {
            1: { name: 'SubID/IP32', multiplier: 1.5, min: 500, max: 3000, default: 1500 },
            2: { name: 'Zone/IP24', multiplier: 3, min: 2500, max: 10000, default: 7000 },
            3: { name: 'IP16', multiplier: 5, min: 5000, max: 15000, default: 10000 }
        };
        
        const INVALID_PATTERNS = [
            '0.0.0.0', /^0\.0\.0\./,
            '{zone_id}', '{zoneid}', '{zone}', '{sub}', '{subid}', '{sub_id}',
            '{click_id}', '{clickid}',
            '×œ× ××–×•×”×”', 'not identified', 'unknown', 'undefined', 'null',
            '(not set)', '(none)', 'n/a', 'na'
        ];
        const $ = id => document.getElementById(id);
        const parseNum = v => { if (typeof v === 'number') return v; if (!v) return 0; return parseFloat(String(v).replace(/[,$%\s]/g, '')) || 0; };
        
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = String(text ?? ''); return div.innerHTML; }
        
        function highlightSafe(text, query) {
            const raw = String(text ?? ''); const q = String(query ?? '').trim();
            if (!q) return escapeHtml(raw);
            const re = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            let out = '', last = 0;
            raw.replace(re, (m, offset) => { out += escapeHtml(raw.slice(last, offset)); out += '<mark class="search-highlight">' + escapeHtml(m) + '</mark>'; last = offset + m.length; return m; });
            out += escapeHtml(raw.slice(last));
            return out;
        }
        
        function fillSelectWithHeaders(selectEl, headers) {
            selectEl.textContent = '';
            headers.forEach((h, i) => { const opt = document.createElement('option'); opt.value = String(i); opt.textContent = String(h ?? ''); selectEl.appendChild(opt); });
        }
        function toggleSection(section) { const content = $(section + '-content'); const icon = $(section + '-icon'); content.classList.toggle('open'); icon.classList.toggle('open'); }

        function isInvalidIdentifier(id) {
            if (!id || id.trim() === '') return true;
            const lower = id.toLowerCase().trim();
            for (const pattern of INVALID_PATTERNS) { if (pattern instanceof RegExp) { if (pattern.test(lower)) return true; } else { if (lower === pattern.toLowerCase()) return true; } }
            if (/^\{.*\}$/.test(lower)) return true;
            return false;
        }
        
        function detectIdentifierType(values) {
            const sample = values.slice(0, 100);
            let ipCount = 0, numericCount = 0, mixedCount = 0;
            for (const val of sample) {
                if (!val || isInvalidIdentifier(val)) continue;
                if (/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}(\/\d{1,2})?$/.test(val)) ipCount++;
                else if (/^\d+$/.test(val)) numericCount++;
                else mixedCount++;
            }
            const total = ipCount + numericCount + mixedCount;
            if (total === 0) return 'unknown';
            if (ipCount / total > 0.5) return 'ip';
            if (numericCount / total > 0.5) {
                const numericValues = sample.filter(v => /^\d+$/.test(v)).map(Number);
                const avgValue = numericValues.reduce((a, b) => a + b, 0) / numericValues.length;
                const maxValue = Math.max(...numericValues);
                if (maxValue > 10000 || avgValue > 1000) return 'subid';
                return 'zone';
            }
            return 'mixed';
        }
        
        function getIdentifierTypeLabel(type) {
            const labels = { 'ip': 'ğŸŒ IP Address', 'zone': 'ğŸ“ Zone ID', 'subid': 'ğŸ¯ SubID', 'mixed': 'ğŸ”€ Mixed', 'unknown': 'â“ Unknown' };
            return labels[type] || type;
        }

        function toCIDR(identifier) {
            const str = String(identifier).trim();
            const ipLevel = parseInt($('ip-level').value);
            if (str.includes('/')) return str;
            if (/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(str)) {
                const parts = str.split('.').map(Number);
                if (ipLevel === 1) return str + '/32';
                if (ipLevel === 2) return parts[0] + '.' + parts[1] + '.' + parts[2] + '.0/24';
                if (ipLevel === 3) return parts[0] + '.' + parts[1] + '.0.0/16';
                return str + '/32';
            }
            return str;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AUTO THRESHOLD DETECTION (Jenks Natural Breaks)
        // Finds natural clusters in score distribution
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function jenksBreaks(data, numClasses) {
            // Jenks Natural Breaks / Fisher-Jenks
            // Minimizes within-class variance, maximizes between-class variance
            const n = data.length;
            if (n <= numClasses) return data.map(d => d);
            
            const sorted = [...data].sort((a, b) => a - b);
            
            // For efficiency, sample if too many values
            let values = sorted;
            if (n > 500) {
                const step = Math.floor(n / 500);
                values = sorted.filter((_, i) => i % step === 0);
                if (values[values.length - 1] !== sorted[sorted.length - 1]) values.push(sorted[sorted.length - 1]);
            }
            const m = values.length;
            
            // Initialize matrices
            const lowerClassLimits = Array.from({ length: m + 1 }, () => new Float64Array(numClasses + 1));
            const varianceCombinations = Array.from({ length: m + 1 }, () => { const a = new Float64Array(numClasses + 1); a.fill(Infinity); return a; });
            
            for (let i = 1; i <= numClasses; i++) lowerClassLimits[1][i] = 1;
            varianceCombinations[0].fill(0);
            
            for (let l = 2; l <= m; l++) {
                let sumX = 0, sumX2 = 0;
                for (let jj = 1; jj <= l; jj++) {
                    const val = values[l - jj];
                    sumX += val;
                    sumX2 += val * val;
                    const w = jj;
                    const variance = sumX2 - (sumX * sumX) / w;
                    if (jj === l) {
                        for (let j = 1; j <= numClasses; j++) {
                            if (variance < varianceCombinations[l][j]) {
                                lowerClassLimits[l][j] = 1;
                                varianceCombinations[l][j] = variance;
                            }
                        }
                    } else {
                        for (let j = 2; j <= numClasses; j++) {
                            const candidate = varianceCombinations[l - jj][j - 1] + variance;
                            if (candidate < varianceCombinations[l][j]) {
                                lowerClassLimits[l][j] = l - jj + 1;
                                varianceCombinations[l][j] = candidate;
                            }
                        }
                    }
                }
            }
            
            // Extract breaks
            const breaks = new Array(numClasses + 1);
            breaks[numClasses] = values[m - 1];
            breaks[0] = values[0];
            let k = m;
            for (let j = numClasses; j >= 2; j--) {
                const idx = lowerClassLimits[k][j] - 1;
                breaks[j - 1] = values[Math.max(0, idx)];
                k = lowerClassLimits[k][j] - 1;
            }
            return breaks;
        }
        
        function autoDetectThresholds() {
            // SMART AUTO: Jenks on PROFITABLE zones â†’ sets Pure & Gold percentiles
            // BL stays manual (median/mean) â€” user controls it
            const source = state.processed || [];
            if (!source.length) return;
            
            const metric = $('auto-metric').value;
            const metricLabels = { score: 'Score', ppc: 'PPC', roi: 'ROI', cr: 'CR' };
            const clickThreshold = state.clickThreshold;
            
            // Get profitable zones with conversions
            const profitable = source.filter(r => r.conv > 0 && r.profit > 0 && r.clicks >= clickThreshold && !r.isSummary);
            
            if (profitable.length < 10) {
                showToast('×¦×¨×™×š ×œ×¤×—×•×ª 10 ×–×•× ×™× ×¨×•×•×—×™×™× (' + profitable.length + ' × ××¦××•)', 'warn');
                return;
            }
            
            const getValue = (r) => {
                switch (metric) {
                    case 'ppc': return r.ppc;
                    case 'roi': return r.roi;
                    case 'cr': return r.cr * 100;
                    default: return r.score;
                }
            };
            
            // Jenks 3-class on profitable: [Potential | Gold | Pure]
            const values = profitable.map(r => getValue(r)).sort((a, b) => a - b);
            const breaks = jenksBreaks(values, 3);
            const goldBreak = breaks[1];
            const pureBreak = breaks[2];
            
            const pureCount = profitable.filter(r => getValue(r) >= pureBreak).length;
            const goldCount = profitable.filter(r => getValue(r) >= goldBreak).length;
            
            let purePct = Math.round((pureCount / profitable.length) * 100);
            let goldPct = Math.round((goldCount / profitable.length) * 100);
            purePct = Math.max(2, Math.min(40, purePct));
            goldPct = Math.max(purePct + 5, Math.min(65, goldPct));
            
            // Apply Pure/Gold sliders
            $('pure-pct-num').value = purePct;
            $('pure-pct').value = Math.min(50, purePct);
            $('gold-pct-num').value = goldPct;
            $('gold-pct').value = Math.min(70, goldPct);
            
            // P25 quality gate stats (same as classifyRanges computes)
            const sortedROI = profitable.map(r => r.roi).sort((a, b) => a - b);
            const sortedScores = profitable.map(r => r.score).sort((a, b) => a - b);
            const p25ROI = Math.max(100, sortedROI[Math.floor(sortedROI.length * 0.25)]);
            const p25Score = sortedScores[Math.floor(sortedScores.length * 0.25)];
            const potentialOK = profitable.filter(r => r.roi >= p25ROI && r.score >= p25Score).length;
            const watchCount = profitable.length - potentialOK;
            
            // Display
            const fmtVal = (v) => {
                if (metric === 'ppc') return '$' + v.toFixed(4);
                if (metric === 'roi') return v.toFixed(0) + '%';
                if (metric === 'cr') return v.toFixed(3) + '%';
                return v.toFixed(2);
            };
            
            const summaryParts = [
                'ğŸ’ Pure: top ' + purePct + '% (' + metricLabels[metric] + ' â‰¥ ' + fmtVal(pureBreak) + ')',
                'ğŸ¥‡ Gold: top ' + goldPct + '% (' + metricLabels[metric] + ' â‰¥ ' + fmtVal(goldBreak) + ')',
                'ğŸŒ± Potential: ROI â‰¥ ' + p25ROI.toFixed(0) + '% & Score â‰¥ ' + p25Score.toFixed(2) + ' (' + potentialOK + ' zones)',
                watchCount > 0 ? 'ğŸ‘€ Watch: ' + watchCount + ' marginal zones (below P25 quality gate)' : '',
                'ğŸ“Š ' + profitable.length + ' ×¨×•×•×—×™×™× ××ª×•×š ' + source.filter(r => !r.isSummary).length + ' ×¡×”×´×›'
            ].filter(Boolean);
            
            $('auto-thresh-info').classList.remove('hidden');
            $('auto-thresh-text').innerHTML = summaryParts.join('<br>');
            
            showToast('ğŸ¤– Smart Auto (' + metricLabels[metric] + '): Pure ' + purePct + '% | Gold ' + goldPct + '% | Potential ' + potentialOK + ' | Watch ' + watchCount, 'success', 5000);
            
            processData();
        }
        
        function calculateClickThreshold() {
            const level = parseInt($('ip-level').value);
            const config = IP_LEVELS[level];
            if (state.campaignCR <= 0 || state.campaignCR < 0.001) {
                state.clickThreshold = config.default;
            } else {
                const crPercent = state.campaignCR * 100;
                let threshold = config.multiplier * (100 / crPercent);
                threshold = Math.max(config.min, Math.min(config.max, threshold));
                state.clickThreshold = Math.round(threshold);
            }
            $('current-threshold').textContent = state.clickThreshold.toLocaleString();
            $('click-threshold').textContent = state.clickThreshold.toLocaleString();
        }

        const dz = $('drop-zone');
        const fi = $('file-input');
        dz.addEventListener('click', () => fi.click());
        fi.addEventListener('change', e => loadFile(e.target.files[0]));
        dz.addEventListener('dragover', e => e.preventDefault());
        dz.addEventListener('drop', e => { e.preventDefault(); loadFile(e.dataTransfer.files[0]); });

        function loadFile(file) {
            if (!file) return;
            const sizeMB = file.size / (1024 * 1024);
            if (sizeMB > 50) { alert('×§×•×‘×¥ ×’×“×•×œ ××“×™ (××¢×œ 50MB)'); return; }
            $('filename').innerHTML = '<span class="animate-pulse">â³ ×˜×•×¢×Ÿ ' + escapeHtml(file.name) + ' (' + sizeMB.toFixed(1) + 'MB)...</span>';
            $('global-stats').innerHTML = '<span class="text-amber-500 animate-pulse">ğŸ”„ ××¢×‘×“ × ×ª×•× ×™×...</span>';
            setTimeout(() => {
                const reader = new FileReader();
                reader.onerror = () => { alert('×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥'); $('filename').textContent = ''; };
                reader.onload = e => {
                    try {
                        const wb = XLSX.read(e.target.result, { type: 'array', cellDates: false, cellNF: false, cellStyles: false });
                        const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1, defval: '', raw: true });
                        if (json.length < 2) { alert('×§×•×‘×¥ ×¨×™×§'); $('filename').textContent = ''; return; }
                        state.headers = json[0].map(h => String(h || '').trim());
                        state.rawData = json.slice(1).filter(row => row.some(c => c !== '' && c != null));
                        $('filename').textContent = file.name + ' (' + state.rawData.length.toLocaleString() + ' ×©×•×¨×•×ª)';
                        const hLower = state.headers.map(h => h.toLowerCase());
                        const levelIdx = hLower.findIndex(x => x === 'level' || x === 'lvl' || x === 'depth');
                        state.levelColumn = levelIdx !== -1 ? state.headers[levelIdx] : null;
                        state.hasHierarchy = levelIdx !== -1;
                        setupMapping();
                        setupFilters();
                        setTimeout(() => processData(), 10);
                    } catch (err) {
                        console.error('Error processing file:', err);
                        alert('×©×’×™××” ×‘×¢×™×‘×•×“: ' + err.message);
                        $('filename').textContent = '';
                        $('global-stats').innerHTML = '<span class="text-red-500">×©×’×™××” ×‘×˜×¢×™× ×”</span>';
                    }
                };
                reader.readAsArrayBuffer(file);
            }, 50);
        }

        function setupMapping() {
            const ipSel = $('col-ip');
            fillSelectWithHeaders(ipSel, state.headers);
            const hLower = state.headers.map(h => h.toLowerCase());
            const subidPatterns = ['subid', 'sub_id', 'sub id', 'token 3', 'token3'];
            const zonePatterns = ['zone', 'zone_id', 'zoneid', 'token 4', 'token4'];
            const ipPatterns = ['ip', 'ip address', 'ip_address', 'range', 'identifier'];
            
            let matchIdx = hLower.findIndex(h => subidPatterns.some(p => h.includes(p)));
            if (matchIdx < 0) matchIdx = hLower.findIndex(h => zonePatterns.some(p => h.includes(p)));
            if (matchIdx < 0) matchIdx = hLower.findIndex(h => ipPatterns.some(p => h.includes(p)));
            if (matchIdx >= 0) ipSel.value = matchIdx;

            const selects = ['col-clicks', 'col-conv', 'col-rev', 'col-cost'];
            const defaults = { 'col-clicks': ['clicks', 'click', 'impressions'], 'col-conv': ['conv', 'conversions', 'conversion', 'leads'], 'col-rev': ['revenue', 'rev', 'income', 'payout'], 'col-cost': ['cost', 'spend', 'expense'] };
            
            const mappingResults = [];
            selects.forEach(id => {
                const sel = $(id);
                fillSelectWithHeaders(sel, state.headers);
                const mIdx = hLower.findIndex(h => defaults[id].some(k => h.includes(k)));
                if (mIdx >= 0) {
                    sel.value = mIdx;
                    mappingResults.push(id.replace('col-', '') + ' â†’ ' + state.headers[mIdx]);
                }
            });
            
            // Show mapping toast
            if (mappingResults.length > 0) {
                showToast('××™×¤×•×™ ××•×˜×•××˜×™: ' + mappingResults.join(', '), 'success');
            }
            
            // Sanity check: warn if avg cost looks weird
            const costIdx = +$('col-cost').value;
            const sampleCosts = state.rawData.slice(0, 50).map(r => parseNum(r[costIdx]));
            const avgCost = sampleCosts.reduce((a, b) => a + b, 0) / sampleCosts.length;
            if (avgCost > 10000) {
                showToast('âš ï¸ ×¢××•×“×ª Cost ×××•×¦×¢: $' + avgCost.toFixed(0) + ' â€” ×‘×“×•×§ ×©×”××™×¤×•×™ × ×›×•×Ÿ!', 'warn', 5000);
            }
            
            state.ipColumn = state.headers[+$('col-ip').value];
            $('mapping-box').classList.remove('hidden');
            $('medians-box').classList.remove('hidden');
            state.extraColumns = [];
            const osPatterns = ['os', 'operating system', 'device os', 'platform'];
            const ispPatterns = ['isp', 'carrier', 'network', 'provider'];
            const browserPatterns = ['browser', 'user agent'];
            const countryPatterns = ['country', 'geo', 'region'];
            
            const osIdx = hLower.findIndex(h => osPatterns.some(p => h.includes(p)));
            const ispIdx = hLower.findIndex(h => ispPatterns.some(p => h.includes(p)));
            const browserIdx = hLower.findIndex(h => browserPatterns.some(p => h.includes(p)));
            const countryIdx = hLower.findIndex(h => countryPatterns.some(p => h === p || h.includes(p)));
            
            if (osIdx >= 0) { state.osColumn = osIdx; state.extraColumns.push(state.headers[osIdx]); }
            if (ispIdx >= 0) { state.ispColumn = ispIdx; state.extraColumns.push(state.headers[ispIdx]); }
            if (browserIdx >= 0 && state.extraColumns.length < 2) state.extraColumns.push(state.headers[browserIdx]);
            if (countryIdx >= 0 && state.extraColumns.length < 2) state.extraColumns.push(state.headers[countryIdx]);

            detectAndUpdateIdentifierType();
            if (state.hasHierarchy) {
                $('hierarchy-box').classList.remove('hidden');
                $('level-filter-box').style.display = 'flex';
                $('th-level').style.display = '';
            } else {
                $('hierarchy-box').classList.add('hidden');
                $('level-filter-box').style.display = 'none';
                $('th-level').style.display = 'none';
            }
        }
        
        function detectAndUpdateIdentifierType() {
            const ipColIdx = +$('col-ip').value;
            const colName = state.headers[ipColIdx] || '';
            const identifierValues = state.rawData.map(row => String(row[ipColIdx] || '').trim());
            state.detectedType = detectIdentifierType(identifierValues);
            const colLower = colName.toLowerCase();
            let nameHint = null;
            if (colLower.includes('subid') || colLower.includes('sub_id') || colLower.includes('token 3') || colLower.includes('token3')) nameHint = 'subid';
            else if (colLower.includes('zone') || colLower.includes('token 4') || colLower.includes('token4')) nameHint = 'zone';
            else if (colLower.includes('ip')) nameHint = 'ip';
            const finalType = nameHint || state.detectedType;
            const detectedEl = $('detected-type');
            if (finalType && finalType !== 'unknown') {
                detectedEl.innerHTML = 'âœ“ ×–×•×”×”: ' + getIdentifierTypeLabel(finalType) + ' <span class="text-slate-400">(' + escapeHtml(colName) + ')</span>';
                detectedEl.classList.remove('hidden');
                if ($('identifier-type').value === 'auto') {
                    if (finalType === 'subid') $('ip-level').value = '1';
                    else if (finalType === 'zone') $('ip-level').value = '2';
                    else if (finalType === 'ip') { const hasSlash24 = identifierValues.some(v => v.endsWith('.0') || v.includes('/24')); $('ip-level').value = hasSlash24 ? '2' : '1'; }
                }
            } else { detectedEl.classList.add('hidden'); }
            state.ipColumn = colName;
        }

        function setupFilters() {
            state.dimensions = {};
            const skip = ['clicks', 'conversions', 'revenue', 'cost', 'profit', 'roi', 'cr', 'epc', 'cpc', 'level'];
            state.headers.forEach((h, idx) => {
                if (skip.some(s => h.toLowerCase().includes(s))) return;
                const vals = new Set();
                state.rawData.forEach(row => { const v = row[idx]; if (v !== undefined && v !== null && String(v).trim() !== '') vals.add(String(v).trim()); });
                if (vals.size > 0 && vals.size < 500) state.dimensions[h] = [...vals].sort();
            });
            const colSel = $('col-selector');
            colSel.textContent = '';
            const defaultOpt = document.createElement('option'); defaultOpt.value = ''; defaultOpt.textContent = '×‘×—×¨ ×¢××•×“×”...'; colSel.appendChild(defaultOpt);
            Object.keys(state.dimensions).forEach(h => { const opt = document.createElement('option'); opt.value = h; opt.textContent = h; colSel.appendChild(opt); });
            $('filter-msg').classList.add('hidden');
            $('btn-add-filter').classList.remove('hidden');
            state.activeFilters = [];
            $('filters-list').innerHTML = '';
        }

        function showAddFilterMenu() {
            if (state.activeFilters.length >= 4) return alert("××§×¡×™××•× 4 ××¡× × ×™×");
            $('btn-add-filter').classList.add('hidden');
            $('col-selector').classList.remove('hidden');
            $('col-selector').value = "";
        }

        function createNewFilter(col) {
            if (!col) { $('col-selector').classList.add('hidden'); $('btn-add-filter').classList.remove('hidden'); return; }
            const fid = Date.now();
            const div = document.createElement('div'); div.className = 'filter-item'; div.id = 'f-' + fid;
            div.innerHTML = '<div class="filter-header"><span>' + escapeHtml(col) + '</span><i data-lucide="x" class="w-3 h-3 cursor-pointer text-red-400 hover:text-red-600" onclick="removeFilter(' + fid + ')"></i></div><div class="filter-btn" onclick="togglePopup(' + fid + ')"><span id="l-' + fid + '">(×”×›×œ)</span><i data-lucide="chevron-down" class="w-3 h-3"></i></div><div class="filter-popup" id="p-' + fid + '"><input type="text" class="filter-search" placeholder="×—×¤×©..." oninput="filterOpts(' + fid + ', this.value)"><div class="filter-list custom-scrollbar" id="lst-' + fid + '"></div><div class="flex justify-between mt-2"><div class="btn-tiny btn-cancel" onclick="togglePopup(' + fid + ')">×¡×’×•×¨</div><div class="btn-tiny btn-apply" onclick="applyFilterSelection(' + fid + ')">×”×—×œ</div></div></div>';
            $('filters-list').appendChild(div);
            lucide.createIcons();
            const lst = $('lst-' + fid);
            (state.dimensions[col] || []).forEach(v => {
                const optDiv = document.createElement('div'); optDiv.className = 'filter-opt';
                const chk = document.createElement('input'); chk.type = 'checkbox'; chk.className = 'chk-input'; chk.value = v;
                const span = document.createElement('span'); span.textContent = v;
                optDiv.appendChild(chk); optDiv.appendChild(span); lst.appendChild(optDiv);
            });
            state.activeFilters.push({ id: fid, col, colIdx: state.headers.indexOf(col), values: [] });
            $('col-selector').classList.add('hidden');
            if (state.activeFilters.length < 4) $('btn-add-filter').classList.remove('hidden');
        }

        function removeFilter(fid) { $('f-' + fid).remove(); state.activeFilters = state.activeFilters.filter(f => f.id !== fid); $('btn-add-filter').classList.remove('hidden'); processData(); }
        function togglePopup(fid) { const el = $('p-' + fid); const isOpen = el.classList.contains('show'); document.querySelectorAll('.filter-popup').forEach(p => p.classList.remove('show')); if (!isOpen) el.classList.add('show'); }
        function filterOpts(fid, txt) { const term = txt.toLowerCase(); const opts = $('lst-' + fid).children; for (let o of opts) o.style.display = o.innerText.toLowerCase().includes(term) ? 'flex' : 'none'; }
        function applyFilterSelection(fid) {
            const lst = $('lst-' + fid);
            const vals = Array.from(lst.querySelectorAll('input:checked')).map(c => c.value);
            const f = state.activeFilters.find(x => x.id === fid);
            f.values = vals;
            const lbl = $('l-' + fid);
            lbl.innerText = vals.length ? vals.length + ' × ×‘×—×¨×•' : '(×”×›×œ)';
            lbl.className = vals.length ? 'text-blue-600 font-bold' : '';
            togglePopup(fid);
            processData(); 
        }

        function processData() {
            try {
                if (state.compareMode) {
                    state.compareMode = false; state.compareData = null;
                    state.compareResults = { new: [], improved: [], declined: [], gone: [] };
                    $('compare-panel').classList.add('hidden');
                    $('btn-clear-compare').classList.add('hidden');
                    $('show-changes-box').classList.add('hidden');
                }
                
                $('global-stats').innerHTML = '<span class="text-amber-500">ğŸ”„ ××¢×‘×“ ' + state.rawData.length.toLocaleString() + ' ×©×•×¨×•×ª...</span>';
                const cols = { ip: +$('col-ip').value, clicks: +$('col-clicks').value, conv: +$('col-conv').value, rev: +$('col-rev').value, cost: +$('col-cost').value };
                state.ipColumn = state.headers[cols.ip];
                const levelIdx = state.levelColumn ? state.headers.indexOf(state.levelColumn) : -1;
                const extraColIndices = {};
                state.extraColumns.forEach(col => { extraColIndices[col] = state.headers.indexOf(col); });

                state.allRows = state.rawData.map((row, idx) => {
                    const level = levelIdx >= 0 ? parseNum(row[levelIdx]) : 1;
                    const extraData = {};
                    state.extraColumns.forEach(col => { const colIdx = extraColIndices[col]; if (colIdx >= 0) extraData[col] = String(row[colIdx] || '').trim(); });
                    return { idx, raw: row, identifier: String(row[cols.ip] || '').trim(), level, clicks: parseNum(row[cols.clicks]), conv: parseNum(row[cols.conv]), rev: parseNum(row[cols.rev]), cost: parseNum(row[cols.cost]), profit: parseNum(row[cols.rev]) - parseNum(row[cols.cost]), extraData };
                });

                if (state.hasHierarchy) {
                    let maxLvl = 1; const levelSet = new Set();
                    for (let i = 0; i < state.allRows.length; i++) { const lvl = state.allRows[i].level; if (lvl > maxLvl) maxLvl = lvl; levelSet.add(lvl); }
                    state.maxLevel = maxLvl;
                    const levels = [...levelSet].sort((a, b) => a - b);
                    $('level-badges').innerHTML = levels.map(l => '<span class="level-badge level-' + Math.min(l, 3) + '">' + l + '</span>').join('');
                }

                state.customEnabled = $('custom-enabled').checked;
                $('custom-badge').classList.toggle('hidden', !state.customEnabled);
                processFullPipeline();
                saveSettings();
            } catch (err) {
                console.error('Error in processData:', err);
                $('global-stats').innerHTML = '<span class="text-red-500">âŒ ×©×’×™××”: ' + err.message + '</span>';
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // IMPROVED SCORING - graduated penalty instead of hard zero
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function calculateScore(r, medianPPC, medianCR, medianROI) {
            if (r.conv === 0) return 0;
            if (medianPPC <= 0 || medianCR <= 0) return 0;
            
            const roiMed = medianROI > 0 ? medianROI : 100;
            
            // Base quality components (same weights)
            const ppcComponent = 0.5 * (r.ppc / medianPPC);
            const roiComponent = 0.3 * (r.roi / roiMed);
            const crComponent = 0.2 * (r.cr / medianCR);
            const quality = ppcComponent + roiComponent + crComponent;
            
            // Reliability: scales with conv count (same as before)
            const reliability = Math.min(r.conv / 10, 1.0);
            
            // *** NEW: Graduated profit penalty instead of hard zero ***
            // Items with profit > 0 get full score
            // Items near break-even get partial score (not zero)
            // Items deeply negative get near-zero
            let profitFactor = 1.0;
            if (r.profit <= 0 && r.cost > 0) {
                // Ratio: how negative is profit relative to cost
                // -$0.01 profit on $100 cost â†’ factor ~0.99
                // -$50 profit on $100 cost â†’ factor ~0.0
                const lossRatio = Math.abs(r.profit) / r.cost;
                profitFactor = Math.max(0, 1 - lossRatio * 2); // Penalty: doubles the loss ratio
            } else if (r.profit <= 0 && r.cost === 0) {
                profitFactor = r.ppc > 0 ? 0.5 : 0; // No cost data but positive PPC = partial
            }
            
            // Wilson confidence boost: high-confidence CRs get a small bonus
            const wilson = wilsonScore(r.conv, r.clicks);
            const confidenceBonus = wilson.confidence === 'high' ? 1.05 : wilson.confidence === 'medium' ? 1.0 : 0.95;
            
            return Math.max(0, quality * reliability * profitFactor * confidenceBonus);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // IMPROVED BLACKLIST - Severity tiers + fix circular dependency
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function classifyRanges(data, medianPPC, medianCR, campaignAvgCR, campaignAvgPPC, totalCost, totalProfit, medianROI) {
            const purePct = +$('pure-pct-num').value || 10;
            const goldPct = +$('gold-pct-num').value || 25;
            const clickThreshold = state.clickThreshold;
            const medROI = medianROI || state.medianROI || 100;
            const blMode = state.blMode;
            const blMult = parseFloat($('bl-threshold-mult').value) || 0.5;
            const blSoftRoiThreshold = parseFloat($('bl-soft-roi').value) || -30;

            // *** Calculate BL threshold from profitable rows only ***
            // Generic: works for ppc, cr, roi, score
            const profitableRows = data.filter(r => r.conv > 0 && r.profit > 0);
            
            const getBlMetric = (r) => {
                if (blMode === 'ppc') return r.ppc;
                if (blMode === 'cr') return r.cr;
                if (blMode === 'roi') return r.roi;
                return r.score; // score
            };
            
            let cleanThreshold = 0;
            let jenksHard = 0, jenksSoft = 0;
            
            if (profitableRows.length > 0) {
                if (state.blCalc === 'median') {
                    const sorted = profitableRows.map(r => getBlMetric(r)).sort((a, b) => a - b);
                    cleanThreshold = sorted[Math.floor(sorted.length / 2)];
                } else if (state.blCalc === 'mean') {
                    cleanThreshold = profitableRows.reduce((s, r) => s + getBlMetric(r), 0) / profitableRows.length;
                } else if (state.blCalc === 'jenks') {
                    // Jenks: calculate from losing zones
                    const losers = data.filter(r => r.clicks >= clickThreshold && r.conv > 0 && r.profit < 0);
                    if (losers.length >= 8) {
                        const vals = losers.map(r => getBlMetric(r)).sort((a, b) => a - b);
                        const br = jenksBreaks(vals, 2);
                        jenksHard = br[1]; jenksSoft = br[2];
                        // Sanity cap: don't exceed 30%/60% of profitable median
                        const profSorted = profitableRows.map(r => getBlMetric(r)).sort((a, b) => a - b);
                        const profMed = profSorted[Math.floor(profSorted.length / 2)];
                        if (profMed > 0) {
                            jenksHard = Math.min(jenksHard, profMed * 0.3);
                            jenksSoft = Math.min(jenksSoft, profMed * 0.6);
                        }
                    } else {
                        // Fallback to median Ã— mult
                        const sorted = profitableRows.map(r => getBlMetric(r)).sort((a, b) => a - b);
                        cleanThreshold = sorted[Math.floor(sorted.length / 2)];
                    }
                }
            }
            // Store for display
            state.blCleanThreshold = cleanThreshold;
            state.blJenksHard = jenksHard;
            state.blJenksSoft = jenksSoft;
            const jenksActive = state.blCalc === 'jenks' && (jenksHard > 0 || jenksSoft > 0);

            const custConvMin = parseFloat($('cust-conv-min').value) || 0;
            const custConvMax = $('cust-conv-max').value !== '' ? parseFloat($('cust-conv-max').value) : Infinity;
            const custScoreMin = parseFloat($('cust-score-min').value) || 0;
            const custScoreMax = $('cust-score-max').value !== '' ? parseFloat($('cust-score-max').value) : Infinity;
            const custClicksMin = parseFloat($('cust-clicks-min').value) || 0;
            const custClicksMax = $('cust-clicks-max').value !== '' ? parseFloat($('cust-clicks-max').value) : Infinity;
            const custRoiMin = parseFloat($('cust-roi-min').value) || -9999;
            const custRoiMax = $('cust-roi-max').value !== '' ? parseFloat($('cust-roi-max').value) : Infinity;
            const custCrMin = parseFloat($('cust-cr-min').value) || 0;
            const custCrMax = $('cust-cr-max').value !== '' ? parseFloat($('cust-cr-max').value) : Infinity;
            const custPpcMin = parseFloat($('cust-ppc-min').value) || 0;
            const custPpcMax = $('cust-ppc-max').value !== '' ? parseFloat($('cust-ppc-max').value) : Infinity;

            data = data.map(r => ({ ...r, score: calculateScore(r, medianPPC, medianCR, medROI) }));

            function percentileThreshold(pool, pct) {
                if (!pool.length) return Infinity;
                const idx = Math.max(0, Math.min(pool.length - 1, Math.ceil(pool.length * pct / 100) - 1));
                return pool[idx].score;
            }
            
            const purePool = data.filter(r => r.conv >= 3 && r.profit > 0).sort((a, b) => b.score - a.score);
            const goldPool = data.filter(r => r.conv >= 2 && r.profit > 0).sort((a, b) => b.score - a.score);
            const pureThreshold = percentileThreshold(purePool, purePct);
            const goldThreshold = percentileThreshold(goldPool, goldPct);
            
            // P25 Quality Gate for Potential: always-on, data-driven floor
            const potentialPool = data.filter(r => r.conv >= 1 && r.profit > 0);
            let potentialMinROI = 100; // absolute minimum
            let potentialMinScore = 0;
            if (potentialPool.length >= 10) {
                const sortedROI = potentialPool.map(r => r.roi).sort((a, b) => a - b);
                const sortedScores = potentialPool.map(r => r.score).sort((a, b) => a - b);
                potentialMinROI = Math.max(100, sortedROI[Math.floor(sortedROI.length * 0.25)]);
                potentialMinScore = sortedScores[Math.floor(sortedScores.length * 0.25)];
            }

            return data.map(r => {
                let category, action, blSeverity = null;
                const hasEnoughClicks = r.clicks >= clickThreshold;
                
                // === BL SEVERITY TIERS ===
                const blCond_ZeroConv = r.conv === 0;
                const blCond_DeepNegROI = r.cost > 0 && r.roi < -50;
                
                // Generic BL metric check
                let blCond_PoorPerf = false;
                let blCond_JenksHard = false;
                let blCond_JenksSoft = false;
                const blVal = getBlMetric(r);
                
                if (r.conv > 0) {
                    if (jenksActive) {
                        // Jenks: profit < 0 required for BL (profit safety valve)
                        blCond_JenksHard = blVal < jenksHard && r.profit < 0;
                        blCond_JenksSoft = blVal >= jenksHard && blVal < jenksSoft && r.profit < 0;
                    } else {
                        // Median/Mean: threshold Ã— multiplier
                        blCond_PoorPerf = blVal < (cleanThreshold * blMult);
                    }
                }
                
                // Soft BL: negative profit but not catastrophic
                const blCond_NegProfit = r.profit < 0;
                const isDeepNeg = r.cost > 0 && r.roi < blSoftRoiThreshold;
                
                const isTesting = r.conv === 0 && r.clicks < clickThreshold;

                // Determine BL tier
                let isBlacklist = false;
                let isBlacklistSoft = false;
                let isWatch = false;
                
                if (hasEnoughClicks) {
                    if (blCond_ZeroConv || blCond_DeepNegROI) {
                        isBlacklist = true;
                        blSeverity = 'hard';
                    } else if (blCond_JenksHard) {
                        // Jenks: bottom cluster + negative profit (already in condition)
                        isBlacklist = true;
                        blSeverity = 'hard';
                    } else if (blCond_JenksSoft) {
                        // Jenks: mid-low cluster + negative profit (already in condition)
                        isBlacklistSoft = true;
                        blSeverity = 'soft';
                    } else if (blCond_NegProfit && isDeepNeg) {
                        isBlacklistSoft = true;
                        blSeverity = 'soft';
                    } else if (blCond_PoorPerf) {
                        isWatch = true;
                        blSeverity = 'watch';
                    } else if (blCond_NegProfit) {
                        isWatch = true;
                        blSeverity = 'watch';
                    }
                }

                const crPercent = r.cr * 100;
                const matchesCustom = state.customEnabled &&
                    r.conv >= custConvMin && r.conv <= custConvMax &&
                    r.score >= custScoreMin && r.score <= custScoreMax &&
                    r.clicks >= custClicksMin && r.clicks <= custClicksMax &&
                    r.roi >= custRoiMin && r.roi <= custRoiMax &&
                    crPercent >= custCrMin && crPercent <= custCrMax &&
                    r.ppc >= custPpcMin && r.ppc <= custPpcMax;

                // Wilson confidence
                const wilson = wilsonScore(r.conv, r.clicks);

                if (isBlacklist) { category = 'blacklist'; action = 'ğŸ”´ Block'; }
                else if (isBlacklistSoft) { category = 'blacklist-soft'; action = 'ğŸŸ  Review & Block'; }
                else if (isWatch) { category = 'watch'; action = 'ğŸ‘€ Monitor'; }
                else if (isTesting) { category = 'testing'; action = 'Wait'; }
                else if (matchesCustom) { category = 'custom'; action = 'Custom'; }
                else if (r.conv >= 3 && r.profit > 0 && r.score >= pureThreshold) { category = 'pure'; action = 'Bid +30%'; }
                else if (r.conv >= 2 && r.profit > 0 && r.score >= goldThreshold) { category = 'gold'; action = 'Bid +15%'; }
                else if (r.conv >= 1 && r.profit > 0 && r.roi >= potentialMinROI && r.score >= potentialMinScore) { category = 'potential'; action = 'Bid +5-10%'; }
                else if (r.conv >= 1) { category = 'watch'; action = 'ğŸ‘€ Monitor'; }
                else { category = 'ignore'; action = 'RON'; }

                return { ...r, category, action, matchesCustom, isBlacklist, isBlacklistSoft, isWatch, isTesting, blSeverity, wilson,
                    blReason: (isBlacklist || isBlacklistSoft || isWatch) ? 
                        (blCond_ZeroConv ? 'zero_conv' : blCond_DeepNegROI ? 'deep_neg_roi' : blCond_JenksHard ? 'jenks_hard' : blCond_JenksSoft ? 'jenks_soft' : blCond_NegProfit ? 'neg_profit' : 'poor_' + blMode) : null };
            });
        }

        function assignVolumeTiers(data) {
            // Assign High/Mid/Low volume tier within each category based on clicks terciles
            const volCategories = ['pure', 'gold', 'potential', 'watch', 'blacklist', 'blacklist-soft', 'testing'];
            const groups = {};
            volCategories.forEach(cat => { groups[cat] = []; });
            data.forEach((r, i) => { if (groups[r.category]) groups[r.category].push(i); });
            
            Object.keys(groups).forEach(cat => {
                const indices = groups[cat];
                if (indices.length === 0) return;
                // Sort by clicks descending within category
                indices.sort((a, b) => data[b].clicks - data[a].clicks);
                const n = indices.length;
                const t1 = Math.ceil(n / 3);
                const t2 = Math.ceil(n * 2 / 3);
                indices.forEach((idx, rank) => {
                    if (rank < t1) data[idx].volumeTier = 'high';
                    else if (rank < t2) data[idx].volumeTier = 'mid';
                    else data[idx].volumeTier = 'low';
                    data[idx].volumeRank = rank + 1;
                    data[idx].volumeTotal = n;
                });
            });
            // Non-categorized
            data.forEach(r => { if (!r.volumeTier) r.volumeTier = 'mid'; });
            return data;
        }

        function processFullPipeline() {
            let filteredRows = state.allRows.filter(r => {
                for (const f of state.activeFilters) { if (f.values.length > 0) { const val = String(r.raw[f.colIdx] || ''); if (!f.values.includes(val)) return false; } }
                if (state.icloudFilter === 'hide' && isIcloudIP(r.identifier)) return false;
                if (state.icloudFilter === 'only' && !isIcloudIP(r.identifier)) return false;
                return true;
            });

            if (state.hasHierarchy) {
                state.detailRows = filteredRows.filter(r => r.level === state.maxLevel);
                state.summaryRows = filteredRows.filter(r => r.level < state.maxLevel);
            } else {
                state.detailRows = filteredRows.filter(r => r.identifier !== '');
                state.summaryRows = [];
            }
            state.detailRows = state.detailRows.filter(r => !isInvalidIdentifier(r.identifier));

            state.rawDetailRows = state.detailRows.map(r => ({
                ...r, identifier: r.identifier || 'Unknown',
                roi: r.cost > 0 ? (r.profit / r.cost) * 100 : (r.profit > 0 ? 999 : 0),
                cr: r.clicks > 0 ? r.conv / r.clicks : 0,
                ppc: r.clicks > 0 ? r.profit / r.clicks : 0
            }));
            
            const getAggKey = (r) => {
                let keyParts = [r.identifier || 'Unknown'];
                state.activeFilters.forEach(f => { if (f.values.length > 0) { keyParts.push(f.colIdx + ':' + String(r.raw[f.colIdx] || '').trim()); } });
                return keyParts.join('|');
            };
            
            const grouped = {};
            state.detailRows.forEach(r => {
                const key = getAggKey(r);
                if (!grouped[key]) {
                    grouped[key] = { identifier: r.identifier || 'Unknown', level: r.level, clicks: 0, conv: 0, rev: 0, cost: 0, profit: 0, isSummary: false, extraData: { ...r.extraData }, _extraSets: {}, _rowCount: 0 };
                    state.extraColumns.forEach(col => { grouped[key]._extraSets[col] = new Set(); if (r.extraData && r.extraData[col]) grouped[key]._extraSets[col].add(r.extraData[col]); });
                } else {
                    state.extraColumns.forEach(col => { if (r.extraData && r.extraData[col]) grouped[key]._extraSets[col].add(r.extraData[col]); });
                }
                const g = grouped[key];
                g.clicks += r.clicks; g.conv += r.conv; g.rev += r.rev; g.cost += r.cost; g.profit += r.profit; g._rowCount++;
            });
            
            state.aggregatedData = Object.values(grouped).map(g => {
                const finalExtraData = { ...g.extraData };
                state.extraColumns.forEach(col => { if (g._extraSets[col] && g._extraSets[col].size > 1) finalExtraData[col] = '××¢×•×¨×‘ (' + g._extraSets[col].size + ')'; });
                return { ...g, extraData: finalExtraData, roi: g.cost > 0 ? (g.profit / g.cost) * 100 : (g.profit > 0 ? 999 : 0), cr: g.clicks > 0 ? g.conv / g.clicks : 0, ppc: g.clicks > 0 ? g.profit / g.clicks : 0 };
            });

            const totalClicks = state.aggregatedData.reduce((s, r) => s + r.clicks, 0);
            const totalConv = state.aggregatedData.reduce((s, r) => s + r.conv, 0);
            const totalProfit = state.aggregatedData.reduce((s, r) => s + r.profit, 0);
            const totalCost = state.aggregatedData.reduce((s, r) => s + r.cost, 0);
            const campaignAvgCR = totalClicks > 0 ? totalConv / totalClicks : 0;
            const campaignAvgPPC = totalClicks > 0 ? totalProfit / totalClicks : 0;

            const profitable = state.aggregatedData.filter(r => r.conv > 0 && r.ppc > 0);
            let medianPPC = 0.001, medianCR = 0.001, medianROI = 100;
            if (profitable.length > 0) {
                const ppcs = profitable.map(r => r.ppc).sort((a, b) => a - b);
                const crs = profitable.map(r => r.cr).sort((a, b) => a - b);
                const rois = profitable.filter(r => r.cost > 0 && r.roi > 0).map(r => Math.min(r.roi, 300)).sort((a, b) => a - b);
                medianPPC = ppcs[Math.floor(ppcs.length / 2)];
                medianCR = crs[Math.floor(crs.length / 2)];
                medianROI = rois.length > 0 ? rois[Math.floor(rois.length / 2)] : 100;
            }
            
            state.medianPPC = medianPPC; state.medianCR = medianCR; state.medianROI = medianROI;
            state.campaignCR = campaignAvgCR; state.campaignAvgPPC = campaignAvgPPC;
            $('med-ppc').textContent = '$' + state.medianPPC.toFixed(4);
            $('med-cr').textContent = (state.medianCR * 100).toFixed(3) + '%';
            calculateClickThreshold();

            let processed = classifyRanges(state.aggregatedData, medianPPC, medianCR, campaignAvgCR, campaignAvgPPC, totalCost, totalProfit, medianROI);
            processed = detectAnomalies(processed, campaignAvgCR);
            processed = assignVolumeTiers(processed);
            state.processed = processed;
            state.processedRaw = null;
            
            // Update BL threshold display
            const blMult = parseFloat($('bl-threshold-mult').value) || 0.5;
            const blCalcLabel = state.blCalc === 'median' ? '××—×¦×™×•×Ÿ' : state.blCalc === 'mean' ? '×××•×¦×¢' : 'Jenks Auto';
            const blDisplay = $('bl-current-threshold-display');
            const blCalcLabelEl = $('bl-calc-label');
            if (blCalcLabelEl) blCalcLabelEl.textContent = blCalcLabel;
            
            const blModeLabel = state.blMode === 'ppc' ? 'PPC' : state.blMode === 'cr' ? 'CR' : state.blMode === 'roi' ? 'ROI' : 'Score';
            const fmtBlVal = (v) => {
                if (state.blMode === 'ppc') return '$' + v.toFixed(4);
                if (state.blMode === 'cr') return (v * 100).toFixed(3) + '%';
                if (state.blMode === 'roi') return v.toFixed(0) + '%';
                return v.toFixed(3);
            };
            
            const blJenksInfo = $('bl-jenks-info');
            if (state.blCalc === 'jenks' && (state.blJenksHard > 0 || state.blJenksSoft > 0)) {
                if (blDisplay) blDisplay.textContent = 'Hard: ' + blModeLabel + ' < ' + fmtBlVal(state.blJenksHard) + ' | Soft: < ' + fmtBlVal(state.blJenksSoft);
                if (blJenksInfo) {
                    blJenksInfo.classList.remove('hidden');
                    $('bl-jenks-text').textContent = 'Hard < ' + fmtBlVal(state.blJenksHard) + ' | Soft < ' + fmtBlVal(state.blJenksSoft);
                }
            } else {
                if (blJenksInfo) blJenksInfo.classList.add('hidden');
                if (blDisplay && state.blCleanThreshold !== undefined) {
                    blDisplay.textContent = blModeLabel + ' < ' + fmtBlVal(state.blCleanThreshold * blMult) + ' (' + blCalcLabel + ': ' + fmtBlVal(state.blCleanThreshold) + ')';
                }
            }

            applyViewFilter();
            renderKPIs();
            renderTable();
            renderGlobalStats();
            updateMiniDashboard();
            enableCompareButton();
            updateMacroWarning();
        }
        
        function applyViewFilter() {
            const view = $('filter-view').value;
            const levelView = $('level-view').value;
            const minScore = parseFloat($('min-score-filter').value) || 0;
            
            if (state.aggMode === 'split' && !state.processedRaw && state.rawDetailRows.length > 0) {
                const rawClicks = state.rawDetailRows.reduce((s, r) => s + r.clicks, 0);
                const rawConv = state.rawDetailRows.reduce((s, r) => s + r.conv, 0);
                const rawCost = state.rawDetailRows.reduce((s, r) => s + r.cost, 0);
                const rawProfit = state.rawDetailRows.reduce((s, r) => s + r.profit, 0);
                const rawCampaignAvgCR = rawClicks > 0 ? (rawConv / rawClicks) : 0;
                const rawCampaignAvgPPC = rawClicks > 0 ? (rawProfit / rawClicks) : 0;
                let processedRaw = classifyRanges(state.rawDetailRows, state.medianPPC, state.medianCR, rawCampaignAvgCR, rawCampaignAvgPPC, rawCost, rawProfit, state.medianROI);
                processedRaw = detectAnomalies(processedRaw, rawCampaignAvgCR);
                processedRaw = assignVolumeTiers(processedRaw);
                state.processedRaw = processedRaw;
                
                if (state.compareMode && state.compareData) {
                    state.processedRaw.forEach(r => {
                        const old = state.compareData.get(r.identifier);
                        if (!old) { r.compareStatus = 'new'; r.profitChange = 0; }
                        else {
                            const profitChange = old.profit - r.profit;
                            r.profitChange = profitChange; r.oldProfit = old.profit; r.oldRoi = old.roi; r.oldCr = old.cr;
                            if (profitChange > 0.5) r.compareStatus = 'improved';
                            else if (profitChange < -0.5) r.compareStatus = 'declined';
                            else r.compareStatus = 'same';
                        }
                    });
                }
            }
            
            const sourceData = state.aggMode === 'split' ? state.processedRaw : state.processed;
            let finalData = [...(sourceData || [])];

            if (levelView === 'all' && state.hasHierarchy) {
                const summaries = state.summaryRows.map(r => ({
                    ...r, identifier: r.identifier || buildIdentifier(r),
                    roi: r.cost > 0 ? (r.profit / r.cost) * 100 : 0, cr: r.clicks > 0 ? r.conv / r.clicks : 0,
                    ppc: r.clicks > 0 ? r.profit / r.clicks : 0,
                    score: 0, category: 'summary', action: '-', isSummary: true
                }));
                finalData = [...summaries, ...finalData];
            }

            if (view === 'winners') finalData = finalData.filter(r => ['pure', 'gold'].includes(r.category));
            else if (view === 'relevant') finalData = finalData.filter(r => ['pure', 'gold', 'potential'].includes(r.category));
            else if (view === 'relevant_high') finalData = finalData.filter(r => ['pure', 'gold', 'potential'].includes(r.category) && r.volumeTier === 'high');
            else if (view === 'relevant_mid') finalData = finalData.filter(r => ['pure', 'gold', 'potential'].includes(r.category) && r.volumeTier === 'mid');
            else if (view === 'relevant_low') finalData = finalData.filter(r => ['pure', 'gold', 'potential'].includes(r.category) && r.volumeTier === 'low');
            else if (view === 'pure_high') finalData = finalData.filter(r => r.category === 'pure' && r.volumeTier === 'high');
            else if (view === 'pure_mid') finalData = finalData.filter(r => r.category === 'pure' && r.volumeTier === 'mid');
            else if (view === 'pure_low') finalData = finalData.filter(r => r.category === 'pure' && r.volumeTier === 'low');
            else if (view === 'gold_high') finalData = finalData.filter(r => r.category === 'gold' && r.volumeTier === 'high');
            else if (view === 'gold_mid') finalData = finalData.filter(r => r.category === 'gold' && r.volumeTier === 'mid');
            else if (view === 'gold_low') finalData = finalData.filter(r => r.category === 'gold' && r.volumeTier === 'low');
            else if (view === 'relevant_plus') finalData = finalData.filter(r => ['pure', 'gold', 'potential', 'testing'].includes(r.category));
            else if (view === 'custom') finalData = finalData.filter(r => r.matchesCustom);
            else if (view === 'blacklist') finalData = finalData.filter(r => r.category === 'blacklist');
            else if (view === 'blacklist-soft') finalData = finalData.filter(r => r.category === 'blacklist-soft');
            else if (view === 'watch') finalData = finalData.filter(r => r.category === 'watch');
            else if (view === 'all-bl') finalData = finalData.filter(r => ['blacklist', 'blacklist-soft', 'watch'].includes(r.category));
            else if (view === 'anomaly') finalData = finalData.filter(r => r.anomalies && r.anomalies.length > 0);
            else if (view === 'compare-new') finalData = finalData.filter(r => r.compareStatus === 'new');
            else if (view === 'compare-improved') finalData = finalData.filter(r => r.compareStatus === 'improved');
            else if (view === 'compare-declined') finalData = finalData.filter(r => r.compareStatus === 'declined');
            else if (view !== 'all') finalData = finalData.filter(r => r.category === view);
            
            if (minScore > 0) finalData = finalData.filter(r => r.score >= minScore || r.isSummary);
            if (state.icloudFilter === 'hide') finalData = finalData.filter(r => !isIcloudIP(r.identifier));
            else if (state.icloudFilter === 'only') finalData = finalData.filter(r => isIcloudIP(r.identifier));
            if (state.searchQuery) finalData = finalData.filter(r => r.identifier.toLowerCase().includes(state.searchQuery));
            
            // Volume filter
            const volFilter = $('filter-volume') ? $('filter-volume').value : 'all';
            if (volFilter === 'high') finalData = finalData.filter(r => r.volumeTier === 'high' || r.isSummary);
            else if (volFilter === 'mid') finalData = finalData.filter(r => r.volumeTier === 'mid' || r.isSummary);
            else if (volFilter === 'low') finalData = finalData.filter(r => r.volumeTier === 'low' || r.isSummary);
            else if (volFilter === 'high-mid') finalData = finalData.filter(r => r.volumeTier === 'high' || r.volumeTier === 'mid' || r.isSummary);
            
            state.filtered = finalData.sort((a, b) => {
                if (a.isSummary && !b.isSummary) return -1;
                if (!a.isSummary && b.isSummary) return 1;
                if (a.isSummary && b.isSummary) return a.level - b.level;
                if (state.sortColumn) {
                    let valA, valB;
                    switch (state.sortColumn) {
                        case 'identifier': valA = a.identifier; valB = b.identifier; break;
                        case 'category': valA = a.category; valB = b.category; break;
                        case 'volumeTier': { const vo = {high:3,mid:2,low:1}; valA = vo[a.volumeTier]||2; valB = vo[b.volumeTier]||2; break; }
                        case 'score': valA = a.score; valB = b.score; break;
                        case 'clicks': valA = a.clicks; valB = b.clicks; break;
                        case 'conv': valA = a.conv; valB = b.conv; break;
                        case 'revenue': valA = a.rev; valB = b.rev; break;
                        case 'cost': valA = a.cost; valB = b.cost; break;
                        case 'profit': valA = a.profit; valB = b.profit; break;
                        case 'roi': valA = a.roi; valB = b.roi; break;
                        case 'cr': valA = a.cr; valB = b.cr; break;
                        case 'ppc': valA = a.ppc; valB = b.ppc; break;
                        default: valA = a.score; valB = b.score;
                    }
                    if (typeof valA === 'string') { const cmp = valA.localeCompare(valB); return state.sortDirection === 'asc' ? cmp : -cmp; }
                    return state.sortDirection === 'asc' ? valA - valB : valB - valA;
                }
                return b.score - a.score;
            });
            state.page = 1;
        }
        
        function applyFilter() {
            applyViewFilter(); renderKPIs(); renderTable(); renderGlobalStats(); updateMiniDashboard(); updateMacroWarning();
        }
        
        function updateMacroWarning() {
            const warningEl = $('macro-warning'); if (!warningEl) return;
            const microCount = state.rawDetailRows ? state.rawDetailRows.length : 0;
            const macroCount = state.processed ? state.processed.length : 0;
            const microCountEl = $('micro-count'); const macroCountEl = $('macro-count');
            if (microCountEl) microCountEl.textContent = microCount.toLocaleString();
            if (macroCountEl) macroCountEl.textContent = macroCount.toLocaleString();
            warningEl.classList.toggle('hidden', state.aggMode !== 'smart');
        }
        
        function sortByColumn(column) {
            if (state.sortColumn === column) state.sortDirection = state.sortDirection === 'desc' ? 'asc' : 'desc';
            else { state.sortColumn = column; state.sortDirection = 'desc'; }
            applyFilter();
        }
        
        function updateSortIndicators() {
            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sort === state.sortColumn) th.classList.add(state.sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
            });
        }

        function buildIdentifier(row) {
            const parts = [];
            const skip = ['level', 'clicks', 'conversions', 'revenue', 'cost', 'profit', 'roi', 'cr'];
            for (let i = 0; i < state.headers.length; i++) {
                const h = state.headers[i].toLowerCase();
                if (skip.some(s => h.includes(s))) continue;
                const val = row.raw[i]; if (val && String(val).trim() !== '') parts.push(String(val).trim());
            }
            return parts.join(' | ') || 'Unknown';
        }

        $('filter-view').addEventListener('change', () => { applyFilter(); });
        $('level-view').addEventListener('change', () => { applyFilter(); });
        $('min-score-filter').addEventListener('input', () => { applyFilter(); });
        
        document.querySelectorAll('.icloud-switcher .switcher-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.icloud-switcher .switcher-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active'); state.icloudFilter = btn.dataset.value; saveSettings(); applyFilter();
            });
        });
        
        document.querySelectorAll('.agg-switcher .switcher-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const newMode = btn.dataset.agg; if (state.aggMode === newMode) return;
                document.querySelectorAll('.agg-switcher .switcher-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active'); state.aggMode = newMode; updateMacroWarning();
                if (newMode === 'smart') state.processedRaw = null;
                saveSettings(); applyFilter();
            });
        });
        
        $('ip-level').addEventListener('change', () => { processData(); });
        $('identifier-type').addEventListener('change', () => { 
            state.identifierType = $('identifier-type').value;
            if (state.identifierType !== 'auto') {
                if (state.identifierType === 'subid') $('ip-level').value = '1';
                else if (state.identifierType === 'zone') $('ip-level').value = '2';
                else if (state.identifierType === 'ip') $('ip-level').value = '1';
            }
            processData(); 
        });
        $('col-ip').addEventListener('change', () => { detectAndUpdateIdentifierType(); processData(); });
        $('custom-enabled').addEventListener('change', () => { processData(); });

        function setBlMode(mode) {
            state.blMode = mode;
            document.querySelectorAll('.bl-mode-btn[data-blmode]').forEach(btn => btn.classList.toggle('active', btn.dataset.blmode === mode));
            state.processedRaw = null;
            processFullPipeline();
            saveSettings();
        }
        
        function setBlCalc(calc) {
            state.blCalc = calc;
            if (calc !== 'jenks') {
                const blJenksInfo = $('bl-jenks-info');
                if (blJenksInfo) blJenksInfo.classList.add('hidden');
            }
            document.querySelectorAll('.bl-mode-btn[data-blcalc]').forEach(btn => btn.classList.toggle('active', btn.dataset.blcalc === calc));
            state.processedRaw = null;
            processFullPipeline();
            saveSettings();
        }

        function renderKPIs() {
            const sourceData = state.aggMode === 'split' ? (state.processedRaw || []) : (state.processed || []);
            
            const categories = [
                { key: 'blacklist', name: 'BLACKLIST', icon: 'ğŸš«', cls: 'kpi-blacklist', lblCls: 'text-red-600' },
                { key: 'blacklist-soft', name: 'BL SOFT', icon: 'ğŸŸ ', cls: 'kpi-blacklist', lblCls: 'text-orange-600' },
                { key: 'ignore', name: 'IGNORE', icon: 'ğŸ˜', cls: 'kpi-ignore', lblCls: 'text-slate-500' },
                { key: 'potential', name: 'POTENTIAL', icon: 'ğŸŒ±', cls: 'kpi-potential', lblCls: 'text-emerald-600' },
                { key: 'gold', name: 'GOLD', icon: 'ğŸ¥‡', cls: 'kpi-gold', lblCls: 'text-amber-600' },
                { key: 'pure', name: 'PURE', icon: 'ğŸ’', cls: 'kpi-pure', lblCls: 'text-amber-700' },
                { key: 'watch', name: 'WATCH', icon: 'ğŸ‘€', cls: 'kpi-testing', lblCls: 'text-blue-500' },
                { key: 'testing', name: state.customEnabled ? 'CUSTOM' : 'TESTING', icon: state.customEnabled ? 'ğŸ¯' : 'ğŸ”¬', cls: 'kpi-testing', lblCls: 'text-blue-600' }
            ];
            let html = '';
            categories.forEach(cat => {
                let rows;
                if (cat.key === 'testing' && state.customEnabled) rows = sourceData.filter(r => r.matchesCustom);
                else rows = sourceData.filter(r => r.category === cat.key);

                const s = { count: rows.length, clicks: rows.reduce((sum, r) => sum + r.clicks, 0), conv: rows.reduce((sum, r) => sum + r.conv, 0), rev: rows.reduce((sum, r) => sum + r.rev, 0), cost: rows.reduce((sum, r) => sum + r.cost, 0), profit: rows.reduce((sum, r) => sum + r.profit, 0) };
                s.roi = s.cost > 0 ? (s.profit / s.cost * 100) : (s.profit > 0 ? 999 : 0);
                s.cr = s.clicks > 0 ? (s.conv / s.clicks * 100) : 0;
                s.ppc = s.clicks > 0 ? (s.profit / s.clicks) : 0;
                const isCustomActive = cat.key === 'testing' && state.customEnabled;
                const profitCls = s.profit >= 0 ? 'text-green-600' : 'text-red-500';
                const roiCls = s.roi >= 0 ? 'text-green-600' : 'text-red-500';
                const ppcDisplay = s.ppc < 0 ? formatNum(Math.abs(s.ppc)) + '-$' : '$' + s.ppc.toFixed(4);

                html += '<div class="kpi-card ' + cat.cls + (isCustomActive ? ' kpi-custom-active' : '') + '" onclick="$(\'filter-view\').value=\'' + cat.key + '\'; applyFilter();">' +
                    // Header: count + label
                    '<div class="kpi-card-header">' +
                        '<span class="kpi-card-count">' + s.count.toLocaleString() + '</span>' +
                        '<span class="kpi-card-label ' + cat.lblCls + '">' + cat.name + ' ' + cat.icon + '</span>' +
                    '</div>' +
                    // Top row: PPC + Clicks in bordered boxes
                    '<div class="kpi-top-row">' +
                        '<div class="kpi-top-cell"><div class="kpi-top-lbl">PPC</div><div class="kpi-top-val text-amber-600">' + ppcDisplay + '</div></div>' +
                        '<div class="kpi-top-cell"><div class="kpi-top-lbl">Clicks</div><div class="kpi-top-val">' + formatNum(s.clicks) + '</div></div>' +
                    '</div>' +
                    // Mid row: Cost / Revenue / Conv
                    '<div class="kpi-mid-row">' +
                        '<div class="kpi-mid-cell"><div class="kpi-mid-lbl">Cost</div><div class="kpi-mid-val">$' + formatNum(s.cost) + '</div></div>' +
                        '<div class="kpi-mid-cell"><div class="kpi-mid-lbl">Revenue</div><div class="kpi-mid-val text-green-600">$' + formatNum(s.rev) + '</div></div>' +
                        '<div class="kpi-mid-cell"><div class="kpi-mid-lbl">Conv</div><div class="kpi-mid-val">' + s.conv.toLocaleString() + '</div></div>' +
                    '</div>' +
                    // Bottom row: CR / ROI / Profit
                    '<div class="kpi-bot-row">' +
                        '<div class="kpi-bot-cell"><div class="kpi-bot-lbl">CR</div><div class="kpi-bot-val text-blue-600">' + s.cr.toFixed(3) + '%</div></div>' +
                        '<div class="kpi-bot-cell"><div class="kpi-bot-lbl">ROI</div><div class="kpi-bot-val ' + roiCls + '">' + s.roi.toFixed(0) + '%</div></div>' +
                        '<div class="kpi-bot-cell"><div class="kpi-bot-lbl">Profit</div><div class="kpi-bot-val ' + profitCls + '">$' + formatNum(s.profit) + '</div></div>' +
                    '</div>' +
                '</div>';
            });
            $('kpi-container').innerHTML = html;
        }

        function formatNum(n) {
            if (Math.abs(n) >= 1e6) return (n / 1e6).toFixed(1) + 'M';
            if (Math.abs(n) >= 1e3) return (n / 1e3).toFixed(1) + 'K';
            return n.toFixed(0);
        }

        function renderGlobalStats() {
            const data = state.aggMode === 'split' ? (state.processedRaw || []) : (state.processed || []);
            const clicks = data.reduce((s, r) => s + r.clicks, 0);
            const conv = data.reduce((s, r) => s + r.conv, 0);
            const rev = data.reduce((s, r) => s + r.rev, 0);
            const cost = data.reduce((s, r) => s + r.cost, 0);
            const profit = data.reduce((s, r) => s + r.profit, 0);
            const roi = cost > 0 ? (profit / cost * 100) : 0;
            const cr = clicks > 0 ? (conv / clicks * 100) : 0;
            const ppc = clicks > 0 ? (profit / clicks) : 0;
            const anomalyCount = data.filter(r => r.anomalies && r.anomalies.length > 0).length;
            const pill = (l, v, c) => '<div class="g-item"><span class="g-lbl">' + l + '</span><span class="g-val ' + c + '">' + v + '</span></div>';
            $('global-stats').innerHTML = pill('××–×”×™×', data.length.toLocaleString(), '') + pill('Clicks', formatNum(clicks), 'text-blue-600') + pill('Conv', conv.toLocaleString(), '') + pill('Revenue', '$' + formatNum(rev), 'text-green-600') + pill('Cost', '$' + formatNum(cost), 'text-slate-500') + pill('Profit', '$' + formatNum(profit), profit >= 0 ? 'text-green-600' : 'text-red-500') + pill('ROI', roi.toFixed(0) + '%', roi >= 0 ? 'text-green-600' : 'text-red-500') + pill('CR', cr.toFixed(3) + '%', 'text-blue-600') + pill('PPC', '$' + ppc.toFixed(4), 'text-amber-600') + (anomalyCount > 0 ? pill('ğŸš¨', anomalyCount.toString(), 'text-red-500') : '');
        }

        function renderTable() {
            const start = (state.page - 1) * state.pageSize;
            const pageData = state.filtered.slice(start, start + state.pageSize);
            const showLevel = state.hasHierarchy;
            const showChanges = state.compareMode && $('chk-show-changes').checked;
            const showExtraCols = state.extraColumns && state.extraColumns.length > 0;
            
            const totals = { clicks: 0, conv: 0, rev: 0, cost: 0, profit: 0 };
            state.filtered.forEach(r => { if (!r.isSummary) { totals.clicks += r.clicks; totals.conv += r.conv; totals.rev += r.rev; totals.cost += r.cost; totals.profit += r.profit; } });
            totals.roi = totals.cost > 0 ? (totals.profit / totals.cost * 100) : 0;
            totals.cr = totals.clicks > 0 ? (totals.conv / totals.clicks * 100) : 0;
            totals.ppc = totals.clicks > 0 ? (totals.profit / totals.clicks) : 0;
            const extraColsPlaceholders = state.extraColumns.map(() => '<th class="summary-cell"></th>').join('');
            
            $('table-summary-row').innerHTML = '<th class="summary-cell text-center text-slate-400">-</th>' +
                (showLevel ? '<th class="summary-cell"></th>' : '') +
                '<th class="summary-cell text-right text-indigo-700">×¡×”"×› (' + state.filtered.length + ')</th>' +
                extraColsPlaceholders +
                '<th class="summary-cell"></th><th class="summary-cell"></th><th class="summary-cell"></th>' +
                '<th class="summary-cell text-center text-indigo-900">' + totals.clicks.toLocaleString() + '</th>' +
                '<th class="summary-cell text-center text-indigo-900">' + totals.conv.toLocaleString() + '</th>' +
                '<th class="summary-cell text-center text-green-700">$' + formatNum(totals.rev) + '</th>' +
                '<th class="summary-cell text-center text-slate-500">$' + formatNum(totals.cost) + '</th>' +
                '<th class="summary-cell text-center ' + (totals.profit >= 0 ? 'text-green-700' : 'text-red-600') + '">$' + formatNum(totals.profit) + '</th>' +
                '<th class="summary-cell text-center ' + (totals.roi >= 0 ? 'text-green-700' : 'text-red-600') + '">' + totals.roi.toFixed(0) + '%</th>' +
                '<th class="summary-cell text-center text-blue-700">' + totals.cr.toFixed(3) + '%</th>' +
                '<th class="summary-cell text-center text-amber-700">$' + totals.ppc.toFixed(4) + '</th>';

            const catConfig = {
                pure: { badge: 'badge-pure', row: 'row-pure', label: 'ğŸ’ PURE' },
                gold: { badge: 'badge-gold', row: 'row-gold', label: 'ğŸ¥‡ GOLD' },
                potential: { badge: 'badge-potential', row: 'row-potential', label: 'ğŸŒ± POTENTIAL' },
                ignore: { badge: 'badge-ignore', row: '', label: 'ğŸ˜ IGNORE' },
                blacklist: { badge: 'badge-blacklist', row: 'row-blacklist', label: 'ğŸ”´ BL HARD' },
                'blacklist-soft': { badge: 'badge-blacklist-soft', row: 'row-blacklist-soft', label: 'ğŸŸ  BL SOFT' },
                watch: { badge: 'badge-watch', row: 'row-watch', label: 'ğŸ‘€ WATCH' },
                testing: { badge: 'badge-testing', row: 'row-testing', label: 'ğŸ”¬ TESTING' },
                custom: { badge: 'badge-custom', row: 'row-custom', label: 'ğŸ¯ CUSTOM' },
                summary: { badge: 'badge-summary', row: 'row-summary', label: 'ğŸ“Š SUMMARY' }
            };
            const compareBadges = {
                'new': '<span class="compare-badge badge-new ml-1">âœ¨</span>',
                'improved': '<span class="compare-badge badge-improved ml-1">ğŸ“ˆ</span>',
                'declined': '<span class="compare-badge badge-declined ml-1">ğŸ“‰</span>'
            };
            function makeDelta(current, old, prefix, suffix, decimals) {
                if (!showChanges || old === undefined) return '';
                const delta = current - old;
                if (Math.abs(delta) < 0.01) return '';
                const cls = delta >= 0 ? 'delta-positive' : 'delta-negative';
                const sign = delta >= 0 ? '+' : '';
                return '<div class="change-delta ' + cls + '">' + sign + prefix + delta.toFixed(decimals) + suffix + '</div>';
            }

            let html = '';
            pageData.forEach((r, i) => {
                const cfg = catConfig[r.category] || catConfig.ignore;
                const scoreCls = r.score > 5 ? 'score-high' : r.score > 1 ? 'score-mid' : 'score-low';
                const levelCls = r.level === 1 ? 'level-1' : r.level === 2 ? 'level-2' : 'level-3';
                const displayId = highlightSafe(r.identifier, state.searchQuery);
                const cmpBadge = state.compareMode && r.compareStatus ? (compareBadges[r.compareStatus] || '') : '';
                const icloudBadge = isIcloudIP(r.identifier) ? '<span class="icloud-badge" title="iCloud Private Relay">â˜ï¸</span>' : '';
                const profitDelta = r.compareStatus !== 'new' ? makeDelta(r.profit, r.oldProfit, '$', '', 2) : '';
                const roiDelta = r.compareStatus !== 'new' ? makeDelta(r.roi, r.oldRoi, '', '%', 0) : '';
                const crDelta = r.compareStatus !== 'new' ? makeDelta(r.cr * 100, r.oldCr * 100, '', '%', 2) : '';
                
                // Anomaly flags
                let anomalyHtml = '';
                if (r.anomalies && r.anomalies.length > 0) {
                    r.anomalies.forEach(a => {
                        const cls = a.type === 'fraud' ? 'anomaly-fraud' : a.type === 'bot' ? 'anomaly-bot' : 'anomaly-outlier';
                        anomalyHtml += '<span class="anomaly-flag ' + cls + '" title="' + escapeHtml(a.reason) + '">' + a.label + '</span>';
                    });
                }
                
                // Wilson CI display on CR
                let crDisplay = (r.cr * 100).toFixed(3) + '%';
                if (r.wilson && r.conv > 0) {
                    const ciCls = r.wilson.confidence === 'high' ? 'ci-high' : r.wilson.confidence === 'medium' ? 'ci-medium' : 'ci-low';
                    crDisplay += ' <span class="ci-indicator ' + ciCls + '" title="CI: ' + (r.wilson.lower * 100).toFixed(3) + '%-' + (r.wilson.upper * 100).toFixed(3) + '% (' + r.wilson.confidence + ')"></span>';
                }
                
                let extraCells = '';
                if (showExtraCols) state.extraColumns.forEach(col => { extraCells += '<td class="text-center text-[11px] text-slate-600">' + escapeHtml((r.extraData && r.extraData[col]) || '-') + '</td>'; });
                
                html += '<tr class="' + cfg.row + '">' +
                    '<td class="text-center num-font text-slate-400">' + (start + i + 1) + '</td>' +
                    (showLevel ? '<td class="text-center"><span class="level-badge ' + levelCls + '">' + r.level + '</span></td>' : '') +
                    '<td class="text-right font-bold text-slate-700 ' + (r.isSummary ? 'text-indigo-700' : '') + '">' + icloudBadge + displayId + cmpBadge + anomalyHtml + '</td>' +
                    extraCells +
                    '<td class="text-center"><span class="cat-badge ' + cfg.badge + '">' + cfg.label + '</span></td>' +
                    '<td class="text-center"><span class="vol-badge vol-' + (r.volumeTier || 'mid') + '" title="' + (r.volumeRank || '') + '/' + (r.volumeTotal || '') + ' clicks in ' + (cfg.label || r.category) + '">' + (r.volumeTier === 'high' ? 'â–²' : r.volumeTier === 'low' ? 'â–¼' : 'â– ') + '</span></td>' +
                    '<td class="text-center"><span class="score-pill ' + scoreCls + '">' + r.score.toFixed(2) + '</span></td>' +
                    '<td class="text-center num-font">' + r.clicks.toLocaleString() + '</td>' +
                    '<td class="text-center num-font font-bold">' + r.conv + '</td>' +
                    '<td class="text-center num-font text-green-600">$' + r.rev.toFixed(2) + '</td>' +
                    '<td class="text-center num-font text-slate-500">$' + r.cost.toFixed(2) + '</td>' +
                    '<td class="text-center num-font font-bold ' + (r.profit >= 0 ? 'text-green-600' : 'text-red-500') + '">' + profitDelta + '$' + r.profit.toFixed(2) + '</td>' +
                    '<td class="text-center num-font ' + (r.roi >= 0 ? 'text-green-600' : 'text-red-500') + '">' + roiDelta + r.roi.toFixed(0) + '%</td>' +
                    '<td class="text-center num-font text-blue-600">' + crDelta + crDisplay + '</td>' +
                    '<td class="text-center num-font">$' + r.ppc.toFixed(4) + '</td></tr>';
            });
            const baseCols = showLevel ? 14 : 13;
            const colspan = baseCols + (showExtraCols ? state.extraColumns.length : 0);
            $('table-body').innerHTML = html || '<tr><td colspan="' + colspan + '" class="text-center text-slate-400 py-8">××™×Ÿ × ×ª×•× ×™×</td></tr>';
            const maxPage = Math.ceil(state.filtered.length / state.pageSize) || 1;
            $('disp-count').textContent = state.filtered.length.toLocaleString();
            $('page-num').textContent = state.page + ' / ' + maxPage;
            updateExtraColumnHeaders();
            updateSortIndicators();
        }
        
        function updateExtraColumnHeaders() {
            const existingExtraTh = document.querySelectorAll('.extra-col-th');
            existingExtraTh.forEach(th => th.remove());
            if (state.extraColumns && state.extraColumns.length > 0) {
                const categoryTh = document.querySelector('th:nth-child(' + (state.hasHierarchy ? 4 : 3) + ')');
                state.extraColumns.forEach(col => {
                    const th = document.createElement('th'); th.className = 'text-center extra-col-th'; th.textContent = col;
                    categoryTh.parentNode.insertBefore(th, categoryTh);
                });
            }
        }

        function changePage(d) {
            const max = Math.ceil(state.filtered.length / state.pageSize) || 1;
            if (state.page + d > 0 && state.page + d <= max) { state.page += d; renderTable(); }
        }

        function exportData() {
            const wb = XLSX.utils.book_new();
            const useCidr = $('chk-cidr').checked;
            const source = state.aggMode === 'split' ? (state.processedRaw || []) : (state.processed || []);
            
            // === BUILD SUMMARY SHEET FIRST ===
            const allNonSummary = source.filter(r => !r.isSummary);
            const blHard = allNonSummary.filter(r => r.category === 'blacklist');
            const blSoft = allNonSummary.filter(r => r.category === 'blacklist-soft');
            const blWatch = allNonSummary.filter(r => r.category === 'watch');
            const allBL = [...blHard, ...blSoft];
            const pure = allNonSummary.filter(r => r.category === 'pure');
            const gold = allNonSummary.filter(r => r.category === 'gold');
            const potential = allNonSummary.filter(r => r.category === 'potential');
            const testing = allNonSummary.filter(r => r.category === 'testing');
            const winners = [...pure, ...gold];
            
            const sum = (arr, key) => arr.reduce((s, r) => s + r[key], 0);
            const totalProfit = sum(allNonSummary, 'profit');
            const totalCost = sum(allNonSummary, 'cost');
            const totalRev = sum(allNonSummary, 'rev');
            const totalClicks = sum(allNonSummary, 'clicks');
            const totalConv = sum(allNonSummary, 'conv');
            
            const blWaste = Math.abs(sum(allBL, 'profit'));
            const winnersProfit = sum(winners, 'profit');
            const potentialProfit = sum(potential, 'profit');
            
            const summaryData = [
                { Section: 'ğŸ“Š ×¡×™×›×•× ×›×œ×œ×™', Metric: '', Value: '', Note: '' },
                { Section: '', Metric: '×¡×”"×› ××–×”×™×', Value: allNonSummary.length, Note: '' },
                { Section: '', Metric: '×¡×”"×› ×§×œ×™×§×™×', Value: totalClicks, Note: '' },
                { Section: '', Metric: '×¡×”"×› ×”××¨×•×ª', Value: totalConv, Note: '' },
                { Section: '', Metric: '×¡×”"×› ×”×›× ×¡×”', Value: '$' + totalRev.toFixed(2), Note: '' },
                { Section: '', Metric: '×¡×”"×› ×¢×œ×•×ª', Value: '$' + totalCost.toFixed(2), Note: '' },
                { Section: '', Metric: '×¡×”"×› ×¨×•×•×—', Value: '$' + totalProfit.toFixed(2), Note: totalProfit >= 0 ? 'âœ… ×¨×•×•×—×™' : 'âŒ ×”×¤×¡×“' },
                { Section: '', Metric: 'ROI', Value: totalCost > 0 ? (totalProfit / totalCost * 100).toFixed(1) + '%' : 'N/A', Note: '' },
                { Section: '', Metric: 'CR', Value: totalClicks > 0 ? (totalConv / totalClicks * 100).toFixed(3) + '%' : 'N/A', Note: '' },
                { Section: '', Metric: 'PPC', Value: totalClicks > 0 ? '$' + (totalProfit / totalClicks).toFixed(4) : 'N/A', Note: '' },
                { Section: '', Metric: '', Value: '', Note: '' },
                { Section: 'ğŸ”´ ×—×¡×•× ×•×ª×—×¡×•×š', Metric: '', Value: '', Note: '' },
                { Section: '', Metric: '×–×•× ×™× ×œ×—×¡×™××” (Hard+Soft)', Value: allBL.length, Note: '' },
                { Section: '', Metric: '×”×¤×¡×“ ××¦×˜×‘×¨ ×-BL', Value: '$' + blWaste.toFixed(2), Note: '×—×¡×•× â†’ ×—×¡×•×š ×¡×›×•× ×–×”' },
                { Section: '', Metric: '×§×œ×™×§×™× ××‘×•×–×‘×–×™×', Value: sum(allBL, 'clicks').toLocaleString(), Note: Math.round(sum(allBL, 'clicks') / totalClicks * 100) + '% ××”×ª× ×•×¢×”' },
                { Section: '', Metric: '×¢×œ×•×ª ××‘×•×–×‘×–×ª', Value: '$' + sum(allBL, 'cost').toFixed(2), Note: '' },
            ];
            
            // Top 5 biggest BL losers
            const topLosers = [...allBL].sort((a, b) => a.profit - b.profit).slice(0, 5);
            if (topLosers.length) {
                summaryData.push({ Section: '', Metric: '', Value: '', Note: '' });
                summaryData.push({ Section: '', Metric: 'âš¡ TOP ×”×¤×¡×“×™× ×œ×—×¡×™××” ××™×™×“×™×ª:', Value: '', Note: '' });
                topLosers.forEach((r, i) => {
                    summaryData.push({ Section: '', Metric: (i + 1) + '. ' + r.identifier, Value: '$' + r.profit.toFixed(2), Note: r.clicks.toLocaleString() + ' clicks, ' + r.conv + ' conv' });
                });
            }
            
            summaryData.push({ Section: '', Metric: '', Value: '', Note: '' });
            summaryData.push({ Section: 'ğŸŸ¢ ×”×¢×œ×” bid ×•×ª×¨×•×•×™×— ×™×•×ª×¨', Metric: '', Value: '', Note: '' });
            summaryData.push({ Section: '', Metric: 'Pure + Gold ×–×•× ×™×', Value: winners.length, Note: '' });
            summaryData.push({ Section: '', Metric: '×¨×•×•×— × ×•×›×—×™ ×-Winners', Value: '$' + winnersProfit.toFixed(2), Note: '' });
            summaryData.push({ Section: '', Metric: '×¨×•×•×— ×-Potential', Value: '$' + potentialProfit.toFixed(2), Note: potential.length + ' ×–×•× ×™× ×©××¤×©×¨ ×œ×§×“×' });
            
            // Top 5 winners to scale
            const topWinners = [...winners].sort((a, b) => b.profit - a.profit).slice(0, 5);
            if (topWinners.length) {
                summaryData.push({ Section: '', Metric: '', Value: '', Note: '' });
                summaryData.push({ Section: '', Metric: 'âš¡ TOP ×¨×•×•×—×™×™× ×œ×”×’×“×œ×ª bid:', Value: '', Note: '' });
                topWinners.forEach((r, i) => {
                    summaryData.push({ Section: '', Metric: (i + 1) + '. ' + r.identifier, Value: '+$' + r.profit.toFixed(2), Note: 'ROI ' + r.roi.toFixed(0) + '%, CR ' + (r.cr * 100).toFixed(3) + '%' });
                });
            }
            
            summaryData.push({ Section: '', Metric: '', Value: '', Note: '' });
            summaryData.push({ Section: 'ğŸ‘€ Watch', Metric: '', Value: '', Note: '' });
            summaryData.push({ Section: '', Metric: '×–×•× ×™× ×‘-Watch', Value: blWatch.length, Note: '×œ× ×œ×—×¡×•× ×¢×“×™×™×Ÿ, ×œ×¢×§×•×‘' });
            summaryData.push({ Section: '', Metric: '×–×•× ×™× ×‘-Testing', Value: testing.length, Note: '××™×Ÿ ××¡×¤×™×§ ×“××˜×” ×¢×“×™×™×Ÿ' });
            
            summaryData.push({ Section: '', Metric: '', Value: '', Note: '' });
            // Calculate projected CRs
            const currentCR = totalClicks > 0 ? (totalConv / totalClicks * 100) : 0;
            const afterBlockClicks = totalClicks - sum(allBL, 'clicks');
            const afterBlockConv = totalConv - sum(allBL, 'conv');
            const afterBlockCR = afterBlockClicks > 0 ? (afterBlockConv / afterBlockClicks * 100) : 0;
            const afterBlockProfit = totalProfit + blWaste;
            const afterBlockCost = totalCost - sum(allBL, 'cost');
            const afterBlockROI = afterBlockCost > 0 ? (afterBlockProfit / afterBlockCost * 100) : 0;
            
            const wlClicks = sum(winners, 'clicks');
            const wlConv = sum(winners, 'conv');
            const wlCR = wlClicks > 0 ? (wlConv / wlClicks * 100) : 0;
            const wlCost = sum(winners, 'cost');
            const wlROI = wlCost > 0 ? (winnersProfit / wlCost * 100) : 0;
            
            summaryData.push({ Section: 'ğŸ’¡ ×”×©×•×¨×” ×”×ª×—×ª×•× ×”', Metric: '', Value: '', Note: '' });
            summaryData.push({ Section: '', Metric: '×—×¡×•× ' + allBL.length + ' ×–×•× ×™×', Value: 'â†’ ×—×¡×•×š $' + blWaste.toFixed(2), Note: 'CR: ' + currentCR.toFixed(3) + '% â†’ ' + afterBlockCR.toFixed(3) + '%  |  ROI: ' + afterBlockROI.toFixed(0) + '%' });
            summaryData.push({ Section: '', Metric: 'WL ×¢×œ ' + winners.length + ' ×–×•× ×™× ×‘×œ×‘×“', Value: 'â†’ ×¨×•×•×— $' + winnersProfit.toFixed(2), Note: 'CR: ' + wlCR.toFixed(3) + '%  |  ROI: ' + wlROI.toFixed(0) + '%' });
            
            const summaryWs = XLSX.utils.json_to_sheet(summaryData);
            summaryWs['!cols'] = [{ wch: 22 }, { wch: 35 }, { wch: 20 }, { wch: 35 }];
            XLSX.utils.book_append_sheet(wb, summaryWs, '×¡×™×›×•×');
            
            // === CATEGORY SHEETS ===
            const exports = [
                { id: 'chk-pure', name: 'Pure', pick: r => r.category === 'pure' },
                { id: 'chk-gold', name: 'Gold', pick: r => r.category === 'gold' },
                { id: 'chk-potential', name: 'Potential', pick: r => r.category === 'potential' },
                { id: 'chk-bl', name: 'Blacklist', pick: r => ['blacklist', 'blacklist-soft'].includes(r.category) },
                { id: 'chk-custom', name: 'Custom', pick: r => r.matchesCustom || r.category === 'custom' }
            ];
            let count = 1; // Already have summary
            exports.forEach(exp => {
                if ($(exp.id).checked) {
                    const rows = source.filter(r => !r.isSummary && exp.pick(r));
                    if (rows.length) {
                        const data = rows.map(r => ({
                            Identifier: useCidr ? toCIDR(r.identifier) : r.identifier,
                            Category: r.category,
                            Volume: (r.volumeTier || 'mid').toUpperCase(),
                            BL_Severity: r.blSeverity || '',
                            Score: r.score.toFixed(2), Clicks: r.clicks, Conv: r.conv,
                            Revenue: r.rev.toFixed(2), Cost: r.cost.toFixed(2), Profit: r.profit.toFixed(2),
                            'ROI%': r.roi.toFixed(0), 'CR%': (r.cr * 100).toFixed(3), PPC: r.ppc.toFixed(4),
                            CR_Confidence: r.wilson ? r.wilson.confidence : '',
                            Action: r.action,
                            Anomalies: r.anomalies ? r.anomalies.map(a => a.label).join(', ') : ''
                        }));
                        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), exp.name);
                        count++;
                    }
                }
            });
            if (count) { XLSX.writeFile(wb, 'ListLab_V49_Export.xlsx'); showToast('×§×•×‘×¥ Excel ×™×•×¦× ×‘×”×¦×œ×—×” (' + count + ' ×’×™×œ×™×•× ×•×ª, ×›×•×œ×œ ×¡×™×›×•×)', 'success'); }
            else alert('×‘×—×¨ ×œ×¤×—×•×ª ×¨×©×™××” ××—×ª');
        }

        function copyIPs() {
            if (!state.filtered.length) return alert('××™×Ÿ × ×ª×•× ×™×');
            const useCidr = $('chk-copy-cidr').checked;
            const allIds = state.filtered.filter(r => !r.isSummary).map(r => useCidr ? toCIDR(r.identifier) : r.identifier);
            const uniqueIds = [...new Set(allIds)];
            navigator.clipboard.writeText(uniqueIds.join('\n')).then(() => {
                showToast('×”×•×¢×ª×§×• ' + uniqueIds.length + ' ××–×”×™×', 'success');
                const btn = $('btn-copy');
                btn.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i> ×”×•×¢×ª×§!';
                lucide.createIcons();
                setTimeout(() => { btn.innerHTML = '<i data-lucide="copy" class="w-3 h-3"></i> ×”×¢×ª×§ <span class="shortcut-key">C</span>'; lucide.createIcons(); }, 1500);
            });
        }

        function debounce(fn, ms = 150) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); }; }
        const debouncedProcess = debounce(processData, 200);
        
        function syncControls(rangeId, numId) {
            const range = $(rangeId); const num = $(numId);
            range.addEventListener('input', () => { num.value = range.value; debouncedProcess(); });
            num.addEventListener('input', () => { range.value = num.value; debouncedProcess(); });
        }
        syncControls('pure-pct', 'pure-pct-num');
        syncControls('gold-pct', 'gold-pct-num');
        
        function toggleDashboard() {
            const content = $('dashboard-content'); const icon = $('dash-toggle-icon');
            content.classList.toggle('hidden');
            icon.style.transform = content.classList.contains('hidden') ? '' : 'rotate(180deg)';
        }
        
        function toggleFocusMode() {
            const container = document.querySelector('.dash-container');
            container.classList.toggle('focus-mode');
            const isFocus = container.classList.contains('focus-mode');
            if (isFocus) {
                showToast('ğŸ” Focus Mode â€” ×œ×—×¥ F ×œ×—×–×•×¨', 'info', 2000);
            }
        }
        
        function toggleSectionCollapse(sectionId) {
            const section = $(sectionId);
            section.classList.toggle('section-collapsed');
        }
        
        function getCategoryMini(cat) {
            const cats = {
                pure: '<span class="text-[9px] px-1 rounded bg-amber-100 text-amber-700">PURE</span>',
                gold: '<span class="text-[9px] px-1 rounded bg-amber-200 text-amber-800">GOLD</span>',
                potential: '<span class="text-[9px] px-1 rounded bg-green-100 text-green-700">POT</span>',
                ignore: '<span class="text-[9px] px-1 rounded bg-slate-100 text-slate-600">IGN</span>',
                blacklist: '<span class="text-[9px] px-1 rounded bg-red-100 text-red-700">BL</span>',
                'blacklist-soft': '<span class="text-[9px] px-1 rounded bg-orange-100 text-orange-700">SOFT</span>',
                watch: '<span class="text-[9px] px-1 rounded bg-yellow-100 text-yellow-700">WATCH</span>',
                testing: '<span class="text-[9px] px-1 rounded bg-blue-100 text-blue-700">TEST</span>'
            };
            return cats[cat] || '';
        }
        
        function updateMiniDashboard() {
            const sourceData = state.aggMode === 'split' ? (state.processedRaw || []) : (state.processed || []);
            if (!sourceData.length) { $('section-dashboard').classList.add('hidden'); return; }
            $('section-dashboard').classList.remove('hidden');
            const byProfit = [...sourceData].sort((a, b) => b.profit - a.profit);
            const testedOnly = byProfit.filter(r => r.clicks >= state.clickThreshold);
            
            const top5 = testedOnly.filter(r => r.profit > 0).slice(0, 5);
            $('top-performers').innerHTML = top5.length ? top5.map(r => '<div class="performer-item"><span class="performer-id" title="' + escapeHtml(r.identifier) + '">' + escapeHtml(r.identifier) + '</span>' + getCategoryMini(r.category) + '<span class="performer-val text-green-600">+$' + r.profit.toFixed(2) + '</span></div>').join('') : '<div class="text-slate-400 text-[10px]">××™×Ÿ × ×ª×•× ×™×</div>';
            
            const bottom5 = testedOnly.filter(r => r.profit < 0).sort((a, b) => a.profit - b.profit).slice(0, 5);
            $('top-losers').innerHTML = bottom5.length ? bottom5.map(r => '<div class="performer-item"><span class="performer-id" title="' + escapeHtml(r.identifier) + '">' + escapeHtml(r.identifier) + '</span>' + getCategoryMini(r.category) + '<span class="performer-val text-red-500">$' + r.profit.toFixed(2) + '</span></div>').join('') : '<div class="text-slate-400 text-[10px]">××™×Ÿ × ×ª×•× ×™×</div>';

            const totalClicks = sourceData.reduce((s, r) => s + r.clicks, 0);
            const totalCost = sourceData.reduce((s, r) => s + r.cost, 0);
            const avgCPC = totalClicks > 0 ? totalCost / totalClicks : 0.001;
            const payoutsPerConv = [];
            sourceData.forEach(r => { if (r.conv > 0 && r.rev > 0) payoutsPerConv.push(r.rev / r.conv); });
            payoutsPerConv.sort((a, b) => a - b);
            const medianPayout = payoutsPerConv.length > 0 ? payoutsPerConv[Math.floor(payoutsPerConv.length / 2)] : 0;
            const maxClicksUntilLoss = avgCPC > 0 ? medianPayout / avgCPC : 0;
            const minCRtoProfit = medianPayout > 0 ? avgCPC / medianPayout : 0;
            
            $('be-max-clicks').textContent = maxClicksUntilLoss.toLocaleString(undefined, {maximumFractionDigits: 0});
            $('be-clicks-formula').textContent = 'Median AP $' + medianPayout.toFixed(2) + ' Ã· CPC $' + avgCPC.toFixed(4);
            $('be-min-cr').textContent = (minCRtoProfit * 100).toFixed(3) + '%';
            $('be-cr-formula').textContent = 'CPC $' + avgCPC.toFixed(4) + ' Ã· Median AP $' + medianPayout.toFixed(2);

            const avgROI = testedOnly.length > 0 ? testedOnly.reduce((s, r) => s + r.roi, 0) / testedOnly.length : 0;
            const crValues = testedOnly.filter(r => r.conv > 0).map(r => r.cr).sort((a, b) => a - b);
            const medianCR = crValues.length > 0 ? crValues[Math.floor(crValues.length / 2)] : 0;
            
            const outstanding = testedOnly.filter(r => {
                if (r.profit <= 0 || r.conv < 2 || r.cr < medianCR) return false;
                const roiRatio = avgROI > 0 ? r.roi / avgROI : 0;
                return roiRatio >= 2 && r.roi > 750;
            }).sort((a, b) => b.roi - a.roi).slice(0, 5);
            
            $('outstanding-list').innerHTML = outstanding.length ? outstanding.map(r => {
                const multiplier = avgROI > 0 ? (r.roi / avgROI).toFixed(1) : 'âˆ';
                return '<div class="performer-item"><span class="performer-id" title="' + escapeHtml(r.identifier) + '">' + escapeHtml(r.identifier) + '</span>' + getCategoryMini(r.category) + '<span class="performer-val text-purple-600">x' + multiplier + '</span></div>';
            }).join('') : '<div class="text-slate-400 text-[10px]">××™×Ÿ ××¦×˜×™×™× ×™× ×‘×•×œ×˜×™×</div>';
        }
        
        function searchIdentifier(query) { state.searchQuery = query.trim().toLowerCase(); applyFilter(); }
        $('search-input').addEventListener('input', (e) => { searchIdentifier(e.target.value); });

        function enableCompareButton() { $('btn-compare').disabled = !state.processed.length; $('btn-auto-thresh').disabled = !state.processed.length; $('auto-metric').disabled = !state.processed.length; }
        $('btn-compare').addEventListener('click', () => { $('compare-input').click(); });
        $('btn-clear-compare').addEventListener('click', () => {
            state.compareMode = false; state.compareData = null;
            state.compareResults = { new: [], improved: [], declined: [], gone: [] };
            state.processed.forEach(r => { r.compareStatus = null; r.profitChange = undefined; r.oldProfit = undefined; r.oldRoi = undefined; r.oldCr = undefined; });
            if (state.processedRaw) state.processedRaw.forEach(r => { r.compareStatus = null; r.profitChange = undefined; r.oldProfit = undefined; r.oldRoi = undefined; r.oldCr = undefined; });
            $('compare-panel').classList.add('hidden'); $('btn-clear-compare').classList.add('hidden'); $('show-changes-box').classList.add('hidden');
            applyFilter();
        });
        $('chk-show-changes').addEventListener('change', () => { renderTable(); });
        $('compare-input').addEventListener('change', function(e) {
            const file = e.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = function(evt) {
                try {
                    const data = new Uint8Array(evt.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });
                    if (json.length < 2) { alert('×§×•×‘×¥ ×”×”×©×•×•××” ×¨×™×§'); return; }
                    const ipIdx = +$('col-ip').value, clicksIdx = +$('col-clicks').value, convIdx = +$('col-conv').value, revIdx = +$('col-rev').value, costIdx = +$('col-cost').value;
                    const compareMap = new Map();
                    for (let i = 1; i < json.length; i++) {
                        const row = json[i]; const id = String(row[ipIdx] || '').trim();
                        if (!id || isInvalidIdentifier(id)) continue;
                        const clicks = parseFloat(row[clicksIdx]) || 0, conv = parseFloat(row[convIdx]) || 0, rev = parseFloat(row[revIdx]) || 0, cost = parseFloat(row[costIdx]) || 0;
                        const profit = rev - cost, roi = cost > 0 ? ((rev - cost) / cost) * 100 : 0, cr = clicks > 0 ? conv / clicks : 0;
                        compareMap.set(id, { clicks, conv, rev, cost, profit, roi, cr });
                    }
                    state.compareData = compareMap; state.compareMode = true;
                    const results = { new: [], improved: [], declined: [], gone: [] };
                    const currentIds = new Set(state.processed.map(r => r.identifier));
                    function applyCompareToRow(r) {
                        const old = compareMap.get(r.identifier);
                        if (!old) { r.compareStatus = 'new'; r.profitChange = 0; return 'new'; }
                        else {
                            const profitChange = old.profit - r.profit;
                            r.profitChange = profitChange; r.oldProfit = old.profit; r.oldRoi = old.roi; r.oldCr = old.cr;
                            if (profitChange > 0.5) { r.compareStatus = 'improved'; return 'improved'; }
                            else if (profitChange < -0.5) { r.compareStatus = 'declined'; return 'declined'; }
                            else { r.compareStatus = 'same'; return 'same'; }
                        }
                    }
                    state.processed.forEach(r => { const s = applyCompareToRow(r); if (s === 'new') results.new.push(r.identifier); else if (s === 'improved') results.improved.push(r.identifier); else if (s === 'declined') results.declined.push(r.identifier); });
                    if (state.processedRaw) state.processedRaw.forEach(r => applyCompareToRow(r));
                    compareMap.forEach((_, id) => { if (!currentIds.has(id)) results.gone.push(id); });
                    state.compareResults = results;
                    $('compare-panel').classList.remove('hidden'); $('btn-clear-compare').classList.remove('hidden'); $('show-changes-box').classList.remove('hidden');
                    $('compare-file-name').textContent = file.name;
                    $('cmp-new').textContent = results.new.length; $('cmp-improved').textContent = results.improved.length;
                    $('cmp-declined').textContent = results.declined.length; $('cmp-gone').textContent = results.gone.length;
                    showToast('×”×©×•×•××” × ×˜×¢× ×”: ' + results.new.length + ' ×—×“×©×™×, ' + results.improved.length + ' ×”×©×ª×¤×¨×•, ' + results.declined.length + ' ×™×¨×“×•', 'info');
                    applyFilter();
                } catch (err) { console.error('Compare file error:', err); alert('×©×’×™××” ×‘×§×¨×™××ª ×§×•×‘×¥ ×”×”×©×•×•××”'); }
            };
            reader.readAsArrayBuffer(file);
            e.target.value = '';
        });
    </script>
</body>
</html>
