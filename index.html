<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ListLab V55 - Enhanced Edition</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">

    <style>
        /* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
           LISTLAB V52 - ENHANCED EDITION
           Based on V48 by Nir & Yael
           Improvements: Scoring, BL tiers, Wilson CI, 
           localStorage, compact KPIs, shortcuts, anomaly detection
           â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
        
        body { font-family: 'Assistant', sans-serif; background: #eef0f4; height: 100vh; overflow: hidden; color: #1e293b; font-size: 14px; box-sizing: border-box; margin: 0; }
        *, *::before, *::after { box-sizing: border-box; }
        .num-font { font-family: 'Inter', sans-serif; }
        
        .main-wrapper { width: 100%; height: 100vh; display: flex; flex-direction: column; padding: 6px; gap: 5px; }
        .glass-header { background: white; border-radius: 10px; padding: 0 1.2rem; box-shadow: 0 1px 3px rgba(0,0,0,0.04); display: flex; justify-content: space-between; align-items: center; height: 50px; border: 1px solid #e5e7eb; flex-shrink: 0; }
        .dash-container { flex: 1; min-height: 0; background: white; border-radius: 10px; box-shadow: 0 1px 4px rgba(0,0,0,0.05); display: flex; overflow: hidden; border: 1px solid #e0e3e8; }
        
        .dash-sidebar { width: 310px; background: #f6f7f9; border-left: 1px solid #e0e3e8; display: flex; flex-direction: column; overflow-y: auto; padding: 10px; gap: 6px; flex-shrink: 0; }
        .dash-content { flex: 1; min-height: 0; background: #fafbfc; display: flex; flex-direction: column; overflow: hidden; }

        .control-box { border-radius: 8px; padding: 10px; border: 1px solid #e5e7eb; background: white !important; position: relative; transition: box-shadow 0.15s; }
        .control-box:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
        .control-box.border-blue-200 { border-right: 3px solid #3b82f6; }
        .control-box.border-slate-300 { border-right: 3px solid #94a3b8; }
        .control-box.border-amber-200 { border-right: 3px solid #f59e0b; }
        .control-box.border-purple-200 { border-right: 3px solid #8b5cf6; }
        .control-box.border-slate-200 { border-right: 3px solid #64748b; }
        .control-box.border-red-200 { border-right: 3px solid #ef4444; }
        
        .control-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        .control-item { display: flex; flex-direction: column; }
        .lbl-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
        .lbl-sm { font-size: 11px; font-weight: 700; color: #64748b; }
        
        input[type=range] { height: 4px; border-radius: 2px; background: #e2e8f0; outline: none; appearance: none; cursor: pointer; width: 100%; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%; background: currentColor; border: 2px solid white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .dash-input { width: 46px; font-family: 'Inter', sans-serif; font-weight: 700; font-size: 11px; text-align: center; border: 1px solid #ddd; border-radius: 5px; padding: 2px; background: #fafbfc; height: 24px; transition: border-color 0.15s; }
        .dash-input:focus { border-color: #3b82f6; outline: none; }

        .collapsible-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 2px 0; }
        .collapsible-content { display: none; }
        .collapsible-content.open { display: block; }
        .collapse-icon { transition: transform 0.2s; }
        .collapse-icon.open { transform: rotate(180deg); }

        /* === KPI CARDS === */
        .kpi-container { display: flex; flex-wrap: nowrap; gap: 6px; overflow-x: auto; padding: 3px 0 2px 0; }
        .kpi-card { 
            background: white; border: 1px solid #e2e5e9; border-radius: 8px; 
            cursor: pointer; transition: all 0.15s; flex: 1; min-width: 165px;
            display: flex; flex-direction: column; overflow: visible;
        }
        .kpi-card:hover { box-shadow: 0 3px 12px -2px rgba(0,0,0,0.1); transform: translateY(-1px); }
        .kpi-card-header { display: flex; justify-content: space-between; align-items: center; padding: 7px 10px 5px; }
        .kpi-card-count { font-family: 'Inter', sans-serif; font-size: 22px; font-weight: 900; color: #1e293b; line-height: 1; }
        .kpi-card-label { font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.03em; display: flex; align-items: center; gap: 3px; white-space: nowrap; }
        .kpi-top-row { display: grid; grid-template-columns: 1fr 1fr; gap: 3px; padding: 4px 6px; }
        .kpi-top-cell { background: #f8f9fb; border: 1px solid #eef0f3; border-radius: 5px; padding: 2px 4px; text-align: center; }
        .kpi-top-lbl { font-size: 7px; font-weight: 700; color: #9ca3af; text-transform: uppercase; }
        .kpi-top-val { font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; color: #374151; white-space: nowrap; }
        .kpi-mid-row { display: grid; grid-template-columns: 1fr 1fr 1fr; border-top: 1px solid #f1f2f4; }
        .kpi-mid-cell { padding: 2px 4px; text-align: center; }
        .kpi-mid-lbl { font-size: 7px; font-weight: 700; color: #b0b5bc; text-transform: uppercase; }
        .kpi-mid-val { font-family: 'Inter', sans-serif; font-size: 10px; font-weight: 700; color: #4b5563; white-space: nowrap; }
        .kpi-bot-row { display: grid; grid-template-columns: 1fr 1fr 1fr; border-top: 1px solid #eef0f3; background: #fcfcfd; }
        .kpi-bot-cell { padding: 3px 4px; text-align: center; }
        .kpi-bot-lbl { font-size: 7px; font-weight: 700; color: #9ca3af; }
        .kpi-bot-val { font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; white-space: nowrap; }
        
        .kpi-pure { border-right: 3px solid #3b82f6; background: linear-gradient(135deg, #eff6ff 0%, white 100%); }
        .kpi-gold { border-right: 3px solid #f59e0b; background: linear-gradient(135deg, #fffbeb 0%, white 100%); }
        .kpi-potential { border-right: 3px solid #10b981; background: linear-gradient(135deg, #ecfdf5 0%, white 100%); }
        .kpi-ignore { border-right: 3px solid #94a3b8; }
        .kpi-poor { border-right: 3px solid #f97316; background: linear-gradient(135deg, #fff7ed 0%, white 100%); }
        .kpi-bl-soft { border-right: 3px solid #ef4444; background: linear-gradient(135deg, #fef2f2 0%, white 100%); }
        .kpi-blacklist { border-right: 3px solid #b91c1c; background: linear-gradient(135deg, #fef2f2 0%, white 100%); }
        .kpi-testing { border-right: 3px solid #3b82f6; }
        .kpi-custom-active { border: 2px solid #8b5cf6; box-shadow: 0 0 12px rgba(139, 92, 246, 0.2); }

        .stat-lbl { font-size: 10px; font-weight: 700; color: #9ca3af; text-transform: uppercase; letter-spacing: 0.03em; }
        
        /* Focus mode: F key hides everything except table */
        .focus-mode .collapsible-section,
        .focus-mode #section-dashboard,
        .focus-mode .dash-sidebar { display: none !important; }
        .focus-mode .dash-content { flex: 1; }
        .focus-mode .table-toolbar { padding: 4px 8px !important; }
        
        /* Section collapse */
        .section-toggle { 
            position: absolute; top: 4px; left: 4px; z-index: 5;
            width: 20px; height: 20px; border-radius: 50%; border: 1px solid #ddd;
            background: white; cursor: pointer; display: flex; align-items: center; 
            justify-content: center; font-size: 10px; color: #999; transition: all 0.15s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.08);
        }
        .section-toggle:hover { background: #f3f4f6; color: #333; }
        .section-collapsed .section-inner { display: none !important; }
        .section-collapsed { padding: 0 !important; padding-left: 28px !important; min-height: 22px !important; }
        .section-collapsed .section-toggle { top: 1px; }
        
        /* Focus indicator */
        #focus-badge { 
            position: fixed; top: 8px; left: 50%; transform: translateX(-50%);
            background: #1e293b; color: white; padding: 3px 14px; border-radius: 20px;
            font-size: 11px; font-weight: 700; z-index: 100; display: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
        }
        .focus-mode #focus-badge { display: flex; align-items: center; gap: 6px; }
        .stat-val { font-family: 'Inter', sans-serif; font-weight: 700; font-size: 13px; color: #1e293b; }
        
        .g-item { text-align: center; border-left: 1px solid #f3f4f6; flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 0 5px; }
        .g-item:last-child { border: none; }
        .g-lbl { font-size: 10px; font-weight: 700; color: #9ca3af; text-transform: uppercase; }
        .g-val { font-size: 13px; font-weight: 800; color: #1e293b; font-family: 'Inter', sans-serif; }

        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        .chk-input { width: 13px; height: 13px; accent-color: #4f46e5; cursor: pointer; }
        
        th { font-size: 10px; text-transform: uppercase; letter-spacing: 0.05em; color: #6b7280; font-weight: 800; background: #f3f4f6; position: sticky; top: 0; z-index: 20; padding: 8px 10px; cursor: pointer; border-bottom: 2px solid #e5e7eb; }
        th:hover { background: #e8eaed; color: #374151; }
        
        .summary-cell {
            background: #f3f4f6; color: #1e293b; font-weight: 800;
            font-family: 'Inter', sans-serif; font-size: 12px; padding: 7px 10px;
            position: sticky; top: 34px; z-index: 19; border-bottom: 2px solid #d1d5db;
        }

        td { font-size: 12px; border-bottom: 1px solid #f3f4f6; padding: 6px 10px; }
        tr:hover td { background-color: #f8f9fb; }
        
        .row-pure { background: rgba(147, 197, 253, 0.12); }
        .row-gold { background: rgba(251, 191, 36, 0.10); }
        .row-potential { background: rgba(16, 185, 129, 0.08); }
        .row-blacklist { background: rgba(185, 28, 28, 0.10); }
        .row-blacklist-soft { background: rgba(220, 38, 38, 0.07); }
        .row-watch { background: rgba(249, 115, 22, 0.08); }
        .row-ignore { background: rgba(148, 163, 184, 0.06); }
        .row-testing { background: rgba(59, 130, 246, 0.05); }
        .row-custom { background: rgba(139, 92, 246, 0.06); }
        .row-summary { background: #f0f0ff; font-weight: 700; }

        .cat-badge { font-size: 10px; font-weight: 800; padding: 2px 7px; border-radius: 4px; white-space: nowrap; letter-spacing: 0.02em; }
        .badge-pure { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
        .badge-gold { background: #fef3c7; color: #92400e; border: 1px solid #fbbf24; }
        .badge-potential { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
        .badge-ignore { background: #f1f5f9; color: #64748b; border: 1px solid #cbd5e1; }
        .badge-blacklist { background: #fecaca; color: #7f1d1d; border: 1px solid #f87171; }
        .badge-blacklist-soft { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
        .badge-watch { background: #ffedd5; color: #9a3412; border: 1px solid #fdba74; }
        .badge-testing { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
        .badge-custom { background: #ede9fe; color: #7c3aed; }
        .vol-badge { font-size: 9px; font-weight: 800; padding: 1px 5px; border-radius: 3px; letter-spacing: 0.3px; }
        .vol-high { background: #dcfce7; color: #166534; }
        .vol-mid { background: #f1f5f9; color: #475569; }
        .vol-low { background: #fef2f2; color: #991b1b; }
        .ci-bar { display: inline-flex; align-items: center; gap: 2px; margin-left: 3px; vertical-align: middle; }
        .ci-bar-inner { height: 6px; border-radius: 3px; min-width: 8px; max-width: 28px; }
        .ci-bar-high { background: #22c55e; width: 28px; }
        .ci-bar-med { background: #f59e0b; width: 18px; }
        .ci-bar-low { background: #ef4444; width: 8px; }
        .be-badge { font-size: 8px; font-weight: 800; padding: 0px 4px; border-radius: 3px; display: inline-block; cursor: help; }
        .be-safe { background: #dcfce7; color: #166534; }
        .be-warn { background: #fef9c3; color: #854d0e; }
        .be-danger { background: #fecaca; color: #dc2626; }
        .badge-summary { background: #e0e7ff; color: #4338ca; }

        .score-pill { font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; padding: 2px 7px; border-radius: 10px; }
        .score-high { background: #fbbf24; color: #78350f; }
        .score-mid { background: #10b981; color: white; }
        .score-low { background: #e8eaed; color: #6b7280; }

        .btn-upload { background: white; color: #4338ca; border: 1.5px dashed #a5b4fc; padding: 10px; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .btn-upload:hover { background: #eef2ff; border-color: #6366f1; }

        .filter-item { margin-bottom: 6px; position: relative; }
        .filter-header { display: flex; justify-content: space-between; align-items: center; font-size: 11px; font-weight: 700; color: #475569; margin-bottom: 2px; }
        .filter-btn { width: 100%; text-align: right; background: #fafbfc; border: 1px solid #ddd; padding: 6px 10px; border-radius: 6px; font-size: 11px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; transition: border-color 0.15s; }
        .filter-btn:hover { border-color: #3b82f6; }
        .filter-popup { position: absolute; top: 100%; left: 0; width: 240px; background: white; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 12px 28px rgba(0,0,0,0.12); z-index: 50; display: none; flex-direction: column; padding: 8px; margin-top: 4px; }
        .filter-popup.show { display: flex; }
        .filter-search { width: 100%; padding: 5px 9px; border: 1px solid #e5e7eb; border-radius: 5px; font-size: 11px; margin-bottom: 6px; }
        .filter-list { max-height: 150px; overflow-y: auto; display: flex; flex-direction: column; gap: 3px; border: 1px solid #f3f4f6; padding: 4px; border-radius: 5px; margin-bottom: 6px; }
        .filter-opt { display: flex; align-items: center; gap: 6px; font-size: 11px; color: #334155; cursor: pointer; user-select: none; padding: 3px 5px; border-radius: 4px; }
        .filter-opt:hover { background: #f3f4f6; }
        .btn-tiny { font-size: 11px; padding: 3px 10px; border-radius: 4px; cursor: pointer; font-weight: 600; }
        .btn-apply { background: #4f46e5; color: white; }
        .btn-cancel { background: #f3f4f6; color: #64748b; }

        .level-badge { font-size: 10px; font-weight: 800; padding: 2px 6px; border-radius: 4px; }
        .level-1 { background: #fee2e2; color: #991b1b; }
        .level-2 { background: #fef3c7; color: #92400e; }
        .level-3 { background: #d1fae5; color: #065f46; }

        .mapping-row { display: flex; align-items: center; gap: 6px; margin-bottom: 3px; }
        .mapping-row label { font-size: 10px; font-weight: 700; color: #6b7280; min-width: 48px; }
        .mapping-row select { flex: 1; font-size: 10px; padding: 3px 5px; border: 1px solid #ddd; border-radius: 5px; }

        .threshold-info { font-size: 10px; color: #6b7280; background: #f6f7f9; padding: 4px 8px; border-radius: 5px; margin-top: 4px; border: 1px solid #eee; }
        .threshold-val { font-weight: 800; color: #4f46e5; }
        
        .search-box { position: relative; }
        .search-box input { width: 150px; padding: 5px 10px 5px 28px; border: 1px solid #e5e7eb; border-radius: 6px; font-size: 12px; background: #fafbfc; transition: all 0.15s; }
        .search-box input:focus { outline: none; border-color: #4f46e5; box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.08); background: white; }
        .search-box i { position: absolute; left: 8px; top: 50%; transform: translateY(-50%); color: #9ca3af; pointer-events: none; }
        .search-highlight { background: #fef08a !important; padding: 0 2px; border-radius: 2px; }
        .icloud-badge { font-size: 10px; margin-left: 4px; opacity: 0.7; cursor: help; color: #3b82f6; }
        
        .icloud-switcher, .agg-switcher { display: flex; align-items: center; gap: 3px; padding: 2px 4px; background: #f3f4f6; border-radius: 6px; border: 1px solid #e5e7eb; }
        .switcher-options { display: flex; gap: 1px; }
        .switcher-btn { padding: 2px 6px; font-size: 10px; border: none; background: transparent; border-radius: 4px; cursor: pointer; opacity: 0.45; transition: all 0.15s; font-weight: 600; }
        .icloud-switcher .switcher-btn:hover, .agg-switcher .switcher-btn:hover { opacity: 0.75; background: #e5e7eb; }
        .icloud-switcher .switcher-btn.active { opacity: 1; background: #4f46e5; color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        .agg-switcher .switcher-btn.active { opacity: 1; background: #059669; color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
        
        .sortable-th { cursor: pointer; user-select: none; transition: background 0.15s; }
        .sortable-th:hover { background: #e8eaed; }
        .sortable-th .sort-icon { font-size: 10px; opacity: 0.35; margin-right: 2px; }
        .sortable-th.sort-asc .sort-icon { opacity: 1; font-size: 0; }
        .sortable-th.sort-asc .sort-icon::after { content: 'â†‘'; font-size: 10px; }
        .sortable-th.sort-desc .sort-icon { opacity: 1; font-size: 0; }
        .sortable-th.sort-desc .sort-icon::after { content: 'â†“'; font-size: 10px; }
        
        .control-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 6px; }
        
        .performer-item { display: flex; justify-content: space-between; align-items: center; gap: 2px; padding: 2px 0; border-bottom: 1px solid #f3f4f6; flex-wrap: wrap; }
        .performer-item:last-child { border: none; }
        .performer-id { font-weight: 600; color: #374151; font-size: 11px; word-break: break-all; }
        .performer-val { font-weight: 700; font-family: 'Inter', sans-serif; white-space: nowrap; font-size: 11px; }

        .bl-mode-switcher { display: inline-flex; gap: 1px; background: #fee2e2; border-radius: 5px; padding: 2px; margin-right: 6px; }
        .bl-mode-btn { font-size: 9px; font-weight: 800; padding: 2px 7px; border-radius: 3px; cursor: pointer; border: none; background: transparent; color: #991b1b; opacity: 0.5; transition: all 0.15s; white-space: nowrap; }
        .bl-mode-btn.active { opacity: 1; background: #dc2626; color: white; box-shadow: 0 1px 2px rgba(0,0,0,0.15); }
        .bl-mode-btn:hover:not(.active) { opacity: 0.8; background: #fca5a5; }
        
        .dash-sidebar select { font-size: 11px; border: 1px solid #ddd; border-radius: 5px; background: #fafbfc; transition: border-color 0.15s; }
        .dash-sidebar select:focus { border-color: #4f46e5; outline: none; }
        
        /* === TOAST NOTIFICATION === */
        .toast-container { position: fixed; top: 12px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 6px; pointer-events: none; }
        .toast { 
            background: white; border: 1px solid #e5e7eb; border-radius: 8px; padding: 8px 16px; 
            box-shadow: 0 8px 24px rgba(0,0,0,0.12); font-size: 12px; font-weight: 600;
            display: flex; align-items: center; gap: 8px; pointer-events: auto;
            animation: toastIn 0.3s ease, toastOut 0.3s ease 2.7s forwards;
            max-width: 400px;
        }
        .toast-success { border-right: 3px solid #10b981; }
        .toast-info { border-right: 3px solid #3b82f6; }
        .toast-warn { border-right: 3px solid #f59e0b; }
        .toast-error { border-right: 3px solid #ef4444; }
        @keyframes toastIn { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes toastOut { from { opacity: 1; } to { opacity: 0; transform: translateY(-10px); } }
        
        /* === CONFIDENCE INTERVAL === */
        .ci-bar { display: inline-flex; align-items: center; gap: 2px; }
        .ci-range { font-size: 9px; color: #9ca3af; font-family: 'Inter', sans-serif; }
        .ci-indicator { font-size: 8px; font-weight: 800; padding: 0px 3px; border-radius: 2px; display: inline-block; vertical-align: middle; line-height: 13px; }
        .ci-high { background: #dcfce7; color: #166534; }
        .ci-medium { background: #fef3c7; color: #92400e; }
        .ci-low { background: #fecaca; color: #991b1b; }
        
        /* === ANOMALY FLAG === */
        .anomaly-flag { font-size: 9px; padding: 1px 4px; border-radius: 3px; font-weight: 800; margin-left: 3px; cursor: help; }
        .anomaly-fraud { background: #fecaca; color: #dc2626; }
        .anomaly-bot { background: #fed7aa; color: #ea580c; }
        .anomaly-outlier { background: #ddd6fe; color: #7c3aed; }
        
        /* === KEYBOARD SHORTCUTS HINT === */
        .shortcuts-hint { 
            position: fixed; bottom: 12px; right: 12px; background: rgba(30,41,59,0.9); 
            color: white; padding: 10px 14px; border-radius: 8px; font-size: 11px; 
            z-index: 100; display: none; backdrop-filter: blur(8px);
        }
        .shortcuts-hint.show { display: block; }
        .shortcut-key { background: rgba(255,255,255,0.15); padding: 1px 5px; border-radius: 3px; font-family: 'Inter', monospace; font-size: 10px; margin-left: 4px; }
        
        /* === BL SEVERITY INDICATOR === */
        .bl-severity { font-size: 9px; font-weight: 800; padding: 1px 5px; border-radius: 3px; margin-right: 4px; }
        .bl-hard { background: #dc2626; color: white; }
        .bl-soft { background: #fb923c; color: white; }
        .bl-poor { background: #fbbf24; color: #78350f; }
        
        .kpi-label-hover { cursor: help; }
        #kpi-tooltip-el { position: fixed; background: #1e293b; color: white; font-size: 10px; font-weight: 600; padding: 6px 10px; border-radius: 6px; max-width: 260px; min-width: 180px; white-space: normal; z-index: 99999; box-shadow: 0 4px 16px rgba(0,0,0,0.3); line-height: 1.5; direction: rtl; text-align: right; pointer-events: none; display: none; }
        
        .btn-reset-view { font-size: 10px; font-weight: 800; padding: 4px 10px; border-radius: 6px; cursor: pointer; border: 2px solid #818cf8; background: linear-gradient(135deg,#eef2ff,#e0e7ff); color: #4338ca; transition: all 0.15s; display: flex; align-items: center; gap: 3px; box-shadow: 0 1px 3px rgba(99,102,241,0.2); }
        .btn-reset-view:hover { background: #4f46e5; color: white; border-color: #4f46e5; box-shadow: 0 2px 6px rgba(99,102,241,0.3); }
    </style>
</head>
<body>
    <div class="toast-container" id="toast-container"></div>
    <div id="kpi-tooltip-el"></div>
    <div id="focus-badge">ğŸ” Focus Mode â€” ×œ×—×¥ F ×œ×—×–×•×¨</div>
    
    <div class="main-wrapper">
        <div class="glass-header">
            <div class="flex items-center gap-2.5 shrink-0">
                <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 text-white p-1.5 rounded-lg">
                    <i data-lucide="activity" class="w-4 h-4"></i>
                </div>
                <div>
                    <h1 class="text-sm font-extrabold text-slate-800 leading-none">ListLab <span class="text-indigo-500 font-black">V55</span></h1>
                    <div class="text-[9px] text-slate-400 font-medium">Enhanced Edition</div>
                </div>
            </div>
            
            <div id="global-stats" class="flex-1 flex justify-center items-center">
                <span class="text-sm text-slate-400">×˜×¢×Ÿ ×§×•×‘×¥ ×œ×”×ª×—×œ×”... <span class="shortcut-key">?</span> ×œ×§×™×¦×•×¨×™ ××§×œ×“×ª</span>
            </div>
            
            <div id="medians-box" class="hidden shrink-0 text-[11px] bg-gray-50 px-3 py-1 rounded-lg border border-gray-200">
                <span class="text-slate-500">Median PPC:</span> <strong id="med-ppc" class="text-amber-600 num-font">$0</strong>
                <span class="mx-2 text-slate-300">|</span>
                <span class="text-slate-500">Median CR:</span> <strong id="med-cr" class="text-blue-600 num-font">0%</strong>
                <span class="mx-2 text-slate-300">|</span>
                <span class="text-slate-500">×¡×£ ×§×œ×™×§×™×:</span> <strong id="click-threshold" class="text-red-500 num-font">0</strong>
            </div>
        </div>

        <div class="dash-container">
            <aside class="dash-sidebar custom-scrollbar">

                <div class="btn-upload" id="drop-zone">
                    <input type="file" id="file-input" class="hidden" accept=".xlsx,.csv">
                    <div class="flex items-center justify-center gap-2 text-indigo-600">
                        <i data-lucide="upload-cloud" class="w-3.5 h-3.5"></i>
                        <span class="text-xs font-bold">×˜×¢×Ÿ ×§×•×‘×¥ CSV / Excel</span>
                    </div>
                    <div id="filename" class="text-[10px] text-indigo-400 truncate mt-0.5"></div>
                </div>

                <div id="hierarchy-box" class="hidden bg-white border border-amber-200 border-r-4 rounded-lg p-2">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2 text-amber-700 text-[11px] font-bold">
                            <i data-lucide="git-branch" class="w-3 h-3"></i><span>×”×™×¨×¨×›×™×” ×¤×¢×™×œ×”</span>
                        </div>
                        <div id="level-badges" class="flex gap-1"></div>
                    </div>
                </div>

                <div class="control-box border-slate-300">
                    <div class="collapsible-header" onclick="toggleSection('filters')">
                        <div class="text-[11px] font-bold text-slate-700 flex items-center gap-1.5">
                            <i data-lucide="filter" class="w-3.5 h-3.5 text-slate-400"></i> ×¡×™× ×•×Ÿ ××ª×§×“×
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-600 collapse-icon open" id="filters-icon"></i>
                    </div>
                    <div class="collapsible-content open" id="filters-content">
                        <div id="filters-list" class="mt-2"></div>
                        <button onclick="showAddFilterMenu()" id="btn-add-filter" class="hidden w-full mt-2 border border-dashed border-indigo-300 text-indigo-600 rounded p-1.5 text-[10px] font-bold hover:bg-indigo-50 flex items-center justify-center gap-1">
                            <i data-lucide="plus" class="w-3 h-3"></i> ×”×•×¡×£ ××¡× ×Ÿ
                        </button>
                        <select id="col-selector" class="hidden w-full mt-1 text-[11px] border border-slate-300 rounded p-1" onchange="createNewFilter(this.value)">
                            <option value="">×‘×—×¨ ×¢××•×“×”...</option>
                        </select>
                        <div id="filter-msg" class="text-[11px] text-slate-400 text-center py-2 italic">×˜×¢×Ÿ ×§×•×‘×¥ ×›×“×™ ×œ×”×ª×—×™×œ</div>
                    </div>
                </div>

                <div class="control-box border-blue-200">
                    <div class="text-[11px] font-bold text-slate-700 mb-2 flex items-center gap-1.5">
                        <i data-lucide="layers" class="w-3.5 h-3.5 text-blue-500"></i> ××–×”×” ×•×¡×£ ×§×œ×™×§×™×
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-2">
                        <div>
                            <label class="text-[10px] text-slate-500 mb-0.5 block">×¨××ª ×˜×¨××¤×™×§:</label>
                            <select id="ip-level" class="w-full text-[11px] border border-gray-200 rounded-lg p-1.5 font-medium bg-white">
                                <option value="1" selected>×¨××” 1 - SubID/IP32 (1.5Ã—)</option>
                                <option value="2">×¨××” 2 - Zone/IP24 (3Ã—)</option>
                                <option value="3">×¨××” 3 - IP16 (5Ã—)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] text-slate-500 mb-0.5 block">×¢××•×“×ª ××–×”×”:</label>
                            <select id="col-ip" class="w-full text-[11px] border border-gray-200 rounded-lg p-1.5 font-medium bg-white"></select>
                        </div>
                    </div>
                    <div id="detected-type" class="text-center mb-2 hidden">
                        <span id="detected-type-badge" style="display:inline-flex;align-items:center;gap:5px;background:#dbeafe;color:#1e40af;font-size:11px;font-weight:700;padding:4px 14px;border-radius:14px;border:1px solid #93c5fd;">
                            <i data-lucide="globe" class="w-3.5 h-3.5" style="color:#3b82f6;"></i>
                            <span id="detected-type-text">×–×•×”×”: IP (IP Address)</span>
                        </span>
                    </div>
                    <select id="identifier-type" class="hidden">
                        <option value="auto">ğŸ” ××•×˜×•××˜×™</option>
                        <option value="subid">ğŸ¯ SubID</option>
                        <option value="zone">ğŸ“ Zone</option>
                        <option value="ip">ğŸŒ IP</option>
                    </select>
                    <div style="text-align:center;background:linear-gradient(135deg,#ecfdf5,#f0fdfa);border:1px solid #a7f3d0;border-radius:8px;padding:6px 10px;">
                        <div style="font-size:11px;color:#374151;font-weight:700;">×¡×£ ×§×œ×™×§×™× × ×•×›×—×™: <span style="font-family:'Inter',sans-serif;font-size:14px;font-weight:900;color:#059669;letter-spacing:-0.3px;" id="current-threshold">1,500</span></div>
                        <div style="font-size:9px;color:#94a3b8;margin-top:1px;">× ×•×¡×—×”: ××›×¤×™×œ Ã— (100 / CR%)</div>
                    </div>
                </div>

                <!-- === BL CONTROL CENTER === -->
                <div class="control-box border-red-200">
                    <div class="collapsible-header" onclick="toggleSection('bl-config')">
                        <div class="text-[11px] font-bold text-slate-700 flex items-center gap-1.5">
                            <i data-lucide="shield-alert" class="w-3.5 h-3.5 text-red-500"></i> ×”×’×“×¨×•×ª Blacklist
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-600 collapse-icon" id="bl-config-icon"></i>
                    </div>
                    <div class="collapsible-content" id="bl-config-content">
                        <div class="mt-2 space-y-2">
                            <div class="flex items-center gap-2 text-[10px]">
                                <span class="font-bold text-slate-600 w-20">×—×™×©×•×‘ ×¡×£:</span>
                                <div class="bl-mode-switcher" style="background:#fef3c3;">
                                    <button class="bl-mode-btn active" data-blcalc="median" onclick="setBlCalc('median')" title="××—×¦×™×•×Ÿ â€” ×©××¨× ×™, ×¢××™×“ ×œ-outliers" style="color:#854d0e;">××—×¦×™×•×Ÿ</button>
                                    <button class="bl-mode-btn" data-blcalc="mean" onclick="setBlCalc('mean')" title="×××•×¦×¢ â€” ××’×¨×¡×™×‘×™, ×—×•×¡× ×™×•×ª×¨" style="color:#854d0e;">×××•×¦×¢</button>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 text-[10px]">
                                <span class="font-bold text-slate-600 w-20">××¦×‘ BL:</span>
                                <div class="bl-mode-switcher">
                                    <button class="bl-mode-btn active" data-blmode="ppc" onclick="setBlMode('ppc')" title="×—×¡×•× ×œ×¤×™ PPC">PPC</button>
                                    <button class="bl-mode-btn" data-blmode="cr" onclick="setBlMode('cr')" title="×—×¡×•× ×œ×¤×™ CR">CR</button>
                                    <button class="bl-mode-btn" data-blmode="roi" onclick="setBlMode('roi')" title="×—×¡×•× ×œ×¤×™ ROI">ROI</button>
                                    <button class="bl-mode-btn" data-blmode="score" onclick="setBlMode('score')" title="×—×¡×•× ×œ×¤×™ Score (PPC+ROI+CR ××©×•×§×œ×œ)">Score</button>
                                </div>
                            </div>
                            <div class="flex items-center gap-2 text-[10px]">
                                <span class="font-bold text-slate-600 w-20">××›×¤×™×œ BL:</span>
                                <input type="number" id="bl-threshold-mult" value="0.5" step="0.05" min="0.1" max="1.0" class="w-16 text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center">
                                <span class="text-slate-400">Ã— ×¡×£ (×‘×¨×™×¨×ª ××—×“×œ: 0.5)</span>
                            </div>
                            <div class="bg-red-50 rounded p-2 text-[10px] text-red-700 border border-red-100">
                                <div class="font-bold mb-1">×¨××•×ª Blacklist:</div>
                                <div class="flex items-center gap-1 mb-0.5"><span class="bl-severity bl-hard">HARD</span> 0 conv (××¢×œ ×¡×£ ×§×œ×™×§×™×) / conv ×¢× $0 Rev</div>
                                <div class="flex items-center gap-1 mb-0.5"><span class="bl-severity bl-soft">SOFT</span> ×™×© conv + Rev ××‘×œ profit ×©×œ×™×œ×™</div>
                                <div class="flex items-center gap-1"><span class="bl-severity bl-poor">POOR</span> ××ª×—×ª ×œ×¡×£ ××˜×¨×™ Ã— ××›×¤×™×œ</div>
                                <div class="mt-1.5 pt-1.5 border-t border-red-200 text-[9px]">
                                    <div>×¡×£ × ×•×›×—×™ (<span id="bl-calc-label">××—×¦×™×•×Ÿ</span>):</div>
                                    <div class="font-bold num-font text-red-800" id="bl-current-threshold-display">×˜×¢×Ÿ ×§×•×‘×¥...</div>
                                </div>
                            </div>
                            <button onclick="processData()" class="w-full bg-red-600 text-white py-1.5 rounded-md text-xs font-bold hover:bg-red-700 flex items-center justify-center gap-1 transition-colors">
                                <i data-lucide="refresh-cw" class="w-3 h-3"></i> ×¢×“×›×Ÿ
                            </button>
                        </div>
                    </div>
                    <input type="hidden" id="bl-soft-roi" value="-30">
                    <input type="hidden" id="bl-soft-min-loss" value="0">
                    <input type="hidden" id="bl-soft-needs-clicks" type="checkbox">
                </div>

                <div class="control-box border-amber-200">
                    <div class="text-[11px] font-bold text-slate-700 mb-2 flex items-center justify-between">
                        <div class="flex items-center gap-1.5">
                            <i data-lucide="sliders" class="w-3.5 h-3.5 text-amber-500"></i> TOP % Thresholds + Smart BL
                        </div>
                        <div class="flex items-center gap-1">
                            <select id="auto-metric" class="text-[10px] border border-amber-300 rounded px-1 py-0.5 bg-amber-50 font-bold text-amber-700" disabled>
                                <option value="score">Score</option>
                                <option value="ppc">PPC</option>
                                <option value="roi">ROI</option>
                                <option value="cr">CR</option>
                            </select>
                            <button onclick="state.manualTiers = false; autoDetectThresholds(false); processData();" id="btn-auto-thresh" class="flex items-center gap-1 bg-amber-500 text-white px-2 py-0.5 rounded text-[10px] font-bold hover:bg-amber-600 transition-colors disabled:opacity-40" disabled title="Jenks clustering ×¢×œ ×–×•× ×™× ×¨×•×•×—×™×™× â†’ ×§×•×‘×¢ Pure/Gold ××•×˜×•××˜×™×ª">
                                <i data-lucide="sparkles" class="w-3 h-3"></i> Auto Tiers
                            </button>
                        </div>
                    </div>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="lbl-row"><span class="lbl-sm">ğŸ’ PURE</span><input type="number" id="pure-pct-num" value="10" class="dash-input text-amber-600"></div>
                            <input type="range" id="pure-pct" min="1" max="50" value="10" class="text-amber-500">
                        </div>
                        <div class="control-item">
                            <div class="lbl-row"><span class="lbl-sm">ğŸ¥‡ GOLD</span><input type="number" id="gold-pct-num" value="25" class="dash-input text-amber-600"></div>
                            <input type="range" id="gold-pct" min="1" max="70" value="25" class="text-amber-500">
                        </div>
                    </div>
                    <div id="auto-thresh-info" class="hidden threshold-info mt-2 border-amber-200 bg-amber-50" style="line-height:1.6;">
                        <div class="text-amber-700 font-bold mb-1">âš¡ Auto Tiers Results:</div>
                        <div id="auto-thresh-text" class="text-amber-800 text-[10px] num-font"></div>
                    </div>
                </div>

                <div class="control-box border-purple-200">
                    <div class="collapsible-header" onclick="toggleSection('custom')">
                        <div class="text-[11px] font-bold text-slate-700 flex items-center gap-1.5">
                            <i data-lucide="list-filter" class="w-3.5 h-3.5 text-purple-500"></i> Custom List
                            <span id="custom-badge" class="hidden text-[9px] bg-purple-600 text-white px-1.5 py-0.5 rounded-full">×¤×¢×™×œ</span>
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-purple-600 collapse-icon" id="custom-icon"></i>
                    </div>
                    <div class="collapsible-content" id="custom-content">
                        <div class="flex items-center gap-2 mb-2 mt-1.5">
                            <input type="checkbox" id="custom-enabled" class="chk-input">
                            <label for="custom-enabled" class="text-[11px] font-bold text-gray-700">×”×¤×¢×œ Custom List</label>
                        </div>
                        <div class="grid grid-cols-2 gap-1.5 mb-1.5">
                            <div class="bg-gray-50 rounded-md p-1.5 border border-gray-200">
                                <div class="text-[10px] font-bold text-gray-600 mb-1">Conv</div>
                                <div class="flex gap-1">
                                    <div class="flex-1"><input type="number" id="cust-conv-min" value="1" min="0" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="Min"></div>
                                    <span class="text-slate-300 self-center">-</span>
                                    <div class="flex-1"><input type="number" id="cust-conv-max" value="" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="âˆ"></div>
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-md p-1.5 border border-gray-200">
                                <div class="text-[10px] font-bold text-gray-600 mb-1">Score</div>
                                <div class="flex gap-1">
                                    <div class="flex-1"><input type="number" id="cust-score-min" value="0" step="0.1" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="Min"></div>
                                    <span class="text-slate-300 self-center">-</span>
                                    <div class="flex-1"><input type="number" id="cust-score-max" value="" step="0.1" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="âˆ"></div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-1.5 mb-1.5">
                            <div class="bg-gray-50 rounded-md p-1.5 border border-gray-200">
                                <div class="text-[10px] font-bold text-gray-600 mb-1">Clicks</div>
                                <div class="flex gap-1">
                                    <div class="flex-1"><input type="number" id="cust-clicks-min" value="0" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="Min"></div>
                                    <span class="text-slate-300 self-center">-</span>
                                    <div class="flex-1"><input type="number" id="cust-clicks-max" value="" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="âˆ"></div>
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-md p-1.5 border border-gray-200">
                                <div class="text-[10px] font-bold text-gray-600 mb-1">ROI%</div>
                                <div class="flex gap-1">
                                    <div class="flex-1"><input type="number" id="cust-roi-min" value="-100" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="Min"></div>
                                    <span class="text-slate-300 self-center">-</span>
                                    <div class="flex-1"><input type="number" id="cust-roi-max" value="" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="âˆ"></div>
                                </div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-1.5 mb-1.5">
                            <div class="bg-gray-50 rounded-md p-1.5 border border-gray-200">
                                <div class="text-[10px] font-bold text-gray-600 mb-1">CR%</div>
                                <div class="flex gap-1">
                                    <div class="flex-1"><input type="number" id="cust-cr-min" value="0" step="0.001" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="Min"></div>
                                    <span class="text-slate-300 self-center">-</span>
                                    <div class="flex-1"><input type="number" id="cust-cr-max" value="" step="0.001" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="âˆ"></div>
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-md p-1.5 border border-gray-200">
                                <div class="text-[10px] font-bold text-gray-600 mb-1">PPC</div>
                                <div class="flex gap-1">
                                    <div class="flex-1"><input type="number" id="cust-ppc-min" value="-1" step="0.001" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="Min"></div>
                                    <span class="text-slate-300 self-center">-</span>
                                    <div class="flex-1"><input type="number" id="cust-ppc-max" value="" step="0.001" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="âˆ"></div>
                                </div>
                            </div>
                        </div>
                        <button onclick="processData()" class="w-full mt-1 bg-indigo-600 text-white py-1.5 rounded-md text-xs font-bold hover:bg-indigo-700 flex items-center justify-center gap-1 transition-colors">
                            <i data-lucide="check" class="w-3 h-3"></i> ×”×—×œ ×¤×™×œ×˜×¨
                        </button>
                    </div>
                </div>

                <!-- === LEGEND (separate) === -->
                <div class="control-box border-slate-200">
                    <div class="collapsible-header" onclick="toggleSection('legend')">
                        <div class="text-[11px] font-bold text-slate-700 flex items-center gap-1.5">
                            <i data-lucide="info" class="w-3.5 h-3.5 text-slate-400"></i> Legend â€” ×¡×™×•×•×’ ×–×•× ×™×
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-600 collapse-icon" id="legend-icon"></i>
                    </div>
                    <div class="collapsible-content" id="legend-content">
                        <div class="mt-2 bg-slate-50 rounded p-2.5 text-[10px] text-slate-700 border border-slate-200 space-y-1">
                            <div class="flex items-center gap-1.5"><span class="cat-badge badge-pure" style="font-size:9px;">ğŸ’ PURE</span> <span class="text-slate-500">Top performers â€” scale up</span></div>
                            <div class="flex items-center gap-1.5"><span class="cat-badge badge-gold" style="font-size:9px;">ğŸ¥‡ GOLD</span> <span class="text-slate-500">Strong â€” increase bids</span></div>
                            <div class="flex items-center gap-1.5"><span class="cat-badge badge-potential" style="font-size:9px;">ğŸŒ± POTENTIAL</span> <span class="text-slate-500">Promising â€” grow</span></div>
                            <div class="flex items-center gap-1.5"><span class="cat-badge badge-ignore" style="font-size:9px;">ğŸ‘€ WATCH</span> <span class="text-slate-500">Profitable, below gates â€” RON</span></div>
                            <div class="flex items-center gap-1.5"><span class="cat-badge badge-watch" style="font-size:9px;">âš ï¸ POOR</span> <span class="text-slate-500">Profitable but weak metric</span></div>
                            <div class="flex items-center gap-1.5"><span class="cat-badge badge-blacklist-soft" style="font-size:9px;">ğŸŸ  BL SOFT</span> <span class="text-slate-500">Has conv+rev, profit &lt; 0</span></div>
                            <div class="flex items-center gap-1.5"><span class="cat-badge badge-blacklist" style="font-size:9px;">â›” BL HARD</span> <span class="text-slate-500">0 conv or $0 revenue</span></div>
                            <div class="flex items-center gap-1.5"><span class="cat-badge badge-testing" style="font-size:9px;">ğŸ”¬ TESTING</span> <span class="text-slate-500">0 conv, below click threshold</span></div>
                        </div>
                    </div>
                </div>


                <!-- === PAYOUT CONFIG (hidden - auto calculated, shown in top bar) === -->
                <div class="control-box border-green-200 hidden">
                    <div class="text-[11px] font-bold text-slate-700 mb-2 flex items-center gap-1.5">
                        <i data-lucide="dollar-sign" class="w-3.5 h-3.5 text-green-500"></i> Campaign Payout (AP)
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="number" id="avg-payout" value="0" min="0" step="0.1" class="w-24 text-[12px] border border-gray-200 rounded p-1.5 font-bold num-font text-center" placeholder="Auto">
                        <span class="text-[10px] text-slate-500">$ per conv</span>
                        <button onclick="autoCalcPayout()" class="text-[9px] bg-green-100 text-green-700 px-2 py-1 rounded font-bold hover:bg-green-200" title="×—×©×‘ ×× ×ª×•× ×™ ×”×§××¤×™×™×Ÿ">Auto</button>
                    </div>
                    <div class="threshold-info mt-1" id="payout-info">
                        ××—×•×©×‘ ××•×˜×•××˜×™×ª ×-Revenue / Conversions
                    </div>
                </div>


                <div id="mapping-box" class="hidden control-box border-slate-200">
                    <div class="collapsible-header" onclick="toggleSection('mapping')">
                        <div class="text-[11px] font-bold text-slate-700 flex items-center gap-1.5">
                            <i data-lucide="columns" class="w-3.5 h-3.5 text-slate-400"></i> ××™×¤×•×™ ×¢××•×“×•×ª
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-600 collapse-icon" id="mapping-icon"></i>
                    </div>
                    <div class="collapsible-content" id="mapping-content">
                        <div class="mapping-row"><label>×§×œ×™×§×™×</label><select id="col-clicks"></select></div>
                        <div class="mapping-row"><label>×”××¨×•×ª</label><select id="col-conv"></select></div>
                        <div class="mapping-row"><label>×”×›× ×¡×”</label><select id="col-rev"></select></div>
                        <div class="mapping-row"><label>×¢×œ×•×ª</label><select id="col-cost"></select></div>
                        <button onclick="processData()" class="w-full mt-2 bg-gray-700 text-white py-1.5 rounded-md text-xs font-bold hover:bg-gray-800 transition-colors">×¢×“×›×Ÿ ××™×¤×•×™</button>
                    </div>
                </div>

                <div class="mt-auto border-t border-gray-200 pt-2">
                    <div class="grid grid-cols-3 gap-1.5 mb-2 text-[10px] font-medium text-slate-500">
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="chk-pure" checked class="chk-input"> Pure</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="chk-gold" checked class="chk-input"> Gold</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="chk-potential" checked class="chk-input"> Potential</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="chk-bl" class="chk-input"> Blacklist</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="chk-custom" class="chk-input"> Custom</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="chk-cidr" class="chk-input"> CIDR</label>
                    </div>
                    <button onclick="exportData()" class="w-full bg-indigo-600 text-white py-1.5 rounded-lg text-xs font-bold hover:bg-indigo-700 flex items-center justify-center gap-2 transition-colors shadow-sm">
                        <i data-lucide="download" class="w-3.5 h-3.5"></i> ×™×™×¦×•× Excel <span class="shortcut-key text-indigo-300">E</span>
                    </button>
                </div>

            </aside>

            <main class="dash-content">
                <div id="section-kpi" class="p-2 bg-white border-b border-gray-100 shrink-0 relative collapsible-section">
                    <button class="section-toggle" onclick="toggleSectionCollapse('section-kpi')" title="×›×•×•×¥/×”×¨×—×‘">â–²</button>
                    <div class="section-inner">
                        <div id="kpi-container" class="kpi-container"></div>
                    </div>
                </div>
                
                <!-- ACTION + SAVINGS MESSAGES SIDE BY SIDE -->
                <div id="messages-row" class="hidden shrink-0" style="display:none;padding:6px 8px;gap:6px;">
                    <div id="action-summary" class="hidden" style="flex:1;min-width:0;background:linear-gradient(135deg,#eef2ff 0%,#e0e7ff 50%,#ede9fe 100%);border-radius:10px;padding:10px 14px;border:1px solid #c7d2fe;">
                        <div class="flex items-center gap-3 flex-wrap">
                            <div class="flex items-center gap-1.5">
                                <span class="text-[15px]">ğŸ¯</span>
                                <span class="font-extrabold text-indigo-800 text-[13px]">Next Steps</span>
                            </div>
                            <div class="flex items-center gap-1 px-2.5 py-0.5 bg-red-100 rounded-full border border-red-200 text-[12px]">
                                <span class="text-red-700 font-bold">â›” <span id="act-block-count" class="font-extrabold">0</span></span>
                                <span class="text-red-400">â†’</span>
                                <span class="text-red-800 font-extrabold">×—×¡×•×š <span id="act-block-save">$0</span></span>
                            </div>
                            <div class="flex items-center gap-1 px-2.5 py-0.5 bg-blue-100 rounded-full border border-blue-200 text-[12px]">
                                <span class="text-blue-700 font-bold">ğŸ’ <span id="act-scale-count" class="font-extrabold">0</span></span>
                                <span class="text-blue-400">â†’</span>
                                <span class="text-blue-800 font-extrabold">$<span id="act-scale-profit">0</span></span>
                            </div>
                            <div class="flex items-center gap-1 px-2.5 py-0.5 bg-green-100 rounded-full border border-green-200 text-[12px]">
                                <span class="text-green-700 font-bold">ğŸŒ± <span id="act-grow-count" class="font-extrabold">0</span></span>
                            </div>
                            <div class="text-[11px] text-indigo-400 font-bold mr-auto">
                                <span id="act-total-zones">0</span> zones | <span id="act-tested-pct">0</span>% tested
                            </div>
                        </div>
                    </div>
                    
                    <div id="savings-banner" class="hidden" style="flex:1;min-width:0;background:linear-gradient(135deg,#ecfdf5 0%,#f0fdf4 50%,#fefce8 100%);border-radius:10px;padding:10px 14px;border:1px solid #bbf7d0;">
                        <div class="flex items-center gap-2 mb-1">
                            <div class="flex items-center gap-1 text-[13px] font-bold text-green-700">
                                <i data-lucide="shield-check" class="w-3.5 h-3.5"></i> Projected Savings
                            </div>
                            <span class="bg-white border border-green-200 rounded px-1.5 py-0.5 font-bold text-green-700 text-[11px] num-font" id="sv-payout-display"></span>
                        </div>
                        <div class="text-[11px] num-font" style="line-height:1.7;">
                            <div>
                                <span class="font-bold text-red-600">â›”+ğŸŸ </span>
                                ×—×¡×•× <strong id="sv-bl-count">0</strong> â†’
                                <strong id="sv-save-amt" class="text-green-700">$0</strong> |
                                CR: <span id="sv-cr-before" class="text-slate-400">0%</span>â†’<strong id="sv-cr-after" class="text-green-700">0%</strong> |
                                ROI: <span id="sv-roi-before" class="text-slate-400">0%</span>â†’<strong id="sv-roi-after" class="text-green-700">0%</strong>
                            </div>
                            <div>
                                <span class="font-bold text-amber-600">â›”+ğŸŸ +âš ï¸</span>
                                ×—×¡×•× <strong id="sv2-bl-count">0</strong> â†’
                                <strong id="sv2-save-amt" class="text-green-700">$0</strong> |
                                CR: <span id="sv2-cr-before" class="text-slate-400">0%</span>â†’<strong id="sv2-cr-after" class="text-green-700">0%</strong> |
                                ROI: <span id="sv2-roi-before" class="text-slate-400">0%</span>â†’<strong id="sv2-roi-after" class="text-green-700">0%</strong>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="section-savings" class="hidden px-3 py-2 bg-gradient-to-r from-red-50 to-green-50 border-b border-gray-200 shrink-0">
                    <div class="flex items-center justify-between gap-3">
                        <div class="flex items-center gap-4 text-[11px]">
                            <div class="flex items-center gap-1.5">
                                <span class="text-red-600 font-black text-[13px]">ğŸ”´</span>
                                <span class="font-bold text-red-700">×—×¡×•× <span id="sav-bl-count" class="num-font">0</span> ×–×•× ×™×</span>
                                <span class="text-red-500 font-bold">â†’</span>
                                <span class="font-black text-red-600 num-font text-[13px]" id="sav-waste">$0</span>
                                <span class="text-red-500 font-bold">×—×™×¡×›×•×Ÿ</span>
                            </div>
                            <div class="h-5 w-px bg-gray-300"></div>
                            <div class="flex items-center gap-1.5">
                                <span class="text-slate-500 font-bold">CR:</span>
                                <span class="num-font text-slate-600" id="sav-cr-before">0%</span>
                                <span class="text-green-600 font-bold">â†’</span>
                                <span class="num-font text-green-700 font-bold" id="sav-cr-after">0%</span>
                            </div>
                            <div class="h-5 w-px bg-gray-300"></div>
                            <div class="flex items-center gap-1.5">
                                <span class="text-slate-500 font-bold">ROI:</span>
                                <span class="num-font text-slate-600" id="sav-roi-before">0%</span>
                                <span class="text-green-600 font-bold">â†’</span>
                                <span class="num-font text-green-700 font-bold" id="sav-roi-after">0%</span>
                            </div>
                            <div class="h-5 w-px bg-gray-300"></div>
                            <div class="flex items-center gap-1.5">
                                <span class="text-slate-500 font-bold">Traffic:</span>
                                <span class="num-font text-orange-600" id="sav-traffic-pct">0%</span>
                                <span class="text-slate-400 text-[9px]">××”×ª× ×•×¢×”</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="section-dashboard" class="hidden border-b border-slate-200 collapsible-section">
                    <div class="flex items-center justify-between px-3 py-1.5 bg-gray-50 cursor-pointer border-b border-gray-100" onclick="toggleDashboard()">
                        <div class="flex items-center gap-2 text-[11px] font-bold text-gray-500">
                            <i data-lucide="bar-chart-3" class="w-4 h-4"></i>
                            <span>Dashboard ××”×™×¨</span> <span class="shortcut-key">D</span>
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-400 transition-transform" id="dash-toggle-icon"></i>
                    </div>
                    <div id="dashboard-content" class="hidden px-3 py-2 bg-gray-50">
                        <div class="grid grid-cols-4 gap-2">
                            <div class="bg-white rounded-lg p-2 border border-green-200 shadow-sm">
                                <div class="text-[11px] font-bold text-green-600 mb-1 flex items-center gap-1">
                                    <i data-lucide="trophy" class="w-3 h-3"></i> TOP 5 ×¨×•×•×—×™×™×
                                </div>
                                <div id="top-performers" class="space-y-0.5"></div>
                            </div>
                            <div class="bg-white rounded-lg p-2 border border-red-200 shadow-sm">
                                <div class="text-[11px] font-bold text-red-600 mb-1 flex items-center gap-1">
                                    <i data-lucide="trending-down" class="w-3 h-3"></i> TOP 5 ××¤×¡×™×“×™×
                                </div>
                                <div id="top-losers" class="space-y-0.5"></div>
                            </div>
                            <div class="bg-white rounded-lg p-2 border border-purple-200 shadow-sm">
                                <div class="text-[11px] font-bold text-purple-600 mb-1 flex items-center gap-1">
                                    <i data-lucide="star" class="w-3 h-3"></i> ×¨××•×™×™× ×œ×§××¤×™×™×Ÿ × ×¤×¨×“
                                </div>
                                <div id="outstanding-list" class="space-y-0.5"></div>
                            </div>
                            <div class="bg-white rounded-lg p-2 border border-blue-200 shadow-sm">
                                <div class="text-[11px] font-bold text-blue-600 mb-1 flex items-center gap-1">
                                    <i data-lucide="calculator" class="w-3 h-3"></i> Break-Even Calculator
                                </div>
                                <div class="text-[10px] space-y-1.5">
                                    <div class="bg-blue-50 rounded p-1.5">
                                        <div class="text-slate-600 mb-0.5 font-medium">×§×œ×™×§×™× ××§×¡×³ ×¢×“ ×”×¤×¡×“:</div>
                                        <div class="font-bold text-blue-700 num-font text-[13px]" id="be-max-clicks">-</div>
                                        <div class="text-[9px] text-slate-400 num-font" id="be-clicks-formula"></div>
                                    </div>
                                    <div class="bg-purple-50 rounded p-1.5">
                                        <div class="text-slate-600 mb-0.5 font-medium">CR ××™× ×™××œ×™ ×œ×¨×•×•×—:</div>
                                        <div class="font-bold text-purple-700 num-font text-[13px]" id="be-min-cr">-</div>
                                        <div class="text-[9px] text-slate-400 num-font" id="be-cr-formula"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="flex:1;min-height:0;display:flex;flex-direction:column;padding:8px;padding-top:4px;">
                    <div style="flex:1;min-height:0;display:flex;flex-direction:column;background:white;border-radius:8px;border:1px solid #e5e7eb;">
                        <div id="section-toolbar" class="table-toolbar px-3 py-2 border-b border-gray-100 bg-white shrink-0 relative" style="border-radius:8px 8px 0 0;">
                            <button class="section-toggle" onclick="toggleSectionCollapse('section-toolbar')" title="×›×•×•×¥/×”×¨×—×‘ ×¡×¨×’×œ" style="top:2px;left:2px;">â–²</button>
                            <div class="section-inner flex justify-between items-center flex-wrap gap-2">
                            <div class="flex items-center gap-3 flex-wrap">
                                <div class="search-box">
                                    <i data-lucide="search" class="w-3 h-3"></i>
                                    <input type="text" id="search-input" placeholder="×—×¤×© ××–×”×”... (Ctrl+F)" class="text-right">
                                </div>
                                <button class="btn-reset-view" onclick="$('filter-view').value='all'; $('filter-volume').value='all'; $('search-input').value=''; $('min-score-filter').value='0'; state.searchQuery=''; applyFilter();" title="××™×¤×•×¡ ×›×œ ×”×¡×™× ×•× ×™×">
                                    <i data-lucide="rotate-ccw" class="w-3 h-3"></i> ××™×¤×•×¡
                                </button>
                                
                                <div class="icloud-switcher">
                                    <div class="switcher-options">
                                        <button type="button" class="switcher-btn" data-value="hide" title="×”×¡×ª×¨ iCloud">ğŸš«</button>
                                        <button type="button" class="switcher-btn active" data-value="all" title="×”×¦×’ ×”×›×œ">âœ“</button>
                                        <button type="button" class="switcher-btn" data-value="only" title="×¨×§ iCloud">â˜ï¸</button>
                                    </div>
                                </div>
                                
                                <div class="agg-switcher" title="××¦×‘ ×ª×¦×•×’×”">
                                    <div class="switcher-options">
                                        <button type="button" class="switcher-btn active" data-agg="split" title="MICRO">MICRO</button>
                                        <button type="button" class="switcher-btn" data-agg="smart" title="MACRO">MACRO</button>
                                    </div>
                                    <span id="macro-warning" class="hidden text-[10px] bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full font-bold animate-pulse border border-orange-200 shadow-sm">âš ï¸ ×××•×’×“: <span id="macro-count">0</span> | ××¤×•×¦×œ: <span id="micro-count">0</span></span>
                                </div>
                                
                                
                                <div class="flex items-center gap-2">
                                    <span class="text-[11px] font-bold text-slate-400 uppercase">×ª×¦×•×’×”:</span>
                                    <select id="filter-view" class="text-sm bg-slate-50 border border-slate-200 rounded px-2 py-1 font-medium w-40">
                                        <option value="all">×”×›×œ</option>
                                        <option value="relevant">ğŸ¯ Relevant (P+G+Pot)</option>
                                        <option value="relevant_plus">ğŸš€ Relevant+ (incl. Test)</option>
                                        <option value="winners">âœ¨ Winners (P+G)</option>
                                        <option value="pure">ğŸ’ Pure</option>
                                        <option value="gold">ğŸ¥‡ Gold</option>
                                        <option value="potential">ğŸŒ± Potential</option>
                                        <option value="ignore">ğŸ‘€ Watch</option>
                                        <option value="blacklist">â›” Blacklist (Hard)</option>
                                        <option value="blacklist-soft">ğŸŸ  Blacklist (Soft)</option>
                                        <option value="watch">âš ï¸ Poor</option>
                                        <option value="all-bl">â›” All BL+Poor</option>
                                        <option value="testing">ğŸ”¬ Testing</option>
                                        <option value="custom">ğŸ¯ Custom</option>
                                        <option value="anomaly">ğŸš¨ Anomalies</option>
                                    </select>
                                </div>

                                <div class="flex items-center gap-2">
                                    <span class="text-[11px] font-bold text-slate-400 uppercase">Vol:</span>
                                    <select id="filter-volume" class="text-sm bg-slate-50 border border-slate-200 rounded px-2 py-1 font-medium w-28" onchange="applyViewFilter(); renderKPIs(); renderTable(); renderGlobalStats(); updateMiniDashboard();">
                                        <option value="all">×”×›×œ</option>
                                        <option value="high">â–² High</option>
                                        <option value="mid">â–  Mid</option>
                                        <option value="low">â–¼ Low</option>
                                        <option value="high-mid">â–²â–  High+Mid</option>
                                        <option value="low-mid">â–¼â–  Low+Mid</option>
                                    </select>
                                </div>

                                <div class="flex items-center gap-2" id="level-filter-box" style="display:none;">
                                    <span class="text-[11px] font-bold text-slate-400 uppercase">×©×›×‘×”:</span>
                                    <select id="level-view" class="text-sm bg-slate-50 border border-slate-200 rounded px-2 py-1 font-medium">
                                        <option value="detail">×¤×™×¨×•×˜ ×‘×œ×‘×“</option>
                                        <option value="all">×”×›×œ (×›×•×œ×œ ×¡×™×›×•××™×)</option>
                                    </select>
                                </div>

                                <div class="flex items-center gap-2 border-r border-slate-200 pr-3">
                                    <span class="text-[11px] font-bold text-slate-400">Min Score:</span>
                                    <input type="number" id="min-score-filter" value="0" step="0.1" class="w-16 text-sm border border-slate-200 rounded px-2 py-1 num-font">
                                </div>

                                <div class="flex items-center gap-2">
                                    <label class="flex items-center gap-1 text-[11px] text-slate-500 font-bold cursor-pointer">
                                        <input type="checkbox" id="chk-copy-cidr" class="chk-input"> CIDR
                                    </label>
                                    <button onclick="copyIPs()" id="btn-copy" class="flex items-center gap-1 bg-white border border-slate-200 text-slate-600 px-2 py-1 rounded hover:bg-slate-50 text-[11px] font-bold">
                                        <i data-lucide="copy" class="w-3 h-3"></i> ×”×¢×ª×§ <span class="shortcut-key">C</span>
                                    </button>
                                </div>
                            </div>
                            <div class="text-[11px] text-slate-400 font-medium">
                                ×¡×”"×›: <span id="disp-count" class="font-bold text-slate-800 num-font text-base">0</span>
                            </div>
                            </div>
                        </div>

                        <div class="custom-scrollbar" style="flex:1;min-height:0;overflow:auto;background:white;">
                            <table class="w-full text-sm relative">
                                <thead class="bg-slate-50">
                                    <tr>
                                        <th class="text-center w-8">#</th>
                                        <th class="text-center w-10" id="th-level" style="display:none;">Lvl</th>
                                        <th class="text-right sortable-th" data-sort="identifier" onclick="sortByColumn('identifier')">××–×”×” <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="category" onclick="sortByColumn('category')">×§×˜×’×•×¨×™×” <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="volumeTier" onclick="sortByColumn('volumeTier')">Vol <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="score" onclick="sortByColumn('score')">Score <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="clicks" onclick="sortByColumn('clicks')">Clicks <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="conv" onclick="sortByColumn('conv')">Conv <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="revenue" onclick="sortByColumn('revenue')">Revenue <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="cost" onclick="sortByColumn('cost')">Cost <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="profit" onclick="sortByColumn('profit')">Profit <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="roi" onclick="sortByColumn('roi')">ROI% <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="cr" onclick="sortByColumn('cr')">CR% <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="ppc" onclick="sortByColumn('ppc')">PPC <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="cpc" onclick="sortByColumn('cpc')">CPC <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="cpa" onclick="sortByColumn('cpa')">CPA <span class="sort-icon">â‡…</span></th>
                                        <th class="text-center sortable-th" data-sort="ap" onclick="sortByColumn('ap')">AP <span class="sort-icon">â‡…</span></th>
                                    </tr>
                                    <tr id="table-summary-row"></tr>
                                </thead>
                                <tbody id="table-body"></tbody>
                            </table>
                        </div>

                        <div class="p-1.5 border-t border-gray-100 bg-white flex justify-center gap-4 items-center" style="flex-shrink:0;border-radius:0 0 8px 8px;">
                            <button onclick="changePage(-1)" class="p-1 hover:bg-gray-100 rounded text-gray-400"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                            <span id="page-num" class="text-[11px] font-bold text-gray-400 num-font">1 / 1</span>
                            <button onclick="changePage(1)" class="p-1 hover:bg-gray-100 rounded text-gray-400"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Keyboard shortcuts overlay -->
    <div id="shortcuts-panel" class="shortcuts-hint">
        <div class="font-bold text-[12px] mb-2 border-b border-slate-600 pb-1">âŒ¨ï¸ ×§×™×¦×•×¨×™ ××§×œ×“×ª</div>
        <div class="space-y-1">
            <div><span class="shortcut-key">Ctrl+F</span> ×—×™×¤×•×©</div>
            <div><span class="shortcut-key">E</span> ×™×™×¦×•× Excel</div>
            <div><span class="shortcut-key">C</span> ×”×¢×ª×§ ××–×”×™×</div>
            <div><span class="shortcut-key">D</span> Dashboard</div>
            <div><span class="shortcut-key">F</span> Focus (×˜×‘×œ×” ×‘×œ×‘×“)</div>
            <div><span class="shortcut-key">1-6</span> ××¢×‘×¨ ×§×˜×’×•×¨×™×”</div>
            <div><span class="shortcut-key">?</span> ×¢×–×¨×” ×–×•</div>
            <div><span class="shortcut-key">Esc</span> ×¡×’×•×¨</div>
        </div>
    </div>

    <script>
        lucide.createIcons();
        
        // KPI Tooltip handler (fixed position to bypass overflow clipping)
        (function(){
            const tip = document.getElementById('kpi-tooltip-el');
            document.addEventListener('mouseover', function(e){
                const el = e.target.closest('.kpi-label-hover');
                if(el && el.dataset.tiphe){
                    tip.textContent = el.dataset.tiphe;
                    tip.style.display = 'block';
                    const r = el.getBoundingClientRect();
                    tip.style.top = (r.bottom + 8) + 'px';
                    tip.style.left = Math.max(10, r.left + r.width/2 - 130) + 'px';
                }
            });
            document.addEventListener('mouseout', function(e){
                if(e.target.closest('.kpi-label-hover')){ tip.style.display = 'none'; }
            });
        })();
        
        document.addEventListener('click', (e) => {
            const insidePopup = e.target.closest('.filter-popup');
            const insideBtn = e.target.closest('.filter-btn');
            const insideFilterItem = e.target.closest('.filter-item');
            if (insidePopup || insideBtn || insideFilterItem) return;
            document.querySelectorAll('.filter-popup').forEach(p => p.classList.remove('show'));
        });
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TOAST SYSTEM
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showToast(message, type = 'info', duration = 3000) {
            const container = $('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast toast-' + type;
            const icons = { success: 'âœ…', info: 'â„¹ï¸', warn: 'âš ï¸', error: 'âŒ' };
            toast.innerHTML = '<span>' + (icons[type] || '') + '</span><span>' + message + '</span>';
            container.appendChild(toast);
            setTimeout(() => { if (toast.parentNode) toast.remove(); }, duration);
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // WILSON SCORE CONFIDENCE INTERVAL
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function wilsonScore(successes, total, z = 1.96) {
            if (total === 0) return { lower: 0, upper: 0, center: 0, confidence: 'none' };
            const p = successes / total;
            const denominator = 1 + z * z / total;
            const center = (p + z * z / (2 * total)) / denominator;
            const margin = z * Math.sqrt((p * (1 - p) + z * z / (4 * total)) / total) / denominator;
            const lower = Math.max(0, center - margin);
            const upper = Math.min(1, center + margin);
            const width = upper - lower;
            let confidence = 'low';
            if (total >= 1000 && width < 0.01) confidence = 'high';
            else if (total >= 200 && width < 0.03) confidence = 'high';
            else if (total >= 50 && width < 0.05) confidence = 'medium';
            else if (total >= 20) confidence = 'medium';
            return { lower, upper, center, confidence, width };
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ANOMALY DETECTION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function detectAnomalies(data, campaignAvgCR) {
            if (!data.length) return data;
            // Calculate traffic percentiles for bot detection
            const clickValues = data.map(r => r.clicks).sort((a, b) => a - b);
            const p95clicks = clickValues[Math.floor(clickValues.length * 0.95)] || 1000;
            
            return data.map(r => {
                const anomalies = [];
                // Fraud: many conversions but zero/near-zero revenue (fake conversions)
                if (r.conv >= 3 && r.rev < r.conv * 0.1) {
                    anomalies.push({ type: 'fraud', label: 'ğŸ­ Fraud?', reason: r.conv + ' ×”××¨×•×ª ×¢× $' + r.rev.toFixed(2) + ' ×”×›× ×¡×” ×‘×œ×‘×“' });
                }
                // Bot: extreme traffic relative to dataset (P95+) with zero conversions
                if (r.conv === 0 && r.clicks > p95clicks * 2) {
                    anomalies.push({ type: 'bot', label: 'ğŸ¤– Bot?', reason: '0 ×”××¨×•×ª ×¢× ' + r.clicks.toLocaleString() + ' ×§×œ×™×§×™× (P95 = ' + p95clicks.toLocaleString() + ')' });
                }
                // Statistical outlier - extreme PPC (positive)
                if (r.ppc > state.medianPPC * 10 && r.conv >= 3) {
                    anomalies.push({ type: 'outlier', label: 'â­ Outlier+', reason: 'PPC x' + (r.ppc / state.medianPPC).toFixed(0) + ' ××”××“×™××Ÿ' });
                }
                return { ...r, anomalies };
            });
        }
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // LOCALSTORAGE PERSISTENCE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const STORAGE_KEY = 'listlab_v49_settings';
        
        function saveSettings() {
            try {
                const settings = {
                    purePct: $('pure-pct-num').value,
                    goldPct: $('gold-pct-num').value,
                    ipLevel: $('ip-level').value,
                    identifierType: $('identifier-type').value,
                    blMode: state.blMode,
                    blCalc: state.blCalc,
                    blThresholdMult: $('bl-threshold-mult').value,
                    blSoftRoi: $('bl-soft-roi').value,
                    blSoftMinLoss: $('bl-soft-min-loss').value,
                    blSoftNeedsClicks: $('bl-soft-needs-clicks').checked,
                    icloudFilter: state.icloudFilter,
                    aggMode: state.aggMode,
                    customEnabled: $('custom-enabled').checked,
                    custConvMin: $('cust-conv-min').value,
                    custConvMax: $('cust-conv-max').value,
                    custScoreMin: $('cust-score-min').value,
                    custScoreMax: $('cust-score-max').value,
                    custClicksMin: $('cust-clicks-min').value,
                    custClicksMax: $('cust-clicks-max').value,
                    custRoiMin: $('cust-roi-min').value,
                    custRoiMax: $('cust-roi-max').value,
                    custCrMin: $('cust-cr-min').value,
                    custCrMax: $('cust-cr-max').value,
                    custPpcMin: $('cust-ppc-min').value,
                    custPpcMax: $('cust-ppc-max').value,
                    exportChecks: {
                        pure: $('chk-pure').checked, gold: $('chk-gold').checked,
                        potential: $('chk-potential').checked, bl: $('chk-bl').checked,
                        custom: $('chk-custom').checked, cidr: $('chk-cidr').checked
                    },
                    avgPayout: $('avg-payout').value
                };
                localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
            } catch(e) { /* silent fail */ }
        }
        
        function loadSettings() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (!saved) return;
                const s = JSON.parse(saved);
                if (s.purePct) { $('pure-pct-num').value = s.purePct; $('pure-pct').value = s.purePct; }
                if (s.goldPct) { $('gold-pct-num').value = s.goldPct; $('gold-pct').value = s.goldPct; }
                if (s.ipLevel) $('ip-level').value = s.ipLevel;
                if (s.identifierType) $('identifier-type').value = s.identifierType;
                if (s.blMode) { state.blMode = s.blMode; document.querySelectorAll('.bl-mode-btn[data-blmode]').forEach(b => b.classList.toggle('active', b.dataset.blmode === s.blMode)); }
                if (s.blCalc) { state.blCalc = s.blCalc === 'jenks' ? 'median' : s.blCalc; document.querySelectorAll('.bl-mode-btn[data-blcalc]').forEach(b => b.classList.toggle('active', b.dataset.blcalc === state.blCalc)); }
                if (s.blThresholdMult) $('bl-threshold-mult').value = s.blThresholdMult;
                if (s.blSoftRoi) $('bl-soft-roi').value = s.blSoftRoi;
                if (s.blSoftMinLoss !== undefined) $('bl-soft-min-loss').value = s.blSoftMinLoss;
                if (s.blSoftNeedsClicks !== undefined) $('bl-soft-needs-clicks').checked = s.blSoftNeedsClicks;
                if (s.icloudFilter) { state.icloudFilter = s.icloudFilter; document.querySelectorAll('.icloud-switcher .switcher-btn').forEach(b => b.classList.toggle('active', b.dataset.value === s.icloudFilter)); }
                if (s.aggMode) { state.aggMode = s.aggMode; document.querySelectorAll('.agg-switcher .switcher-btn').forEach(b => b.classList.toggle('active', b.dataset.agg === s.aggMode)); }
                if (s.customEnabled) $('custom-enabled').checked = s.customEnabled;
                if (s.custConvMin) $('cust-conv-min').value = s.custConvMin;
                if (s.custConvMax) $('cust-conv-max').value = s.custConvMax;
                if (s.custScoreMin) $('cust-score-min').value = s.custScoreMin;
                if (s.custScoreMax) $('cust-score-max').value = s.custScoreMax;
                if (s.custClicksMin) $('cust-clicks-min').value = s.custClicksMin;
                if (s.custClicksMax) $('cust-clicks-max').value = s.custClicksMax;
                if (s.custRoiMin) $('cust-roi-min').value = s.custRoiMin;
                if (s.custRoiMax) $('cust-roi-max').value = s.custRoiMax;
                if (s.custCrMin) $('cust-cr-min').value = s.custCrMin;
                if (s.custCrMax) $('cust-cr-max').value = s.custCrMax;
                if (s.custPpcMin) $('cust-ppc-min').value = s.custPpcMin;
                if (s.custPpcMax) $('cust-ppc-max').value = s.custPpcMax;
                if (s.exportChecks) {
                    if (s.exportChecks.pure !== undefined) $('chk-pure').checked = s.exportChecks.pure;
                    if (s.exportChecks.gold !== undefined) $('chk-gold').checked = s.exportChecks.gold;
                    if (s.exportChecks.potential !== undefined) $('chk-potential').checked = s.exportChecks.potential;
                    if (s.exportChecks.bl !== undefined) $('chk-bl').checked = s.exportChecks.bl;
                    if (s.exportChecks.custom !== undefined) $('chk-custom').checked = s.exportChecks.custom;
                    if (s.exportChecks.cidr !== undefined) $('chk-cidr').checked = s.exportChecks.cidr;
                }
                if (s.avgPayout) $('avg-payout').value = s.avgPayout;
                showToast('×”×’×“×¨×•×ª × ×˜×¢× ×• ××”×–×™×›×¨×•×Ÿ', 'info');
            } catch(e) { /* silent fail */ }
        }
        
        // Load settings on startup
        loadSettings();
        
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // KEYBOARD SHORTCUTS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        document.addEventListener('keydown', (e) => {
            const tag = document.activeElement.tagName;
            const isInput = tag === 'INPUT' || tag === 'SELECT' || tag === 'TEXTAREA';
            
            // Ctrl+F - search
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                $('search-input').focus();
                return;
            }
            
            if (isInput) return;
            
            // ? - show shortcuts
            if (e.key === '?') {
                $('shortcuts-panel').classList.toggle('show');
                return;
            }
            // Esc - close shortcuts
            if (e.key === 'Escape') {
                $('shortcuts-panel').classList.remove('show');
                return;
            }
            // E - export
            if (e.key === 'e' || e.key === 'E') { exportData(); return; }
            // C - copy IPs
            if (e.key === 'c' && !e.ctrlKey) { copyIPs(); return; }
            // D - toggle dashboard
            if (e.key === 'd' || e.key === 'D') { toggleDashboard(); return; }
            // F - focus mode (table only)
            if (e.key === 'f' || e.key === 'F') { toggleFocusMode(); return; }
            // 1-6 - category views
            const viewMap = { '1': 'pure', '2': 'gold', '3': 'potential', '4': 'blacklist', '5': 'testing', '6': 'all' };
            if (viewMap[e.key]) { $('filter-view').value = viewMap[e.key]; applyFilter(); return; }
        });
        
        const state = {
            rawData: [], allRows: [], detailRows: [], summaryRows: [], aggregatedData: [], processed: [], filtered: [],
            headers: [], dimensions: {}, activeFilters: [], page: 1, pageSize: 100,
            medianPPC: 0, medianCR: 0, medianROI: 100, campaignCR: 0, campaignAvgPPC: 0, clickThreshold: 7000,
            visibleKpis: ['pure', 'gold', 'potential', 'ignore', 'blacklist', 'testing'],
            hasHierarchy: false, levelColumn: null, maxLevel: 1, ipColumn: '',
            customEnabled: false, identifierType: 'auto', detectedType: null,
            searchQuery: '', osColumn: null, ispColumn: null, extraColumns: [],
            sortColumn: null, sortDirection: 'desc',
            icloudFilter: 'all', aggMode: 'split',
            rawDetailRows: [], processedRaw: null, hasActiveAdvancedFilters: false,
            blMode: 'ppc',
            blCalc: 'median',
            blCleanThreshold: 0,
            blJenksHard: 0,
            blJenksSoft: 0,
            manualTiers: false
        };
        
        const ICLOUD_RANGES = ['104.28', '172.226', '172.225', '172.224', '146.75', '140.248'];
        function isIcloudIP(identifier) {
            if (!identifier) return false;
            const str = String(identifier);
            for (const range of ICLOUD_RANGES) { if (str.startsWith(range + '.')) return true; }
            return false;
        }

        const IP_LEVELS = {
            1: { name: 'SubID/IP32', multiplier: 1.5, min: 500, max: 3000, default: 1500 },
            2: { name: 'Zone/IP24', multiplier: 3, min: 2500, max: 10000, default: 7000 },
            3: { name: 'IP16', multiplier: 5, min: 5000, max: 15000, default: 10000 }
        };
        
        const INVALID_PATTERNS = [
            '0.0.0.0', /^0\.0\.0\./,
            '{zone_id}', '{zoneid}', '{zone}', '{sub}', '{subid}', '{sub_id}',
            '{click_id}', '{clickid}',
            '×œ× ××–×•×”×”', 'not identified', 'unknown', 'undefined', 'null',
            '(not set)', '(none)', 'n/a', 'na'
        ];
        const $ = id => document.getElementById(id);
        const parseNum = v => { if (typeof v === 'number') return v; if (!v) return 0; return parseFloat(String(v).replace(/[,$%\s]/g, '')) || 0; };
        
        function escapeHtml(text) { const div = document.createElement('div'); div.textContent = String(text ?? ''); return div.innerHTML; }
        
        function highlightSafe(text, query) {
            const raw = String(text ?? ''); const q = String(query ?? '').trim();
            if (!q) return escapeHtml(raw);
            const re = new RegExp(q.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'gi');
            let out = '', last = 0;
            raw.replace(re, (m, offset) => { out += escapeHtml(raw.slice(last, offset)); out += '<mark class="search-highlight">' + escapeHtml(m) + '</mark>'; last = offset + m.length; return m; });
            out += escapeHtml(raw.slice(last));
            return out;
        }
        
        function fillSelectWithHeaders(selectEl, headers) {
            selectEl.textContent = '';
            headers.forEach((h, i) => { const opt = document.createElement('option'); opt.value = String(i); opt.textContent = String(h ?? ''); selectEl.appendChild(opt); });
        }
        function toggleSection(section) { const content = $(section + '-content'); const icon = $(section + '-icon'); content.classList.toggle('open'); icon.classList.toggle('open'); }

        function isInvalidIdentifier(id) {
            if (!id || id.trim() === '') return true;
            const lower = id.toLowerCase().trim();
            for (const pattern of INVALID_PATTERNS) { if (pattern instanceof RegExp) { if (pattern.test(lower)) return true; } else { if (lower === pattern.toLowerCase()) return true; } }
            if (/^\{.*\}$/.test(lower)) return true;
            return false;
        }
        
        function detectIdentifierType(values) {
            const sample = values.slice(0, 100);
            let ipCount = 0, numericCount = 0, mixedCount = 0;
            for (const val of sample) {
                if (!val || isInvalidIdentifier(val)) continue;
                if (/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}(\/\d{1,2})?$/.test(val)) ipCount++;
                else if (/^\d+$/.test(val)) numericCount++;
                else mixedCount++;
            }
            const total = ipCount + numericCount + mixedCount;
            if (total === 0) return 'unknown';
            if (ipCount / total > 0.5) return 'ip';
            if (numericCount / total > 0.5) {
                const numericValues = sample.filter(v => /^\d+$/.test(v)).map(Number);
                const avgValue = numericValues.reduce((a, b) => a + b, 0) / numericValues.length;
                const maxValue = Math.max(...numericValues);
                if (maxValue > 10000 || avgValue > 1000) return 'subid';
                return 'zone';
            }
            return 'mixed';
        }
        
        function getIdentifierTypeLabel(type) {
            const labels = { 'ip': 'ğŸŒ IP Address', 'zone': 'ğŸ“ Zone ID', 'subid': 'ğŸ¯ SubID', 'mixed': 'ğŸ”€ Mixed', 'unknown': 'â“ Unknown' };
            return labels[type] || type;
        }

        function toCIDR(identifier) {
            const str = String(identifier).trim();
            const ipLevel = parseInt($('ip-level').value);
            if (str.includes('/')) return str;
            if (/^\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}$/.test(str)) {
                const parts = str.split('.').map(Number);
                if (ipLevel === 1) return str + '/32';
                if (ipLevel === 2) return parts[0] + '.' + parts[1] + '.' + parts[2] + '.0/24';
                if (ipLevel === 3) return parts[0] + '.' + parts[1] + '.0.0/16';
                return str + '/32';
            }
            return str;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // AUTO THRESHOLD DETECTION (Jenks Natural Breaks)
        // Finds natural clusters in score distribution
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function jenksBreaks(data, numClasses) {
            // Jenks Natural Breaks / Fisher-Jenks
            // Minimizes within-class variance, maximizes between-class variance
            const n = data.length;
            if (n <= numClasses) return data.map(d => d);
            
            const sorted = [...data].sort((a, b) => a - b);
            
            // For efficiency, sample if too many values
            let values = sorted;
            if (n > 500) {
                const step = Math.floor(n / 500);
                values = sorted.filter((_, i) => i % step === 0);
                if (values[values.length - 1] !== sorted[sorted.length - 1]) values.push(sorted[sorted.length - 1]);
            }
            const m = values.length;
            
            // Initialize matrices
            const lowerClassLimits = Array.from({ length: m + 1 }, () => new Float64Array(numClasses + 1));
            const varianceCombinations = Array.from({ length: m + 1 }, () => { const a = new Float64Array(numClasses + 1); a.fill(Infinity); return a; });
            
            for (let i = 1; i <= numClasses; i++) lowerClassLimits[1][i] = 1;
            varianceCombinations[0].fill(0);
            
            for (let l = 2; l <= m; l++) {
                let sumX = 0, sumX2 = 0;
                for (let jj = 1; jj <= l; jj++) {
                    const val = values[l - jj];
                    sumX += val;
                    sumX2 += val * val;
                    const w = jj;
                    const variance = sumX2 - (sumX * sumX) / w;
                    if (jj === l) {
                        for (let j = 1; j <= numClasses; j++) {
                            if (variance < varianceCombinations[l][j]) {
                                lowerClassLimits[l][j] = 1;
                                varianceCombinations[l][j] = variance;
                            }
                        }
                    } else {
                        for (let j = 2; j <= numClasses; j++) {
                            const candidate = varianceCombinations[l - jj][j - 1] + variance;
                            if (candidate < varianceCombinations[l][j]) {
                                lowerClassLimits[l][j] = l - jj + 1;
                                varianceCombinations[l][j] = candidate;
                            }
                        }
                    }
                }
            }
            
            // Extract breaks
            const breaks = new Array(numClasses + 1);
            breaks[numClasses] = values[m - 1];
            breaks[0] = values[0];
            let k = m;
            for (let j = numClasses; j >= 2; j--) {
                const idx = lowerClassLimits[k][j] - 1;
                breaks[j - 1] = values[Math.max(0, idx)];
                k = lowerClassLimits[k][j] - 1;
            }
            return breaks;
        }
        
        function jenksGVF(data, breaks) {
            // Goodness of Variance Fit: 1.0 = perfect separation, 0.0 = no separation
            if (!data.length || !breaks.length) return 0;
            const sorted = [...data].sort((a, b) => a - b);
            const mean = sorted.reduce((s, v) => s + v, 0) / sorted.length;
            const sdam = sorted.reduce((s, v) => s + (v - mean) ** 2, 0); // total variance
            if (sdam === 0) return 1;
            
            // Assign each value to a class based on breaks
            let sdcm = 0;
            const numClasses = breaks.length - 1;
            for (let c = 0; c < numClasses; c++) {
                const lo = breaks[c];
                const hi = breaks[c + 1];
                const classVals = sorted.filter(v => c === 0 ? v <= hi : (v > lo && v <= hi));
                if (classVals.length === 0) continue;
                const classMean = classVals.reduce((s, v) => s + v, 0) / classVals.length;
                sdcm += classVals.reduce((s, v) => s + (v - classMean) ** 2, 0);
            }
            return 1 - (sdcm / sdam);
        }
        
        function autoDetectThresholds(silent) {
            // SMART AUTO: Jenks on PROFITABLE zones â†’ sets Pure & Gold percentiles
            const source = state.processed || [];
            if (!source.length) return false;
            
            const metric = $('auto-metric').value;
            const metricLabels = { score: 'Score', ppc: 'PPC', roi: 'ROI', cr: 'CR' };
            
            // Get profitable zones with conversions
            const profitable = source.filter(r => r.conv > 0 && r.profit > 0 && !r.isSummary);
            
            if (profitable.length < 10) {
                if (!silent) showToast('×¦×¨×™×š ×œ×¤×—×•×ª 10 ×–×•× ×™× ×¨×•×•×—×™×™× (' + profitable.length + ' × ××¦××•)', 'warn');
                return false;
            }
            
            const getValue = (r) => {
                switch (metric) {
                    case 'ppc': return r.ppc;
                    case 'roi': return r.roi;
                    case 'cr': return r.cr * 100;
                    default: return r.score;
                }
            };
            
            // Jenks 3-class on profitable: [Potential | Gold | Pure]
            const values = profitable.map(r => getValue(r)).sort((a, b) => a - b);
            const breaks = jenksBreaks(values, 3);
            const gvf = jenksGVF(values, breaks);
            const goldBreak = breaks[1];
            const pureBreak = breaks[2];
            
            const pureCount = profitable.filter(r => getValue(r) >= pureBreak).length;
            const goldCount = profitable.filter(r => getValue(r) >= goldBreak).length;
            
            let purePct = Math.round((pureCount / profitable.length) * 100);
            let goldPct = Math.round((goldCount / profitable.length) * 100);
            purePct = Math.max(2, Math.min(40, purePct));
            goldPct = Math.max(purePct + 5, Math.min(65, goldPct));
            
            // Apply Pure/Gold sliders
            $('pure-pct-num').value = purePct;
            $('pure-pct').value = Math.min(50, purePct);
            $('gold-pct-num').value = goldPct;
            $('gold-pct').value = Math.min(70, goldPct);
            
            // P25 quality gate stats
            const sortedROI = profitable.map(r => r.roi).sort((a, b) => a - b);
            const sortedScores = profitable.map(r => r.score).sort((a, b) => a - b);
            const p25ROI = Math.max(100, sortedROI[Math.floor(sortedROI.length * 0.25)]);
            const p25Score = sortedScores[Math.floor(sortedScores.length * 0.25)];
            const potentialOK = profitable.filter(r => r.roi >= p25ROI && r.score >= p25Score).length;
            const watchCount = profitable.length - potentialOK;
            
            // GVF quality label
            const gvfPct = (gvf * 100).toFixed(0);
            const gvfLabel = gvf >= 0.8 ? 'ğŸŸ¢ ×—×™×ª×•×š ×—×–×§' : gvf >= 0.6 ? 'ğŸŸ¡ ×—×™×ª×•×š ×¡×‘×™×¨' : 'ğŸ”´ ×—×™×ª×•×š ×—×œ×© â€” ×©×§×•×œ ×™×“× ×™';
            
            // Display
            const fmtVal = (v) => {
                if (metric === 'ppc') return '$' + v.toFixed(4);
                if (metric === 'roi') return v.toFixed(0) + '%';
                if (metric === 'cr') return v.toFixed(3) + '%';
                return v.toFixed(2);
            };
            
            const totalZones = source.filter(r => !r.isSummary).length;
            const summaryParts = [
                'ğŸ“Š Jenks Fit: ' + gvfPct + '% â€” ' + gvfLabel,
                'ğŸ’ Pure: top ' + purePct + '% (' + metricLabels[metric] + ' â‰¥ ' + fmtVal(pureBreak) + ')',
                'ğŸ¥‡ Gold: top ' + goldPct + '% (' + metricLabels[metric] + ' â‰¥ ' + fmtVal(goldBreak) + ')',
                'ğŸŒ± Potential: P25 quality gate â€” ' + potentialOK + ' zones ×¢×‘×¨×• ×¡×£',
                watchCount > 0 ? 'âš ï¸ Poor: ' + watchCount + ' zones ×¨×•×•×—×™×™× ××ª×—×ª ×œ×¡×£' : '',
                'ğŸ“Š ' + profitable.length + ' ×¨×•×•×—×™×™× ××ª×•×š ' + totalZones + ' ×¡×”×´×›'
            ].filter(Boolean);
            
            $('auto-thresh-info').classList.remove('hidden');
            $('auto-thresh-text').innerHTML = summaryParts.join('<br>');
            
            if (!silent) {
                showToast('âš¡ Auto Tiers (' + metricLabels[metric] + '): Pure ' + purePct + '% | Gold ' + goldPct + '%', 'success', 3000);
            }
            
            return true; // thresholds were updated
        }
        
        function calculateClickThreshold() {
            const level = parseInt($('ip-level').value);
            const config = IP_LEVELS[level];
            if (state.campaignCR <= 0 || state.campaignCR < 0.001) {
                state.clickThreshold = config.default;
            } else {
                const crPercent = state.campaignCR * 100;
                let threshold = config.multiplier * (100 / crPercent);
                threshold = Math.max(config.min, Math.min(config.max, threshold));
                state.clickThreshold = Math.round(threshold);
            }
            $('current-threshold').textContent = state.clickThreshold.toLocaleString();
            $('click-threshold').textContent = state.clickThreshold.toLocaleString();
        }

        const dz = $('drop-zone');
        const fi = $('file-input');
        dz.addEventListener('click', () => fi.click());
        fi.addEventListener('change', e => loadFile(e.target.files[0]));
        dz.addEventListener('dragover', e => e.preventDefault());
        dz.addEventListener('drop', e => { e.preventDefault(); loadFile(e.dataTransfer.files[0]); });

        function loadFile(file) {
            if (!file) return;
            const sizeMB = file.size / (1024 * 1024);
            if (sizeMB > 50) { alert('×§×•×‘×¥ ×’×“×•×œ ××“×™ (××¢×œ 50MB)'); return; }
            $('filename').innerHTML = '<span class="animate-pulse">â³ ×˜×•×¢×Ÿ ' + escapeHtml(file.name) + ' (' + sizeMB.toFixed(1) + 'MB)...</span>';
            $('global-stats').innerHTML = '<span class="text-amber-500 animate-pulse">ğŸ”„ ××¢×‘×“ × ×ª×•× ×™×...</span>';
            setTimeout(() => {
                const reader = new FileReader();
                reader.onerror = () => { alert('×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥'); $('filename').textContent = ''; };
                reader.onload = e => {
                    try {
                        const wb = XLSX.read(e.target.result, { type: 'array', cellDates: false, cellNF: false, cellStyles: false });
                        const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { header: 1, defval: '', raw: true });
                        if (json.length < 2) { alert('×§×•×‘×¥ ×¨×™×§'); $('filename').textContent = ''; return; }
                        state.headers = json[0].map(h => String(h || '').trim());
                        state.rawData = json.slice(1).filter(row => row.some(c => c !== '' && c != null));
                        $('filename').textContent = file.name + ' (' + state.rawData.length.toLocaleString() + ' ×©×•×¨×•×ª)';
                        const hLower = state.headers.map(h => h.toLowerCase());
                        const levelIdx = hLower.findIndex(x => x === 'level' || x === 'lvl' || x === 'depth');
                        state.levelColumn = levelIdx !== -1 ? state.headers[levelIdx] : null;
                        state.hasHierarchy = levelIdx !== -1;
                        setupMapping();
                        setupFilters();
                        state.manualTiers = false;
                        setTimeout(() => processData(), 10);
                    } catch (err) {
                        console.error('Error processing file:', err);
                        alert('×©×’×™××” ×‘×¢×™×‘×•×“: ' + err.message);
                        $('filename').textContent = '';
                        $('global-stats').innerHTML = '<span class="text-red-500">×©×’×™××” ×‘×˜×¢×™× ×”</span>';
                    }
                };
                reader.readAsArrayBuffer(file);
            }, 50);
        }

        function setupMapping() {
            const ipSel = $('col-ip');
            fillSelectWithHeaders(ipSel, state.headers);
            const hLower = state.headers.map(h => h.toLowerCase());
            const subidPatterns = ['subid', 'sub_id', 'sub id', 'token 3', 'token3'];
            const zonePatterns = ['zone', 'zone_id', 'zoneid', 'token 4', 'token4'];
            const ipPatterns = ['ip', 'ip address', 'ip_address', 'range', 'identifier'];
            
            let matchIdx = hLower.findIndex(h => subidPatterns.some(p => h.includes(p)));
            if (matchIdx < 0) matchIdx = hLower.findIndex(h => zonePatterns.some(p => h.includes(p)));
            if (matchIdx < 0) matchIdx = hLower.findIndex(h => ipPatterns.some(p => h.includes(p)));
            if (matchIdx >= 0) ipSel.value = matchIdx;

            const selects = ['col-clicks', 'col-conv', 'col-rev', 'col-cost'];
            const defaults = { 'col-clicks': ['clicks', 'click', 'impressions'], 'col-conv': ['conv', 'conversions', 'conversion', 'leads'], 'col-rev': ['revenue', 'rev', 'income', 'payout'], 'col-cost': ['cost', 'spend', 'expense'] };
            
            const mappingResults = [];
            selects.forEach(id => {
                const sel = $(id);
                fillSelectWithHeaders(sel, state.headers);
                const mIdx = hLower.findIndex(h => defaults[id].some(k => h.includes(k)));
                if (mIdx >= 0) {
                    sel.value = mIdx;
                    mappingResults.push(id.replace('col-', '') + ' â†’ ' + state.headers[mIdx]);
                }
            });
            
            // Show mapping toast
            if (mappingResults.length > 0) {
                showToast('××™×¤×•×™ ××•×˜×•××˜×™: ' + mappingResults.join(', '), 'success');
            }
            
            // Sanity check: warn if avg cost looks weird
            const costIdx = +$('col-cost').value;
            const sampleCosts = state.rawData.slice(0, 50).map(r => parseNum(r[costIdx]));
            const avgCost = sampleCosts.reduce((a, b) => a + b, 0) / sampleCosts.length;
            if (avgCost > 10000) {
                showToast('âš ï¸ ×¢××•×“×ª Cost ×××•×¦×¢: $' + avgCost.toFixed(0) + ' â€” ×‘×“×•×§ ×©×”××™×¤×•×™ × ×›×•×Ÿ!', 'warn', 5000);
            }
            
            state.ipColumn = state.headers[+$('col-ip').value];
            $('mapping-box').classList.remove('hidden');
            $('medians-box').classList.remove('hidden');
            state.extraColumns = [];
            const osPatterns = ['os', 'operating system', 'device os', 'platform'];
            const ispPatterns = ['isp', 'carrier', 'network', 'provider'];
            const browserPatterns = ['browser', 'user agent'];
            const countryPatterns = ['country', 'geo', 'region'];
            
            const osIdx = hLower.findIndex(h => osPatterns.some(p => h.includes(p)));
            const ispIdx = hLower.findIndex(h => ispPatterns.some(p => h.includes(p)));
            const browserIdx = hLower.findIndex(h => browserPatterns.some(p => h.includes(p)));
            const countryIdx = hLower.findIndex(h => countryPatterns.some(p => h === p || h.includes(p)));
            
            if (osIdx >= 0) { state.osColumn = osIdx; state.extraColumns.push(state.headers[osIdx]); }
            if (ispIdx >= 0) { state.ispColumn = ispIdx; state.extraColumns.push(state.headers[ispIdx]); }
            if (browserIdx >= 0 && state.extraColumns.length < 2) state.extraColumns.push(state.headers[browserIdx]);
            if (countryIdx >= 0 && state.extraColumns.length < 2) state.extraColumns.push(state.headers[countryIdx]);

            detectAndUpdateIdentifierType();
            if (state.hasHierarchy) {
                $('hierarchy-box').classList.remove('hidden');
                $('level-filter-box').style.display = 'flex';
                $('th-level').style.display = '';
            } else {
                $('hierarchy-box').classList.add('hidden');
                $('level-filter-box').style.display = 'none';
                $('th-level').style.display = 'none';
            }
        }
        
        function detectAndUpdateIdentifierType() {
            const ipColIdx = +$('col-ip').value;
            const colName = state.headers[ipColIdx] || '';
            const identifierValues = state.rawData.map(row => String(row[ipColIdx] || '').trim());
            state.detectedType = detectIdentifierType(identifierValues);
            const colLower = colName.toLowerCase();
            let nameHint = null;
            if (colLower.includes('subid') || colLower.includes('sub_id') || colLower.includes('token 3') || colLower.includes('token3')) nameHint = 'subid';
            else if (colLower.includes('zone') || colLower.includes('token 4') || colLower.includes('token4')) nameHint = 'zone';
            else if (colLower.includes('ip')) nameHint = 'ip';
            const finalType = nameHint || state.detectedType;
            const detectedEl = $('detected-type');
            if (finalType && finalType !== 'unknown') {
                const icons = { ip: 'globe', zone: 'map-pin', subid: 'crosshair', mixed: 'shuffle' };
                const labels = { ip: 'IP', zone: 'Zone', subid: 'SubID', mixed: 'Mixed' };
                const typeName = labels[finalType] || finalType;
                const iconName = icons[finalType] || 'help-circle';
                $('detected-type-badge').innerHTML = '<i data-lucide="' + iconName + '" style="width:13px;height:13px;color:#3b82f6;"></i> <span>×–×•×”×”: <strong>' + typeName + '</strong> (' + escapeHtml(colName) + ')</span>';
                detectedEl.classList.remove('hidden');
                lucide.createIcons();
                if ($('identifier-type').value === 'auto') {
                    if (finalType === 'subid') $('ip-level').value = '1';
                    else if (finalType === 'zone') $('ip-level').value = '2';
                    else if (finalType === 'ip') { const hasSlash24 = identifierValues.some(v => v.endsWith('.0') || v.includes('/24')); $('ip-level').value = hasSlash24 ? '2' : '1'; }
                }
            } else { detectedEl.classList.add('hidden'); }
            state.ipColumn = colName;
        }

        function setupFilters() {
            state.dimensions = {};
            const skip = ['clicks', 'conversions', 'revenue', 'cost', 'profit', 'roi', 'cr', 'epc', 'cpc', 'level'];
            state.headers.forEach((h, idx) => {
                if (skip.some(s => h.toLowerCase().includes(s))) return;
                const vals = new Set();
                state.rawData.forEach(row => { const v = row[idx]; if (v !== undefined && v !== null && String(v).trim() !== '') vals.add(String(v).trim()); });
                if (vals.size > 0 && vals.size < 500) state.dimensions[h] = [...vals].sort();
            });
            const colSel = $('col-selector');
            colSel.textContent = '';
            const defaultOpt = document.createElement('option'); defaultOpt.value = ''; defaultOpt.textContent = '×‘×—×¨ ×¢××•×“×”...'; colSel.appendChild(defaultOpt);
            Object.keys(state.dimensions).forEach(h => { const opt = document.createElement('option'); opt.value = h; opt.textContent = h; colSel.appendChild(opt); });
            $('filter-msg').classList.add('hidden');
            $('btn-add-filter').classList.remove('hidden');
            state.activeFilters = [];
            $('filters-list').innerHTML = '';
        }

        function showAddFilterMenu() {
            if (state.activeFilters.length >= 4) return alert("××§×¡×™××•× 4 ××¡× × ×™×");
            $('btn-add-filter').classList.add('hidden');
            $('col-selector').classList.remove('hidden');
            $('col-selector').value = "";
        }

        function createNewFilter(col) {
            if (!col) { $('col-selector').classList.add('hidden'); $('btn-add-filter').classList.remove('hidden'); return; }
            const fid = Date.now();
            const div = document.createElement('div'); div.className = 'filter-item'; div.id = 'f-' + fid;
            div.innerHTML = '<div class="filter-header"><span>' + escapeHtml(col) + '</span><i data-lucide="x" class="w-3 h-3 cursor-pointer text-red-400 hover:text-red-600" onclick="removeFilter(' + fid + ')"></i></div><div class="filter-btn" onclick="togglePopup(' + fid + ')"><span id="l-' + fid + '">(×”×›×œ)</span><i data-lucide="chevron-down" class="w-3 h-3"></i></div><div class="filter-popup" id="p-' + fid + '"><input type="text" class="filter-search" placeholder="×—×¤×©..." oninput="filterOpts(' + fid + ', this.value)"><div class="filter-list custom-scrollbar" id="lst-' + fid + '"></div><div class="flex justify-between mt-2"><div class="btn-tiny btn-cancel" onclick="togglePopup(' + fid + ')">×¡×’×•×¨</div><div class="btn-tiny btn-apply" onclick="applyFilterSelection(' + fid + ')">×”×—×œ</div></div></div>';
            $('filters-list').appendChild(div);
            lucide.createIcons();
            const lst = $('lst-' + fid);
            (state.dimensions[col] || []).forEach(v => {
                const optDiv = document.createElement('div'); optDiv.className = 'filter-opt';
                const chk = document.createElement('input'); chk.type = 'checkbox'; chk.className = 'chk-input'; chk.value = v;
                const span = document.createElement('span'); span.textContent = v;
                optDiv.appendChild(chk); optDiv.appendChild(span); lst.appendChild(optDiv);
            });
            state.activeFilters.push({ id: fid, col, colIdx: state.headers.indexOf(col), values: [] });
            $('col-selector').classList.add('hidden');
            if (state.activeFilters.length < 4) $('btn-add-filter').classList.remove('hidden');
        }

        function removeFilter(fid) { $('f-' + fid).remove(); state.activeFilters = state.activeFilters.filter(f => f.id !== fid); $('btn-add-filter').classList.remove('hidden'); processData(); }
        function togglePopup(fid) { const el = $('p-' + fid); const isOpen = el.classList.contains('show'); document.querySelectorAll('.filter-popup').forEach(p => p.classList.remove('show')); if (!isOpen) el.classList.add('show'); }
        function filterOpts(fid, txt) { const term = txt.toLowerCase(); const opts = $('lst-' + fid).children; for (let o of opts) o.style.display = o.innerText.toLowerCase().includes(term) ? 'flex' : 'none'; }
        function applyFilterSelection(fid) {
            const lst = $('lst-' + fid);
            const vals = Array.from(lst.querySelectorAll('input:checked')).map(c => c.value);
            const f = state.activeFilters.find(x => x.id === fid);
            f.values = vals;
            const lbl = $('l-' + fid);
            lbl.innerText = vals.length ? vals.length + ' × ×‘×—×¨×•' : '(×”×›×œ)';
            lbl.className = vals.length ? 'text-blue-600 font-bold' : '';
            togglePopup(fid);
            processData(); 
        }

        function processData() {
            try {
                $('global-stats').innerHTML = '<span class="text-amber-500">ğŸ”„ ××¢×‘×“ ' + state.rawData.length.toLocaleString() + ' ×©×•×¨×•×ª...</span>';
                const cols = { ip: +$('col-ip').value, clicks: +$('col-clicks').value, conv: +$('col-conv').value, rev: +$('col-rev').value, cost: +$('col-cost').value };
                state.ipColumn = state.headers[cols.ip];
                const levelIdx = state.levelColumn ? state.headers.indexOf(state.levelColumn) : -1;
                const extraColIndices = {};
                state.extraColumns.forEach(col => { extraColIndices[col] = state.headers.indexOf(col); });

                state.allRows = state.rawData.map((row, idx) => {
                    const level = levelIdx >= 0 ? parseNum(row[levelIdx]) : 1;
                    const extraData = {};
                    state.extraColumns.forEach(col => { const colIdx = extraColIndices[col]; if (colIdx >= 0) extraData[col] = String(row[colIdx] || '').trim(); });
                    return { idx, raw: row, identifier: String(row[cols.ip] || '').trim(), level, clicks: parseNum(row[cols.clicks]), conv: parseNum(row[cols.conv]), rev: parseNum(row[cols.rev]), cost: parseNum(row[cols.cost]), profit: parseNum(row[cols.rev]) - parseNum(row[cols.cost]), extraData };
                });

                if (state.hasHierarchy) {
                    let maxLvl = 1; const levelSet = new Set();
                    for (let i = 0; i < state.allRows.length; i++) { const lvl = state.allRows[i].level; if (lvl > maxLvl) maxLvl = lvl; levelSet.add(lvl); }
                    state.maxLevel = maxLvl;
                    const levels = [...levelSet].sort((a, b) => a - b);
                    $('level-badges').innerHTML = levels.map(l => '<span class="level-badge level-' + Math.min(l, 3) + '">' + l + '</span>').join('');
                }

                state.customEnabled = $('custom-enabled').checked;
                $('custom-badge').classList.toggle('hidden', !state.customEnabled);
                processFullPipeline();
                saveSettings();
            } catch (err) {
                console.error('Error in processData:', err);
                $('global-stats').innerHTML = '<span class="text-red-500">âŒ ×©×’×™××”: ' + err.message + '</span>';
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // IMPROVED SCORING - graduated penalty instead of hard zero
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function calculateScore(r, medianPPC, medianCR, medianROI) {
            if (r.conv === 0) return 0;
            if (medianPPC <= 0 || medianCR <= 0) return 0;
            
            const roiMed = medianROI > 0 ? medianROI : 100;
            
            // Base quality components (same weights)
            const ppcComponent = 0.5 * (r.ppc / medianPPC);
            const roiComponent = 0.3 * (r.roi / roiMed);
            const crComponent = 0.2 * (r.cr / medianCR);
            const quality = ppcComponent + roiComponent + crComponent;
            
            // Reliability: scales with conv count (same as before)
            const reliability = Math.min(r.conv / 10, 1.0);
            
            // *** NEW: Graduated profit penalty instead of hard zero ***
            // Items with profit > 0 get full score
            // Items near break-even get partial score (not zero)
            // Items deeply negative get near-zero
            let profitFactor = 1.0;
            if (r.profit <= 0 && r.cost > 0) {
                // Ratio: how negative is profit relative to cost
                // -$0.01 profit on $100 cost â†’ factor ~0.99
                // -$50 profit on $100 cost â†’ factor ~0.0
                const lossRatio = Math.abs(r.profit) / r.cost;
                profitFactor = Math.max(0, 1 - lossRatio * 2); // Penalty: doubles the loss ratio
            } else if (r.profit <= 0 && r.cost === 0) {
                profitFactor = r.ppc > 0 ? 0.5 : 0; // No cost data but positive PPC = partial
            }
            
            // Wilson confidence boost: high-confidence CRs get a small bonus
            const wilson = wilsonScore(r.conv, r.clicks);
            const confidenceBonus = wilson.confidence === 'high' ? 1.05 : wilson.confidence === 'medium' ? 1.0 : 0.95;
            
            return Math.max(0, quality * reliability * profitFactor * confidenceBonus);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // BLACKLIST + CLASSIFICATION
        // BL Hard: 0 conv (enough clicks) OR conv>0 but rev=0
        // BL Soft: conv>0, rev>0, profit<0 (losing money)
        // Poor: enough clicks + below metric threshold (uses controls)
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function classifyRanges(data, medianPPC, medianCR, campaignAvgCR, campaignAvgPPC, totalCost, totalProfit, medianROI) {
            const purePct = +$('pure-pct-num').value || 10;
            const goldPct = +$('gold-pct-num').value || 25;
            const clickThreshold = state.clickThreshold;
            const medROI = medianROI || state.medianROI || 100;
            const blMode = state.blMode;
            const blMult = parseFloat($('bl-threshold-mult').value) || 0.5;

            // STEP 1: Calculate scores FIRST
            data = data.map(r => ({ ...r, score: calculateScore(r, medianPPC, medianCR, medROI) }));

            // STEP 2: Calculate metric threshold for Poor classification
            const profitableRows = data.filter(r => r.conv > 0 && r.profit > 0);
            
            const getBlMetric = (r) => {
                if (blMode === 'ppc') return r.ppc;
                if (blMode === 'cr') return r.cr;
                if (blMode === 'roi') return r.roi;
                return r.score;
            };
            
            let cleanThreshold = 0;
            
            if (profitableRows.length > 0) {
                const metricVals = profitableRows.map(r => getBlMetric(r)).sort((a, b) => a - b);
                const calcMedian = metricVals[Math.floor(metricVals.length / 2)];
                const calcMean = metricVals.reduce((s, v) => s + v, 0) / metricVals.length;
                
                if (state.blCalc === 'mean') {
                    cleanThreshold = calcMean;
                } else {
                    cleanThreshold = calcMedian;
                }
                console.log('[BL] blCalc=' + state.blCalc + ' blMode=' + blMode + ' median=' + calcMedian.toFixed(6) + ' mean=' + calcMean.toFixed(6) + ' â†’ threshold=' + cleanThreshold.toFixed(6) + ' Ã— ' + blMult + ' = ' + (cleanThreshold * blMult).toFixed(6) + ' (' + profitableRows.length + ' profitable rows)');
            }
            if (isNaN(cleanThreshold)) cleanThreshold = 0;
            
            state.blCleanThreshold = cleanThreshold;
            state.blJenksHard = 0;
            state.blJenksSoft = 0;

            const custConvMin = parseFloat($('cust-conv-min').value) || 0;
            const custConvMax = $('cust-conv-max').value !== '' ? parseFloat($('cust-conv-max').value) : Infinity;
            const custScoreMin = parseFloat($('cust-score-min').value) || 0;
            const custScoreMax = $('cust-score-max').value !== '' ? parseFloat($('cust-score-max').value) : Infinity;
            const custClicksMin = parseFloat($('cust-clicks-min').value) || 0;
            const custClicksMax = $('cust-clicks-max').value !== '' ? parseFloat($('cust-clicks-max').value) : Infinity;
            const custRoiMin = parseFloat($('cust-roi-min').value) || -9999;
            const custRoiMax = $('cust-roi-max').value !== '' ? parseFloat($('cust-roi-max').value) : Infinity;
            const custCrMin = parseFloat($('cust-cr-min').value) || 0;
            const custCrMax = $('cust-cr-max').value !== '' ? parseFloat($('cust-cr-max').value) : Infinity;
            const custPpcMin = parseFloat($('cust-ppc-min').value) || 0;
            const custPpcMax = $('cust-ppc-max').value !== '' ? parseFloat($('cust-ppc-max').value) : Infinity;

            // STEP 3: Pure/Gold/Potential thresholds from percentiles
            function percentileThreshold(pool, pct) {
                if (!pool.length) return Infinity;
                const idx = Math.max(0, Math.min(pool.length - 1, Math.ceil(pool.length * pct / 100) - 1));
                return pool[idx].score;
            }
            
            const purePool = data.filter(r => r.conv >= 3 && r.profit > 0).sort((a, b) => b.score - a.score);
            const goldPool = data.filter(r => r.conv >= 2 && r.profit > 0).sort((a, b) => b.score - a.score);
            const pureThreshold = percentileThreshold(purePool, purePct);
            const goldThreshold = percentileThreshold(goldPool, goldPct);
            
            const potentialPool = data.filter(r => r.conv >= 1 && r.profit > 0);
            let potentialMinROI = 100;
            let potentialMinScore = 0;
            if (potentialPool.length >= 10) {
                const sortedROI = potentialPool.map(r => r.roi).sort((a, b) => a - b);
                const sortedScores = potentialPool.map(r => r.score).sort((a, b) => a - b);
                potentialMinROI = Math.max(100, sortedROI[Math.floor(sortedROI.length * 0.25)]);
                potentialMinScore = sortedScores[Math.floor(sortedScores.length * 0.25)];
            }

            // STEP 4: Classify each zone
            return data.map(r => {
                let category, action, blSeverity = null;
                const hasEnoughClicks = r.clicks >= clickThreshold;
                
                // === BL RULES ===
                // Hard: enough clicks + (0 conv OR conv with $0 revenue)
                const isBLHard = hasEnoughClicks && (r.conv === 0 || (r.conv > 0 && r.rev <= 0));
                // Soft: has conv + has revenue + losing money
                const isBLSoft = !isBLHard && r.conv > 0 && r.rev > 0 && r.profit < 0;
                // Testing: 0 conv, not enough clicks
                const isTesting = r.conv === 0 && !hasEnoughClicks;
                
                // Poor: enough clicks + conv > 0 + below metric threshold Ã— multiplier
                let isPoor = false;
                if (hasEnoughClicks && r.conv > 0 && !isBLHard && !isBLSoft) {
                    const blVal = getBlMetric(r);
                    isPoor = blVal < (cleanThreshold * blMult);
                }

                const crPercent = r.cr * 100;
                const matchesCustom = state.customEnabled &&
                    r.conv >= custConvMin && r.conv <= custConvMax &&
                    r.score >= custScoreMin && r.score <= custScoreMax &&
                    r.clicks >= custClicksMin && r.clicks <= custClicksMax &&
                    r.roi >= custRoiMin && r.roi <= custRoiMax &&
                    crPercent >= custCrMin && crPercent <= custCrMax &&
                    r.ppc >= custPpcMin && r.ppc <= custPpcMax;

                const wilson = wilsonScore(r.conv, r.clicks);

                // === FINAL CLASSIFICATION ===
                // BL Hard â†’ BL Soft â†’ Testing â†’ Custom â†’ Pure â†’ Gold â†’ Potential â†’ Poor â†’ Watch
                if (isBLHard) { category = 'blacklist'; action = 'â›” Block'; blSeverity = 'hard'; }
                else if (isBLSoft) { category = 'blacklist-soft'; action = 'ğŸŸ  Review'; blSeverity = 'soft'; }
                else if (isTesting) { category = 'testing'; action = 'ğŸ”¬ Wait'; }
                else if (matchesCustom) { category = 'custom'; action = 'ğŸ¯ Custom'; }
                else if (r.conv >= 3 && r.profit > 0 && r.score >= pureThreshold) { category = 'pure'; action = 'ğŸ’ Scale'; }
                else if (r.conv >= 2 && r.profit > 0 && r.score >= goldThreshold) { category = 'gold'; action = 'ğŸ¥‡ Increase'; }
                else if (r.conv >= 1 && r.profit > 0 && r.roi >= potentialMinROI && r.score >= potentialMinScore) { category = 'potential'; action = 'ğŸŒ± Grow'; }
                else if (isPoor) { category = 'watch'; action = 'âš ï¸ Monitor'; }
                else { category = 'ignore'; action = 'ğŸ‘€ Watch'; }

                const blReason = isBLHard ? (r.conv === 0 ? 'zero_conv' : 'zero_revenue') : isBLSoft ? 'negative_profit' : isPoor ? 'below_threshold' : null;

                return { ...r, category, action, matchesCustom,
                    isBlacklist: isBLHard, isBlacklistSoft: isBLSoft, isWatch: category === 'watch',
                    isTesting, blSeverity, wilson, blReason };
            });
        }

        function assignVolumeTiers(data) {
            // Assign High/Mid/Low volume tier within each category based on clicks terciles
            const volCategories = ['pure', 'gold', 'potential', 'watch', 'ignore', 'blacklist', 'blacklist-soft', 'testing'];
            const groups = {};
            volCategories.forEach(cat => { groups[cat] = []; });
            data.forEach((r, i) => { if (groups[r.category]) groups[r.category].push(i); });
            
            Object.keys(groups).forEach(cat => {
                const indices = groups[cat];
                if (indices.length === 0) return;
                // Sort by clicks descending within category
                indices.sort((a, b) => data[b].clicks - data[a].clicks);
                const n = indices.length;
                const t1 = Math.ceil(n / 3);
                const t2 = Math.ceil(n * 2 / 3);
                indices.forEach((idx, rank) => {
                    if (rank < t1) data[idx].volumeTier = 'high';
                    else if (rank < t2) data[idx].volumeTier = 'mid';
                    else data[idx].volumeTier = 'low';
                    data[idx].volumeRank = rank + 1;
                    data[idx].volumeTotal = n;
                });
            });
            // Non-categorized
            data.forEach(r => { if (!r.volumeTier) r.volumeTier = 'mid'; });
            return data;
        }

        function processFullPipeline() {
            let filteredRows = state.allRows.filter(r => {
                for (const f of state.activeFilters) { if (f.values.length > 0) { const val = String(r.raw[f.colIdx] || ''); if (!f.values.includes(val)) return false; } }
                if (state.icloudFilter === 'hide' && isIcloudIP(r.identifier)) return false;
                if (state.icloudFilter === 'only' && !isIcloudIP(r.identifier)) return false;
                return true;
            });

            if (state.hasHierarchy) {
                state.detailRows = filteredRows.filter(r => r.level === state.maxLevel);
                state.summaryRows = filteredRows.filter(r => r.level < state.maxLevel);
            } else {
                state.detailRows = filteredRows.filter(r => r.identifier !== '');
                state.summaryRows = [];
            }
            state.detailRows = state.detailRows.filter(r => !isInvalidIdentifier(r.identifier));

            state.rawDetailRows = state.detailRows.map(r => ({
                ...r, identifier: r.identifier || 'Unknown',
                roi: r.cost > 0 ? (r.profit / r.cost) * 100 : (r.profit > 0 ? 999 : 0),
                cr: r.clicks > 0 ? r.conv / r.clicks : 0,
                ppc: r.clicks > 0 ? r.profit / r.clicks : 0,
                cpa: r.conv > 0 ? r.cost / r.conv : 0,
                ap: r.conv > 0 ? r.rev / r.conv : 0,
                cpc: r.clicks > 0 ? r.cost / r.clicks : 0
            }));
            
            const getAggKey = (r) => {
                let keyParts = [r.identifier || 'Unknown'];
                state.activeFilters.forEach(f => { if (f.values.length > 0) { keyParts.push(f.colIdx + ':' + String(r.raw[f.colIdx] || '').trim()); } });
                return keyParts.join('|');
            };
            
            const grouped = {};
            state.detailRows.forEach(r => {
                const key = getAggKey(r);
                if (!grouped[key]) {
                    grouped[key] = { identifier: r.identifier || 'Unknown', level: r.level, clicks: 0, conv: 0, rev: 0, cost: 0, profit: 0, isSummary: false, extraData: { ...r.extraData }, _extraSets: {}, _rowCount: 0 };
                    state.extraColumns.forEach(col => { grouped[key]._extraSets[col] = new Set(); if (r.extraData && r.extraData[col]) grouped[key]._extraSets[col].add(r.extraData[col]); });
                } else {
                    state.extraColumns.forEach(col => { if (r.extraData && r.extraData[col]) grouped[key]._extraSets[col].add(r.extraData[col]); });
                }
                const g = grouped[key];
                g.clicks += r.clicks; g.conv += r.conv; g.rev += r.rev; g.cost += r.cost; g.profit += r.profit; g._rowCount++;
            });
            
            state.aggregatedData = Object.values(grouped).map(g => {
                const finalExtraData = { ...g.extraData };
                state.extraColumns.forEach(col => { if (g._extraSets[col] && g._extraSets[col].size > 1) finalExtraData[col] = '××¢×•×¨×‘ (' + g._extraSets[col].size + ')'; });
                return { ...g, extraData: finalExtraData, roi: g.cost > 0 ? (g.profit / g.cost) * 100 : (g.profit > 0 ? 999 : 0), cr: g.clicks > 0 ? g.conv / g.clicks : 0, ppc: g.clicks > 0 ? g.profit / g.clicks : 0, cpc: g.clicks > 0 ? g.cost / g.clicks : 0, cpa: g.conv > 0 ? g.cost / g.conv : 0, ap: g.conv > 0 ? g.rev / g.conv : 0 };
            });

            const totalClicks = state.aggregatedData.reduce((s, r) => s + r.clicks, 0);
            const totalConv = state.aggregatedData.reduce((s, r) => s + r.conv, 0);
            const totalRev = state.aggregatedData.reduce((s, r) => s + r.rev, 0);
            const totalProfit = state.aggregatedData.reduce((s, r) => s + r.profit, 0);
            const totalCost = state.aggregatedData.reduce((s, r) => s + r.cost, 0);
            const campaignAvgCR = totalClicks > 0 ? totalConv / totalClicks : 0;
            const campaignAvgPPC = totalClicks > 0 ? totalProfit / totalClicks : 0;

            const profitable = state.aggregatedData.filter(r => r.conv > 0 && r.ppc > 0);
            let medianPPC = 0.001, medianCR = 0.001, medianROI = 100;
            if (profitable.length > 0) {
                const ppcs = profitable.map(r => r.ppc).sort((a, b) => a - b);
                const crs = profitable.map(r => r.cr).sort((a, b) => a - b);
                const rois = profitable.filter(r => r.cost > 0 && r.roi > 0).map(r => Math.min(r.roi, 300)).sort((a, b) => a - b);
                medianPPC = ppcs[Math.floor(ppcs.length / 2)];
                medianCR = crs[Math.floor(crs.length / 2)];
                medianROI = rois.length > 0 ? rois[Math.floor(rois.length / 2)] : 100;
            }
            
            state.medianPPC = medianPPC; state.medianCR = medianCR; state.medianROI = medianROI;
            state.campaignCR = campaignAvgCR; state.campaignAvgPPC = campaignAvgPPC;
            $('med-ppc').textContent = '$' + state.medianPPC.toFixed(4);
            $('med-cr').textContent = (state.medianCR * 100).toFixed(3) + '%';
            calculateClickThreshold();
            
            // Auto-calculate campaign AP (payout) if not manually set
            const campaignAP = totalConv > 0 ? totalRev / totalConv : 0;
            state.campaignAP = campaignAP;
            if (campaignAP > 0 && (parseFloat($('avg-payout').value) === 0 || !$('avg-payout').dataset.manual)) {
                $('avg-payout').value = campaignAP.toFixed(2);
                $('payout-info').textContent = 'AP ×××•×¦×¢: $' + campaignAP.toFixed(2) + ' (Rev $' + totalRev.toFixed(0) + ' / ' + totalConv + ' conv)';
            }

            let processed = classifyRanges(state.aggregatedData, medianPPC, medianCR, campaignAvgCR, campaignAvgPPC, totalCost, totalProfit, medianROI);
            processed = detectAnomalies(processed, campaignAvgCR);
            processed = assignVolumeTiers(processed);
            
            // AUTO TIERS: auto-detect optimal Pure%/Gold% thresholds, then re-classify
            // Skip if user has manually set Pure/Gold values
            state.processed = processed;
            if (!state.manualTiers && autoDetectThresholds(true)) {
                processed = classifyRanges(state.aggregatedData, medianPPC, medianCR, campaignAvgCR, campaignAvgPPC, totalCost, totalProfit, medianROI);
                processed = detectAnomalies(processed, campaignAvgCR);
                processed = assignVolumeTiers(processed);
            }
            
            // Break-even per zone (if campaign payout is set)
            const campaignPayout = parseFloat($('avg-payout') ? $('avg-payout').value : 0) || 0;
            if (campaignPayout > 0) {
                processed = processed.map(r => {
                    if (r.isSummary || r.clicks === 0) return { ...r, breakEven: null };
                    const cpc = r.cost / r.clicks;
                    const expectedPerClick = r.cr * campaignPayout;
                    const netPerClick = expectedPerClick - cpc;
                    let beClicks = null;
                    let beStatus = 'neutral';
                    if (r.conv === 0) {
                        // No conversions yet - calculate how many clicks to first expected conversion
                        beClicks = campaignPayout > 0 ? Math.ceil(r.cost / (campaignPayout * (campaignAvgCR || 0.001))) : null;
                        beStatus = 'unknown';
                    } else if (netPerClick > 0.0001) {
                        // Zone earns per click - it's sustainable
                        if (r.profit < 0) {
                            beClicks = Math.ceil(Math.abs(r.profit) / netPerClick);
                            beStatus = 'recovering';
                        } else {
                            beClicks = 0;
                            beStatus = 'safe';
                        }
                    } else if (netPerClick < -0.0001) {
                        // Zone loses per click
                        if (r.profit > 0) {
                            beClicks = Math.ceil(r.profit / Math.abs(netPerClick));
                            beStatus = 'declining';
                        } else {
                            beClicks = -1;
                            beStatus = 'sinking';
                        }
                    } else {
                        beStatus = r.profit >= 0 ? 'safe' : 'sinking';
                    }
                    return { ...r, breakEven: { clicks: beClicks, status: beStatus, netPerClick: netPerClick, cpc: cpc, expectedPerClick: expectedPerClick } };
                });
            }
            state.processed = processed;
            state.processedRaw = null;
            
            // Update BL threshold display â€” show both values for transparency
            const blMult = parseFloat($('bl-threshold-mult').value) || 0.5;
            const blCalcLabel = state.blCalc === 'mean' ? '×××•×¦×¢' : '××—×¦×™×•×Ÿ';
            const blDisplay = $('bl-current-threshold-display');
            const blCalcLabelEl = $('bl-calc-label');
            if (blCalcLabelEl) blCalcLabelEl.textContent = blCalcLabel;
            
            const blModeLabel = state.blMode === 'ppc' ? 'PPC' : state.blMode === 'cr' ? 'CR' : state.blMode === 'roi' ? 'ROI' : 'Score';
            const fmtBlVal = (v) => {
                if (isNaN(v) || v === undefined || v === null) return '0';
                if (state.blMode === 'ppc') return '$' + v.toFixed(6);
                if (state.blMode === 'cr') return (v * 100).toFixed(4) + '%';
                if (state.blMode === 'roi') return v.toFixed(1) + '%';
                return v.toFixed(5);
            };
            
            // Calculate BOTH median and mean for display
            const profRows = processed.filter(r => r.conv > 0 && r.profit > 0 && !r.isSummary);
            const getMetric = (r) => {
                if (state.blMode === 'ppc') return r.ppc;
                if (state.blMode === 'cr') return r.cr;
                if (state.blMode === 'roi') return r.roi;
                return r.score;
            };
            let dispMedian = 0, dispMean = 0;
            if (profRows.length > 0) {
                const vals = profRows.map(r => getMetric(r)).sort((a, b) => a - b);
                dispMedian = vals[Math.floor(vals.length / 2)];
                dispMean = vals.reduce((s, v) => s + v, 0) / vals.length;
            }
            
            const hardCount = processed.filter(r => r.isBlacklist).length;
            const softCount = processed.filter(r => r.isBlacklistSoft).length;
            const poorCount = processed.filter(r => r.isWatch).length;
            console.log('[BL Display] blCalc=' + state.blCalc + ' threshold=' + (state.blCleanThreshold).toFixed(6) + ' Ã—' + blMult + '=' + (state.blCleanThreshold * blMult).toFixed(6) + ' | Hard=' + hardCount + ' Soft=' + softCount + ' Poor=' + poorCount);
            
            if (blDisplay) {
                const activeVal = state.blCalc === 'mean' ? dispMean : dispMedian;
                blDisplay.innerHTML = '<div>' + blModeLabel + ' Poor ×¡×£: <strong>' + fmtBlVal(activeVal * blMult) + '</strong> (' + blCalcLabel + ' Ã— ' + blMult + ')</div>' +
                    '<div class="text-[9px] text-slate-500 mt-0.5">××—×¦×™×•×Ÿ: ' + fmtBlVal(dispMedian) + ' | ×××•×¦×¢: ' + fmtBlVal(dispMean) + ' | ' + profRows.length + ' zones ×¨×•×•×—×™×™×</div>' +
                    '<div class="mt-1">â›”' + hardCount + ' ğŸŸ ' + softCount + ' âš ï¸' + poorCount + '</div>';
            }

            applyViewFilter();
            renderKPIs();
            renderTable();
            renderGlobalStats();
            updateActionSummary();
            updateSavingsBanner();
            updateMiniDashboard();
            enableButtons();
            updateMacroWarning();
        }
        
        function applyViewFilter() {
            const view = $('filter-view').value;
            const levelView = $('level-view').value;
            const minScore = parseFloat($('min-score-filter').value) || 0;
            
            if (state.aggMode === 'split' && !state.processedRaw && state.rawDetailRows.length > 0) {
                const rawClicks = state.rawDetailRows.reduce((s, r) => s + r.clicks, 0);
                const rawConv = state.rawDetailRows.reduce((s, r) => s + r.conv, 0);
                const rawCost = state.rawDetailRows.reduce((s, r) => s + r.cost, 0);
                const rawProfit = state.rawDetailRows.reduce((s, r) => s + r.profit, 0);
                const rawCampaignAvgCR = rawClicks > 0 ? (rawConv / rawClicks) : 0;
                const rawCampaignAvgPPC = rawClicks > 0 ? (rawProfit / rawClicks) : 0;
                let processedRaw = classifyRanges(state.rawDetailRows, state.medianPPC, state.medianCR, rawCampaignAvgCR, rawCampaignAvgPPC, rawCost, rawProfit, state.medianROI);
                processedRaw = detectAnomalies(processedRaw, rawCampaignAvgCR);
                processedRaw = assignVolumeTiers(processedRaw);
                state.processedRaw = processedRaw;
            }
            
            const sourceData = state.aggMode === 'split' ? state.processedRaw : state.processed;
            let finalData = [...(sourceData || [])];

            if (levelView === 'all' && state.hasHierarchy) {
                const summaries = state.summaryRows.map(r => ({
                    ...r, identifier: r.identifier || buildIdentifier(r),
                    roi: r.cost > 0 ? (r.profit / r.cost) * 100 : 0, cr: r.clicks > 0 ? r.conv / r.clicks : 0,
                    ppc: r.clicks > 0 ? r.profit / r.clicks : 0, cpc: r.clicks > 0 ? r.cost / r.clicks : 0, cpa: r.conv > 0 ? r.cost / r.conv : 0, ap: r.conv > 0 ? r.rev / r.conv : 0,
                    score: 0, category: 'summary', action: '-', isSummary: true
                }));
                finalData = [...summaries, ...finalData];
            }

            if (view === 'winners') finalData = finalData.filter(r => ['pure', 'gold'].includes(r.category));
            else if (view === 'relevant') finalData = finalData.filter(r => ['pure', 'gold', 'potential'].includes(r.category));
            else if (view === 'relevant_plus') finalData = finalData.filter(r => ['pure', 'gold', 'potential', 'testing'].includes(r.category));
            else if (view === 'custom') finalData = finalData.filter(r => r.matchesCustom);
            else if (view === 'blacklist') finalData = finalData.filter(r => r.category === 'blacklist');
            else if (view === 'blacklist-soft') finalData = finalData.filter(r => r.category === 'blacklist-soft');
            else if (view === 'watch') finalData = finalData.filter(r => r.category === 'watch');
            else if (view === 'all-bl') finalData = finalData.filter(r => ['blacklist', 'blacklist-soft', 'watch'].includes(r.category));
            else if (view === 'anomaly') finalData = finalData.filter(r => r.anomalies && r.anomalies.length > 0);
            else if (view !== 'all') finalData = finalData.filter(r => r.category === view);
            
            if (minScore > 0) finalData = finalData.filter(r => r.score >= minScore || r.isSummary);
            if (state.icloudFilter === 'hide') finalData = finalData.filter(r => !isIcloudIP(r.identifier));
            else if (state.icloudFilter === 'only') finalData = finalData.filter(r => isIcloudIP(r.identifier));
            if (state.searchQuery) finalData = finalData.filter(r => r.identifier.toLowerCase().includes(state.searchQuery));
            
            // Volume filter
            const volFilter = $('filter-volume') ? $('filter-volume').value : 'all';
            if (volFilter === 'high') finalData = finalData.filter(r => r.volumeTier === 'high' || r.isSummary);
            else if (volFilter === 'mid') finalData = finalData.filter(r => r.volumeTier === 'mid' || r.isSummary);
            else if (volFilter === 'low') finalData = finalData.filter(r => r.volumeTier === 'low' || r.isSummary);
            else if (volFilter === 'high-mid') finalData = finalData.filter(r => r.volumeTier === 'high' || r.volumeTier === 'mid' || r.isSummary);
            else if (volFilter === 'low-mid') finalData = finalData.filter(r => r.volumeTier === 'low' || r.volumeTier === 'mid' || r.isSummary);
            
            state.filtered = finalData.sort((a, b) => {
                if (a.isSummary && !b.isSummary) return -1;
                if (!a.isSummary && b.isSummary) return 1;
                if (a.isSummary && b.isSummary) return a.level - b.level;
                if (state.sortColumn) {
                    let valA, valB;
                    switch (state.sortColumn) {
                        case 'identifier': valA = a.identifier; valB = b.identifier; break;
                        case 'category': valA = a.category; valB = b.category; break;
                        case 'volumeTier': { const vo = {high:3,mid:2,low:1}; valA = vo[a.volumeTier]||2; valB = vo[b.volumeTier]||2; break; }
                        case 'score': valA = a.score; valB = b.score; break;
                        case 'clicks': valA = a.clicks; valB = b.clicks; break;
                        case 'conv': valA = a.conv; valB = b.conv; break;
                        case 'revenue': valA = a.rev; valB = b.rev; break;
                        case 'cost': valA = a.cost; valB = b.cost; break;
                        case 'profit': valA = a.profit; valB = b.profit; break;
                        case 'roi': valA = a.roi; valB = b.roi; break;
                        case 'cr': valA = a.cr; valB = b.cr; break;
                        case 'ppc': valA = a.ppc; valB = b.ppc; break;
                        case 'cpc': valA = a.cpc || 0; valB = b.cpc || 0; break;
                        case 'cpa': valA = a.cpa || 0; valB = b.cpa || 0; break;
                        case 'ap': valA = a.ap || 0; valB = b.ap || 0; break;
                        default: valA = a.score; valB = b.score;
                    }
                    if (typeof valA === 'string') { const cmp = valA.localeCompare(valB); return state.sortDirection === 'asc' ? cmp : -cmp; }
                    return state.sortDirection === 'asc' ? valA - valB : valB - valA;
                }
                return b.score - a.score;
            });
            state.page = 1;
        }
        
        function applyFilter() {
            applyViewFilter(); renderKPIs(); renderTable(); renderGlobalStats(); updateMiniDashboard(); updateMacroWarning();
        }
        
        function updateMacroWarning() {
            const warningEl = $('macro-warning'); if (!warningEl) return;
            const microCount = state.rawDetailRows ? state.rawDetailRows.length : 0;
            const macroCount = state.processed ? state.processed.length : 0;
            const microCountEl = $('micro-count'); const macroCountEl = $('macro-count');
            if (microCountEl) microCountEl.textContent = microCount.toLocaleString();
            if (macroCountEl) macroCountEl.textContent = macroCount.toLocaleString();
            warningEl.classList.toggle('hidden', state.aggMode !== 'smart');
        }
        
        function sortByColumn(column) {
            if (state.sortColumn === column) state.sortDirection = state.sortDirection === 'desc' ? 'asc' : 'desc';
            else { state.sortColumn = column; state.sortDirection = 'desc'; }
            applyFilter();
        }
        
        function updateSortIndicators() {
            document.querySelectorAll('th[data-sort]').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sort === state.sortColumn) th.classList.add(state.sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
            });
        }

        function buildIdentifier(row) {
            const parts = [];
            const skip = ['level', 'clicks', 'conversions', 'revenue', 'cost', 'profit', 'roi', 'cr'];
            for (let i = 0; i < state.headers.length; i++) {
                const h = state.headers[i].toLowerCase();
                if (skip.some(s => h.includes(s))) continue;
                const val = row.raw[i]; if (val && String(val).trim() !== '') parts.push(String(val).trim());
            }
            return parts.join(' | ') || 'Unknown';
        }

        $('filter-view').addEventListener('change', () => { applyFilter(); });
        $('level-view').addEventListener('change', () => { applyFilter(); });
        $('min-score-filter').addEventListener('input', () => { applyFilter(); });
        
        document.querySelectorAll('.icloud-switcher .switcher-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.icloud-switcher .switcher-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active'); state.icloudFilter = btn.dataset.value; saveSettings(); applyFilter();
            });
        });
        
        document.querySelectorAll('.agg-switcher .switcher-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                const newMode = btn.dataset.agg; if (state.aggMode === newMode) return;
                document.querySelectorAll('.agg-switcher .switcher-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active'); state.aggMode = newMode; updateMacroWarning();
                if (newMode === 'smart') state.processedRaw = null;
                saveSettings(); applyFilter();
            });
        });
        
        $('ip-level').addEventListener('change', () => { state.manualTiers = false; processData(); });
        $('identifier-type').addEventListener('change', () => { 
            state.identifierType = $('identifier-type').value;
            if (state.identifierType !== 'auto') {
                if (state.identifierType === 'subid') $('ip-level').value = '1';
                else if (state.identifierType === 'zone') $('ip-level').value = '2';
                else if (state.identifierType === 'ip') $('ip-level').value = '1';
            }
            processData(); 
        });
        $('col-ip').addEventListener('change', () => { state.manualTiers = false; detectAndUpdateIdentifierType(); processData(); });
        $('custom-enabled').addEventListener('change', () => { processData(); });
        $('avg-payout').addEventListener('input', () => { $('avg-payout').dataset.manual = '1'; saveSettings(); processData(); });
        
        function autoCalcPayout() {
            $('avg-payout').dataset.manual = '';
            if (state.campaignAP > 0) {
                $('avg-payout').value = state.campaignAP.toFixed(2);
                $('payout-info').textContent = 'AP ×××•×¦×¢: $' + state.campaignAP.toFixed(2) + ' (××•×˜×•××˜×™)';
                showToast('Payout = Campaign AP: $' + state.campaignAP.toFixed(2), 'success');
            }
            processData();
        }

        function setBlMode(mode) {
            console.log('[BL] setBlMode: ' + state.blMode + ' â†’ ' + mode);
            state.blMode = mode;
            document.querySelectorAll('.bl-mode-btn[data-blmode]').forEach(btn => btn.classList.toggle('active', btn.dataset.blmode === mode));
            state.processedRaw = null;
            processFullPipeline();
            saveSettings();
            showToast('BL ××¦×‘: ' + mode.toUpperCase(), 'info', 1500);
        }
        
        function setBlCalc(calc) {
            // Only median and mean supported now
            if (calc === 'jenks') calc = 'median';
            console.log('[BL] setBlCalc: ' + state.blCalc + ' â†’ ' + calc);
            state.blCalc = calc;
            document.querySelectorAll('.bl-mode-btn[data-blcalc]').forEach(btn => btn.classList.toggle('active', btn.dataset.blcalc === calc));
            state.processedRaw = null;
            processFullPipeline();
            saveSettings();
            showToast('BL ×—×™×©×•×‘: ' + (calc === 'mean' ? '×××•×¦×¢' : '××—×¦×™×•×Ÿ'), 'info', 1500);
        }

        function renderKPIs() {
            const sourceData = state.aggMode === 'split' ? (state.processedRaw || []) : (state.processed || []);
            
            const categories = [
                { key: 'pure', name: 'PURE', icon: 'ğŸ’', cls: 'kpi-pure', lblCls: 'text-blue-700', tip: 'Top performers â€” â‰¥3 conv, profitable, highest score. Scale aggressively.', tipHe: 'ğŸ’ ×”×˜×•×¤! â‰¥3 ×”××¨×•×ª, ×¨×•×•×—×™×™×, ×¡×§×•×¨ ×’×‘×•×”. ×”×’×“×œ ×ª×§×¦×™×‘ ×‘×¦×•×¨×” ××’×¨×¡×™×‘×™×ª' },
                { key: 'gold', name: 'GOLD', icon: 'ğŸ¥‡', cls: 'kpi-gold', lblCls: 'text-amber-600', tip: 'Strong performers â€” â‰¥2 conv, profitable, high score. Increase bids.', tipHe: 'ğŸ¥‡ ×—×–×§×™×! â‰¥2 ×”××¨×•×ª, ×¨×•×•×—×™×™×. ×”×¢×œ×” ×”×¦×¢×•×ª ××—×™×¨' },
                { key: 'potential', name: 'POTENTIAL', icon: 'ğŸŒ±', cls: 'kpi-potential', lblCls: 'text-emerald-600', tip: 'Promising zones â€” profitable with good ROI & score. Room to grow.', tipHe: 'ğŸŒ± ××‘×˜×™×—×™× - ×¨×•×•×—×™×™× ×¢× ROI ×˜×•×‘. ×™×© ××§×•× ×œ×¦××•×—' },
                { key: 'ignore', name: 'WATCH', icon: 'ğŸ‘€', cls: 'kpi-ignore', lblCls: 'text-slate-500', tip: 'Profitable but below quality gates. Keep running, monitor performance.', tipHe: 'ğŸ‘€ ×¨×•×•×—×™×™× ××‘×œ ××ª×—×ª ×œ×©×¢×¨×™ ××™×›×•×ª. ×”××©×š ×œ×”×¨×™×¥, ×¢×§×•×‘' },
                { key: 'testing', name: state.customEnabled ? 'CUSTOM' : 'TESTING', icon: state.customEnabled ? 'ğŸ¯' : 'ğŸ”¬', cls: 'kpi-testing', lblCls: 'text-blue-600', tip: '0 conversions, not enough clicks to judge. Still collecting data.', tipHe: 'ğŸ”¬ 0 ×”××¨×•×ª, ×œ× ××¡×¤×™×§ ×§×œ×™×§×™× ×œ×©×¤×•×˜. ×¢×“×™×™×Ÿ ××•×¡×¤×™× × ×ª×•× ×™×' },
                { key: 'watch', name: 'POOR', icon: 'âš ï¸', cls: 'kpi-poor', lblCls: 'text-orange-600', tip: 'Has conversions & profit > 0 but doesn\'t meet Potential thresholds. Consider reducing bids.', tipHe: 'âš ï¸ ×™×© ×”××¨×•×ª ×•×¨×•×•×— ××‘×œ ××ª×—×ª ×œ×¡×£. ×©×§×•×œ ×”×•×¨×“×ª ×”×¦×¢×•×ª' },
                { key: 'blacklist-soft', name: 'BL SOFT', icon: 'ğŸŸ ', cls: 'kpi-bl-soft', lblCls: 'text-red-500', tip: 'Has conversions + revenue but losing money (profit < 0). Review & consider blocking.', tipHe: 'ğŸŸ  ×™×© ×”××¨×•×ª ×•×”×›× ×¡×” ××‘×œ ××¤×¡×™×“×™× ×›×¡×£. ×‘×“×•×§ ××§×¨×•×‘' },
                { key: 'blacklist', name: 'BL HARD', icon: 'â›”', cls: 'kpi-blacklist', lblCls: 'text-red-700', tip: 'Zero conversions (enough clicks) or conversions with $0 revenue. Block immediately.', tipHe: 'â›” ××¤×¡ ×”××¨×•×ª ××• ×”×›× ×¡×” 0 - ×—×¡×•× ××™×“!' }
            ];
            let html = '';
            categories.forEach(cat => {
                let rows;
                if (cat.key === 'testing' && state.customEnabled) rows = sourceData.filter(r => r.matchesCustom);
                else rows = sourceData.filter(r => r.category === cat.key);

                const s = { count: rows.length, clicks: rows.reduce((sum, r) => sum + r.clicks, 0), conv: rows.reduce((sum, r) => sum + r.conv, 0), rev: rows.reduce((sum, r) => sum + r.rev, 0), cost: rows.reduce((sum, r) => sum + r.cost, 0), profit: rows.reduce((sum, r) => sum + r.profit, 0) };
                s.roi = s.cost > 0 ? (s.profit / s.cost * 100) : (s.profit > 0 ? 999 : 0);
                s.cr = s.clicks > 0 ? (s.conv / s.clicks * 100) : 0;
                s.ppc = s.clicks > 0 ? (s.profit / s.clicks) : 0;
                const isCustomActive = cat.key === 'testing' && state.customEnabled;
                const profitCls = s.profit >= 0 ? 'text-green-600' : 'text-red-500';
                const roiCls = s.roi >= 0 ? 'text-green-600' : 'text-red-500';
                const ppcDisplay = s.ppc < 0 ? formatNum(Math.abs(s.ppc)) + '-$' : '$' + s.ppc.toFixed(4);

                html += '<div class="kpi-card ' + cat.cls + (isCustomActive ? ' kpi-custom-active' : '') + '" onclick="$(\'filter-view\').value=\'' + cat.key + '\'; applyFilter();">' +
                    // Header: count + label
                    '<div class="kpi-card-header">' +
                        '<span class="kpi-card-count">' + s.count.toLocaleString() + '</span>' +
                        '<span class="kpi-card-label ' + cat.lblCls + ' kpi-label-hover" data-tiphe="' + cat.tipHe + '">' + cat.name + ' ' + cat.icon + '</span>' +
                    '</div>' +
                    // Top row: PPC + Clicks in bordered boxes
                    '<div class="kpi-top-row">' +
                        '<div class="kpi-top-cell"><div class="kpi-top-lbl">PPC</div><div class="kpi-top-val text-amber-600">' + ppcDisplay + '</div></div>' +
                        '<div class="kpi-top-cell"><div class="kpi-top-lbl">Clicks</div><div class="kpi-top-val">' + formatNum(s.clicks) + '</div></div>' +
                    '</div>' +
                    // Mid row: Cost / Revenue / Conv
                    '<div class="kpi-mid-row">' +
                        '<div class="kpi-mid-cell"><div class="kpi-mid-lbl">Cost</div><div class="kpi-mid-val">$' + formatNum(s.cost) + '</div></div>' +
                        '<div class="kpi-mid-cell"><div class="kpi-mid-lbl">Revenue</div><div class="kpi-mid-val text-green-600">$' + formatNum(s.rev) + '</div></div>' +
                        '<div class="kpi-mid-cell"><div class="kpi-mid-lbl">Conv</div><div class="kpi-mid-val">' + s.conv.toLocaleString() + '</div></div>' +
                    '</div>' +
                    // Bottom row: CR / ROI / Profit
                    '<div class="kpi-bot-row">' +
                        '<div class="kpi-bot-cell"><div class="kpi-bot-lbl">CR</div><div class="kpi-bot-val text-blue-600">' + s.cr.toFixed(3) + '%</div></div>' +
                        '<div class="kpi-bot-cell"><div class="kpi-bot-lbl">ROI</div><div class="kpi-bot-val ' + roiCls + '">' + s.roi.toFixed(0) + '%</div></div>' +
                        '<div class="kpi-bot-cell"><div class="kpi-bot-lbl">Profit</div><div class="kpi-bot-val ' + profitCls + '">$' + formatNum(s.profit) + '</div></div>' +
                    '</div>' +
                '</div>';
            });
            $('kpi-container').innerHTML = html;
        }

        function formatNum(n) {
            if (Math.abs(n) >= 1e6) return (n / 1e6).toFixed(1) + 'M';
            if (Math.abs(n) >= 1e3) return (n / 1e3).toFixed(1) + 'K';
            return n.toFixed(0);
        }

        function renderGlobalStats() {
            const data = state.aggMode === 'split' ? (state.processedRaw || []) : (state.processed || []);
            const clicks = data.reduce((s, r) => s + r.clicks, 0);
            const conv = data.reduce((s, r) => s + r.conv, 0);
            const rev = data.reduce((s, r) => s + r.rev, 0);
            const cost = data.reduce((s, r) => s + r.cost, 0);
            const profit = data.reduce((s, r) => s + r.profit, 0);
            const roi = cost > 0 ? (profit / cost * 100) : 0;
            const cr = clicks > 0 ? (conv / clicks * 100) : 0;
            const ppc = clicks > 0 ? (profit / clicks) : 0;
            const anomalyCount = data.filter(r => r.anomalies && r.anomalies.length > 0).length;
            const pill = (l, v, c) => '<div class="g-item"><span class="g-lbl">' + l + '</span><span class="g-val ' + c + '">' + v + '</span></div>';
            const ap = conv > 0 ? (rev / conv) : 0;
            const cpc = clicks > 0 ? (cost / clicks) : 0;
            const cpa = conv > 0 ? (cost / conv) : 0;
            $('global-stats').innerHTML = pill('××–×”×™×', data.length.toLocaleString(), '') + pill('Clicks', formatNum(clicks), 'text-blue-600') + pill('Conv', conv.toLocaleString(), '') + pill('Revenue', '$' + formatNum(rev), 'text-green-600') + pill('Cost', '$' + formatNum(cost), 'text-slate-500') + pill('Profit', '$' + formatNum(profit), profit >= 0 ? 'text-green-600' : 'text-red-500') + pill('ROI', roi.toFixed(0) + '%', roi >= 0 ? 'text-green-600' : 'text-red-500') + pill('CR', cr.toFixed(3) + '%', 'text-blue-600') + pill('PPC', '$' + ppc.toFixed(4), 'text-amber-600') + pill('CPC', '$' + cpc.toFixed(4), 'text-slate-600') + pill('CPA', '$' + cpa.toFixed(2), 'text-orange-600') + pill('AP', '$' + ap.toFixed(2), 'text-green-700') + (anomalyCount > 0 ? pill('ğŸš¨', anomalyCount.toString(), 'text-red-500') : '');
        }

        function renderTable() {
            const start = (state.page - 1) * state.pageSize;
            const pageData = state.filtered.slice(start, start + state.pageSize);
            const showLevel = state.hasHierarchy;
            const showExtraCols = state.extraColumns && state.extraColumns.length > 0;
            
            // Dynamic extra column headers
            document.querySelectorAll('.extra-col-th').forEach(el => el.remove());
            if (showExtraCols) {
                const refTh = document.querySelector('th[data-sort="category"]');
                if (refTh) {
                    state.extraColumns.slice().reverse().forEach(col => {
                        const th = document.createElement('th');
                        th.className = 'text-center extra-col-th';
                        th.style.fontSize = '11px';
                        th.textContent = col;
                        refTh.parentNode.insertBefore(th, refTh);
                    });
                }
            }
            
            const totals = { clicks: 0, conv: 0, rev: 0, cost: 0, profit: 0 };
            state.filtered.forEach(r => { if (!r.isSummary) { totals.clicks += r.clicks; totals.conv += r.conv; totals.rev += r.rev; totals.cost += r.cost; totals.profit += r.profit; } });
            totals.roi = totals.cost > 0 ? (totals.profit / totals.cost * 100) : 0;
            totals.cr = totals.clicks > 0 ? (totals.conv / totals.clicks * 100) : 0;
            totals.ppc = totals.clicks > 0 ? (totals.profit / totals.clicks) : 0;
            const extraColsPlaceholders = state.extraColumns.map(() => '<th class="summary-cell"></th>').join('');
            
            $('table-summary-row').innerHTML = '<th class="summary-cell text-center" style="color:#64748b;">-</th>' +
                (showLevel ? '<th class="summary-cell"></th>' : '') +
                '<th class="summary-cell text-right" style="font-weight:900;color:#374151;">×¡×”"×› ' + state.filtered.length + ' ×–×•× ×™×</th>' +
                extraColsPlaceholders +
                '<th class="summary-cell"></th><th class="summary-cell"></th><th class="summary-cell"></th>' +
                '<th class="summary-cell text-center" style="color:#1e293b;">' + totals.clicks.toLocaleString() + '</th>' +
                '<th class="summary-cell text-center" style="color:#1e293b;">' + totals.conv.toLocaleString() + '</th>' +
                '<th class="summary-cell text-center" style="color:#16a34a;">$' + formatNum(totals.rev) + '</th>' +
                '<th class="summary-cell text-center" style="color:#64748b;">$' + formatNum(totals.cost) + '</th>' +
                '<th class="summary-cell text-center" style="color:' + (totals.profit >= 0 ? '#16a34a' : '#dc2626') + ';">$' + formatNum(totals.profit) + '</th>' +
                '<th class="summary-cell text-center" style="color:' + (totals.roi >= 0 ? '#16a34a' : '#dc2626') + ';">' + totals.roi.toFixed(0) + '%</th>' +
                '<th class="summary-cell text-center" style="color:#2563eb;">' + totals.cr.toFixed(3) + '%</th>' +
                '<th class="summary-cell text-center" style="color:#d97706;">$' + totals.ppc.toFixed(4) + '</th>' +
                '<th class="summary-cell text-center" style="color:#64748b;">$' + (totals.clicks > 0 ? (totals.cost / totals.clicks).toFixed(4) : '0') + '</th>' +
                '<th class="summary-cell text-center" style="color:#ea580c;">' + (totals.conv > 0 ? '$' + (totals.cost / totals.conv).toFixed(2) : '-') + '</th>' +
                '<th class="summary-cell text-center" style="color:#7c3aed;">' + (totals.conv > 0 ? '$' + (totals.rev / totals.conv).toFixed(2) : '-') + '</th>';

            const catConfig = {
                pure: { badge: 'badge-pure', row: 'row-pure', label: 'ğŸ’ PURE' },
                gold: { badge: 'badge-gold', row: 'row-gold', label: 'ğŸ¥‡ GOLD' },
                potential: { badge: 'badge-potential', row: 'row-potential', label: 'ğŸŒ± POTENTIAL' },
                ignore: { badge: 'badge-ignore', row: 'row-ignore', label: 'ğŸ‘€ WATCH' },
                blacklist: { badge: 'badge-blacklist', row: 'row-blacklist', label: 'â›” BL HARD' },
                'blacklist-soft': { badge: 'badge-blacklist-soft', row: 'row-blacklist-soft', label: 'ğŸŸ  BL SOFT' },
                watch: { badge: 'badge-watch', row: 'row-watch', label: 'âš ï¸ POOR' },
                testing: { badge: 'badge-testing', row: 'row-testing', label: 'ğŸ”¬ TESTING' },
                custom: { badge: 'badge-custom', row: 'row-custom', label: 'ğŸ¯ CUSTOM' },
                summary: { badge: 'badge-summary', row: 'row-summary', label: 'ğŸ“Š SUMMARY' }
            };

            let html = '';
            pageData.forEach((r, i) => {
                const cfg = catConfig[r.category] || catConfig.ignore;
                const safeScore = r.score || 0;
                const scoreCls = safeScore > 5 ? 'score-high' : safeScore > 1 ? 'score-mid' : 'score-low';
                const levelCls = r.level === 1 ? 'level-1' : r.level === 2 ? 'level-2' : 'level-3';
                const displayId = highlightSafe(r.identifier, state.searchQuery);
                const icloudBadge = isIcloudIP(r.identifier) ? '<span class="icloud-badge" title="iCloud Private Relay">â˜ï¸</span>' : '';
                
                // Anomaly flags
                let anomalyHtml = '';
                if (r.anomalies && r.anomalies.length > 0) {
                    r.anomalies.forEach(a => {
                        const cls = a.type === 'fraud' ? 'anomaly-fraud' : a.type === 'bot' ? 'anomaly-bot' : 'anomaly-outlier';
                        anomalyHtml += '<span class="anomaly-flag ' + cls + '" title="' + escapeHtml(a.reason) + '">' + a.label + '</span>';
                    });
                }
                
                // Wilson CI display on CR - visual bar
                let crDisplay = (r.cr * 100).toFixed(3) + '%';
                if (r.wilson && r.conv > 0) {
                    const ciCls = r.wilson.confidence === 'high' ? 'ci-bar-high' : r.wilson.confidence === 'medium' ? 'ci-bar-med' : 'ci-bar-low';
                    const ciLabel = r.wilson.confidence === 'high' ? 'âœ“' : r.wilson.confidence === 'medium' ? '~' : '?';
                    crDisplay += ' <span class="ci-bar" title="Wilson CI: ' + (r.wilson.lower * 100).toFixed(3) + '% - ' + (r.wilson.upper * 100).toFixed(3) + '% (' + r.wilson.confidence + ')"><span class="ci-bar-inner ' + ciCls + '"></span><span style="font-size:8px;font-weight:800">' + ciLabel + '</span></span>';
                }
                
                let extraCells = '';
                if (showExtraCols) state.extraColumns.forEach(col => { extraCells += '<td class="text-center text-[11px] text-slate-600">' + escapeHtml((r.extraData && r.extraData[col]) || '-') + '</td>'; });
                
                // CPA & AP tooltips with Break-even
                const payout = parseFloat($('avg-payout').value) || 0;
                let cpaTitle = '';
                let cpaExtra = '';
                let apTitle = '';
                if (r.conv > 0 && payout > 0) {
                    // CPA vs Payout: is cost per acquisition below what you earn?
                    if (r.cpa < payout) {
                        cpaTitle = 'CPA $' + r.cpa.toFixed(2) + ' < Payout $' + payout.toFixed(2) + ' â†’ ×¨×•×•×—×™ (+$' + (payout - r.cpa).toFixed(2) + '/conv)';
                        cpaExtra = ' âœ“';
                    } else if (r.cpa > payout) {
                        cpaTitle = 'CPA $' + r.cpa.toFixed(2) + ' > Payout $' + payout.toFixed(2) + ' â†’ ×”×¤×¡×“×™ (-$' + (r.cpa - payout).toFixed(2) + '/conv)';
                        cpaExtra = ' âœ—';
                    } else {
                        cpaTitle = 'CPA = Payout â†’ Break-even';
                    }
                    apTitle = 'AP ×××•×¦×¢ $' + r.ap.toFixed(2) + ' | Payout ×¦×¤×•×™ $' + payout.toFixed(2);
                } else if (r.conv === 0 && payout > 0 && r.cost > 0) {
                    const cpc = r.cost / r.clicks;
                    const clicksToPayout = cpc > 0 ? Math.ceil(payout / cpc) : 0;
                    cpaTitle = '× ×™×¦×œ ' + r.clicks.toLocaleString() + ' clicks ($' + r.cost.toFixed(2) + ') | ×¦×¨×™×š ×”××¨×” ×ª×•×š ' + clicksToPayout.toLocaleString() + ' clicks ×›×“×™ ×œ×”×™×©××¨ ×¨×•×•×—×™';
                }
                
                // Break-even badge
                let beBadge = '';
                if (r.breakEven && r.breakEven.clicks !== null) {
                    const be = r.breakEven;
                    if (be.status === 'safe') beBadge = ' <span class="be-badge be-safe" title="Sustainable: +$' + be.netPerClick.toFixed(4) + '/click">âœ“ BE</span>';
                    else if (be.status === 'recovering') beBadge = ' <span class="be-badge be-warn" title="' + be.clicks.toLocaleString() + ' clicks ×¢×“ ×¨×•×•×— | +$' + be.netPerClick.toFixed(4) + '/click">' + formatNum(be.clicks) + 'â†’BE</span>';
                    else if (be.status === 'declining') beBadge = ' <span class="be-badge be-warn" title="×¢×•×“ ' + be.clicks.toLocaleString() + ' clicks â†’ ×”×¤×¡×“ | -$' + Math.abs(be.netPerClick).toFixed(4) + '/click">âš ' + formatNum(be.clicks) + '</span>';
                    else if (be.status === 'sinking') beBadge = ' <span class="be-badge be-danger" title="×©×•×§×¢: -$' + Math.abs(be.netPerClick).toFixed(4) + '/click">â†“â†“</span>';
                }
                
                html += '<tr class="' + cfg.row + '">' +
                    '<td class="text-center num-font text-slate-400">' + (start + i + 1) + '</td>' +
                    (showLevel ? '<td class="text-center"><span class="level-badge ' + levelCls + '">' + r.level + '</span></td>' : '') +
                    '<td class="text-right font-bold text-slate-700 ' + (r.isSummary ? 'text-indigo-700' : '') + '">' + icloudBadge + displayId + anomalyHtml + '</td>' +
                    extraCells +
                    '<td class="text-center"><span class="cat-badge ' + cfg.badge + '">' + cfg.label + '</span></td>' +
                    '<td class="text-center"><span class="vol-badge vol-' + (r.volumeTier || 'mid') + '" title="' + (r.volumeRank || '') + '/' + (r.volumeTotal || '') + ' clicks in ' + (cfg.label || r.category) + '">' + (r.volumeTier === 'high' ? 'â–²' : r.volumeTier === 'low' ? 'â–¼' : 'â– ') + '</span></td>' +
                    '<td class="text-center"><span class="score-pill ' + scoreCls + '">' + safeScore.toFixed(2) + '</span></td>' +
                    '<td class="text-center num-font">' + r.clicks.toLocaleString() + '</td>' +
                    '<td class="text-center num-font font-bold">' + r.conv + '</td>' +
                    '<td class="text-center num-font text-green-600">$' + r.rev.toFixed(2) + '</td>' +
                    '<td class="text-center num-font text-slate-500">$' + r.cost.toFixed(2) + '</td>' +
                    '<td class="text-center num-font font-bold ' + (r.profit >= 0 ? 'text-green-600' : 'text-red-500') + '">$' + r.profit.toFixed(2) + beBadge + '</td>' +
                    '<td class="text-center num-font ' + (r.roi >= 0 ? 'text-green-600' : 'text-red-500') + '">' + r.roi.toFixed(0) + '%</td>' +
                    '<td class="text-center num-font text-blue-600">' + crDisplay + '</td>' +
                    '<td class="text-center num-font">$' + r.ppc.toFixed(4) + '</td>' +
                    '<td class="text-center num-font text-slate-600">$' + (r.cpc || 0).toFixed(4) + '</td>' +
                    '<td class="text-center num-font text-orange-600" title="' + escapeHtml(cpaTitle) + '">' + (r.conv > 0 ? '$' + r.cpa.toFixed(2) + cpaExtra : (cpaTitle ? 'â³' : '-')) + '</td>' +
                    '<td class="text-center num-font text-purple-600" title="' + escapeHtml(apTitle) + '">' + (r.conv > 0 ? '$' + r.ap.toFixed(2) : '-') + '</td></tr>';
            });
            const baseCols = showLevel ? 17 : 16;
            const colspan = baseCols + (showExtraCols ? state.extraColumns.length : 0);
            $('table-body').innerHTML = html || '<tr><td colspan="' + colspan + '" class="text-center text-slate-400 py-8">××™×Ÿ × ×ª×•× ×™×</td></tr>';
            const maxPage = Math.ceil(state.filtered.length / state.pageSize) || 1;
            $('disp-count').textContent = state.filtered.length.toLocaleString();
            $('page-num').textContent = state.page + ' / ' + maxPage;
            updateExtraColumnHeaders();
            updateSortIndicators();
            updateSavingsBanner();
        }
        
        function updateExtraColumnHeaders() {
            const existingExtraTh = document.querySelectorAll('.extra-col-th');
            existingExtraTh.forEach(th => th.remove());
            if (state.extraColumns && state.extraColumns.length > 0) {
                const categoryTh = document.querySelector('th:nth-child(' + (state.hasHierarchy ? 4 : 3) + ')');
                state.extraColumns.forEach(col => {
                    const th = document.createElement('th'); th.className = 'text-center extra-col-th'; th.textContent = col;
                    categoryTh.parentNode.insertBefore(th, categoryTh);
                });
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // PROJECTED SAVINGS BANNER
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function updateActionSummary() {
            const sourceData = state.aggMode === 'split' ? (state.processedRaw || []) : (state.processed || []);
            const el = $('action-summary');
            if (!sourceData.length) { if (el) el.classList.add('hidden'); updateMessagesRow(); return; }
            if (el) el.classList.remove('hidden');
            
            const allZones = sourceData.filter(r => !r.isSummary);
            const blHard = allZones.filter(r => r.isBlacklist);
            const blSoft = allZones.filter(r => r.isBlacklistSoft);
            const blAll = [...blHard, ...blSoft];
            const blWaste = blAll.reduce((s, r) => s + Math.max(0, -r.profit), 0);
            const pureGold = allZones.filter(r => r.category === 'pure' || r.category === 'gold');
            const pgProfit = pureGold.reduce((s, r) => s + r.profit, 0);
            const potential = allZones.filter(r => r.category === 'potential');
            const tested = allZones.filter(r => r.clicks >= state.clickThreshold);
            const testedPct = allZones.length > 0 ? Math.round(tested.length / allZones.length * 100) : 0;
            
            $('act-block-count').textContent = blAll.length;
            $('act-block-save').textContent = '$' + formatNum(blWaste);
            $('act-scale-count').textContent = pureGold.length;
            $('act-scale-profit').textContent = formatNum(pgProfit);
            $('act-grow-count').textContent = potential.length;
            $('act-total-zones').textContent = allZones.length.toLocaleString();
            $('act-tested-pct').textContent = testedPct;
            updateMessagesRow();
        }
        
        function updateSavingsBanner() {
            const banner = $('savings-banner');
            if (!banner || !state.processed || !state.processed.length) { if (banner) banner.classList.add('hidden'); updateMessagesRow(); return; }
            
            const all = state.processed.filter(r => !r.isSummary);
            const blZones = all.filter(r => ['blacklist', 'blacklist-soft'].includes(r.category));
            const poorZones = all.filter(r => r.category === 'watch');
            const blPoorZones = [...blZones, ...poorZones];
            
            if (blZones.length === 0 && poorZones.length === 0) { banner.classList.add('hidden'); updateMessagesRow(); return; }
            
            const totalClicks = all.reduce((s, r) => s + r.clicks, 0);
            const totalConv = all.reduce((s, r) => s + r.conv, 0);
            const totalCost = all.reduce((s, r) => s + r.cost, 0);
            const totalRev = all.reduce((s, r) => s + r.rev, 0);
            const totalProfit = totalRev - totalCost;
            
            // Row 1: BL Hard+Soft only
            const nonBl = all.filter(r => !['blacklist', 'blacklist-soft'].includes(r.category));
            const blWaste = blZones.reduce((s, r) => s + Math.max(0, -r.profit), 0);
            const afterClicks1 = nonBl.reduce((s, r) => s + r.clicks, 0);
            const afterConv1 = nonBl.reduce((s, r) => s + r.conv, 0);
            const afterCost1 = nonBl.reduce((s, r) => s + r.cost, 0);
            const afterRev1 = nonBl.reduce((s, r) => s + r.rev, 0);
            const afterProfit1 = afterRev1 - afterCost1;
            
            const crBefore = totalClicks > 0 ? (totalConv / totalClicks * 100) : 0;
            const crAfter1 = afterClicks1 > 0 ? (afterConv1 / afterClicks1 * 100) : 0;
            const roiBefore = totalCost > 0 ? (totalProfit / totalCost * 100) : 0;
            const roiAfter1 = afterCost1 > 0 ? (afterProfit1 / afterCost1 * 100) : 0;
            
            $('sv-bl-count').textContent = blZones.length;
            $('sv-save-amt').textContent = '$' + formatNum(blWaste);
            $('sv-cr-before').textContent = crBefore.toFixed(3) + '%';
            $('sv-cr-after').textContent = crAfter1.toFixed(3) + '%';
            $('sv-roi-before').textContent = roiBefore.toFixed(0) + '%';
            $('sv-roi-after').textContent = roiAfter1.toFixed(0) + '%';
            
            // Row 2: BL + Poor
            const nonBlPoor = all.filter(r => !['blacklist', 'blacklist-soft', 'watch'].includes(r.category));
            const blPoorWaste = blPoorZones.reduce((s, r) => s + Math.max(0, -r.profit), 0);
            const afterClicks2 = nonBlPoor.reduce((s, r) => s + r.clicks, 0);
            const afterConv2 = nonBlPoor.reduce((s, r) => s + r.conv, 0);
            const afterCost2 = nonBlPoor.reduce((s, r) => s + r.cost, 0);
            const afterRev2 = nonBlPoor.reduce((s, r) => s + r.rev, 0);
            const afterProfit2 = afterRev2 - afterCost2;
            
            const crAfter2 = afterClicks2 > 0 ? (afterConv2 / afterClicks2 * 100) : 0;
            const roiAfter2 = afterCost2 > 0 ? (afterProfit2 / afterCost2 * 100) : 0;
            
            $('sv2-bl-count').textContent = blPoorZones.length;
            $('sv2-save-amt').textContent = '$' + formatNum(blPoorWaste);
            $('sv2-cr-before').textContent = crBefore.toFixed(3) + '%';
            $('sv2-cr-after').textContent = crAfter2.toFixed(3) + '%';
            $('sv2-roi-before').textContent = roiBefore.toFixed(0) + '%';
            $('sv2-roi-after').textContent = roiAfter2.toFixed(0) + '%';
            
            // Payout display
            const payout = parseFloat($('avg-payout').value) || 0;
            const payoutEl = $('sv-payout-display');
            if (payout > 0) {
                const cpc = totalClicks > 0 ? totalCost / totalClicks : 0;
                const breakEvenCR = payout > 0 && cpc > 0 ? (cpc / payout) * 100 : 0;
                payoutEl.textContent = 'AP: $' + payout.toFixed(2) + ' | CPC: $' + cpc.toFixed(4) + ' | BE CR: ' + breakEvenCR.toFixed(3) + '%';
                payoutEl.classList.remove('hidden');
            } else {
                payoutEl.classList.add('hidden');
            }
            
            banner.classList.remove('hidden');
            updateMessagesRow();
        }
        
        function updateMessagesRow() {
            const row = $('messages-row');
            if (!row) return;
            const act = $('action-summary');
            const sav = $('savings-banner');
            const actVisible = act && !act.classList.contains('hidden');
            const savVisible = sav && !sav.classList.contains('hidden');
            if (actVisible || savVisible) {
                row.style.display = 'flex';
                row.classList.remove('hidden');
            } else {
                row.style.display = 'none';
            }
        }

        function changePage(d) {
            const max = Math.ceil(state.filtered.length / state.pageSize) || 1;
            if (state.page + d > 0 && state.page + d <= max) { state.page += d; renderTable(); }
        }

        function exportData() {
            const wb = XLSX.utils.book_new();
            const useCidr = $('chk-cidr').checked;
            const source = state.aggMode === 'split' ? (state.processedRaw || []) : (state.processed || []);
            
            // === BUILD SUMMARY SHEET FIRST ===
            const allNonSummary = source.filter(r => !r.isSummary);
            const blHard = allNonSummary.filter(r => r.category === 'blacklist');
            const blSoft = allNonSummary.filter(r => r.category === 'blacklist-soft');
            const blWatch = allNonSummary.filter(r => r.category === 'watch');
            const allBL = [...blHard, ...blSoft];
            const pure = allNonSummary.filter(r => r.category === 'pure');
            const gold = allNonSummary.filter(r => r.category === 'gold');
            const potential = allNonSummary.filter(r => r.category === 'potential');
            const testing = allNonSummary.filter(r => r.category === 'testing');
            const winners = [...pure, ...gold];
            
            const sum = (arr, key) => arr.reduce((s, r) => s + r[key], 0);
            const totalProfit = sum(allNonSummary, 'profit');
            const totalCost = sum(allNonSummary, 'cost');
            const totalRev = sum(allNonSummary, 'rev');
            const totalClicks = sum(allNonSummary, 'clicks');
            const totalConv = sum(allNonSummary, 'conv');
            
            const blWaste = Math.abs(sum(allBL, 'profit'));
            const winnersProfit = sum(winners, 'profit');
            const potentialProfit = sum(potential, 'profit');
            
            const summaryData = [
                { Section: 'ğŸ“Š ×¡×™×›×•× ×›×œ×œ×™', Metric: '', Value: '', Note: '' },
                { Section: '', Metric: '×¡×”"×› ××–×”×™×', Value: allNonSummary.length, Note: '' },
                { Section: '', Metric: '×¡×”"×› ×§×œ×™×§×™×', Value: totalClicks, Note: '' },
                { Section: '', Metric: '×¡×”"×› ×”××¨×•×ª', Value: totalConv, Note: '' },
                { Section: '', Metric: '×¡×”"×› ×”×›× ×¡×”', Value: '$' + totalRev.toFixed(2), Note: '' },
                { Section: '', Metric: '×¡×”"×› ×¢×œ×•×ª', Value: '$' + totalCost.toFixed(2), Note: '' },
                { Section: '', Metric: '×¡×”"×› ×¨×•×•×—', Value: '$' + totalProfit.toFixed(2), Note: totalProfit >= 0 ? 'âœ… ×¨×•×•×—×™' : 'âŒ ×”×¤×¡×“' },
                { Section: '', Metric: 'ROI', Value: totalCost > 0 ? (totalProfit / totalCost * 100).toFixed(1) + '%' : 'N/A', Note: '' },
                { Section: '', Metric: 'CR', Value: totalClicks > 0 ? (totalConv / totalClicks * 100).toFixed(3) + '%' : 'N/A', Note: '' },
                { Section: '', Metric: 'PPC', Value: totalClicks > 0 ? '$' + (totalProfit / totalClicks).toFixed(4) : 'N/A', Note: '' },
                { Section: '', Metric: '', Value: '', Note: '' },
                { Section: 'ğŸ”´ ×—×¡×•× ×•×ª×—×¡×•×š', Metric: '', Value: '', Note: '' },
                { Section: '', Metric: '×–×•× ×™× ×œ×—×¡×™××” (Hard+Soft)', Value: allBL.length, Note: '' },
                { Section: '', Metric: '×”×¤×¡×“ ××¦×˜×‘×¨ ×-BL', Value: '$' + blWaste.toFixed(2), Note: '×—×¡×•× â†’ ×—×¡×•×š ×¡×›×•× ×–×”' },
                { Section: '', Metric: '×§×œ×™×§×™× ××‘×•×–×‘×–×™×', Value: sum(allBL, 'clicks').toLocaleString(), Note: Math.round(sum(allBL, 'clicks') / totalClicks * 100) + '% ××”×ª× ×•×¢×”' },
                { Section: '', Metric: '×¢×œ×•×ª ××‘×•×–×‘×–×ª', Value: '$' + sum(allBL, 'cost').toFixed(2), Note: '' },
            ];
            
            // Top 5 biggest BL losers
            const topLosers = [...allBL].sort((a, b) => a.profit - b.profit).slice(0, 5);
            if (topLosers.length) {
                summaryData.push({ Section: '', Metric: '', Value: '', Note: '' });
                summaryData.push({ Section: '', Metric: 'âš¡ TOP ×”×¤×¡×“×™× ×œ×—×¡×™××” ××™×™×“×™×ª:', Value: '', Note: '' });
                topLosers.forEach((r, i) => {
                    summaryData.push({ Section: '', Metric: (i + 1) + '. ' + r.identifier, Value: '$' + r.profit.toFixed(2), Note: r.clicks.toLocaleString() + ' clicks, ' + r.conv + ' conv' });
                });
            }
            
            summaryData.push({ Section: '', Metric: '', Value: '', Note: '' });
            summaryData.push({ Section: 'ğŸŸ¢ ×”×¢×œ×” bid ×•×ª×¨×•×•×™×— ×™×•×ª×¨', Metric: '', Value: '', Note: '' });
            summaryData.push({ Section: '', Metric: 'Pure + Gold ×–×•× ×™×', Value: winners.length, Note: '' });
            summaryData.push({ Section: '', Metric: '×¨×•×•×— × ×•×›×—×™ ×-Winners', Value: '$' + winnersProfit.toFixed(2), Note: '' });
            summaryData.push({ Section: '', Metric: '×¨×•×•×— ×-Potential', Value: '$' + potentialProfit.toFixed(2), Note: potential.length + ' ×–×•× ×™× ×©××¤×©×¨ ×œ×§×“×' });
            
            // Top 5 winners to scale
            const topWinners = [...winners].sort((a, b) => b.profit - a.profit).slice(0, 5);
            if (topWinners.length) {
                summaryData.push({ Section: '', Metric: '', Value: '', Note: '' });
                summaryData.push({ Section: '', Metric: 'âš¡ TOP ×¨×•×•×—×™×™× ×œ×”×’×“×œ×ª bid:', Value: '', Note: '' });
                topWinners.forEach((r, i) => {
                    summaryData.push({ Section: '', Metric: (i + 1) + '. ' + r.identifier, Value: '+$' + r.profit.toFixed(2), Note: 'ROI ' + r.roi.toFixed(0) + '%, CR ' + (r.cr * 100).toFixed(3) + '%' });
                });
            }
            
            summaryData.push({ Section: '', Metric: '', Value: '', Note: '' });
            summaryData.push({ Section: 'ğŸ‘€ Poor', Metric: '', Value: '', Note: '' });
            summaryData.push({ Section: '', Metric: '×–×•× ×™× ×‘-Poor', Value: blWatch.length, Note: '×‘×™×¦×•×¢ ×—×œ×© ×‘×™×—×¡ ×œ×§××¤×™×™×Ÿ' });
            summaryData.push({ Section: '', Metric: '×–×•× ×™× ×‘-Testing', Value: testing.length, Note: '××™×Ÿ ××¡×¤×™×§ ×“××˜×” ×¢×“×™×™×Ÿ' });
            
            summaryData.push({ Section: '', Metric: '', Value: '', Note: '' });
            // Calculate projected CRs
            const currentCR = totalClicks > 0 ? (totalConv / totalClicks * 100) : 0;
            const afterBlockClicks = totalClicks - sum(allBL, 'clicks');
            const afterBlockConv = totalConv - sum(allBL, 'conv');
            const afterBlockCR = afterBlockClicks > 0 ? (afterBlockConv / afterBlockClicks * 100) : 0;
            const afterBlockProfit = totalProfit + blWaste;
            const afterBlockCost = totalCost - sum(allBL, 'cost');
            const afterBlockROI = afterBlockCost > 0 ? (afterBlockProfit / afterBlockCost * 100) : 0;
            
            const wlClicks = sum(winners, 'clicks');
            const wlConv = sum(winners, 'conv');
            const wlCR = wlClicks > 0 ? (wlConv / wlClicks * 100) : 0;
            const wlCost = sum(winners, 'cost');
            const wlROI = wlCost > 0 ? (winnersProfit / wlCost * 100) : 0;
            
            summaryData.push({ Section: 'ğŸ’¡ ×”×©×•×¨×” ×”×ª×—×ª×•× ×”', Metric: '', Value: '', Note: '' });
            summaryData.push({ Section: '', Metric: '×—×¡×•× ' + allBL.length + ' ×–×•× ×™×', Value: 'â†’ ×—×¡×•×š $' + blWaste.toFixed(2), Note: 'CR: ' + currentCR.toFixed(3) + '% â†’ ' + afterBlockCR.toFixed(3) + '%  |  ROI: ' + afterBlockROI.toFixed(0) + '%' });
            summaryData.push({ Section: '', Metric: 'WL ×¢×œ ' + winners.length + ' ×–×•× ×™× ×‘×œ×‘×“', Value: 'â†’ ×¨×•×•×— $' + winnersProfit.toFixed(2), Note: 'CR: ' + wlCR.toFixed(3) + '%  |  ROI: ' + wlROI.toFixed(0) + '%' });
            
            const summaryWs = XLSX.utils.json_to_sheet(summaryData);
            summaryWs['!cols'] = [{ wch: 22 }, { wch: 35 }, { wch: 20 }, { wch: 35 }];
            XLSX.utils.book_append_sheet(wb, summaryWs, '×¡×™×›×•×');
            
            // === CATEGORY SHEETS ===
            const exports = [
                { id: 'chk-pure', name: 'Pure', pick: r => r.category === 'pure' },
                { id: 'chk-gold', name: 'Gold', pick: r => r.category === 'gold' },
                { id: 'chk-potential', name: 'Potential', pick: r => r.category === 'potential' },
                { id: 'chk-bl', name: 'Blacklist', pick: r => ['blacklist', 'blacklist-soft'].includes(r.category) },
                { id: 'chk-custom', name: 'Custom', pick: r => r.matchesCustom || r.category === 'custom' }
            ];
            let count = 1; // Already have summary
            exports.forEach(exp => {
                if ($(exp.id).checked) {
                    const rows = source.filter(r => !r.isSummary && exp.pick(r));
                    if (rows.length) {
                        const data = rows.map(r => ({
                            Identifier: useCidr ? toCIDR(r.identifier) : r.identifier,
                            Category: r.category,
                            Volume: (r.volumeTier || 'mid').toUpperCase(),
                            BL_Severity: r.blSeverity || '',
                            Score: r.score.toFixed(2), Clicks: r.clicks, Conv: r.conv,
                            Revenue: r.rev.toFixed(2), Cost: r.cost.toFixed(2), Profit: r.profit.toFixed(2),
                            'ROI%': r.roi.toFixed(0), 'CR%': (r.cr * 100).toFixed(3), PPC: r.ppc.toFixed(4),
                            CPC: (r.cpc || 0).toFixed(4),
                            CPA: r.conv > 0 ? r.cpa.toFixed(2) : '',
                            AP: r.conv > 0 ? r.ap.toFixed(2) : '',
                            CR_Confidence: r.wilson ? r.wilson.confidence : '',
                            BE_Status: r.breakEven ? r.breakEven.status : '',
                            BE_Clicks: r.breakEven && r.breakEven.clicks > 0 ? r.breakEven.clicks : '',
                            Net_Per_Click: r.breakEven ? r.breakEven.netPerClick.toFixed(4) : '',
                            Action: r.action,
                            Anomalies: r.anomalies ? r.anomalies.map(a => a.label).join(', ') : ''
                        }));
                        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), exp.name);
                        count++;
                    }
                }
            });
            if (count) { XLSX.writeFile(wb, 'ListLab_V52_Export.xlsx'); showToast('×§×•×‘×¥ Excel ×™×•×¦× ×‘×”×¦×œ×—×” (' + count + ' ×’×™×œ×™×•× ×•×ª, ×›×•×œ×œ ×¡×™×›×•×)', 'success'); }
            else alert('×‘×—×¨ ×œ×¤×—×•×ª ×¨×©×™××” ××—×ª');
        }

        function copyIPs() {
            if (!state.filtered.length) return alert('××™×Ÿ × ×ª×•× ×™×');
            const useCidr = $('chk-copy-cidr').checked;
            const allIds = state.filtered.filter(r => !r.isSummary).map(r => useCidr ? toCIDR(r.identifier) : r.identifier);
            const uniqueIds = [...new Set(allIds)];
            const isSubId = state.detectedType === 'subid' || state.detectedType === 'zone';
            const separator = (useCidr && isSubId) ? ',' : '\n';
            navigator.clipboard.writeText(uniqueIds.join(separator)).then(() => {
                showToast('×”×•×¢×ª×§×• ' + uniqueIds.length + ' ××–×”×™×' + (useCidr && isSubId ? ' (××•×¤×¨×“×™× ×‘×¤×¡×™×§)' : ''), 'success');
                const btn = $('btn-copy');
                btn.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i> ×”×•×¢×ª×§!';
                lucide.createIcons();
                setTimeout(() => { btn.innerHTML = '<i data-lucide="copy" class="w-3 h-3"></i> ×”×¢×ª×§ <span class="shortcut-key">C</span>'; lucide.createIcons(); }, 1500);
            });
        }

        function debounce(fn, ms = 150) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); }; }
        const debouncedProcess = debounce(processData, 200);
        
        function syncControls(rangeId, numId) {
            const range = $(rangeId); const num = $(numId);
            range.addEventListener('input', () => { num.value = range.value; state.manualTiers = true; debouncedProcess(); });
            num.addEventListener('input', () => { range.value = num.value; state.manualTiers = true; debouncedProcess(); });
        }
        syncControls('pure-pct', 'pure-pct-num');
        syncControls('gold-pct', 'gold-pct-num');
        
        function toggleDashboard() {
            const content = $('dashboard-content'); const icon = $('dash-toggle-icon');
            content.classList.toggle('hidden');
            icon.style.transform = content.classList.contains('hidden') ? '' : 'rotate(180deg)';
        }
        
        function toggleFocusMode() {
            const container = document.querySelector('.dash-container');
            container.classList.toggle('focus-mode');
            const isFocus = container.classList.contains('focus-mode');
            if (isFocus) {
                showToast('ğŸ” Focus Mode â€” ×œ×—×¥ F ×œ×—×–×•×¨', 'info', 2000);
            }
        }
        
        function toggleSectionCollapse(sectionId) {
            const section = $(sectionId);
            section.classList.toggle('section-collapsed');
        }
        
        function getCategoryMini(cat) {
            const cats = {
                pure: '<span class="text-[9px] px-1 rounded bg-blue-100 text-blue-700 border border-blue-200">PURE</span>',
                gold: '<span class="text-[9px] px-1 rounded bg-amber-100 text-amber-700 border border-amber-200">GOLD</span>',
                potential: '<span class="text-[9px] px-1 rounded bg-green-100 text-green-700 border border-green-200">POT</span>',
                ignore: '<span class="text-[9px] px-1 rounded bg-slate-100 text-slate-600 border border-slate-200">WATCH</span>',
                blacklist: '<span class="text-[9px] px-1 rounded bg-red-200 text-red-800 border border-red-300">BL</span>',
                'blacklist-soft': '<span class="text-[9px] px-1 rounded bg-red-100 text-red-600 border border-red-200">SOFT</span>',
                watch: '<span class="text-[9px] px-1 rounded bg-orange-100 text-orange-700 border border-orange-200">POOR</span>',
                testing: '<span class="text-[9px] px-1 rounded bg-blue-100 text-blue-700 border border-blue-200">TEST</span>'
            };
            return cats[cat] || '';
        }
        
        function updateMiniDashboard() {
            const sourceData = state.aggMode === 'split' ? (state.processedRaw || []) : (state.processed || []);
            if (!sourceData.length) { $('section-dashboard').classList.add('hidden'); return; }
            $('section-dashboard').classList.remove('hidden');
            const byProfit = [...sourceData].sort((a, b) => b.profit - a.profit);
            const testedOnly = byProfit.filter(r => r.clicks >= state.clickThreshold);
            
            const top5 = testedOnly.filter(r => r.profit > 0).slice(0, 5);
            $('top-performers').innerHTML = top5.length ? top5.map(r => '<div class="performer-item"><span class="performer-id" title="' + escapeHtml(r.identifier) + '">' + escapeHtml(r.identifier) + '</span>' + getCategoryMini(r.category) + '<span class="performer-val text-green-600">+$' + r.profit.toFixed(2) + '</span></div>').join('') : '<div class="text-slate-400 text-[10px]">××™×Ÿ × ×ª×•× ×™×</div>';
            
            const bottom5 = testedOnly.filter(r => r.profit < 0).sort((a, b) => a.profit - b.profit).slice(0, 5);
            $('top-losers').innerHTML = bottom5.length ? bottom5.map(r => '<div class="performer-item"><span class="performer-id" title="' + escapeHtml(r.identifier) + '">' + escapeHtml(r.identifier) + '</span>' + getCategoryMini(r.category) + '<span class="performer-val text-red-500">$' + r.profit.toFixed(2) + '</span></div>').join('') : '<div class="text-slate-400 text-[10px]">××™×Ÿ × ×ª×•× ×™×</div>';

            const totalClicks = sourceData.reduce((s, r) => s + r.clicks, 0);
            const totalCost = sourceData.reduce((s, r) => s + r.cost, 0);
            const avgCPC = totalClicks > 0 ? totalCost / totalClicks : 0.001;
            const payoutsPerConv = [];
            sourceData.forEach(r => { if (r.conv > 0 && r.rev > 0) payoutsPerConv.push(r.rev / r.conv); });
            payoutsPerConv.sort((a, b) => a - b);
            const medianPayout = payoutsPerConv.length > 0 ? payoutsPerConv[Math.floor(payoutsPerConv.length / 2)] : 0;
            const maxClicksUntilLoss = avgCPC > 0 ? medianPayout / avgCPC : 0;
            const minCRtoProfit = medianPayout > 0 ? avgCPC / medianPayout : 0;
            
            $('be-max-clicks').textContent = maxClicksUntilLoss.toLocaleString(undefined, {maximumFractionDigits: 0});
            $('be-clicks-formula').textContent = 'Median AP $' + medianPayout.toFixed(2) + ' Ã· CPC $' + avgCPC.toFixed(4);
            $('be-min-cr').textContent = (minCRtoProfit * 100).toFixed(3) + '%';
            $('be-cr-formula').textContent = 'CPC $' + avgCPC.toFixed(4) + ' Ã· Median AP $' + medianPayout.toFixed(2);

            const avgROI = testedOnly.length > 0 ? testedOnly.reduce((s, r) => s + r.roi, 0) / testedOnly.length : 0;
            const crValues = testedOnly.filter(r => r.conv > 0).map(r => r.cr).sort((a, b) => a - b);
            const medianCR = crValues.length > 0 ? crValues[Math.floor(crValues.length / 2)] : 0;
            
            const outstanding = testedOnly.filter(r => {
                if (r.profit <= 0 || r.conv < 2 || r.cr < medianCR) return false;
                const roiRatio = avgROI > 0 ? r.roi / avgROI : 0;
                return roiRatio >= 2 && r.roi > 750;
            }).sort((a, b) => b.roi - a.roi).slice(0, 5);
            
            $('outstanding-list').innerHTML = outstanding.length ? outstanding.map(r => {
                const multiplier = avgROI > 0 ? (r.roi / avgROI).toFixed(1) : 'âˆ';
                return '<div class="performer-item"><span class="performer-id" title="' + escapeHtml(r.identifier) + '">' + escapeHtml(r.identifier) + '</span>' + getCategoryMini(r.category) + '<span class="performer-val text-purple-600">x' + multiplier + '</span></div>';
            }).join('') : '<div class="text-slate-400 text-[10px]">××™×Ÿ ××¦×˜×™×™× ×™× ×‘×•×œ×˜×™×</div>';
        }
        
        function searchIdentifier(query) { state.searchQuery = query.trim().toLowerCase(); applyFilter(); }
        $('search-input').addEventListener('input', (e) => { searchIdentifier(e.target.value); });

        function enableButtons() { $('btn-auto-thresh').disabled = !state.processed.length; $('auto-metric').disabled = !state.processed.length; }

    </script>
</body>
</html>
