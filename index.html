<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ListLab V35 Production - Decision Support System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700;800&family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Assistant', sans-serif; background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); height: 100vh; overflow: hidden; color: #1e293b; font-size: 15.4px; }
        .num-font { font-family: 'Inter', sans-serif; }
        
        .main-wrapper { width: 100%; height: 100%; display: flex; flex-direction: column; padding: 0.5rem; }
        .glass-header { background: white; border-radius: 10px; padding: 0 1.5rem; margin-bottom: 0.5rem; box-shadow: 0 2px 10px rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; height: 68px; }
        .dash-container { flex: 1; background: white; border-radius: 12px; box-shadow: 0 5px 20px rgba(0, 0, 0, 0.05); display: flex; overflow: hidden; border: 1px solid #e2e8f0; }
        .dash-sidebar { width: 380px; background: #ffffff; border-left: 1px solid #e2e8f0; display: flex; flex-direction: column; overflow-y: auto; padding: 1rem; }
        .dash-content { flex: 1; background: #f8fafc; display: flex; flex-direction: column; overflow: hidden; }

        .control-box { border-radius: 8px; padding: 0.75rem; margin-bottom: 0.75rem; border: 1px solid; }
        .control-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; }
        .control-item { display: flex; flex-direction: column; }
        .lbl-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2px; }
        .lbl-sm { font-size: 12px; font-weight: 700; color: #64748b; }
        
        input[type=range] { height: 5px; border-radius: 2px; background: rgba(0,0,0,0.1); outline: none; appearance: none; cursor: pointer; width: 100%; }
        input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; border-radius: 50%; background: currentColor; border: 2px solid white; box-shadow: 0 1px 2px rgba(0,0,0,0.2); }
        .dash-input { width: 55px; font-family: 'Inter', sans-serif; font-weight: 700; font-size: 12px; text-align: center; border: 1px solid #cbd5e1; border-radius: 4px; padding: 2px; background: white; height: 26px; }

        .collapsible-header { display: flex; justify-content: space-between; align-items: center; cursor: pointer; padding: 6px 0; }
        .collapsible-content { display: none; }
        .collapsible-content.open { display: block; }
        .collapse-icon { transition: transform 0.2s; }
        .collapse-icon.open { transform: rotate(180deg); }

        .kpi-container { display: flex; flex-wrap: wrap; gap: 0.5rem; }
        .kpi-card { background: white; border: 1px solid #e2e8f0; border-radius: 10px; transition: transform 0.2s; display: flex; flex-direction: column; padding: 0.6rem; flex: 1 1 auto; min-width: 180px; max-width: 280px; }
        .kpi-card:hover { transform: translateY(-2px); box-shadow: 0 8px 20px -4px rgba(0,0,0,0.1); }
        .kpi-card.hidden { display: none !important; }
        .kpi-card.custom-active { border: 2px solid #8b5cf6; box-shadow: 0 0 15px rgba(139, 92, 246, 0.3); }
        
        .kpi-pure { border-top: 4px solid #fbbf24; }
        .kpi-gold { border-top: 4px solid #f59e0b; }
        .kpi-potential { border-top: 4px solid #10b981; }
        .kpi-ignore { border-top: 4px solid #6b7280; }
        .kpi-blacklist { border-top: 4px solid #ef4444; }
        .kpi-testing { border-top: 4px solid #3b82f6; }

        .stat-lbl { font-size: 10px; font-weight: 700; color: #94a3b8; text-transform: uppercase; }
        .stat-val { font-family: 'Inter', sans-serif; font-weight: 700; font-size: 13px; color: #334155; }
        
        .g-item { text-align: center; border-left: 1px solid #f1f5f9; flex: 1; display: flex; flex-direction: column; justify-content: center; padding: 0 6px; }
        .g-item:last-child { border: none; }
        .g-lbl { font-size: 11px; font-weight: 700; color: #94a3b8; text-transform: uppercase; }
        .g-val { font-size: 14px; font-weight: 700; color: #334155; font-family: 'Inter', sans-serif; }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .chk-input { width: 15px; height: 15px; accent-color: #1e293b; cursor: pointer; }
        
        th { font-size: 11px; text-transform: uppercase; letter-spacing: 0.03em; color: #64748b; font-weight: 700; background: #f8fafc; position: sticky; top: 0; z-index: 10; padding: 9px 10px; cursor: pointer; }
        th:hover { background: #f1f5f9; }
        td { font-size: 12px; border-bottom: 1px solid #f1f5f9; padding: 7px 10px; }
        tr:hover td { background-color: #f8fafc; }
        
        .row-pure { background: linear-gradient(90deg, #fef3c7 0%, #fffbeb 100%); }
        .row-gold { background: linear-gradient(90deg, #fef3c7 0%, white 100%); }
        .row-potential { background: linear-gradient(90deg, #d1fae5 0%, white 100%); }
        .row-blacklist { background: linear-gradient(90deg, #fee2e2 0%, white 100%); }
        .row-testing { background: linear-gradient(90deg, #dbeafe 0%, white 100%); }
        .row-custom { background: linear-gradient(90deg, #ede9fe 0%, #f5f3ff 100%); }
        .row-summary { background: linear-gradient(90deg, #e0e7ff 0%, #f5f3ff 100%); font-weight: 700; }

        .cat-badge { font-size: 10px; font-weight: 800; padding: 3px 7px; border-radius: 4px; white-space: nowrap; }
        .badge-pure { background: #fef3c7; color: #92400e; }
        .badge-gold { background: #fde68a; color: #92400e; }
        .badge-potential { background: #d1fae5; color: #065f46; }
        .badge-ignore { background: #f3f4f6; color: #6b7280; }
        .badge-blacklist { background: #fee2e2; color: #991b1b; }
        .badge-testing { background: #dbeafe; color: #1e40af; }
        .badge-custom { background: #ede9fe; color: #7c3aed; }
        .badge-summary { background: #e0e7ff; color: #4338ca; }

        .score-pill { font-family: 'Inter', sans-serif; font-size: 11px; font-weight: 800; padding: 2px 7px; border-radius: 10px; }
        .score-high { background: #fbbf24; color: #78350f; }
        .score-mid { background: #10b981; color: white; }
        .score-low { background: #e2e8f0; color: #64748b; }

        .btn-upload { background: #e0e7ff; color: #4338ca; border: 1px dashed #a5b4fc; padding: 0.75rem; border-radius: 8px; text-align: center; cursor: pointer; transition: all 0.2s; }
        .btn-upload:hover { background: #c7d2fe; border-color: #6366f1; }

        .kpi-toggle { display: flex; flex-wrap: wrap; gap: 4px; }
        .kpi-toggle-btn { font-size: 10px; padding: 4px 8px; border-radius: 4px; cursor: pointer; border: 1px solid #e2e8f0; background: white; font-weight: 700; transition: all 0.15s; }
        .kpi-toggle-btn.active { background: #1e293b; color: white; border-color: #1e293b; }
        .kpi-toggle-btn:hover:not(.active) { background: #f1f5f9; }

        .filter-item { margin-bottom: 8px; position: relative; }
        .filter-header { display: flex; justify-content: space-between; align-items: center; font-size: 12px; font-weight: 700; color: #475569; margin-bottom: 2px; }
        .filter-btn { width: 100%; text-align: right; background: #f8fafc; border: 1px solid #cbd5e1; padding: 7px 11px; border-radius: 6px; font-size: 12px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .filter-btn:hover { border-color: #94a3b8; }
        .filter-popup { position: absolute; top: 100%; left: 0; width: 260px; background: white; border: 1px solid #cbd5e1; border-radius: 6px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); z-index: 50; display: none; flex-direction: column; padding: 8px; margin-top: 4px; }
        .filter-popup.show { display: flex; }
        .filter-search { width: 100%; padding: 5px 9px; border: 1px solid #e2e8f0; border-radius: 4px; font-size: 12px; margin-bottom: 6px; }
        .filter-list { max-height: 150px; overflow-y: auto; display: flex; flex-direction: column; gap: 4px; border: 1px solid #f1f5f9; padding: 4px; border-radius: 4px; margin-bottom: 6px; }
        .filter-opt { display: flex; align-items: center; gap: 6px; font-size: 12px; color: #334155; cursor: pointer; user-select: none; padding: 3px 5px; border-radius: 3px; }
        .filter-opt:hover { background: #f8fafc; }
        .btn-tiny { font-size: 11px; padding: 3px 10px; border-radius: 3px; cursor: pointer; font-weight: 600; }
        .btn-apply { background: #3b82f6; color: white; }
        .btn-cancel { background: #f1f5f9; color: #64748b; }

        .level-badge { font-size: 10px; font-weight: 800; padding: 2px 6px; border-radius: 4px; }
        .level-1 { background: #fee2e2; color: #991b1b; }
        .level-2 { background: #fef3c7; color: #92400e; }
        .level-3 { background: #d1fae5; color: #065f46; }

        .mapping-row { display: flex; align-items: center; gap: 8px; margin-bottom: 4px; }
        .mapping-row label { font-size: 11px; font-weight: 700; color: #475569; min-width: 55px; }
        .mapping-row select { flex: 1; font-size: 11px; padding: 4px 6px; border: 1px solid #cbd5e1; border-radius: 4px; }

        .threshold-info { font-size: 10px; color: #64748b; background: #f8fafc; padding: 4px 8px; border-radius: 4px; margin-top: 4px; }
        .threshold-val { font-weight: 800; color: #3b82f6; }
    </style>
</head>
<body>
    <div class="main-wrapper">
        <div class="glass-header">
            <div class="flex items-center gap-3 shrink-0">
                <div class="bg-gradient-to-br from-amber-400 to-orange-500 text-white p-2 rounded-lg shadow-md">
                    <i data-lucide="trophy" class="w-5 h-5"></i>
                </div>
                <div>
                    <h1 class="text-base font-bold text-slate-800">ListLab</h1>
                    <div class="text-[11px] text-amber-600 font-bold">V35 Production</div>
                </div>
            </div>
            
            <div id="global-stats" class="flex-1 flex justify-center items-center">
                <span class="text-sm text-slate-400">×˜×¢×Ÿ ×§×•×‘×¥ ×œ×”×ª×—×œ×”...</span>
            </div>
            
            <div id="medians-box" class="hidden shrink-0 text-[11px] bg-slate-100 px-3 py-1.5 rounded-lg border border-slate-200">
                <span class="text-slate-500">Median EPC:</span> <strong id="med-ppc" class="text-amber-600 num-font">$0</strong>
                <span class="mx-2 text-slate-300">|</span>
                <span class="text-slate-500">Median CR:</span> <strong id="med-cr" class="text-blue-600 num-font">0%</strong>
                <span class="mx-2 text-slate-300">|</span>
                <span class="text-slate-500">×¡×£ ×§×œ×™×§×™×:</span> <strong id="click-threshold" class="text-red-500 num-font">0</strong>
            </div>
        </div>

        <div class="dash-container">
            <aside class="dash-sidebar custom-scrollbar">
                <div class="btn-upload mb-3" id="drop-zone">
                    <input type="file" id="file-input" class="hidden" accept=".xlsx,.csv">
                    <div class="flex items-center justify-center gap-2 mb-1 text-indigo-700">
                        <i data-lucide="upload-cloud" class="w-4 h-4"></i>
                        <span class="text-sm font-bold">×˜×¢×Ÿ ×§×•×‘×¥ CSV / Excel</span>
                    </div>
                    <div id="filename" class="text-[10px] text-indigo-400 truncate"></div>
                </div>

                <div id="hierarchy-box" class="hidden bg-gradient-to-r from-amber-50 to-orange-50 border border-amber-200 rounded-lg p-2 mb-3">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2 text-amber-700 text-[11px] font-bold">
                            <i data-lucide="git-branch" class="w-3 h-3"></i>
                            <span>×”×™×¨×¨×›×™×” ×¤×¢×™×œ×”</span>
                        </div>
                        <div id="level-badges" class="flex gap-1"></div>
                    </div>
                </div>

                <!-- IP Level Selection -->
                <div class="control-box border-blue-200 bg-blue-50 mb-3">
                    <div class="text-xs font-bold text-blue-700 mb-2 flex items-center gap-1">
                        <i data-lucide="layers" class="w-3 h-3"></i> ×¨××ª IP
                    </div>
                    <select id="ip-level" class="w-full text-sm border border-blue-300 rounded p-1.5 font-medium">
                        <option value="1">IP1 / SubID (1.5Ã—, 1K-3K)</option>
                        <option value="2" selected>IP2 / Zone (3Ã—, 3K-10K)</option>
                        <option value="3">IP3 (5Ã—, 5K-15K)</option>
                    </select>
                    <div class="threshold-info mt-2">
                        ×¡×£ ×§×œ×™×§×™× × ×•×›×—×™: <span class="threshold-val" id="current-threshold">7,000</span>
                        <br>× ×•×¡×—×”: ××›×¤×™×œ Ã— (100 / CR%)
                    </div>
                </div>

                <!-- Column Mapping - Collapsed -->
                <div id="mapping-box" class="hidden control-box border-slate-200 bg-slate-50">
                    <div class="collapsible-header" onclick="toggleSection('mapping')">
                        <div class="text-xs font-bold text-slate-700 flex items-center gap-1">
                            <i data-lucide="columns" class="w-3 h-3"></i> ××™×¤×•×™ ×¢××•×“×•×ª
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-600 collapse-icon" id="mapping-icon"></i>
                    </div>
                    <div class="collapsible-content" id="mapping-content">
                        <div class="mapping-row"><label>××–×”×” IP</label><select id="col-ip"></select></div>
                        <div class="mapping-row"><label>×§×œ×™×§×™×</label><select id="col-clicks"></select></div>
                        <div class="mapping-row"><label>×”××¨×•×ª</label><select id="col-conv"></select></div>
                        <div class="mapping-row"><label>×”×›× ×¡×”</label><select id="col-rev"></select></div>
                        <div class="mapping-row"><label>×¢×œ×•×ª</label><select id="col-cost"></select></div>
                        <button onclick="processData()" class="w-full mt-2 bg-slate-700 text-white py-1.5 rounded text-xs font-bold hover:bg-slate-800">ğŸ”„ ×¢×“×›×Ÿ</button>
                    </div>
                </div>

                <!-- Advanced Filters -->
                <div class="control-box border-slate-300 bg-slate-50">
                    <div class="collapsible-header" onclick="toggleSection('filters')">
                        <div class="text-xs font-bold text-slate-700 flex items-center gap-1">
                            <i data-lucide="filter" class="w-3 h-3"></i> ×¡×™× ×•×Ÿ ××ª×§×“×
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-slate-600 collapse-icon open" id="filters-icon"></i>
                    </div>
                    <div class="collapsible-content open" id="filters-content">
                        <div id="filters-list" class="mt-2"></div>
                        <button onclick="showAddFilterMenu()" id="btn-add-filter" class="hidden w-full mt-2 border border-dashed border-indigo-300 text-indigo-600 rounded p-1.5 text-[10px] font-bold hover:bg-indigo-50 flex items-center justify-center gap-1">
                            <i data-lucide="plus" class="w-3 h-3"></i> ×”×•×¡×£ ××¡× ×Ÿ
                        </button>
                        <select id="col-selector" class="hidden w-full mt-1 text-[11px] border border-slate-300 rounded p-1" onchange="createNewFilter(this.value)">
                            <option value="">×‘×—×¨ ×¢××•×“×”...</option>
                        </select>
                        <div id="filter-msg" class="text-[11px] text-slate-400 text-center py-2 italic">×˜×¢×Ÿ ×§×•×‘×¥ ×›×“×™ ×œ×”×ª×—×™×œ</div>
                    </div>
                </div>

                <!-- Score Thresholds -->
                <div class="control-box border-amber-200 bg-amber-50">
                    <div class="text-xs font-bold text-amber-700 mb-2 flex items-center gap-1">
                        <i data-lucide="sliders" class="w-3 h-3"></i> TOP % Thresholds
                    </div>
                    <div class="control-grid">
                        <div class="control-item">
                            <div class="lbl-row"><span class="lbl-sm">ğŸ’ PURE</span><input type="number" id="pure-pct-num" value="10" class="dash-input text-amber-600"></div>
                            <input type="range" id="pure-pct" min="5" max="30" value="10" class="text-amber-500">
                        </div>
                        <div class="control-item">
                            <div class="lbl-row"><span class="lbl-sm">ğŸ¥‡ GOLD</span><input type="number" id="gold-pct-num" value="25" class="dash-input text-amber-600"></div>
                            <input type="range" id="gold-pct" min="15" max="50" value="25" class="text-amber-500">
                        </div>
                    </div>
                </div>

                <!-- Custom List with Min/Max - 2 per row -->
                <div class="control-box border-purple-200 bg-purple-50">
                    <div class="collapsible-header" onclick="toggleSection('custom')">
                        <div class="text-xs font-bold text-purple-700 flex items-center gap-1">
                            <i data-lucide="list-filter" class="w-3 h-3"></i> Custom List
                            <span id="custom-badge" class="hidden text-[9px] bg-purple-600 text-white px-1.5 py-0.5 rounded-full">×¤×¢×™×œ</span>
                        </div>
                        <i data-lucide="chevron-down" class="w-4 h-4 text-purple-600 collapse-icon" id="custom-icon"></i>
                    </div>
                    <div class="collapsible-content" id="custom-content">
                        <div class="flex items-center gap-2 mb-3 mt-2">
                            <input type="checkbox" id="custom-enabled" class="chk-input">
                            <label for="custom-enabled" class="text-[11px] font-bold text-purple-700">×”×¤×¢×œ Custom List</label>
                        </div>
                        
                        <!-- Row 1: Conv & Score -->
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div class="bg-white rounded-lg p-2 border border-purple-100">
                                <div class="text-[10px] font-bold text-purple-600 mb-1.5">Conv</div>
                                <div class="flex gap-1">
                                    <div class="flex-1">
                                        <input type="number" id="cust-conv-min" value="1" min="0" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="Min">
                                    </div>
                                    <span class="text-slate-300 self-center">-</span>
                                    <div class="flex-1">
                                        <input type="number" id="cust-conv-max" value="" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="âˆ">
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg p-2 border border-purple-100">
                                <div class="text-[10px] font-bold text-purple-600 mb-1.5">Score</div>
                                <div class="flex gap-1">
                                    <div class="flex-1">
                                        <input type="number" id="cust-score-min" value="0" step="0.1" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="Min">
                                    </div>
                                    <span class="text-slate-300 self-center">-</span>
                                    <div class="flex-1">
                                        <input type="number" id="cust-score-max" value="" step="0.1" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="âˆ">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Row 2: Clicks & ROI -->
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div class="bg-white rounded-lg p-2 border border-purple-100">
                                <div class="text-[10px] font-bold text-purple-600 mb-1.5">Clicks</div>
                                <div class="flex gap-1">
                                    <div class="flex-1">
                                        <input type="number" id="cust-clicks-min" value="0" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="Min">
                                    </div>
                                    <span class="text-slate-300 self-center">-</span>
                                    <div class="flex-1">
                                        <input type="number" id="cust-clicks-max" value="" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="âˆ">
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg p-2 border border-purple-100">
                                <div class="text-[10px] font-bold text-purple-600 mb-1.5">ROI%</div>
                                <div class="flex gap-1">
                                    <div class="flex-1">
                                        <input type="number" id="cust-roi-min" value="-100" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="Min">
                                    </div>
                                    <span class="text-slate-300 self-center">-</span>
                                    <div class="flex-1">
                                        <input type="number" id="cust-roi-max" value="" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="âˆ">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Row 3: CR & EPC -->
                        <div class="grid grid-cols-2 gap-2 mb-2">
                            <div class="bg-white rounded-lg p-2 border border-purple-100">
                                <div class="text-[10px] font-bold text-purple-600 mb-1.5">CR%</div>
                                <div class="flex gap-1">
                                    <div class="flex-1">
                                        <input type="number" id="cust-cr-min" value="0" step="0.001" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="Min">
                                    </div>
                                    <span class="text-slate-300 self-center">-</span>
                                    <div class="flex-1">
                                        <input type="number" id="cust-cr-max" value="" step="0.001" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="âˆ">
                                    </div>
                                </div>
                            </div>
                            <div class="bg-white rounded-lg p-2 border border-purple-100">
                                <div class="text-[10px] font-bold text-purple-600 mb-1.5">EPC</div>
                                <div class="flex gap-1">
                                    <div class="flex-1">
                                        <input type="number" id="cust-epc-min" value="-1" step="0.001" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="Min">
                                    </div>
                                    <span class="text-slate-300 self-center">-</span>
                                    <div class="flex-1">
                                        <input type="number" id="cust-epc-max" value="" step="0.001" class="w-full text-[11px] border border-slate-200 rounded px-2 py-1 num-font text-center" placeholder="âˆ">
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <button onclick="processData()" class="w-full mt-1 bg-purple-600 text-white py-1.5 rounded text-xs font-bold hover:bg-purple-700 flex items-center justify-center gap-1">
                            <i data-lucide="check" class="w-3 h-3"></i> ×”×—×œ ×¤×™×œ×˜×¨
                        </button>
                    </div>
                </div>

                <!-- KPI Visibility - ALL ACTIVE BY DEFAULT -->
                <div class="control-box border-slate-200 bg-slate-50">
                    <div class="text-xs font-bold text-slate-700 mb-2">×”×¦×’ KPIs</div>
                    <div class="kpi-toggle">
                        <button class="kpi-toggle-btn active" data-kpi="pure" onclick="toggleKpi('pure')">ğŸ’ Pure</button>
                        <button class="kpi-toggle-btn active" data-kpi="gold" onclick="toggleKpi('gold')">ğŸ¥‡ Gold</button>
                        <button class="kpi-toggle-btn active" data-kpi="potential" onclick="toggleKpi('potential')">ğŸŒ± Potential</button>
                        <button class="kpi-toggle-btn active" data-kpi="ignore" onclick="toggleKpi('ignore')">ğŸ˜ Ignore</button>
                        <button class="kpi-toggle-btn active" data-kpi="blacklist" onclick="toggleKpi('blacklist')">ğŸš« Blacklist</button>
                        <button class="kpi-toggle-btn active" data-kpi="testing" onclick="toggleKpi('testing')">ğŸ”¬ Testing</button>
                    </div>
                </div>

                <!-- Export -->
                <div class="mt-auto border-t pt-3">
                    <div class="grid grid-cols-3 gap-2 mb-2 text-[11px] font-medium text-slate-600">
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="chk-pure" checked class="chk-input"> Pure</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="chk-gold" checked class="chk-input"> Gold</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="chk-potential" checked class="chk-input"> Potential</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="chk-bl" class="chk-input"> Blacklist</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="chk-custom" class="chk-input"> Custom</label>
                        <label class="flex items-center gap-1 cursor-pointer"><input type="checkbox" id="chk-cidr" class="chk-input"> CIDR</label>
                    </div>
                    <button onclick="exportData()" class="w-full bg-slate-900 text-white py-2 rounded-md text-sm font-bold hover:bg-slate-800 flex items-center justify-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i> ×™×™×¦×•× Excel
                    </button>
                </div>
            </aside>

            <main class="dash-content">
                <div class="p-3 bg-white border-b border-slate-100 shrink-0">
                    <div id="kpi-container" class="kpi-container"></div>
                </div>

                <div class="flex-1 p-3 min-h-0 flex flex-col">
                    <div class="bg-white rounded-xl border border-slate-200 flex-1 flex flex-col overflow-hidden shadow-sm">
                        <div class="px-4 py-2 border-b border-slate-200 bg-white flex justify-between items-center shrink-0 flex-wrap gap-2">
                            <div class="flex items-center gap-3 flex-wrap">
                                <div class="flex items-center gap-2">
                                    <span class="text-[11px] font-bold text-slate-400 uppercase">×ª×¦×•×’×”:</span>
                                    <select id="filter-view" class="text-sm bg-slate-50 border border-slate-200 rounded px-2 py-1 font-medium w-36">
                                        <option value="all">×”×›×œ</option>
                                        <option value="relevant">ğŸ¯ Relevant</option>
                                        <option value="winners">âœ¨ Winners</option>
                                        <option value="pure">ğŸ’ Pure</option>
                                        <option value="gold">ğŸ¥‡ Gold</option>
                                        <option value="potential">ğŸŒ± Potential</option>
                                        <option value="ignore">ğŸ˜ Ignore</option>
                                        <option value="blacklist">ğŸš« Blacklist</option>
                                        <option value="testing">ğŸ”¬ Testing</option>
                                        <option value="custom">ğŸ¯ Custom</option>
                                    </select>
                                </div>

                                <div class="flex items-center gap-2" id="level-filter-box" style="display:none;">
                                    <span class="text-[11px] font-bold text-slate-400 uppercase">×©×›×‘×”:</span>
                                    <select id="level-view" class="text-sm bg-slate-50 border border-slate-200 rounded px-2 py-1 font-medium">
                                        <option value="detail">×¤×™×¨×•×˜ ×‘×œ×‘×“</option>
                                        <option value="all">×”×›×œ (×›×•×œ×œ ×¡×™×›×•××™×)</option>
                                    </select>
                                </div>

                                <div class="flex items-center gap-2 border-r border-slate-200 pr-3">
                                    <span class="text-[11px] font-bold text-slate-400">Min Score:</span>
                                    <input type="number" id="min-score-filter" value="0" step="0.1" class="w-16 text-sm border border-slate-200 rounded px-2 py-1 num-font">
                                </div>

                                <div class="flex items-center gap-2">
                                    <label class="flex items-center gap-1 text-[11px] text-slate-500 font-bold cursor-pointer">
                                        <input type="checkbox" id="chk-copy-cidr" class="chk-input"> CIDR
                                    </label>
                                    <button onclick="copyIPs()" id="btn-copy" class="flex items-center gap-1 bg-white border border-slate-200 text-slate-600 px-2 py-1 rounded hover:bg-slate-50 text-[11px] font-bold">
                                        <i data-lucide="copy" class="w-3 h-3"></i> ×”×¢×ª×§
                                    </button>
                                </div>
                            </div>
                            <div class="text-[11px] text-slate-400 font-medium">
                                ×¡×”"×›: <span id="disp-count" class="font-bold text-slate-800 num-font text-base">0</span>
                            </div>
                        </div>

                        <div class="flex-1 overflow-auto custom-scrollbar bg-white">
                            <table class="w-full text-sm relative">
                                <thead class="bg-slate-50 sticky top-0 z-10">
                                    <tr>
                                        <th class="text-center w-8">#</th>
                                        <th class="text-center w-10" id="th-level" style="display:none;">Lvl</th>
                                        <th class="text-right">IP / Identifier</th>
                                        <th class="text-center">×§×˜×’×•×¨×™×”</th>
                                        <th class="text-center">Score</th>
                                        <th class="text-center">Clicks</th>
                                        <th class="text-center">Conv</th>
                                        <th class="text-center">Revenue</th>
                                        <th class="text-center">Cost</th>
                                        <th class="text-center">Profit</th>
                                        <th class="text-center">ROI%</th>
                                        <th class="text-center">CR%</th>
                                        <th class="text-center">EPC</th>
                                    </tr>
                                </thead>
                                <tbody id="table-body"></tbody>
                            </table>
                        </div>

                        <div class="p-2 border-t border-slate-100 bg-white flex justify-center gap-4 items-center shrink-0">
                            <button onclick="changePage(-1)" class="p-1 hover:bg-slate-100 rounded text-slate-500"><i data-lucide="chevron-right" class="w-4 h-4"></i></button>
                            <span id="page-num" class="text-[11px] font-bold text-slate-400 num-font">1 / 1</span>
                            <button onclick="changePage(1)" class="p-1 hover:bg-slate-100 rounded text-slate-500"><i data-lucide="chevron-left" class="w-4 h-4"></i></button>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script>
        lucide.createIcons();

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // STATE - ALL KPIs VISIBLE BY DEFAULT
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const state = {
            rawData: [], allRows: [], detailRows: [], summaryRows: [], aggregatedData: [], processed: [], filtered: [],
            headers: [], dimensions: {}, activeFilters: [], page: 1, pageSize: 100,
            medianPPC: 0, medianCR: 0, campaignCR: 0, clickThreshold: 7000,
            visibleKpis: ['pure', 'gold', 'potential', 'ignore', 'blacklist', 'testing'],
            hasHierarchy: false, levelColumn: null, maxLevel: 1, ipColumn: '',
            customEnabled: false
        };

        // IP Level configurations
        const IP_LEVELS = {
            1: { name: 'IP1/SubID', multiplier: 1.5, min: 1000, max: 3000, default: 1500 },
            2: { name: 'IP2/Zone', multiplier: 3, min: 3000, max: 10000, default: 7000 },
            3: { name: 'IP3', multiplier: 5, min: 5000, max: 15000, default: 10000 }
        };

        const $ = id => document.getElementById(id);
        const parseNum = v => { if (typeof v === 'number') return v; if (!v) return 0; return parseFloat(String(v).replace(/[,$%\s]/g, '')) || 0; };

        function toggleSection(section) {
            const content = $(section + '-content');
            const icon = $(section + '-icon');
            content.classList.toggle('open');
            icon.classList.toggle('open');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CIDR CONVERSION - Smart Level Detection
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function ipToLong(ip) {
            return ip.split('.').reduce((long, octet) => (long << 8) + parseInt(octet, 10), 0) >>> 0;
        }
        
        function longToIp(long) {
            return [
                (long >>> 24) & 255,
                (long >>> 16) & 255,
                (long >>> 8) & 255,
                long & 255
            ].join('.');
        }
        
        function toCIDR(ip) {
            const str = String(ip).trim();
            
            // Already has CIDR notation - return as is
            if (str.includes('/')) return str;
            
            // Not a valid IP format - return as is
            if (!/^\d+\.\d+\.\d+\.\d+$/.test(str)) return str;
            
            const parts = str.split('.').map(Number);
            
            // Smart detection based on IP structure:
            // x.x.0.0 â†’ /16 (IP3)
            if (parts[2] === 0 && parts[3] === 0) {
                return parts[0] + '.' + parts[1] + '.0.0/16';
            }
            
            // x.x.x.0 â†’ /24 (IP2)
            if (parts[3] === 0) {
                return parts[0] + '.' + parts[1] + '.' + parts[2] + '.0/24';
            }
            
            // Full IP x.x.x.x â†’ /32 (IP1)
            return str + '/32';
        }
        
        function rangeToOptimalCIDRs(startStr, endStr) {
            let start = ipToLong(startStr);
            let end = ipToLong(endStr);
            let result = [];
            
            while (start <= end) {
                let maxBlockSizeAllowedByIP = 1;
                while ((start & maxBlockSizeAllowedByIP) === 0 && maxBlockSizeAllowedByIP <= (1 << 30)) {
                    maxBlockSizeAllowedByIP <<= 1;
                }
                
                let remainingSize = end - start + 1;
                let maxPow = Math.floor(Math.log2(remainingSize));
                let maxSize = Math.pow(2, maxPow);
                
                if (maxBlockSizeAllowedByIP < maxSize) {
                    maxSize = maxBlockSizeAllowedByIP;
                    maxPow = Math.floor(Math.log2(maxSize));
                }
                
                result.push(longToIp(start) + '/' + (32 - maxPow));
                start += maxSize;
            }
            
            return result;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CLICK THRESHOLD CALCULATION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function calculateClickThreshold() {
            const level = parseInt($('ip-level').value);
            const config = IP_LEVELS[level];
            
            if (state.campaignCR <= 0 || state.campaignCR < 0.001) {
                state.clickThreshold = config.default;
            } else {
                const crPercent = state.campaignCR * 100;
                let threshold = config.multiplier * (100 / crPercent);
                threshold = Math.max(config.min, Math.min(config.max, threshold));
                state.clickThreshold = Math.round(threshold);
            }
            
            $('current-threshold').textContent = state.clickThreshold.toLocaleString();
            $('click-threshold').textContent = state.clickThreshold.toLocaleString();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FILE HANDLING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        const dz = $('drop-zone');
        const fi = $('file-input');
        dz.addEventListener('click', () => fi.click());
        fi.addEventListener('change', e => loadFile(e.target.files[0]));
        dz.addEventListener('dragover', e => e.preventDefault());
        dz.addEventListener('drop', e => { e.preventDefault(); loadFile(e.dataTransfer.files[0]); });

        function loadFile(file) {
            if (!file) return;
            
            const sizeMB = file.size / (1024 * 1024);
            if (sizeMB > 50) {
                alert('×§×•×‘×¥ ×’×“×•×œ ××“×™ (××¢×œ 50MB). × ×¡×” ×œ×¤×¦×œ ××ª ×”×§×•×‘×¥.');
                return;
            }
            
            $('filename').innerHTML = '<span class="animate-pulse">â³ ×˜×•×¢×Ÿ ' + file.name + ' (' + sizeMB.toFixed(1) + 'MB)...</span>';
            $('global-stats').innerHTML = '<span class="text-amber-500 animate-pulse">ğŸ”„ ××¢×‘×“ × ×ª×•× ×™×...</span>';
            
            setTimeout(() => {
                const reader = new FileReader();
                reader.onerror = () => {
                    alert('×©×’×™××” ×‘×§×¨×™××ª ×”×§×•×‘×¥');
                    $('filename').textContent = '';
                };
                reader.onload = e => {
                    try {
                        const wb = XLSX.read(e.target.result, { 
                            type: 'array',
                            cellDates: false,
                            cellNF: false,
                            cellStyles: false
                        });
                        
                        const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]], { 
                            header: 1,
                            defval: '',
                            raw: true
                        });
                        
                        if (json.length < 2) {
                            alert('×§×•×‘×¥ ×¨×™×§');
                            $('filename').textContent = '';
                            return;
                        }

                        state.headers = json[0].map(h => String(h || '').trim());
                        state.rawData = json.slice(1).filter(row => row.some(c => c !== '' && c != null));
                        $('filename').textContent = file.name + ' (' + state.rawData.length.toLocaleString() + ' ×©×•×¨×•×ª)';
                        
                        const hLower = state.headers.map(h => h.toLowerCase());
                        const levelIdx = hLower.findIndex(x => x === 'level' || x === 'lvl' || x === 'depth');
                        state.levelColumn = levelIdx !== -1 ? state.headers[levelIdx] : null;
                        state.hasHierarchy = levelIdx !== -1;

                        setupMapping();
                        setupFilters();
                        
                        setTimeout(() => processData(), 10);
                        
                    } catch (err) {
                        console.error('Error processing file:', err);
                        alert('×©×’×™××” ×‘×¢×™×‘×•×“ ×”×§×•×‘×¥: ' + err.message);
                        $('filename').textContent = '';
                        $('global-stats').innerHTML = '<span class="text-red-500">×©×’×™××” ×‘×˜×¢×™× ×”</span>';
                    }
                };
                reader.readAsArrayBuffer(file);
            }, 50);
        }

        function setupMapping() {
            const selects = ['col-ip', 'col-clicks', 'col-conv', 'col-rev', 'col-cost'];
            const defaults = { 'col-ip': ['ip', 'identifier', 'subid', 'zone', 'range'], 'col-clicks': ['clicks', 'click', 'impressions'], 'col-conv': ['conv', 'conversions', 'conversion', 'leads'], 'col-rev': ['revenue', 'rev', 'income', 'payout'], 'col-cost': ['cost', 'spend', 'expense'] };
            const hLower = state.headers.map(h => h.toLowerCase());
            selects.forEach(id => {
                const sel = $(id);
                sel.innerHTML = state.headers.map((h, i) => '<option value="' + i + '">' + h + '</option>').join('');
                const matchIdx = hLower.findIndex(h => defaults[id].some(k => h.includes(k)));
                if (matchIdx >= 0) sel.value = matchIdx;
            });
            state.ipColumn = state.headers[+$('col-ip').value];
            $('mapping-box').classList.remove('hidden');
            $('medians-box').classList.remove('hidden');

            if (state.hasHierarchy) {
                $('hierarchy-box').classList.remove('hidden');
                $('level-filter-box').style.display = 'flex';
                $('th-level').style.display = '';
            } else {
                $('hierarchy-box').classList.add('hidden');
                $('level-filter-box').style.display = 'none';
                $('th-level').style.display = 'none';
            }
        }

        function setupFilters() {
            state.dimensions = {};
            const skip = ['clicks', 'conversions', 'revenue', 'cost', 'profit', 'roi', 'cr', 'epc', 'cpc', 'level'];
            state.headers.forEach((h, idx) => {
                if (skip.some(s => h.toLowerCase().includes(s))) return;
                const vals = new Set();
                state.rawData.forEach(row => { const v = row[idx]; if (v !== undefined && v !== null && String(v).trim() !== '') vals.add(String(v).trim()); });
                if (vals.size > 0 && vals.size < 500) state.dimensions[h] = [...vals].sort();
            });
            const colSel = $('col-selector');
            colSel.innerHTML = '<option value="">×‘×—×¨ ×¢××•×“×”...</option>' + Object.keys(state.dimensions).map(h => '<option value="' + h + '">' + h + '</option>').join('');
            $('filter-msg').classList.add('hidden');
            $('btn-add-filter').classList.remove('hidden');
            state.activeFilters = [];
            $('filters-list').innerHTML = '';
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // ADVANCED FILTERS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function showAddFilterMenu() {
            if (state.activeFilters.length >= 4) return alert("××§×¡×™××•× 4 ××¡× × ×™×");
            $('btn-add-filter').classList.add('hidden');
            $('col-selector').classList.remove('hidden');
            $('col-selector').value = "";
        }

        function createNewFilter(col) {
            if (!col) { $('col-selector').classList.add('hidden'); $('btn-add-filter').classList.remove('hidden'); return; }
            const fid = Date.now();
            const div = document.createElement('div');
            div.className = 'filter-item';
            div.id = 'f-' + fid;
            div.innerHTML = '<div class="filter-header"><span>' + col + '</span><i data-lucide="x" class="w-3 h-3 cursor-pointer text-red-400 hover:text-red-600" onclick="removeFilter(' + fid + ')"></i></div><div class="filter-btn" onclick="togglePopup(' + fid + ')"><span id="l-' + fid + '">(×”×›×œ)</span><i data-lucide="chevron-down" class="w-3 h-3"></i></div><div class="filter-popup" id="p-' + fid + '"><input type="text" class="filter-search" placeholder="×—×¤×©..." oninput="filterOpts(' + fid + ', this.value)"><div class="filter-list custom-scrollbar" id="lst-' + fid + '"></div><div class="flex justify-between mt-2"><div class="btn-tiny btn-cancel" onclick="togglePopup(' + fid + ')">×¡×’×•×¨</div><div class="btn-tiny btn-apply" onclick="applyFilterSelection(' + fid + ')">×”×—×œ</div></div></div>';
            $('filters-list').appendChild(div);
            lucide.createIcons();
            const lst = $('lst-' + fid);
            (state.dimensions[col] || []).forEach(v => { lst.innerHTML += '<div class="filter-opt"><input type="checkbox" class="chk-input" value="' + v + '"> <span>' + v + '</span></div>'; });
            state.activeFilters.push({ id: fid, col, colIdx: state.headers.indexOf(col), values: [] });
            $('col-selector').classList.add('hidden');
            if (state.activeFilters.length < 4) $('btn-add-filter').classList.remove('hidden');
        }

        function removeFilter(fid) { $('f-' + fid).remove(); state.activeFilters = state.activeFilters.filter(f => f.id !== fid); $('btn-add-filter').classList.remove('hidden'); processData(); }
        function togglePopup(fid) { const el = $('p-' + fid); const isOpen = el.classList.contains('show'); document.querySelectorAll('.filter-popup').forEach(p => p.classList.remove('show')); if (!isOpen) el.classList.add('show'); }
        function filterOpts(fid, txt) { const term = txt.toLowerCase(); const opts = $('lst-' + fid).children; for (let o of opts) o.style.display = o.innerText.toLowerCase().includes(term) ? 'flex' : 'none'; }
        function applyFilterSelection(fid) {
            const lst = $('lst-' + fid);
            const vals = Array.from(lst.querySelectorAll('input:checked')).map(c => c.value);
            const f = state.activeFilters.find(x => x.id === fid);
            f.values = vals;
            const lbl = $('l-' + fid);
            lbl.innerText = vals.length ? vals.length + ' × ×‘×—×¨×•' : '(×”×›×œ)';
            lbl.className = vals.length ? 'text-blue-600 font-bold' : '';
            togglePopup(fid);
            processData();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // DATA PROCESSING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function processData() {
            try {
                console.log('Starting processData with', state.rawData.length, 'rows');
                $('global-stats').innerHTML = '<span class="text-amber-500">ğŸ”„ ××¢×‘×“ ' + state.rawData.length.toLocaleString() + ' ×©×•×¨×•×ª...</span>';
                
                const cols = { ip: +$('col-ip').value, clicks: +$('col-clicks').value, conv: +$('col-conv').value, rev: +$('col-rev').value, cost: +$('col-cost').value };
                state.ipColumn = state.headers[cols.ip];
                const levelIdx = state.levelColumn ? state.headers.indexOf(state.levelColumn) : -1;

                console.log('Parsing rows...');
                state.allRows = state.rawData.map((row, idx) => {
                    const level = levelIdx >= 0 ? parseNum(row[levelIdx]) : 1;
                    return { idx, raw: row, identifier: String(row[cols.ip] || '').trim(), level, clicks: parseNum(row[cols.clicks]), conv: parseNum(row[cols.conv]), rev: parseNum(row[cols.rev]), cost: parseNum(row[cols.cost]), profit: parseNum(row[cols.rev]) - parseNum(row[cols.cost]) };
                });
                console.log('Parsed', state.allRows.length, 'rows');

                if (state.hasHierarchy) {
                    let maxLvl = 1;
                    const levelSet = new Set();
                    for (let i = 0; i < state.allRows.length; i++) {
                        const lvl = state.allRows[i].level;
                        if (lvl > maxLvl) maxLvl = lvl;
                        levelSet.add(lvl);
                    }
                    state.maxLevel = maxLvl;
                    const levels = [...levelSet].sort((a, b) => a - b);
                    $('level-badges').innerHTML = levels.map(l => '<span class="level-badge level-' + Math.min(l, 3) + '">' + l + '</span>').join('');
                }

                let filtered = state.allRows.filter(r => {
                    for (const f of state.activeFilters) { if (f.values.length > 0) { const val = String(r.raw[f.colIdx] || ''); if (!f.values.includes(val)) return false; } }
                    return true;
                });

                if (state.hasHierarchy) {
                    state.detailRows = filtered.filter(r => r.level === state.maxLevel);
                    state.summaryRows = filtered.filter(r => r.level < state.maxLevel);
                } else {
                    state.detailRows = filtered.filter(r => r.identifier !== '');
                    state.summaryRows = [];
                }

                // Filter out invalid IPs (0.0.0.0, ×œ× ××–×•×”×”, empty)
                state.detailRows = state.detailRows.filter(r => {
                    const id = r.identifier.toLowerCase().trim();
                    if (!id) return false;
                    if (id === '0.0.0.0') return false;
                    if (id.startsWith('0.0.0.')) return false;
                    if (id === '×œ× ××–×•×”×”' || id === 'not identified' || id === 'unknown') return false;
                    return true;
                });

                console.log('Aggregating', state.detailRows.length, 'detail rows...');
                
                const grouped = {};
                state.detailRows.forEach(r => {
                    const key = r.identifier || 'Unknown';
                    if (!grouped[key]) grouped[key] = { identifier: key, level: r.level, clicks: 0, conv: 0, rev: 0, cost: 0, profit: 0, isSummary: false };
                    const g = grouped[key];
                    g.clicks += r.clicks; g.conv += r.conv; g.rev += r.rev; g.cost += r.cost; g.profit += r.profit;
                });

                state.aggregatedData = Object.values(grouped).map(g => ({
                    ...g,
                    roi: g.cost > 0 ? (g.profit / g.cost) * 100 : (g.profit > 0 ? 999 : 0),
                    cr: g.clicks > 0 ? g.conv / g.clicks : 0,
                    epc: g.clicks > 0 ? g.profit / g.clicks : 0
                }));
                
                console.log('Aggregated to', state.aggregatedData.length, 'unique IPs');

                const totalClicks = state.aggregatedData.reduce((s, r) => s + r.clicks, 0);
                const totalConv = state.aggregatedData.reduce((s, r) => s + r.conv, 0);
                state.campaignCR = totalClicks > 0 ? totalConv / totalClicks : 0;

                const profitable = state.aggregatedData.filter(r => r.conv > 0 && r.epc > 0);
                if (profitable.length > 0) {
                    const epcs = profitable.map(r => r.epc).sort((a, b) => a - b);
                    const crs = profitable.map(r => r.cr).sort((a, b) => a - b);
                    state.medianPPC = epcs[Math.floor(epcs.length / 2)];
                    state.medianCR = crs[Math.floor(crs.length / 2)];
                } else {
                    state.medianPPC = 0.001;
                    state.medianCR = 0.001;
                }

                calculateClickThreshold();

                $('med-ppc').textContent = '$' + state.medianPPC.toFixed(4);
                $('med-cr').textContent = (state.medianCR * 100).toFixed(3) + '%';

                state.customEnabled = $('custom-enabled').checked;
                $('custom-badge').classList.toggle('hidden', !state.customEnabled);

                console.log('Classifying ranges...');
                state.processed = classifyRanges(state.aggregatedData);
                console.log('Classified', state.processed.length, 'ranges');
                
                applyFilter();
                renderKPIs();
                renderTable();
                renderGlobalStats();
                
                console.log('processData completed successfully');
                
            } catch (err) {
                console.error('Error in processData:', err);
                $('global-stats').innerHTML = '<span class="text-red-500">âŒ ×©×’×™××”: ' + err.message + '</span>';
                alert('×©×’×™××” ×‘×¢×™×‘×•×“: ' + err.message);
            }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SCORING ENGINE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function calculateScore(r) {
            if (r.conv === 0) return 0;
            if (r.epc <= 0) return 0;
            if (state.medianPPC <= 0 || state.medianCR <= 0) return 0;
            
            const efficiency = r.epc / state.medianPPC;
            const certainty = Math.sqrt(r.conv / 3);
            const crBonus = Math.sqrt(r.cr / state.medianCR);
            
            return efficiency * certainty * crBonus;
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // CLASSIFICATION ENGINE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function classifyRanges(data) {
            const purePct = +$('pure-pct-num').value || 10;
            const goldPct = +$('gold-pct-num').value || 25;
            const clickThreshold = state.clickThreshold;

            // Custom list settings - Min/Max
            const custConvMin = parseFloat($('cust-conv-min').value) || 0;
            const custConvMax = $('cust-conv-max').value !== '' ? parseFloat($('cust-conv-max').value) : Infinity;
            const custScoreMin = parseFloat($('cust-score-min').value) || 0;
            const custScoreMax = $('cust-score-max').value !== '' ? parseFloat($('cust-score-max').value) : Infinity;
            const custClicksMin = parseFloat($('cust-clicks-min').value) || 0;
            const custClicksMax = $('cust-clicks-max').value !== '' ? parseFloat($('cust-clicks-max').value) : Infinity;
            const custRoiMin = parseFloat($('cust-roi-min').value) || -9999;
            const custRoiMax = $('cust-roi-max').value !== '' ? parseFloat($('cust-roi-max').value) : Infinity;
            const custCrMin = parseFloat($('cust-cr-min').value) || 0;
            const custCrMax = $('cust-cr-max').value !== '' ? parseFloat($('cust-cr-max').value) : Infinity;
            const custEpcMin = parseFloat($('cust-epc-min').value) || -9999;
            const custEpcMax = $('cust-epc-max').value !== '' ? parseFloat($('cust-epc-max').value) : Infinity;

            data = data.map(r => ({ ...r, score: calculateScore(r) }));

            const totalClicks = data.reduce((s, r) => s + r.clicks, 0);
            const totalConv = data.reduce((s, r) => s + r.conv, 0);
            const totalProfit = data.reduce((s, r) => s + r.profit, 0);
            const totalCost = data.reduce((s, r) => s + r.cost, 0);
            const campaignAvgCR = totalClicks > 0 ? totalConv / totalClicks : 0;
            const campaignAvgEPC = totalClicks > 0 ? totalProfit / totalClicks : 0;

            const purePool = data.filter(r => r.conv >= 3 && r.profit > 0).sort((a, b) => b.score - a.score);
            const goldPool = data.filter(r => r.conv >= 2 && r.profit > 0).sort((a, b) => b.score - a.score);
            const pureThreshold = purePool.length > 0 ? purePool[Math.floor(purePool.length * purePct / 100)]?.score || 0 : Infinity;
            const goldThreshold = goldPool.length > 0 ? goldPool[Math.floor(goldPool.length * goldPct / 100)]?.score || 0 : Infinity;

            return data.map(r => {
                let category, action;
                const hasEnoughClicks = r.clicks >= clickThreshold;

                const blCond1_ZeroConv = r.conv === 0;
                const blCond2_NegProfit = r.profit < 0;
                
                const crBelow50OfAvg = r.cr < (campaignAvgCR * 0.5);
                const epcBelow50OfAvg = r.epc < (campaignAvgEPC * 0.5);
                const campaignAvgROI = totalCost > 0 ? (totalProfit / totalCost * 100) : 0;
                const roiBelow50OfAvg = r.roi < (campaignAvgROI * 0.5);
                
                const blCond3_PoorPerformance = r.conv > 0 && (crBelow50OfAvg || epcBelow50OfAvg || roiBelow50OfAvg);
                
                const isBlacklist = hasEnoughClicks && (blCond1_ZeroConv || blCond2_NegProfit || blCond3_PoorPerformance);
                const isTesting = r.conv === 0 && r.clicks < clickThreshold;

                // Custom List with Min/Max
                const crPercent = r.cr * 100;
                const matchesCustom = state.customEnabled &&
                    r.conv >= custConvMin && r.conv <= custConvMax &&
                    r.score >= custScoreMin && r.score <= custScoreMax &&
                    r.clicks >= custClicksMin && r.clicks <= custClicksMax &&
                    r.roi >= custRoiMin && r.roi <= custRoiMax &&
                    crPercent >= custCrMin && crPercent <= custCrMax &&
                    r.epc >= custEpcMin && r.epc <= custEpcMax;

                if (isBlacklist) {
                    category = 'blacklist';
                    action = 'Block';
                } else if (isTesting) {
                    category = 'testing';
                    action = 'Wait';
                } else if (matchesCustom) {
                    category = 'custom';
                    action = 'Custom';
                } else if (r.conv >= 3 && r.profit > 0 && r.score >= pureThreshold) {
                    category = 'pure';
                    action = 'Bid +30%';
                } else if (r.conv >= 2 && r.profit > 0 && r.score >= goldThreshold) {
                    category = 'gold';
                    action = 'Bid +15%';
                } else if (r.conv >= 1 && r.profit > 0) {
                    category = 'potential';
                    action = 'Bid +5-10%';
                } else {
                    category = 'ignore';
                    action = 'RON';
                }

                return { ...r, category, action, matchesCustom, isBlacklist, isTesting, blCond1_ZeroConv, blCond2_NegProfit, blCond3_PoorPerformance };
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // FILTERING - WITH RELEVANT OPTION
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function applyFilter() {
            const view = $('filter-view').value;
            const levelView = $('level-view').value;
            const minScore = parseFloat($('min-score-filter').value) || 0;
            let data = [...state.processed];

            if (levelView === 'all' && state.hasHierarchy) {
                const summaries = state.summaryRows.map(r => ({
                    ...r, identifier: r.identifier || buildIdentifier(r),
                    roi: r.cost > 0 ? (r.profit / r.cost) * 100 : 0, cr: r.clicks > 0 ? r.conv / r.clicks : 0,
                    epc: r.clicks > 0 ? r.profit / r.clicks : 0,
                    score: 0, category: 'summary', action: '-', isSummary: true
                }));
                data = [...summaries, ...data];
            }

            // Filter by view - RELEVANT = pure, gold, potential, testing
            if (view === 'winners') data = data.filter(r => ['pure', 'gold', 'potential'].includes(r.category));
            else if (view === 'relevant') data = data.filter(r => ['pure', 'gold', 'potential', 'testing'].includes(r.category));
            else if (view === 'custom') data = data.filter(r => r.matchesCustom);
            else if (view !== 'all') data = data.filter(r => r.category === view);

            if (minScore > 0) data = data.filter(r => r.score >= minScore || r.isSummary);

            state.filtered = data.sort((a, b) => {
                if (a.isSummary && !b.isSummary) return -1;
                if (!a.isSummary && b.isSummary) return 1;
                if (a.isSummary && b.isSummary) return a.level - b.level;
                return b.score - a.score;
            });
            state.page = 1;
        }

        function buildIdentifier(row) {
            const parts = [];
            const skip = ['level', 'clicks', 'conversions', 'revenue', 'cost', 'profit', 'roi', 'cr'];
            for (let i = 0; i < state.headers.length; i++) {
                const h = state.headers[i].toLowerCase();
                if (skip.some(s => h.includes(s))) continue;
                const val = row.raw[i];
                if (val && String(val).trim() !== '') parts.push(String(val).trim());
            }
            return parts.join(' | ') || 'Unknown';
        }

        $('filter-view').addEventListener('change', () => { applyFilter(); renderTable(); });
        $('level-view').addEventListener('change', () => { applyFilter(); renderTable(); });
        $('min-score-filter').addEventListener('input', () => { applyFilter(); renderTable(); });
        $('ip-level').addEventListener('change', () => { processData(); });
        $('custom-enabled').addEventListener('change', () => { processData(); });

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // KPI TOGGLE
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function toggleKpi(kpi) {
            const idx = state.visibleKpis.indexOf(kpi);
            if (idx >= 0) state.visibleKpis.splice(idx, 1);
            else state.visibleKpis.push(kpi);
            document.querySelectorAll('.kpi-toggle-btn').forEach(btn => { btn.classList.toggle('active', state.visibleKpis.includes(btn.dataset.kpi)); });
            renderKPIs();
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // KPI RENDERING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderKPIs() {
            const categories = [
                { key: 'pure', name: 'PURE', icon: 'ğŸ’', cls: 'kpi-pure' },
                { key: 'gold', name: 'GOLD', icon: 'ğŸ¥‡', cls: 'kpi-gold' },
                { key: 'potential', name: 'POTENTIAL', icon: 'ğŸŒ±', cls: 'kpi-potential' },
                { key: 'ignore', name: 'IGNORE', icon: 'ğŸ˜', cls: 'kpi-ignore' },
                { key: 'blacklist', name: 'BLACKLIST', icon: 'ğŸš«', cls: 'kpi-blacklist' },
                { key: 'testing', name: state.customEnabled ? 'CUSTOM' : 'TESTING', icon: state.customEnabled ? 'ğŸ¯' : 'ğŸ”¬', cls: 'kpi-testing' }
            ];

            let html = '';
            categories.forEach(cat => {
                let rows;
                if (cat.key === 'testing' && state.customEnabled) {
                    rows = state.processed.filter(r => r.matchesCustom);
                } else {
                    rows = state.processed.filter(r => r.category === cat.key);
                }

                const s = { count: rows.length, clicks: rows.reduce((sum, r) => sum + r.clicks, 0), conv: rows.reduce((sum, r) => sum + r.conv, 0), rev: rows.reduce((sum, r) => sum + r.rev, 0), cost: rows.reduce((sum, r) => sum + r.cost, 0), profit: rows.reduce((sum, r) => sum + r.profit, 0) };
                s.roi = s.cost > 0 ? (s.profit / s.cost * 100) : (s.profit > 0 ? 999 : 0);
                s.cr = s.clicks > 0 ? (s.conv / s.clicks * 100) : 0;
                s.epc = s.clicks > 0 ? (s.profit / s.clicks) : 0;
                const isHidden = !state.visibleKpis.includes(cat.key);
                const isCustomActive = cat.key === 'testing' && state.customEnabled;

                html += '<div class="kpi-card ' + cat.cls + (isHidden ? ' hidden' : '') + (isCustomActive ? ' custom-active' : '') + '"><div class="flex justify-between items-center mb-1"><div class="flex items-center gap-1"><span class="text-lg">' + cat.icon + '</span><span class="text-[11px] font-black uppercase">' + cat.name + '</span></div><div class="text-xl font-black num-font text-slate-800">' + s.count.toLocaleString() + '</div></div><div class="bg-slate-100 border border-slate-200 rounded px-2 py-1 flex justify-between items-center mb-1"><div class="text-center flex-1"><div class="stat-lbl">Clicks</div><div class="stat-val text-[12px]">' + formatNum(s.clicks) + '</div></div><div class="text-center flex-1 border-r border-slate-200"><div class="stat-lbl">EPC</div><div class="stat-val text-[12px]">$' + s.epc.toFixed(4) + '</div></div></div><div class="grid grid-cols-3 gap-0.5 text-center mb-1 border-b border-slate-100 pb-1"><div><div class="stat-lbl">Conv</div><div class="stat-val text-[12px]">' + s.conv.toLocaleString() + '</div></div><div><div class="stat-lbl">Revenue</div><div class="stat-val text-[12px] text-green-600">$' + formatNum(s.rev) + '</div></div><div><div class="stat-lbl">Cost</div><div class="stat-val text-[12px] text-slate-500">$' + formatNum(s.cost) + '</div></div></div><div class="grid grid-cols-3 gap-0.5 text-center"><div><div class="stat-lbl">Profit</div><div class="stat-val text-[12px] ' + (s.profit >= 0 ? 'text-green-600' : 'text-red-500') + '">$' + formatNum(s.profit) + '</div></div><div><div class="stat-lbl">ROI</div><div class="stat-val text-[12px] ' + (s.roi >= 0 ? 'text-green-600' : 'text-red-500') + '">' + s.roi.toFixed(0) + '%</div></div><div><div class="stat-lbl">CR</div><div class="stat-val text-[12px] text-blue-600">' + s.cr.toFixed(3) + '%</div></div></div></div>';
            });
            $('kpi-container').innerHTML = html;
        }

        function formatNum(n) {
            if (Math.abs(n) >= 1e6) return (n / 1e6).toFixed(1) + 'M';
            if (Math.abs(n) >= 1e3) return (n / 1e3).toFixed(1) + 'K';
            return n.toFixed(0);
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // GLOBAL STATS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderGlobalStats() {
            const data = state.processed;
            const clicks = data.reduce((s, r) => s + r.clicks, 0);
            const conv = data.reduce((s, r) => s + r.conv, 0);
            const rev = data.reduce((s, r) => s + r.rev, 0);
            const cost = data.reduce((s, r) => s + r.cost, 0);
            const profit = data.reduce((s, r) => s + r.profit, 0);
            const roi = cost > 0 ? (profit / cost * 100) : 0;
            const cr = clicks > 0 ? (conv / clicks * 100) : 0;
            const epc = clicks > 0 ? (profit / clicks) : 0;
            const pill = (l, v, c) => '<div class="g-item"><span class="g-lbl">' + l + '</span><span class="g-val ' + c + '">' + v + '</span></div>';
            $('global-stats').innerHTML = pill('IPs', data.length.toLocaleString(), '') + pill('Clicks', formatNum(clicks), 'text-blue-600') + pill('Conv', conv.toLocaleString(), '') + pill('Revenue', '$' + formatNum(rev), 'text-green-600') + pill('Cost', '$' + formatNum(cost), 'text-slate-500') + pill('Profit', '$' + formatNum(profit), profit >= 0 ? 'text-green-600' : 'text-red-500') + pill('ROI', roi.toFixed(0) + '%', roi >= 0 ? 'text-green-600' : 'text-red-500') + pill('CR', cr.toFixed(3) + '%', 'text-blue-600') + pill('EPC', '$' + epc.toFixed(4), 'text-amber-600');
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // TABLE RENDERING
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function renderTable() {
            const start = (state.page - 1) * state.pageSize;
            const pageData = state.filtered.slice(start, start + state.pageSize);
            const showLevel = state.hasHierarchy;
            const catConfig = {
                pure: { badge: 'badge-pure', row: 'row-pure', label: 'ğŸ’ PURE' },
                gold: { badge: 'badge-gold', row: 'row-gold', label: 'ğŸ¥‡ GOLD' },
                potential: { badge: 'badge-potential', row: 'row-potential', label: 'ğŸŒ± POTENTIAL' },
                ignore: { badge: 'badge-ignore', row: '', label: 'ğŸ˜ IGNORE' },
                blacklist: { badge: 'badge-blacklist', row: 'row-blacklist', label: 'ğŸš« BLACKLIST' },
                testing: { badge: 'badge-testing', row: 'row-testing', label: 'ğŸ”¬ TESTING' },
                custom: { badge: 'badge-custom', row: 'row-custom', label: 'ğŸ¯ CUSTOM' },
                summary: { badge: 'badge-summary', row: 'row-summary', label: 'ğŸ“Š SUMMARY' }
            };

            let html = '';
            pageData.forEach((r, i) => {
                const cfg = catConfig[r.category] || catConfig.ignore;
                const scoreCls = r.score > 5 ? 'score-high' : r.score > 1 ? 'score-mid' : 'score-low';
                const levelCls = r.level === 1 ? 'level-1' : r.level === 2 ? 'level-2' : 'level-3';
                html += '<tr class="' + cfg.row + '"><td class="text-center num-font text-slate-400">' + (start + i + 1) + '</td>' + (showLevel ? '<td class="text-center"><span class="level-badge ' + levelCls + '">' + r.level + '</span></td>' : '') + '<td class="text-right font-bold text-slate-700 ' + (r.isSummary ? 'text-indigo-700' : '') + '">' + r.identifier + '</td><td class="text-center"><span class="cat-badge ' + cfg.badge + '">' + cfg.label + '</span></td><td class="text-center"><span class="score-pill ' + scoreCls + '">' + r.score.toFixed(2) + '</span></td><td class="text-center num-font">' + r.clicks.toLocaleString() + '</td><td class="text-center num-font font-bold">' + r.conv + '</td><td class="text-center num-font text-green-600">$' + r.rev.toFixed(2) + '</td><td class="text-center num-font text-slate-500">$' + r.cost.toFixed(2) + '</td><td class="text-center num-font font-bold ' + (r.profit >= 0 ? 'text-green-600' : 'text-red-500') + '">$' + r.profit.toFixed(2) + '</td><td class="text-center num-font ' + (r.roi >= 0 ? 'text-green-600' : 'text-red-500') + '">' + r.roi.toFixed(0) + '%</td><td class="text-center num-font text-blue-600">' + (r.cr * 100).toFixed(3) + '%</td><td class="text-center num-font">$' + r.epc.toFixed(4) + '</td></tr>';
            });
            $('table-body').innerHTML = html || '<tr><td colspan="13" class="text-center text-slate-400 py-8">××™×Ÿ × ×ª×•× ×™×</td></tr>';
            const maxPage = Math.ceil(state.filtered.length / state.pageSize) || 1;
            $('disp-count').textContent = state.filtered.length.toLocaleString();
            $('page-num').textContent = state.page + ' / ' + maxPage;
        }

        function changePage(d) {
            const max = Math.ceil(state.filtered.length / state.pageSize) || 1;
            if (state.page + d > 0 && state.page + d <= max) { state.page += d; renderTable(); }
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // EXPORT & COPY
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function exportData() {
            const wb = XLSX.utils.book_new();
            const useCidr = $('chk-cidr').checked;
            const exports = [
                { id: 'chk-pure', name: 'Pure', cat: 'pure' },
                { id: 'chk-gold', name: 'Gold', cat: 'gold' },
                { id: 'chk-potential', name: 'Potential', cat: 'potential' },
                { id: 'chk-bl', name: 'Blacklist', cat: 'blacklist' },
                { id: 'chk-custom', name: 'Custom', cat: 'custom' }
            ];
            let count = 0;
            exports.forEach(exp => {
                if ($(exp.id).checked) {
                    let rows;
                    if (exp.cat === 'custom') {
                        rows = state.processed.filter(r => r.matchesCustom);
                    } else {
                        rows = state.processed.filter(r => r.category === exp.cat);
                    }
                    if (rows.length) {
                        const data = rows.map(r => ({ Identifier: useCidr ? toCIDR(r.identifier) : r.identifier, Score: r.score.toFixed(2), Clicks: r.clicks, Conv: r.conv, Revenue: r.rev.toFixed(2), Cost: r.cost.toFixed(2), Profit: r.profit.toFixed(2), 'ROI%': r.roi.toFixed(0), 'CR%': (r.cr * 100).toFixed(3), EPC: r.epc.toFixed(4), Action: r.action }));
                        XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(data), exp.name);
                        count++;
                    }
                }
            });
            if (count) XLSX.writeFile(wb, 'ListLab_V35_Export.xlsx');
            else alert('×‘×—×¨ ×œ×¤×—×•×ª ×¨×©×™××” ××—×ª');
        }

        function copyIPs() {
            if (!state.filtered.length) return alert('××™×Ÿ × ×ª×•× ×™×');
            const useCidr = $('chk-copy-cidr').checked;
            const text = state.filtered.filter(r => !r.isSummary).map(r => useCidr ? toCIDR(r.identifier) : r.identifier).join('\n');
            navigator.clipboard.writeText(text).then(() => {
                const btn = $('btn-copy');
                btn.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i> ×”×•×¢×ª×§!';
                lucide.createIcons();
                setTimeout(() => { btn.innerHTML = '<i data-lucide="copy" class="w-3 h-3"></i> ×”×¢×ª×§'; lucide.createIcons(); }, 1500);
            });
        }

        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        // SYNC CONTROLS
        // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        function syncControls(rangeId, numId) {
            const range = $(rangeId);
            const num = $(numId);
            range.addEventListener('input', () => { num.value = range.value; processData(); });
            num.addEventListener('input', () => { range.value = num.value; processData(); });
        }

        syncControls('pure-pct', 'pure-pct-num');
        syncControls('gold-pct', 'gold-pct-num');
    </script>
</body>
</html>
